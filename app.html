<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdayCaawiye - Complete CMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        /* Sidebar, Modals, Utils - Keep all previous styles */
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #374151; color: white; }
        .sidebar-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .sidebar-link .icon { width: 1.125rem; height: 1.125rem; margin-right: 0.75rem; flex-shrink: 0; }
        .dropdown-menu { display: none; padding-left: 1.5rem; }
        .sidebar-link.has-dropdown.open + .dropdown-menu { display: block; }
        .sidebar-link.has-dropdown.open .dropdown-icon { transform: rotate(180deg); }
        .dropdown-menu .sidebar-link { padding-top: 0.5rem; padding-bottom: 0.5rem; font-size: 0.875rem; }
        .dropdown-menu .sidebar-link:hover { background-color: #374151; }
        .dropdown-menu .sidebar-link.active { color: #a5b4fc; background-color: transparent; font-weight: 500; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .quiz-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 2rem 1rem; } /* Hidden by default */
        .quiz-modal-container { background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 56rem; margin: auto; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        #quiz-form { overflow-y: auto; }
        .quiz-form-input, .quiz-form-select, .content-form-input { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.65rem 1rem; font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s; } /* Added content-form-input */
        .quiz-form-input:focus, .quiz-form-select:focus, .content-form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .quiz-btn { padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
        .quiz-btn-primary { background-color: #4f46e5; color: white; } .quiz-btn-primary:hover { background-color: #4338ca; }
        .quiz-btn-secondary { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; } .quiz-btn-secondary:hover { background-color: #e5e7eb; }
        .quiz-btn-danger { background-color: #dc2626; color: white; } .quiz-btn-danger:hover { background-color: #b91c1c; }
        .user-modal-backdrop, .content-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 60; display: none; } /* Added content-modal-backdrop */
        .app-view { display: none; } .app-view.active { display: block; }
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 1rem; display: none; }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        #quill-editor { height: 400px; }
        .tagify { --tags-border-color: #d1d5db; border-radius: 0.5rem; } .tagify:hover { --tags-border-color: #4f46e5; } .tagify.tagify--focus { --tags-border-color: #4f46e5; }
        .user-filter-btn.active, .user-sort-btn.active { background-color: #e0e7ff; color: #4338ca; font-weight: 600; }
        .content-list { list-style: none; padding: 0; margin: 0; }
        .content-list li { background-color: #f9fafb; padding: 0.75rem 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .content-actions button { margin-left: 0.5rem; }
        #toast { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    </style>
</head>
<body class="flex h-screen overflow-hidden" style="font-family: 'Inter', sans-serif;">

    <div id="main-app" class="flex w-full h-full">

        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col fixed h-full z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
             <div class="p-5 text-2xl font-bold border-b border-gray-700 flex items-center"> <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.appspot.com/o/logo.png?alt=media&token=5b34de54-86a0-47e1-8848-033190897645" alt="Logo" class="h-8 mr-2"> <span>ArdayCaawiye</span> </div>
             <nav class="flex-1 p-3 space-y-1.5 overflow-y-auto">
                 <a href="#" class="sidebar-link active" data-tab="dashboard"><i data-lucide="home" class="icon"></i> Dashboard</a>
                 <div class="pt-2"> <button class="sidebar-link has-dropdown w-full"><i data-lucide="folder-kanban" class="icon"></i><span class="flex-1 text-left">Manage Content</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button> <ul class="dropdown-menu space-y-1 pt-1"> <li><a href="#" class="sidebar-link" data-tab="subjects"><i data-lucide="book-copy" class="icon"></i> Subjects</a></li> <li><a href="#" class="sidebar-link" data-tab="exams"><i data-lucide="file-check-2" class="icon"></i> Exams</a></li> <li><a href="#" class="sidebar-link" data-tab="quizzes"><i data-lucide="puzzle" class="icon"></i> Quizzes</a></li> <li><a href="#" class="sidebar-link" data-tab="generalBooks"><i data-lucide="book-open" class="icon"></i> General Books</a></li> <li><a href="#" class="sidebar-link" data-tab="pdf-library"><i data-lucide="library" class="icon"></i> PDF Library</a></li> </ul> </div>
                 <div class="pt-2"> <button class="sidebar-link has-dropdown w-full"><i data-lucide="newspaper" class="icon"></i><span class="flex-1 text-left">Blog Management</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button> <ul class="dropdown-menu space-y-1 pt-1"> <li><a href="#" class="sidebar-link" data-tab="list-posts"><i data-lucide="layout-list" class="icon"></i> All Posts</a></li> <li><a href="#" class="sidebar-link" data-tab="post-form-view"><i data-lucide="plus-square" class="icon"></i> Add New Post</a></li> <li><a href="#" class="sidebar-link" data-tab="categories"><i data-lucide="tag" class="icon"></i> Categories</a></li> <li><a href="#" class="sidebar-link" data-tab="comments"><i data-lucide="messages-square" class="icon"></i> Comments</a></li> <li><a href="#" class="sidebar-link" data-tab="analytics"><i data-lucide="bar-chart-3" class="icon"></i> Analytics</a></li> </ul> </div>
                 <div class="pt-2"> <button class="sidebar-link has-dropdown w-full"><i data-lucide="users" class="icon"></i><span class="flex-1 text-left">User Management</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button> <ul class="dropdown-menu space-y-1 pt-1"> <li><a href="#" class="sidebar-link" data-tab="users-students"><i data-lucide="user" class="icon"></i> Students / Members</a></li> <li><a href="#" class="sidebar-link" data-tab="users-roles"><i data-lucide="shield-check" class="icon"></i> Roles & Permissions</a></li> </ul> </div>
                 <div class="pt-2"> <button class="sidebar-link has-dropdown w-full"><i data-lucide="bar-chart-3" class="icon"></i><span class="flex-1 text-left">Reports & Analytics</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button> <ul class="dropdown-menu space-y-1 pt-1"> <li><a href="#" class="sidebar-link" data-tab="main-report"><i data-lucide="activity" class="icon"></i> Main Report</a></li> </ul> </div>
                 <a href="#" class="sidebar-link" data-tab="settings"><i data-lucide="settings" class="icon"></i> Settings</a>
             </nav>
             <div class="p-4 border-t border-gray-700"> <div id="auth-status" class="text-xs text-gray-400 truncate mb-2">Admin Access</div> <button id="logout-btn" class="w-full flex items-center justify-center p-2 rounded bg-red-600 hover:bg-red-700 text-white text-sm"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout</button> </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>

        <div class="md:hidden flex justify-between items-center bg-white p-4 border-b fixed top-0 left-0 right-0 z-10"> <span class="text-xl font-bold">ArdayCaawiye CMS</span> <button id="mobile-menu-btn" class="text-gray-800"><i data-lucide="menu" class="w-6 h-6"></i></button> </div>

        <main class="flex-1 ml-0 md:ml-64 pt-20 md:pt-4 p-4 md:p-8 overflow-y-auto bg-gray-50">

            <div id="dashboard" class="tab-content fade-in"> /* ... (Dashboard HTML structure - Keep as is) ... */ </div>
            <div id="subjects" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Subjects</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <button class="add-content-btn bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700" data-type="subject"><i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>Add Subject</button>
                    <ul id="subjects-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>
            <div id="exams" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Exams</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                     <button class="add-content-btn bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700" data-type="exam"><i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>Add Exam</button>
                     <ul id="exams-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>
            <div id="quizzes" class="tab-content fade-in hidden"> /* ... (Quiz HTML structure - Keep as is) ... */ </div>
            <div id="generalBooks" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage General Books</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <button class="add-content-btn bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700" data-type="book"><i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>Add Book</button>
                    <ul id="books-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>
            <div id="pdf-library" class="tab-content fade-in hidden"> /* ... (PDF Library HTML structure - Keep as is) ... */ </div>
            <div id="list-posts" class="tab-content fade-in hidden"> /* ... (Keep Blog List HTML as is) ... */ </div>
            <div id="post-form-view" class="tab-content fade-in hidden"> /* ... (Keep Blog Form HTML as is) ... */ </div>
            <div id="categories" class="tab-content fade-in hidden"> /* ... (Keep Blog Categories HTML as is) ... */ </div>
            <div id="comments" class="tab-content fade-in hidden"> /* ... (Keep Blog Comments HTML as is) ... */ </div>
            <div id="analytics" class="tab-content fade-in hidden"> /* ... (Keep Blog Analytics HTML as is) ... */ </div>
            <div id="users-students" class="tab-content fade-in hidden"> /* ... (Keep User List HTML as is) ... */ </div>
            <div id="users-roles" class="tab-content fade-in hidden"> /* ... (Keep User Roles HTML as is) ... */ </div>
            <div id="main-report" class="tab-content fade-in hidden"> /* ... (Keep Report HTML as is) ... */ </div>
            <div id="settings" class="tab-content fade-in hidden"> /* ... (Keep Settings HTML as is) ... */ </div>

        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto py-10"><div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 m-4"></div></div>
    <div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"> /* ... */ </div>
    <div id="assign-pdf-to-content-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"> /* ... */ </div>
    <div id="quiz-modal" class="quiz-modal-overlay hidden"> /* ... */ </div>
    <div id="user-modal" class="user-modal-backdrop p-4"> /* ... */ </div>
    <div id="confirm-modal" class="user-modal-backdrop"> /* ... */ </div>
    <div id="delete-modal" class="modal"> /* ... */ </div> <div id="reply-modal" class="modal"> /* ... */ </div> <div id="share-modal" class="modal"> /* ... */ </div>

    <div id="content-modal" class="content-modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="content-modal-title" class="text-2xl font-bold">Add Item</h2>
                <button id="content-modal-close" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6">
                <form id="content-form">
                    <input type="hidden" id="content-id">
                    <input type="hidden" id="content-type">
                    <div id="content-form-fields" class="space-y-4 mb-6">
                        </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="content-cancel-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div id="toast" class="hidden fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform translate-x-full opacity-0"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore, collection, getDocs, getDoc, addDoc, doc, updateDoc, deleteDoc,
            onSnapshot, serverTimestamp, query, where, orderBy, writeBatch, Timestamp,
            getCountFromServer
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject, listAll, getMetadata
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuqswofpquk8aUbCOZCGjdYLUivBEh7a8", // !!! IMPORTANT: Replace with your actual Firebase API key !!!
            authDomain: "ardaycaawiye-18b89.firebaseapp.com", projectId: "ardaycaawiye-18b89", storageBucket: "ardaycaawiye-18b89.firebasestorage.app", messagingSenderId: "590874185284", appId: "1:590874185284:web:6ee7df602c45068e38b611", measurementId: "G-SBGSTJWDMR"
        };

        // --- Firebase Init ---
        let app, auth, db, storage;
        try {
             app = initializeApp(firebaseConfig);
             auth = getAuth(app);
             db = getFirestore(app);
             storage = getStorage(app);
             console.log("Firebase Initialized Successfully");
        } catch (error) {
             console.error("Firebase Initialization Failed:", error);
             alert("Critical Error: Could not connect to Firebase. Check API key and console for details.");
             // Prevent further execution if Firebase fails
        }


        // --- Collections & Storage Refs ---
        const postsCollection = collection(db, "blogPosts");
        const commentsCollection = collection(db, "blogComments");
        const categoriesCollection = collection(db, "blogCategories");
        const usersCollection = collection(db, "users");
        const subjectsCollection = collection(db, "subjects");
        const examsCollection = collection(db, "exams");
        const quizzesCollection = collection(db, "quizzes");
        const booksCollection = collection(db, "generalBooks");
        const pdfsStorageRef = ref(storage, '/'); // Adjust path if needed

        // --- Global State ---
        let currentUser = null;
        let currentActiveTab = 'dashboard';
        let allPosts = [], allComments = [], allCategories = [], allUsers = [];
        let allSubjects = [], allExams = [], allQuizzes = [], allBooks = [], allPdfs = [];
        let unsubscribePosts = () => {}, unsubscribeComments = () => {}, unsubscribeCategories = () => {}, unsubscribeUsers = () => {};
        let unsubscribeSubjects = () => {}, unsubscribeExams = () => {}, unsubscribeQuizzes = () => {}, unsubscribeBooks = () => {};
        let editingPostId = null, postToDeleteId = null, commentToReplyId = null;
        let editingContent = { id: null, type: null }; // For generic content editing

        // --- Lib Instances ---
        let quill, tagify, schedulePicker, reportDatePicker;

        // --- DOM Elements ---
        const mainApp = document.getElementById('main-app');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatus = document.getElementById('auth-status');
        const allTabs = document.querySelectorAll('.tab-content');
        const allSidebarLinks = document.querySelectorAll('#sidebar .sidebar-link');
        const dropdownToggles = document.querySelectorAll('#sidebar .has-dropdown');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mainSidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const toast = document.getElementById('toast');
        // Blog Elements
        const postsTableBody = document.getElementById('posts-table-body'); const blogPostForm = document.getElementById('blog-post-form'); const postFormTitle = document.getElementById('form-title'); const postIdInput = document.getElementById('post-id'); const postTitleInput = document.getElementById('post-title'); const postStatusSelect = document.getElementById('post-status'); const scheduleDateWrapper = document.getElementById('schedule-date-wrapper'); const postCategorySelect = document.getElementById('post-category'); const filterCategorySelect = document.getElementById('filter-category'); const imageDropzone = document.getElementById('image-dropzone'); const imageInput = document.getElementById('post-image'); const imagePreviewWrapper = document.getElementById('image-preview-wrapper'); const imagePreview = document.getElementById('image-preview'); const removeImageBtn = document.getElementById('remove-image-btn'); const attachmentDropzone = document.getElementById('attachment-dropzone'); const attachmentInput = document.getElementById('post-attachments'); const attachmentList = document.getElementById('attachment-list'); const commentsListView = document.getElementById('comments-list'); const deleteModal = document.getElementById('delete-modal'); const confirmDeleteBtn = document.getElementById('confirm-delete-btn'); const cancelDeleteBtn = document.getElementById('cancel-delete-btn'); const replyModal = document.getElementById('reply-modal'); const replyForm = document.getElementById('reply-form'); const cancelReplyBtn = document.getElementById('cancel-reply-btn'); const shareModal = document.getElementById('share-modal'); const cancelShareBtn = document.getElementById('cancel-share-btn'); const copyUrlBtn = document.getElementById('copy-url-btn'); const selectAllCheckbox = document.getElementById('select-all-posts'); const categoriesList = document.getElementById('categories-list'); const addCategoryForm = document.getElementById('add-category-form');
        // User Elements
        const userTableBody = document.getElementById('user-table-body'); const addUserBtn = document.getElementById('add-user-btn'); const userModal = document.getElementById('user-modal'); const userModalCloseBtn = document.getElementById('user-modal-close'); const userForm = document.getElementById('user-form'); const userModalTitle = document.getElementById('user-modal-title'); const userIdInput = document.getElementById('user-id'); const userNameInput = document.getElementById('name'); const userEmailInput = document.getElementById('user-email'); const userPhoneInput = document.getElementById('phone'); const userCancelBtn = document.getElementById('cancel-btn'); const confirmActionModal = document.getElementById('confirm-modal'); const confirmActionBtn = document.getElementById('confirm-action-btn'); const confirmCancelBtn = document.getElementById('confirm-cancel-btn'); const confirmTitle = document.getElementById('confirm-title'); const confirmMessage = document.getElementById('confirm-message'); const confirmIcon = document.getElementById('confirm-icon'); const searchUserInput = document.getElementById('search-input'); const userFilterBtns = document.querySelectorAll('.user-filter-btn'); const userSortBtns = document.querySelectorAll('.user-sort-btn'); const adminUserListContainer = document.getElementById('admin-user-list');
        // Dashboard Stats
        const dashTotalSubjects = document.getElementById('total-subjects'); const dashTotalExams = document.getElementById('total-exams'); const dashTotalBooks = document.getElementById('total-books'); const dashTotalQuizzes = document.getElementById('total-quizzes'); const dashTotalUsers = document.getElementById('dash-total-users'); const dashPaidUsers = document.getElementById('dash-paid-users'); const dashBannedUsers = document.getElementById('dash-banned-users'); const dashTotalRevenue = document.getElementById('dash-total-revenue');
        // User Stats
        const usersTotal = document.getElementById('total-users'); const usersPaid = document.getElementById('paid-users'); const usersNotPaid = document.getElementById('not-paid-users'); const usersRevenue = document.getElementById('total-revenue');
        // Report Elements
        const reportPaidUsersEl = document.getElementById('report-paid-users'); const reportPdfViewsEl = document.getElementById('report-pdf-views'); const reportTopPdfEl = document.getElementById('report-top-pdf'); const reportBlogViewsEl = document.getElementById('report-blog-views'); const reportActiveUsersEl = document.getElementById('report-active-users');
        // Content Lists
        const subjectsListEl = document.getElementById('subjects-list'); const examsListEl = document.getElementById('exams-list'); const quizzesListContainer = document.getElementById('quiz-list-container'); const booksListEl = document.getElementById('books-list'); const pdfListTableBody = document.getElementById('pdf-list-table');
        // PDF Library Elements
        const pdfUploadBtn = document.getElementById('upload-pdf-btn'); const pdfUploadInput = document.getElementById('pdf-upload-input'); const uploadProgressContainer = document.getElementById('upload-progress-container'); const uploadProgressBar = document.getElementById('upload-progress-bar'); const pdfSearchInput = document.getElementById('pdf-search'); const deleteSelectedPdfsBtn = document.getElementById('delete-selected-pdfs-btn'); const selectAllPdfsCheckbox = document.getElementById('select-all-pdfs');
        // Quiz Elements
        const addQuizBtnHeader = document.getElementById('add-quiz-fab-header'); const quizModal = document.getElementById('quiz-modal'); const quizForm = document.getElementById('quiz-form'); const closeQuizModalBtn = document.getElementById('close-modal-btn'); const quizSubjectFilter = document.getElementById('quiz-subject-filter'); /* Add other quiz form inputs */
        // *** NEW: Content Modal Elements ***
        const contentModal = document.getElementById('content-modal');
        const contentModalTitle = document.getElementById('content-modal-title');
        const contentModalCloseBtn = document.getElementById('content-modal-close');
        const contentForm = document.getElementById('content-form');
        const contentFormFields = document.getElementById('content-form-fields');
        const contentIdInput = document.getElementById('content-id');
        const contentTypeInput = document.getElementById('content-type');
        const contentCancelBtn = document.getElementById('content-cancel-btn');


        // =============================================
        // Initialization
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            if (!app) return; // Stop if Firebase failed
            lucide.createIcons();
            initBlogLibs();
            initOtherLibs();
            setupMainEventListeners();
            setupBlogEventListeners();
            setupContentEventListeners();

            authStatus.textContent = 'Admin Access';
            mainApp.classList.remove('hidden');
            showTab(currentActiveTab || 'dashboard');
        });

        // =============================================
        // Lib Initializations
        // =============================================
        function initBlogLibs() { try{quill=new Quill('#quill-editor',{theme:'snow',modules:{toolbar:[[{'header':[1,2,3,!1]}],['bold','italic','underline','strike'],[{'list':'ordered'},{'list':'bullet'}],['link','image','video','code-block'],['clean']]}});const t=document.getElementById('post-tags');if(t)tagify=new Tagify(t);schedulePicker=flatpickr("#post-schedule-date",{enableTime:!0,dateFormat:"Y-m-d H:i"});}catch(e){console.warn("Blog Lib Init Err:",e)} }
        function initOtherLibs() { try{reportDatePicker = flatpickr("#report-date-range",{mode:"range",dateFormat:"Y-m-d"});}catch(e){console.warn("Flatpickr init Err:",e)} }

        // =============================================
        // Toast Notification
        // =============================================
        function showToast(message, isError = false) { toast.textContent=message;toast.className=`fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform ${isError?'bg-red-600':'bg-green-600'}`;toast.style.transform='translateX(100%)';toast.style.opacity='0';toast.classList.remove('hidden');void toast.offsetWidth;toast.style.transition='all 0.3s ease-out';toast.style.transform='translateX(0)';toast.style.opacity='1';setTimeout(()=>{toast.style.transform='translateX(100%)';toast.style.opacity='0';setTimeout(()=>toast.classList.add('hidden'),300);},3000); }

        // =============================================
        // Navigation & Listener Management
        // =============================================
        function stopAllListeners(){unsubscribePosts();unsubscribeComments();unsubscribeCategories();unsubscribeUsers();unsubscribeSubjects();unsubscribeExams();unsubscribeQuizzes();unsubscribeBooks();unsubscribePosts=()=>{};unsubscribeComments=()=>{};unsubscribeCategories=()=>{};unsubscribeUsers=()=>{};unsubscribeSubjects=()=>{};unsubscribeExams=()=>{};unsubscribeQuizzes=()=>{};unsubscribeBooks=()=>{};}
        function showTab(tabId){console.log(`Switching to tab: ${tabId}`);stopAllListeners();currentActiveTab=tabId;allTabs.forEach(t=>t.classList.add('hidden'));const nT=document.getElementById(tabId);if(nT){nT.classList.remove('hidden');}else{document.getElementById('dashboard').classList.remove('hidden');currentActiveTab='dashboard';}allSidebarLinks.forEach(l=>l.classList.remove('active'));dropdownToggles.forEach(b=>b.classList.remove('open'));const aL=document.querySelector(`#sidebar .sidebar-link[data-tab="${tabId}"]`);if(aL){aL.classList.add('active');const pDM=aL.closest('.dropdown-menu');if(pDM){const pB=pDM.previousElementSibling;if(pB?.classList.contains('has-dropdown')){pB.classList.add('open');}}}switch(tabId){case'dashboard':loadDashboardStats();break;case'users-students':initUsersListener(renderUserTable);break;case'users-roles':initUsersListener(renderAdminList);break;case'main-report':console.log("Init Main Report...");break;case'list-posts':initPostsListener();initCategoriesListener();break;case'post-form-view':initCategoriesListener();if(!editingPostId)showPostForm();break;case'categories':initCategoriesListener(renderCategoriesList);break;case'comments':initPostsListener();initCommentsListener();break;case'analytics':fetchAllDataForAnalytics();break;case'subjects':initSubjectsListener();break;case'exams':initExamsListener();break;case'quizzes':initQuizzesListener();initSubjectsListener(populateQuizSubjectFilter);break;case'generalBooks':initBooksListener();break;case'pdf-library':loadPdfList();break;case'settings':console.log("Settings Tab");break;}if(typeof lucide !== 'undefined') lucide.createIcons();}

        // =============================================
        // Main Event Listeners Setup
        // =============================================
        function setupMainEventListeners() {
            if(logoutBtn) logoutBtn.addEventListener('click', () => { showToast("Logout action."); /* Add real logout */ });
            allSidebarLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); if (link.classList.contains('has-dropdown')) { link.classList.toggle('open'); } else if (link.dataset.tab) { editingPostId = null; editingContent = { id: null, type: null }; showTab(link.dataset.tab); if (!mainSidebar.classList.contains('-translate-x-full')) { mainSidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); } } }); });
            if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => { mainSidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); });
            if(sidebarOverlay) sidebarOverlay.addEventListener('click', () => { mainSidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); });
            if(addUserBtn) addUserBtn.addEventListener('click', () => showUserModal());
            if(userModalCloseBtn) userModalCloseBtn.addEventListener('click', () => hideUserModal());
            if(userCancelBtn) userCancelBtn.addEventListener('click', () => hideUserModal());
            if(userForm) userForm.addEventListener('submit', handleUserFormSubmit);
            if(searchUserInput) searchUserInput.addEventListener('input', renderUserTable); // Check if exists before adding listener
            userFilterBtns.forEach(btn => btn.addEventListener('click', handleUserFilterClick));
            userSortBtns.forEach(btn => btn.addEventListener('click', handleUserSortClick));
            if(confirmCancelBtn) confirmCancelBtn.addEventListener('click', () => hideConfirmModal());
            if(userTableBody) userTableBody.addEventListener('click', (e) => { const editBtn=e.target.closest('.edit-user-btn'),delBtn=e.target.closest('.delete-user-btn'); if(editBtn)showUserModal(editBtn.dataset.id); if(delBtn)showConfirmModal('Delete User','Are you sure?',()=>deleteUser(delBtn.dataset.id),!0); });
        }

        // =============================================
        // Dashboard Logic (Corrected Query + Checks)
        // =============================================
        async function loadDashboardStats() {
            console.log("Loading dashboard stats...");
            try {
                // Define queries (ensure collections exist)
                const usersQuery = query(usersCollection, where("role", "!=", "admin"));
                // *** IMPORTANT: The paidUsersQuery requires the composite index you need to create via the console link ***
                const paidUsersQuery = query(usersCollection, where("paymentStatus", "==", "paid"), where("role", "!=", "admin"));
                const subjectsQuery = query(subjectsCollection);
                const examsQuery = query(examsCollection);
                const booksQuery = query(booksCollection);
                const quizzesQuery = query(quizzesCollection);

                // Fetch counts in parallel
                const counts = await Promise.all([
                    getCountFromServer(usersQuery).catch(e => { console.warn("Count failed (users):", e); return { data: () => ({ count: 'N/A' }) }; }), // Add catch blocks
                    getCountFromServer(paidUsersQuery).catch(e => { console.warn("Count failed (paid users - check index):", e); return { data: () => ({ count: 'N/A' }) }; }),
                    getCountFromServer(subjectsQuery).catch(e => { console.warn("Count failed (subjects):", e); return { data: () => ({ count: 'N/A' }) }; }),
                    getCountFromServer(examsQuery).catch(e => { console.warn("Count failed (exams):", e); return { data: () => ({ count: 'N/A' }) }; }),
                    getCountFromServer(booksQuery).catch(e => { console.warn("Count failed (books):", e); return { data: () => ({ count: 'N/A' }) }; }),
                    getCountFromServer(quizzesQuery).catch(e => { console.warn("Count failed (quizzes):", e); return { data: () => ({ count: 'N/A' }) }; })
                ]);

                // Update DOM elements safely
                if(dashTotalUsers) dashTotalUsers.textContent = counts[0].data().count;
                const paidCount = counts[1].data().count;
                if(dashPaidUsers) dashPaidUsers.textContent = paidCount;
                if(dashTotalSubjects) dashTotalSubjects.textContent = counts[2].data().count;
                if(dashTotalExams) dashTotalExams.textContent = counts[3].data().count;
                if(dashTotalBooks) dashTotalBooks.textContent = counts[4].data().count;
                if(dashTotalQuizzes) dashTotalQuizzes.textContent = counts[5].data().count;

                // Revenue Calculation
                const revenue = paidCount === 'N/A' ? 'N/A' : paidCount * 5; // Handle 'N/A'
                if(dashTotalRevenue) dashTotalRevenue.textContent = revenue === 'N/A' ? '$N/A' : `$${revenue}`;
                if(dashBannedUsers) dashBannedUsers.textContent = '0'; // Placeholder

             } catch (error) { // Catch errors from Promise.all itself
                 console.error("Error loading dashboard stats:", error);
                 showToast("Failed to load dashboard statistics.", true);
                 if(dashTotalUsers) dashTotalUsers.textContent = 'Err'; /* Reset others */
             }
         }


        // =============================================
        // User Management Logic (Keep robust version)
        // =============================================
         let currentUsersFilter = 'all'; let currentUsersSort = 'recent';
         function handleUserFilterClick(e) { userFilterBtns.forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentUsersFilter=e.target.dataset.filter; renderUserTable(); }
         function handleUserSortClick(e) { userSortBtns.forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentUsersSort=e.target.dataset.sort; renderUserTable(); }
         function initUsersListener(renderCallback) { unsubscribeUsers = onSnapshot(usersCollection,snap=>{allUsers=snap.docs.map(d=>({id:d.id,...d.data()}));if(renderCallback)renderCallback();updateUserStats();},e=>{console.error(e);showToast("Err users.",!0);/* UI Error */}); }
         function renderUserTable() { if(!userTableBody) return; userTableBody.innerHTML = ''; const searchTerm = searchUserInput?.value?.toLowerCase() || ''; let filteredUsers = allUsers.filter(user => user.role !== 'admin'); if (currentUsersFilter === 'paid') filteredUsers = filteredUsers.filter(u => u.paymentStatus === 'paid'); else if (currentUsersFilter === 'not_paid') filteredUsers = filteredUsers.filter(u => u.paymentStatus !== 'paid'); if (searchTerm) filteredUsers = filteredUsers.filter(u => (u.name?.toLowerCase().includes(searchTerm)) || (u.email?.toLowerCase().includes(searchTerm)) || (u.phone?.includes(searchTerm))); filteredUsers.sort((a, b) => { if (currentUsersSort === 'asc') return (a.name || '').localeCompare(b.name || ''); else { const timeA = a.createdAt?.toMillis() || 0; const timeB = b.createdAt?.toMillis() || 0; return timeB - timeA; } }); if (filteredUsers.length === 0) { userTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No users found.</td></tr>`; return; } filteredUsers.forEach(user => { const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50"; const pStatus = user.paymentStatus === 'paid'; tr.innerHTML = `<td class="p-4"><div class="font-medium">${user.name||'N/A'}</div><div class="text-sm text-gray-500">${user.email||'N/A'}</div></td><td class="p-4 text-sm">${user.phone?`252${user.phone}`:'N/A'}</td><td class="p-4 text-sm capitalize">${user.role||'student'}</td><td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded ${pStatus?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${pStatus?'Paid':'Not Paid'}</span></td><td class="p-4"><div class="flex space-x-1"><button class="edit-user-btn p-1 text-indigo-600 hover:text-indigo-800" data-id="${user.id}" title="Edit"><i data-lucide="edit-2" class="w-4 h-4 p-e-none"></i></button><button class="delete-user-btn p-1 text-red-600 hover:text-red-800" data-id="${user.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button></div></td>`; userTableBody.appendChild(tr); }); if(typeof lucide !== 'undefined') lucide.createIcons(); }
         function renderAdminList() { if(!adminUserListContainer) return; adminUserListContainer.innerHTML='';const admins=allUsers.filter(u=>u.role==='admin');if(admins.length===0){adminUserListContainer.innerHTML=`<p class="text-center text-gray-500">No admins.</p>`;return;}admins.forEach(a=>{const d=document.createElement('div');d.className="flex items-center justify-between p-3 bg-blue-50 border rounded";d.innerHTML=`<div><p class="font-semibold text-blue-800">${a.name||'Admin'}</p><p class="text-sm text-blue-600">${a.email}</p></div><span class="text-sm font-medium text-blue-700 capitalize">${a.role}</span>`;adminUserListContainer.appendChild(d);}); }
         function updateUserStats() { if(!usersTotal) return; const nonAdmin=allUsers.filter(u=>u.role!=='admin'),paid=nonAdmin.filter(u=>u.paymentStatus==='paid').length,rev=paid*5;usersTotal.textContent=nonAdmin.length;usersPaid.textContent=paid;usersNotPaid.textContent=nonAdmin.length-paid;usersRevenue.textContent=`$${rev}`; }
         async function showUserModal(userId=null) { if(!userModal) return; userForm.reset();userIdInput.value='';if(userId){userModalTitle.textContent='Edit';try{const snap=await getDoc(doc(db,"users",userId));if(snap.exists()){const d=snap.data();userIdInput.value=userId;if(userNameInput)userNameInput.value=d.name||'';if(userEmailInput)userEmailInput.value=d.email||'';if(userPhoneInput)userPhoneInput.value=d.phone||'';}else{showToast('User not found.',!0);return;}}catch(e){console.error(e);showToast('Load failed.',!0);return;}}else{userModalTitle.textContent='Add New';}userModal.style.display='flex'; }
         function hideUserModal() { if(userModal) userModal.style.display='none'; }
         async function handleUserFormSubmit(e) { e.preventDefault();const id=userIdInput.value,name=userNameInput.value.trim(),email=userEmailInput.value.trim(),phone=userPhoneInput.value.trim();if(!name||!email){showToast('Name/Email required.',!0);return;}if(phone&&!/^\d+$/.test(phone)){showToast('Phone digits only.',!0);return;}const data={name,email,phone,role:'student',paymentStatus:'not_paid'};const btn=userForm.querySelector('button[type="submit"]');btn.disabled=!0;btn.textContent='Saving...';try{if(id){await updateDoc(doc(db,"users",id),data);showToast('User updated!');}else{data.createdAt=serverTimestamp();await addDoc(usersCollection,data);showToast('User added!');}hideUserModal();}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);}finally{btn.disabled=!1;btn.textContent='Save';} }
         async function deleteUser(userId) { try{await deleteDoc(doc(db,"users",userId));showToast('User deleted!');}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);} }
         let confirmActionCallback=null; function showConfirmModal(title,msg,onConfirm,isDanger=!1) { if(!confirmActionModal) return; confirmTitle.textContent=title;confirmMessage.textContent=msg;confirmActionCallback=onConfirm;confirmActionBtn.className=`px-6 py-2 text-white rounded font-medium ${isDanger?'bg-red-600 hover:bg-red-700':'bg-indigo-600 hover:bg-indigo-700'}`;confirmIcon.className=`text-4xl mb-4 ${isDanger?'fas fa-exclamation-triangle text-red-500':'fas fa-question-circle text-indigo-500'}`;confirmActionBtn.textContent=isDanger?'Yes, delete!':'Yes';confirmActionBtn.replaceWith(confirmActionBtn.cloneNode(!0)); // Re-clone to ensure listener is fresh
            const newConfirmBtn = document.getElementById('confirm-action-btn'); // Get the newly cloned button
            if (newConfirmBtn) { newConfirmBtn.addEventListener('click', () => { if (confirmActionCallback) confirmActionCallback(); hideConfirmModal(); }); }
            confirmActionModal.style.display='flex'; }
         function hideConfirmModal() { if(confirmActionModal) confirmActionModal.style.display='none';confirmActionCallback=null; }

        // =============================================
        // === CONTENT MANAGEMENT LOGIC (REVISED) ===
        // =============================================

        // --- Listeners ---
        function initSubjectsListener() { unsubscribeSubjects = onSnapshot(query(subjectsCollection, orderBy("name")), s => { allSubjects = s.docs.map(d=>({id:d.id,...d.data()})); renderContentList(subjectsListEl, allSubjects, 'subject'); populateQuizSubjectFilter(); /* Update other selects */}, e => { console.error("Err subjects:", e); if(subjectsListEl) subjectsListEl.innerHTML = `<li class="text-red-500">Error loading.</li>`; }); }
        function initExamsListener() { unsubscribeExams = onSnapshot(query(examsCollection, orderBy("title")), s => { allExams = s.docs.map(d=>({id:d.id,...d.data()})); renderContentList(examsListEl, allExams, 'exam'); }, e => { console.error("Err exams:", e); if(examsListEl) examsListEl.innerHTML = `<li class="text-red-500">Error loading.</li>`; }); }
        function initQuizzesListener() { unsubscribeQuizzes = onSnapshot(query(quizzesCollection, orderBy("title")), s => { allQuizzes = s.docs.map(d=>({id:d.id,...d.data()})); renderQuizList(); }, e => { console.error("Err quizzes:", e); if(quizzesListContainer) quizzesListContainer.innerHTML = `<p class="text-red-500 text-center">Error loading quizzes.</p>`; }); }
        function initBooksListener() { unsubscribeBooks = onSnapshot(query(booksCollection, orderBy("title")), s => { allBooks = s.docs.map(d=>({id:d.id,...d.data()})); renderContentList(booksListEl, allBooks, 'book'); }, e => { console.error("Err books:", e); if(booksListEl) booksListEl.innerHTML = `<li class="text-red-500">Error loading.</li>`; }); }

        // --- Renderers ---
        function renderContentList(listElement, items, itemType) {
            if (!listElement) { console.warn(`List element for ${itemType} not found.`); return; }
            listElement.innerHTML = '';
            if (!items || items.length === 0) { listElement.innerHTML = `<li class="text-gray-500 italic">No ${itemType.toLowerCase()}s found.</li>`; return; }
            items.forEach(item => {
                const li = document.createElement('li');
                const displayName = item.name || item.title || `Unnamed ${itemType}`; // Use name for subject, title otherwise
                li.innerHTML = `
                    <span class="font-medium truncate pr-4">${displayName}</span>
                    <div class="content-actions flex-shrink-0">
                        <button class="edit-content-btn p-1 text-indigo-600 hover:text-indigo-800" data-id="${item.id}" data-type="${itemType.toLowerCase()}" title="Edit ${itemType}"> <i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i> </button>
                        <button class="delete-content-btn p-1 text-red-600 hover:text-red-800" data-id="${item.id}" data-type="${itemType.toLowerCase()}" title="Delete ${itemType}"> <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i> </button>
                    </div>`;
                listElement.appendChild(li);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }
        function renderQuizList() { /* ... Keep implementation ... */ if(!quizzesListContainer)return;quizzesListContainer.innerHTML='';const fV=quizSubjectFilter?quizSubjectFilter.value:'all';const fQ=allQuizzes.filter(q=>fV==='all'||q.subjectId===fV);if(fQ.length===0){quizzesListContainer.innerHTML=`<p class="text-gray-500 text-center col-span-full">No quizzes${fV!=='all'?' for this subject':''}.</p>`;return;}fQ.forEach(q=>{const d=document.createElement('div');d.className="bg-white p-4 rounded-xl shadow border flex flex-col";const s=allSubjects.find(s=>s.id===q.subjectId);d.innerHTML=`${q.coverImageUrl?`<img src="${q.coverImageUrl}" alt="${q.title}" class="h-32 w-full object-cover rounded mb-3">`:'<div class="h-32 bg-gray-200 rounded mb-3 flex items-center justify-center text-gray-400">No Image</div>'}<h3 class="font-semibold text-lg mb-1 truncate">${q.title}</h3><p class="text-sm text-gray-500 mb-3">${s?s.name:'Unknown Subject'}</p><div class="mt-auto flex justify-end space-x-2"><button class="edit-content-btn quiz-btn quiz-btn-secondary text-xs" data-id="${q.id}" data-type="quiz">Edit</button><button class="delete-content-btn quiz-btn quiz-btn-danger text-xs" data-id="${q.id}" data-type="quiz">Delete</button></div>`;quizzesListContainer.appendChild(d);}); }
        function populateQuizSubjectFilter() { if(!quizSubjectFilter)return;while(quizSubjectFilter.options.length>1)quizSubjectFilter.remove(1);allSubjects.forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.name;quizSubjectFilter.appendChild(o);}); }

        // --- PDF Library (Keep robust implementation) ---
        async function loadPdfList(){if(!pdfListTableBody)return;pdfListTableBody.innerHTML='<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr>';try{const listRef=ref(storage,'/');const res=await listAll(listRef);allPdfs=await Promise.all(res.items.map(async i=>{const m=await getMetadata(i);return{name:i.name,fullPath:i.fullPath,size:m.size,timeCreated:m.timeCreated};}));renderPdfTable();}catch(e){console.error("Err list PDFs:",e);pdfListTableBody.innerHTML='<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading files.</td></tr>';showToast("Err loading PDFs.",!0);}}
        function renderPdfTable(){if(!pdfListTableBody)return;pdfListTableBody.innerHTML='';const s=pdfSearchInput?.value?.toLowerCase()||'';const f=allPdfs.filter(p=>p.name.toLowerCase().includes(s));f.sort((a,b)=>b.size-a.size);if(f.length===0){pdfListTableBody.innerHTML='<tr><td colspan="5" class="p-4 text-center text-gray-500">No files.</td></tr>';return;}f.forEach(p=>{const tr=document.createElement('tr');tr.className="border-b hover:bg-gray-50";tr.innerHTML=`<td class="p-3"><input type="checkbox" class="pdf-checkbox" data-path="${p.fullPath}"></td><td class="p-3 font-medium">${p.name}</td><td class="p-3 text-sm">${formatBytes(p.size)}</td><td class="p-3 text-sm">${new Date(p.timeCreated).toLocaleDateString()}</td><td class="p-3"><div class="flex space-x-1"><button class="view-pdf-btn p-1 text-blue-600" data-path="${p.fullPath}" title="View"><i data-lucide="external-link" class="w-4 h-4 p-e-none"></i></button><button class="delete-pdf-btn p-1 text-red-600" data-path="${p.fullPath}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button></div></td>`;pdfListTableBody.appendChild(tr);});if(typeof lucide!=='undefined')lucide.createIcons();updateDeleteSelectedButtonState();if(selectAllPdfsCheckbox)selectAllPdfsCheckbox.checked=!1;}
        function formatBytes(b,d=2){if(b===0)return'0 Bytes';const k=1024,dm=d<0?0:d,s=['Bytes','KB','MB','GB','TB'],i=Math.floor(Math.log(b)/Math.log(k));return parseFloat((b/Math.pow(k,i)).toFixed(dm))+' '+s[i];}
        async function handlePdfUpload(files){if(!files||files.length===0)return;if(uploadProgressContainer)uploadProgressContainer.classList.remove('hidden');if(uploadProgressBar)uploadProgressBar.style.width='0%';let completed=0;for(const f of files){const fileRef=ref(storage,f.name);const uTask=uploadBytesResumable(fileRef,f);uTask.on('state_changed',s=>{const p=(s.bytesTransferred/s.totalBytes)*100;if(uploadProgressBar)uploadProgressBar.style.width=p+'%';},e=>{console.error(e);showToast(`Err upload ${f.name}`,!0);completed++;if(completed===files.length&&uploadProgressContainer)uploadProgressContainer.classList.add('hidden');},async()=>{try{await getDownloadURL(uTask.snapshot.ref);showToast(`${f.name} uploaded!`);}catch(e){showToast(`Error URL ${f.name}`,!0);}finally{completed++;if(completed===files.length){loadPdfList();if(uploadProgressContainer)uploadProgressContainer.classList.add('hidden');}}});}if(pdfUploadInput)pdfUploadInput.value='';}
        async function deletePdfFile(path){const r=ref(storage,path);try{await deleteObject(r);showToast('File deleted.');loadPdfList();}catch(e){console.error(e);showToast(`Err delete file: ${e.message}`,!0);}}
        function updateDeleteSelectedButtonState(){if(!pdfListTableBody||!deleteSelectedPdfsBtn)return;const s=pdfListTableBody.querySelectorAll('.pdf-checkbox:checked');deleteSelectedPdfsBtn.classList.toggle('hidden',s.length===0);}
        async function deleteSelectedPdfs(){if(!pdfListTableBody||!deleteSelectedPdfsBtn)return;const sel=pdfListTableBody.querySelectorAll('.pdf-checkbox:checked');if(sel.length===0)return;showConfirmModal(`Delete ${sel.length} Files`,'Sure?',async()=>{deleteSelectedPdfsBtn.disabled=!0;deleteSelectedPdfsBtn.innerHTML='<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Deleting...';if(typeof lucide!=='undefined')lucide.createIcons();let succ=0;for(const cb of sel){try{await deleteObject(ref(storage,cb.dataset.path));succ++;}catch(e){console.error(`Failed delete ${cb.dataset.path}:`,e);showToast(`Err delete ${cb.dataset.path.split('/').pop()}`,!0);}}showToast(`${succ}/${sel.length} deleted.`);loadPdfList();deleteSelectedPdfsBtn.disabled=!1;deleteSelectedPdfsBtn.innerHTML='<i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected';if(typeof lucide!=='undefined')lucide.createIcons();},!0);}

        // --- Content Add/Edit Modal Logic (NEW) ---
        function showContentModal(type, id = null, currentData = null) {
            if (!contentModal || !contentFormFields) return;
            contentForm.reset();
            contentIdInput.value = id || '';
            contentTypeInput.value = type;
            contentFormFields.innerHTML = ''; // Clear previous fields

            let fieldsHtml = '';
            switch (type) {
                case 'subject':
                    contentModalTitle.textContent = id ? 'Edit Subject' : 'Add Subject';
                    fieldsHtml = `
                        <div>
                            <label for="content-name" class="block text-sm font-medium text-gray-700">Subject Name*</label>
                            <input type="text" id="content-name" required class="mt-1 content-form-input" value="${currentData?.name || ''}">
                        </div>
                        `;
                    break;
                case 'exam':
                    contentModalTitle.textContent = id ? 'Edit Exam' : 'Add Exam';
                    fieldsHtml = `
                        <div>
                            <label for="content-title" class="block text-sm font-medium text-gray-700">Exam Title*</label>
                            <input type="text" id="content-title" required class="mt-1 content-form-input" value="${currentData?.title || ''}">
                        </div>
                        <div>
                            <label for="content-subjectId" class="block text-sm font-medium text-gray-700">Subject*</label>
                            <select id="content-subjectId" required class="mt-1 content-form-input">
                                <option value="">-- Select Subject --</option>
                                ${allSubjects.map(s => `<option value="${s.id}" ${currentData?.subjectId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                            </select>
                        </div>
                        `;
                    break;
                case 'book':
                     contentModalTitle.textContent = id ? 'Edit Book' : 'Add Book';
                     fieldsHtml = `
                        <div>
                            <label for="content-title" class="block text-sm font-medium text-gray-700">Book Title*</label>
                            <input type="text" id="content-title" required class="mt-1 content-form-input" value="${currentData?.title || ''}">
                        </div>
                        <div>
                            <label for="content-author" class="block text-sm font-medium text-gray-700">Author</label>
                            <input type="text" id="content-author" class="mt-1 content-form-input" value="${currentData?.author || ''}">
                        </div>
                        `;
                    break;
                 // Add case for quiz if using this modal, though quiz has its own complex modal
                default:
                    console.error("Unknown content type for modal:", type);
                    return;
            }

            contentFormFields.innerHTML = fieldsHtml;
            contentModal.style.display = 'flex';
        }

        function hideContentModal() {
            if (contentModal) contentModal.style.display = 'none';
            editingContent = { id: null, type: null }; // Reset editing state
        }

        async function handleContentFormSubmit(e) {
            e.preventDefault();
            const id = contentIdInput.value;
            const type = contentTypeInput.value;
            const btn = contentForm.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Saving...';

            let data = {};
            // Gather data based on type
            try {
                switch (type) {
                    case 'subject':
                        const name = document.getElementById('content-name')?.value?.trim();
                        if (!name) throw new Error("Name is required.");
                        data = { name };
                        break;
                    case 'exam':
                        const examTitle = document.getElementById('content-title')?.value?.trim();
                        const subjectId = document.getElementById('content-subjectId')?.value;
                        if (!examTitle || !subjectId) throw new Error("Title and Subject are required.");
                        data = { title: examTitle, subjectId };
                        // Get other exam fields
                        break;
                    case 'book':
                         const bookTitle = document.getElementById('content-title')?.value?.trim();
                         const author = document.getElementById('content-author')?.value?.trim();
                         if (!bookTitle) throw new Error("Title is required.");
                         data = { title: bookTitle, author };
                         // Get other book fields
                         break;
                    default: throw new Error(`Invalid content type: ${type}`);
                }

                if (id) { await updateContentItem(type, id, data); }
                else { await addContentItem(type, data); }
                hideContentModal();

            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                showToast(error.message || `Error saving ${type}.`, true);
            } finally {
                btn.disabled = false; btn.textContent = 'Save';
            }
        }

        // --- Generic Content CRUD ---
        async function addContentItem(type, data) { let ref; switch(type){case 'subject':ref=subjectsCollection;break;case 'exam':ref=examsCollection;break;case 'book':ref=booksCollection;break;default:showToast(`Invalid type:${type}`,!0);return;} try{await addDoc(ref,{...data,createdAt:serverTimestamp()});showToast(`${capitalize(type)} added!`);}catch(e){console.error(e);showToast(`Error add ${type}.`,!0);} }
        async function updateContentItem(type, id, data) { let ref; switch(type){case 'subject':ref=doc(db,"subjects",id);break;case 'exam':ref=doc(db,"exams",id);break;case 'book':ref=doc(db,"generalBooks",id);break;default:showToast(`Invalid type:${type}`,!0);return;} try{await updateDoc(ref,{...data,updatedAt:serverTimestamp()});showToast(`${capitalize(type)} updated!`);}catch(e){console.error(e);showToast(`Error update ${type}.`,!0);} }
        async function deleteContentItem(type, id) { let ref; switch(type){case 'subject':ref=doc(db,"subjects",id);break;case 'exam':ref=doc(db,"exams",id);break;case 'book':ref=doc(db,"generalBooks",id);break;case 'quiz':ref=doc(db,"quizzes",id);break;default:showToast(`Invalid type:${type}`,!0);return;} try{await deleteDoc(ref);showToast(`${capitalize(type)} deleted!`);/* Add cascade logic */ }catch(e){console.error(e);showToast(`Error delete ${type}.`,!0);} }
        function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}

        // --- Setup Content Event Listeners ---
        function setupContentEventListeners() {
            // PDF Library (Keep implementation)
            if(pdfUploadBtn)pdfUploadBtn.addEventListener('click',()=>pdfUploadInput.click());if(pdfUploadInput)pdfUploadInput.addEventListener('change',(e)=>handlePdfUpload(e.target.files));if(pdfSearchInput)pdfSearchInput.addEventListener('input',renderPdfTable);if(selectAllPdfsCheckbox)selectAllPdfsCheckbox.addEventListener('change',(e)=>{pdfListTableBody.querySelectorAll('.pdf-checkbox').forEach(cb=>cb.checked=e.target.checked);updateDeleteSelectedButtonState();});if(pdfListTableBody)pdfListTableBody.addEventListener('change',(e)=>{if(e.target.classList.contains('pdf-checkbox'))updateDeleteSelectedButtonState();});if(deleteSelectedPdfsBtn)deleteSelectedPdfsBtn.addEventListener('click',deleteSelectedPdfs);if(pdfListTableBody)pdfListTableBody.addEventListener('click',async(e)=>{const delBtn=e.target.closest('.delete-pdf-btn'),viewBtn=e.target.closest('.view-pdf-btn');if(delBtn)showConfirmModal('Delete File',`Delete ${delBtn.dataset.path.split('/').pop()}?`,()=>deletePdfFile(delBtn.dataset.path),!0);if(viewBtn)try{const url=await getDownloadURL(ref(storage,viewBtn.dataset.path));window.open(url,'_blank');}catch(err){console.error(err);showToast("Could not get URL.",!0);}});

            // Quizzes (Keep implementation + Add/Edit/Filter)
            if(addQuizBtnHeader) addQuizBtnHeader.addEventListener('click', () => { console.log("Show Quiz Modal (Add)"); showQuizModal(); }); // Use specific quiz modal
            if(closeQuizModalBtn) closeQuizModalBtn.addEventListener('click', () => hideQuizModal());
            if(quizSubjectFilter) quizSubjectFilter.addEventListener('change', renderQuizList);
            // Add quizForm submit listener -> handleQuizFormSubmit() - Needs implementation
            // Add listeners for quiz add question, import/export etc. - Needs implementation

            // Generic Content Add/Edit/Delete Delegation
            document.body.addEventListener('click', async (e) => { // Use async for potential data fetching on edit
                const addBtn = e.target.closest('.add-content-btn');
                const editBtn = e.target.closest('.edit-content-btn');
                const deleteBtn = e.target.closest('.delete-content-btn');

                if (addBtn) {
                    const type = addBtn.dataset.type;
                    editingContent = { id: null, type: type }; // Reset editing state
                    console.log(`Show Add Modal for: ${type}`);
                    showContentModal(type); // Show the generic modal for adding
                }
                if (editBtn) {
                    const type = editBtn.dataset.type;
                    const id = editBtn.dataset.id;
                    editingContent = { id, type };
                     if(type === 'quiz') {
                         console.log("Show Quiz Modal for Edit:", id);
                         showQuizModal(id); // Show specific quiz modal for editing
                     } else {
                         console.log(`Show Edit Modal for ${type}:`, id);
                         // Fetch current data before showing modal
                         let currentData = null;
                         try {
                             let dataRef;
                             switch(type) {
                                case 'subject': dataRef = doc(db, "subjects", id); break;
                                case 'exam': dataRef = doc(db, "exams", id); break;
                                case 'book': dataRef = doc(db, "generalBooks", id); break;
                                default: throw new Error("Unknown type");
                             }
                             const docSnap = await getDoc(dataRef);
                             if (docSnap.exists()) {
                                 currentData = docSnap.data();
                                 showContentModal(type, id, currentData); // Show generic modal prefilled
                             } else {
                                 showToast(`${capitalize(type)} not found.`, true);
                             }
                         } catch (error) {
                             console.error(`Error fetching ${type} for edit:`, error);
                             showToast(`Could not load ${type} data.`, true);
                         }
                     }
                }
                if (deleteBtn) {
                    const type = deleteBtn.dataset.type;
                    const id = deleteBtn.dataset.id;
                    showConfirmModal(`Delete ${capitalize(type)}`,`Sure?`,() => deleteContentItem(type, id),true);
                }
            });

            // Content Modal Listeners
            if(contentModalCloseBtn) contentModalCloseBtn.addEventListener('click', hideContentModal);
            if(contentCancelBtn) contentCancelBtn.addEventListener('click', hideContentModal);
            if(contentForm) contentForm.addEventListener('submit', handleContentFormSubmit);
        }

        // =============================================
        // === QUIZ SPECIFIC LOGIC (Placeholders) ===
        // =============================================
        function showQuizModal(quizId = null) {
            console.log(quizId ? `Showing Quiz Modal (Edit: ${quizId})` : "Showing Quiz Modal (Add)");
            // 1. Reset quiz form
            if (quizForm) quizForm.reset();
            document.getElementById('quiz-id-input').value = quizId || '';
            document.getElementById('questions-container').innerHTML = '<p class="text-gray-500 text-center py-4 text-sm" id="question-placeholder">Add questions below.</p>'; // Reset questions
            // Reset cover image preview
            const coverPreview = document.getElementById('cover-image-preview');
            const coverFilename = document.getElementById('cover-image-filename');
            const coverUrlInput = document.getElementById('cover-image-url-input');
            if(coverPreview) coverPreview.innerHTML = '<span class="text-blue-400 text-sm">Image Preview</span>';
            if(coverFilename) coverFilename.textContent = '';
            if(coverUrlInput) coverUrlInput.value = '';

            // 2. Populate subject dropdown (assuming allSubjects is loaded)
            const subjectSelect = document.getElementById('quiz-subject-select');
            if(subjectSelect) {
                 while(subjectSelect.options.length > 1) subjectSelect.remove(1); // Clear old subjects
                 allSubjects.forEach(s => {
                     const opt = document.createElement('option');
                     opt.value = s.id; opt.textContent = s.name;
                     subjectSelect.appendChild(opt);
                 });
            }

            // 3. If editing (quizId is provided), fetch quiz data and populate form
            if (quizId) {
                document.getElementById('quiz-modal-title').textContent = "Edit Quiz";
                 // Fetch quiz data from allQuizzes or Firestore
                 const quizData = allQuizzes.find(q => q.id === quizId); // Example using cache
                 if (quizData) {
                     document.getElementById('quiz-title').value = quizData.title || '';
                     if(subjectSelect) subjectSelect.value = quizData.subjectId || '';
                     // Populate cover image if exists
                     if(quizData.coverImageUrl && coverPreview && coverFilename && coverUrlInput) {
                         coverPreview.innerHTML = `<img src="${quizData.coverImageUrl}" class="max-h-full max-w-full object-contain">`;
                         coverFilename.textContent = 'Current image loaded.'; // Or derive filename
                         coverUrlInput.value = quizData.coverImageUrl;
                     }
                     // Populate questions - This requires parsing quizData.questions and dynamically creating HTML
                     renderQuizQuestions(quizData.questions || []); // Implement renderQuizQuestions
                     document.getElementById('delete-quiz-btn').classList.remove('hidden'); // Show delete button
                 } else {
                     showToast("Quiz data not found for editing.", true);
                     return; // Don't show modal if data isn't found
                 }
            } else {
                document.getElementById('quiz-modal-title').textContent = "Add New Quiz";
                document.getElementById('delete-quiz-btn').classList.add('hidden'); // Hide delete button
            }

            // 4. Show modal
            if(quizModal) quizModal.style.display = 'flex';
        }

        function hideQuizModal() {
            if(quizModal) quizModal.style.display = 'none';
        }

        function renderQuizQuestions(questions) {
             const container = document.getElementById('questions-container');
             if (!container) return;
             container.innerHTML = ''; // Clear placeholder/old questions
             if (!questions || questions.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm" id="question-placeholder">Add first question below.</p>';
                 return;
             }
             // Loop through questions array and create HTML for each question editor
             questions.forEach((q, index) => {
                 // Create complex HTML structure for question text, options, correct answer selection, delete button
                 const questionDiv = document.createElement('div');
                 questionDiv.className = 'border p-4 rounded bg-gray-50';
                 questionDiv.innerHTML = `<div>Question ${index + 1}: ${q.text} (Placeholder)</div>`; // Replace with actual editor UI
                 container.appendChild(questionDiv);
             });
        }
        // Add handleQuizFormSubmit, addQuestionToForm, deleteQuestionFromForm etc.


        // =============================================
        // BLOG LOGIC (Keep all functions as is)
        // =============================================
        // ... (All blog functions: initBlogLibs, mockUploadFile, initPostsListener, initCommentsListener, initCategoriesListener, fetchAllDataForAnalytics, renderPostsTable, renderCommentsList, renderCategoriesList, updateCategoryDropdowns, renderAnalytics, showPostForm, handleBlogPostFormSubmit, handleImageUpload, addAttachmentToList, handleAttachmentUpload, showDeleteModal, confirmDelete, updateCommentStatus, deleteComment, showReplyModal, handleReplySubmit, showShareModal, setupBlogEventListeners) ...
        // Ensure function names don't clash and variables are scoped correctly.
        // The previous provided combined code should be fine here.

    </script>

</body>
</html>
