<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdayCaawiye - Complete CMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #d1d5db; /* gray-400 */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link:hover {
            background-color: #374151; /* gray-700 */
            color: white;
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        .sidebar-link .icon {
            width: 1.125rem; /* w-4.5 */
            height: 1.125rem; /* h-4.5 */
            margin-right: 0.75rem; /* mr-3 */
            flex-shrink: 0;
        }
        .dropdown-menu {
            display: none;
            padding-left: 1.5rem; /* pl-6 */
        }
        .sidebar-link.has-dropdown.open + .dropdown-menu {
            display: block;
        }
        .sidebar-link.has-dropdown.open .dropdown-icon {
            transform: rotate(180deg);
        }
        .dropdown-menu .sidebar-link {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        .dropdown-menu .sidebar-link:hover {
            background-color: #374151; /* gray-700 */
        }
        .dropdown-menu .sidebar-link.active {
            color: #a5b4fc; /* indigo-300 */
            background-color: transparent;
            font-weight: 500;
        }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Quiz Modal Styles */
        .quiz-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 2rem 1rem; }
        .quiz-modal-container { background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 56rem; margin: auto; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        #quiz-form { overflow-y: auto; }
        .quiz-form-input, .quiz-form-select { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.65rem 1rem; font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .quiz-form-input:focus, .quiz-form-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .quiz-btn { padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .quiz-btn-primary { background-color: #4f46e5; color: white; }
        .quiz-btn-primary:hover { background-color: #4338ca; }
        .quiz-btn-secondary { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .quiz-btn-secondary:hover { background-color: #e5e7eb; }
        .quiz-btn-danger { background-color: #dc2626; color: white; }
        .quiz-btn-danger:hover { background-color: #b91c1c; }
        .quiz-fab { position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem; border-radius: 9999px; z-index: 40; }
        .quiz-fab .fa-solid { font-size: 1.5rem; }
         .radio-custom { appearance: none; width: 1.25rem; height: 1.25rem; border: 2px solid #94a3b8; border-radius: 50%; transition: all 0.2s; cursor: pointer; margin-right: 0.5rem; flex-shrink: 0; }
        .radio-custom:checked { border-color: #1d4ed8; background-color: #1d4ed8; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e"); }

        /* User/Confirm Modal Styles */
        .user-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 60; display: none; /* Hidden by default */ }

        /* Blog-specific Styles */
        .app-view { display: none; }
        .app-view.active { display: block; }
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 1rem; display: none; /* Hidden by default */ }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        #quill-editor { height: 400px; }
        .tagify { --tags-border-color: #d1d5db; border-radius: 0.5rem; }
        .tagify:hover { --tags-border-color: #4f46e5; }
        .tagify.tagify--focus { --tags-border-color: #4f46e5; }

        /* Toast */
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s ease-in-out; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #toast.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .toast-success { background-color: #10b981; } /* emerald-500 */
        .toast-error { background-color: #ef4444; } /* red-500 */

    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="login-page" class="w-full h-full flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg m-4">
            <div><h2 id="auth-title" class="text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2></div>
            <form id="auth-form" class="space-y-6">
                <div>
                    <label for="email" class="sr-only">Email address</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address" value="dausfilms@gmail.com">
                </div>
                <div>
                    <label for="password" class="sr-only">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password" value="siciid23">
                </div>
                <div><button id="auth-submit-btn" type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign in</button></div>
            </form>
            <p class="text-center text-sm text-gray-600"><a href="#" id="auth-toggle-link" class="font-medium text-indigo-600 hover:text-indigo-500">Don't have an account? Sign up</a></p>
        </div>
    </div>

    <div id="main-app" class="flex w-full h-full hidden">

        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col fixed h-full z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-5 text-2xl font-bold border-b border-gray-700 flex items-center">
                <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.appspot.com/o/logo.png?alt=media&token=5b34de54-86a0-47e1-8848-033190897645" alt="Logo" class="h-8 mr-2">
                <span>ArdayCaawiye</span>
            </div>

            <nav class="flex-1 p-3 space-y-1.5 overflow-y-auto">
                <a href="#" class="sidebar-link active" data-tab="dashboard">
                    <i data-lucide="home" class="icon"></i> Dashboard
                </a>

                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="folder-kanban" class="icon"></i>
                        <span class="flex-1 text-left">Manage Content</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="subjects"><i data-lucide="book-copy" class="icon"></i> Subjects</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="exams"><i data-lucide="file-check-2" class="icon"></i> Exams</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="quizzes"><i data-lucide="puzzle" class="icon"></i> Quizzes</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="generalBooks"><i data-lucide="book-open" class="icon"></i> General Books</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="pdf-library"><i data-lucide="library" class="icon"></i> PDF Library</a></li>
                    </ul>
                </div>

                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="newspaper" class="icon"></i>
                        <span class="flex-1 text-left">Blog Management</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="list-posts"><i data-lucide="layout-list" class="icon"></i> All Posts</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="post-form-view" data-action="add"><i data-lucide="plus-square" class="icon"></i> Add New Post</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="categories"><i data-lucide="tag" class="icon"></i> Categories</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="comments"><i data-lucide="messages-square" class="icon"></i> Comments</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="analytics"><i data-lucide="bar-chart-3" class="icon"></i> Analytics</a></li>
                    </ul>
                </div>

                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="users" class="icon"></i>
                        <span class="flex-1 text-left">User Management</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="users-students"><i data-lucide="user" class="icon"></i> Students / Members</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="users-roles"><i data-lucide="shield-check" class="icon"></i> Roles & Permissions</a></li>
                    </ul>
                </div>

                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="bar-chart-3" class="icon"></i>
                        <span class="flex-1 text-left">Reports & Analytics</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="main-report"><i data-lucide="activity" class="icon"></i> Main Report</a></li>
                    </ul>
                </div>

                <a href="#" class="sidebar-link" data-tab="settings">
                    <i data-lucide="settings" class="icon"></i> Settings
                </a>

            </nav>

            <div class="p-4 border-t border-gray-700">
                <div id="auth-status" class="text-xs text-gray-400 truncate mb-2">Not Authenticated</div>
                <button id="logout-btn" class="w-full flex items-center justify-center p-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors text-white font-medium text-sm">
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>

        <div class="md:hidden flex justify-between items-center bg-white p-4 border-b fixed top-0 left-0 right-0 z-10">
            <span class="text-xl font-bold text-gray-800">ArdayCaawiye CMS</span>
            <button id="mobile-menu-btn" class="text-gray-800">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <main class="flex-1 ml-0 md:ml-64 pt-20 md:pt-4 p-4 md:p-8 overflow-y-auto bg-gray-50">

            <div id="dashboard" class="tab-content fade-in">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-indigo-100 p-4 rounded-full mr-4"><i data-lucide="book-copy" class="w-8 h-8 text-indigo-600"></i></div><div><p class="text-gray-500">Total Subjects</p><p id="total-subjects" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-green-100 p-4 rounded-full mr-4"><i data-lucide="file-check-2" class="w-8 h-8 text-green-600"></i></div><div><p class="text-gray-500">Total Exams</p><p id="total-exams" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-amber-100 p-4 rounded-full mr-4"><i data-lucide="book-open" class="w-8 h-8 text-amber-600"></i></div><div><p class="text-gray-500">Total Books</p><p id="total-books" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-sky-100 p-4 rounded-full mr-4"><i data-lucide="puzzle" class="w-8 h-8 text-sky-600"></i></div><div><p class="text-gray-500">Total Quizzes</p><p id="total-quizzes" class="text-3xl font-bold">0</p></div></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-blue-100 p-4 rounded-full mr-4"><i data-lucide="users" class="w-8 h-8 text-blue-600"></i></div><div><p class="text-gray-500">Total Users</p><p id="dash-total-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-emerald-100 p-4 rounded-full mr-4"><i data-lucide="user-check" class="w-8 h-8 text-emerald-600"></i></div><div><p class="text-gray-500">Paid Users</p><p id="dash-paid-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-rose-100 p-4 rounded-full mr-4"><i data-lucide="user-x" class="w-8 h-8 text-rose-600"></i></div><div><p class="text-gray-500">Banned Users</p><p id="dash-banned-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-purple-100 p-4 rounded-full mr-4"><i data-lucide="wallet" class="w-8 h-8 text-purple-600"></i></div><div><p class="text-gray-500">Total Revenue</p><p id="dash-total-revenue" class="text-3xl font-bold">$0</p></div></div>
                </div>
            </div>

            <div id="subjects" class="tab-content fade-in hidden">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Subjects</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    </div>
            </div>

            <div id="exams" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Exams</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    </div>
            </div>

            <div id="quizzes" class="tab-content fade-in hidden">
                 <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                    <div>
                        <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Quiz Manager 💡</h1>
                        <p class="text-gray-500 mt-1">Create, edit, and organize your educational content.</p>
                    </div>
                </header>

                <div class="bg-white rounded-xl shadow-md p-4 mb-8 border border-gray-100">
                    <label for="subject-filter" class="block text-sm font-semibold text-gray-700 mb-2">Filter Quizzes by Subject</label>
                    <select id="subject-filter" class="quiz-form-select text-gray-700">
                        <option value="all">All Subjects</option>
                        </select>
                </div>

                <div id="quiz-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse transition-all"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden sm:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden lg:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden xl:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                </div>

                <div id="pagination-container" class="mt-10 flex justify-center items-center gap-2"></div>

                <button id="add-quiz-fab" class="quiz-btn quiz-btn-primary quiz-fab shadow-xl" title="Add New Quiz">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>
            </div>

            <div id="generalBooks" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage General Books</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                     </div>
            </div>

            <div id="pdf-library" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">File Library</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold">All Uploaded Files (PDF, ZIP, Images)</h2>
                        <div>
                            <input type="file" id="pdf-upload-input" multiple accept=".pdf,.zip,.png,.jpg,.jpeg,.webp" class="hidden">
                            <button id="upload-pdf-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center w-full md:w-auto"><i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload Files</button>
                        </div>
                    </div>
                    <div id="upload-progress-container" class="hidden my-4"><div class="text-sm font-medium text-gray-700 mb-1">Uploading...</div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div></div>
                    <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <input type="text" id="pdf-search" placeholder="Search files by name..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg">
                        <button id="delete-selected-pdfs-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center hidden w-full md:w-auto"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected (0)</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 w-8"><input type="checkbox" id="select-all-pdfs"></th>
                                    <th class="p-3 font-semibold text-sm">File Name</th>
                                    <th class="p-3 font-semibold text-sm">Size</th>
                                    <th class="p-3 font-semibold text-sm">Upload Date</th>
                                    <th class="p-3 font-semibold text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pdf-list-table">
                                 <tr><td colspan="5" class="p-6 text-center text-gray-500">Loading files from storage...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="list-posts" class="tab-content fade-in hidden app-view"> <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">All Posts</h1>
                    <button id="add-new-post-btn-main" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center hover:bg-indigo-700 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Post
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="search-posts" placeholder="Search posts..." class="md:col-span-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <select id="filter-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Categories</option>
                            </select>
                        <select id="filter-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Statuses</option>
                            <option value="Published">Published</option>
                            <option value="Draft">Draft</option>
                            <option value="Scheduled">Scheduled</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="p-4 w-12 text-left"><input type="checkbox" id="select-all-posts"></th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Title</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Author</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Published</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="posts-table-body" class="divide-y divide-gray-200">
                                <tr><td colspan="7" class="p-8 text-center text-gray-500">Loading posts...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="post-form-view" class="tab-content fade-in hidden app-view"> <h1 id="form-title" class="text-3xl font-bold text-gray-800 mb-6">Add New Post</h1>
                <form id="blog-post-form">
                    <input type="hidden" id="post-id">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                             <div class="bg-white p-6 rounded-lg shadow-sm">
                                <label for="post-title" class="block text-lg font-semibold text-gray-700 mb-2">Title</label>
                                <input type="text" id="post-title" placeholder="Your Post Title" class="w-full text-2xl font-bold px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                                <div class="p-6 border-b"><label class="block text-lg font-semibold text-gray-700">Content</label></div>
                                <div id="quill-editor"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <label class="block text-lg font-semibold text-gray-700 mb-2">Attachments</label>
                                <div id="attachment-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50">
                                    <i data-lucide="paperclip" class="w-10 h-10 mx-auto text-gray-400"></i>
                                    <p class="mt-2 text-gray-500">Drop files (PDF, ZIP, etc.) here or click to upload</p>
                                    <input type="file" class="hidden" id="post-attachments" multiple>
                                </div>
                                <div id="attachment-list" class="mt-4 space-y-2"></div>
                            </div>
                            <details class="bg-white rounded-lg shadow-sm">
                                <summary class="p-6 cursor-pointer text-lg font-semibold text-gray-700 flex justify-between items-center">SEO Metadata (Optional)<i data-lucide="chevron-down" class="w-5 h-5 transform transition-transform"></i></summary>
                                <div class="p-6 border-t space-y-4">
                                    <div><label for="seo-title" class="block text-sm font-medium text-gray-700">Meta Title</label><input type="text" id="seo-title" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                                    <div><label for="seo-description" class="block text-sm font-medium text-gray-700">Meta Description</label><textarea id="seo-description" rows="3" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea></div>
                                    <div><label for="seo-keywords" class="block text-sm font-medium text-gray-700">Keywords (comma-separated)</label><input type="text" id="seo-keywords" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                                </div>
                            </details>
                        </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Publish</h2>
                                <div class="space-y-4">
                                    <div><label for="post-status" class="block text-sm font-medium text-gray-700">Status</label><select id="post-status" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="Draft">Draft</option><option value="Published">Published</option><option value="Scheduled">Scheduled</option></select></div>
                                    <div id="schedule-date-wrapper" class="hidden"><label for="post-schedule-date" class="block text-sm font-medium text-gray-700">Schedule Date</label><input type="text" id="post-schedule-date" placeholder="Select date and time" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                                </div>
                                <div class="flex justify-between items-center mt-6 pt-4 border-t"><button type="button" id="save-draft-btn" class="text-gray-600 font-medium hover:text-indigo-600">Save Draft</button><button type="submit" id="publish-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Publish</button></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4">Category</h2>
                                <select id="post-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="Uncategorized">Uncategorized</option></select>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4">Tags</h2>
                                <input id="post-tags" placeholder="Add tags...">
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4">Feature Image</h2>
                                <div id="image-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50"><i data-lucide="image" class="w-10 h-10 mx-auto text-gray-400"></i><p class="mt-2 text-gray-500">Drop image here or click to upload</p><input type="file" class="hidden" id="post-image" accept="image/*"></div>
                                <div id="image-preview-wrapper" class="mt-4 hidden"><img id="image-preview" src="#" alt="Image Preview" class="w-full h-auto rounded-lg"><button type="button" id="remove-image-btn" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove Image</button></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

             <div id="categories" class="tab-content fade-in hidden app-view"> <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Categories</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <form id="add-category-form" class="bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-lg font-semibold text-gray-700 mb-4">Add New Category</h2>
                            <div><label for="new-category-name" class="block text-sm font-medium text-gray-700">Category Name</label><input type="text" id="new-category-name" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div>
                            <button type="submit" id="add-category-btn" class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Add Category</button>
                        </form>
                    </div>
                    <div class="md:col-span-2">
                        <div class="bg-white rounded-lg shadow-sm">
                            <h2 class="text-lg font-semibold text-gray-700 p-6 border-b">Existing Categories</h2>
                            <ul id="categories-list" class="divide-y divide-gray-200"><li class="p-6 text-center text-gray-500">Loading categories...</li></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="comments" class="tab-content fade-in hidden app-view"> <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Comments</h1>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="search-comments" placeholder="Search comments or author..." class="md:col-span-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <select id="filter-comment-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Statuses</option><option value="Pending">Pending</option><option value="Approved">Approved</option><option value="Spam">Spam</option>
                        </select>
                    </div>
                </div>
                <div id="comments-list" class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm text-center text-gray-500">Loading comments...</div>
                </div>
            </div>

            <div id="analytics" class="tab-content fade-in hidden app-view"> <h1 class="text-3xl font-bold text-gray-800 mb-6">Blog Analytics</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Posts</p><i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i></div><p id="stats-total-posts" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Views</p><i data-lucide="eye" class="w-5 h-5 text-green-500"></i></div><p id="stats-total-views" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Pending Comments</p><i data-lucide="messages-square" class="w-5 h-5 text-yellow-500"></i></div><p id="stats-total-comments" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Published / Drafts</p><i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i></div><p id="stats-published-drafts" class="text-3xl font-bold text-gray-800 mt-2">0 / 0</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-xl font-semibold text-gray-800 mb-4">Popular Posts (by Views)</h2><ul id="popular-posts-list" class="divide-y divide-gray-200"><li class="py-3 text-center text-gray-500">Loading data...</li></ul></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-xl font-semibold text-gray-800 mb-4">Views Over Time (Placeholder)</h2><div class="h-64 bg-gray-50 rounded-lg flex items-center justify-center p-4"><p class="text-gray-400 m-auto">Analytics chart would be loaded here.</p></div></div>
                </div>
            </div>

            <div id="users-students" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">User Management</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Total Users</p><p id="total-users" class="text-2xl font-bold">0</p></div><div class="bg-blue-100 text-blue-500 p-3 rounded-full"><i class="fas fa-users"></i></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Paid Users</p><p id="paid-users" class="text-2xl font-bold">0</p></div><div class="bg-green-100 text-green-500 p-3 rounded-full"><i class="fas fa-dollar-sign"></i></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Not Paid Users</p><p id="not-paid-users" class="text-2xl font-bold">0</p></div><div class="bg-red-100 text-red-500 p-3 rounded-full"><i class="fas fa-exclamation-triangle"></i></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Total Revenue</p><p id="total-revenue" class="text-2xl font-bold">$0</p></div><div class="bg-purple-100 text-purple-500 p-3 rounded-full"><i class="fas fa-wallet"></i></div></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap gap-3 items-center">
                    <span class="text-sm font-medium text-gray-700 mr-2">Filter by:</span>
                    <button class="user-filter-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 active" data-filter="all">All</button>
                    <button class="user-filter-btn px-3 py-1 text-sm font-medium text-green-700 bg-green-100 rounded-full hover:bg-green-200" data-filter="paid">Paid</button>
                    <button class="user-filter-btn px-3 py-1 text-sm font-medium text-red-700 bg-red-100 rounded-full hover:bg-red-200" data-filter="not_paid">Not Paid</button>

                    <span class="text-sm font-medium text-gray-700 ml-auto mr-2">Sort by:</span>
                    <button class="user-sort-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 active" data-sort="recent">Most Recent</button>
                    <button class="user-sort-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" data-sort="asc">Ascending (A-Z)</button>
                </div>
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="relative w-full md:w-1/3"><input type="text" id="search-input" placeholder="Search by name, email, or phone..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                    <button id="add-user-btn" class="w-full md:w-auto bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors"><i class="fas fa-plus mr-2"></i>Add User</button>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">User</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Phone</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Role</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Payment</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <tr><td colspan="5" class="p-6 text-center text-gray-500">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="users-roles" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Roles & Permissions</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-8 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Manage Roles</h2>
                        <p class="text-gray-500 mb-4">Define custom roles (e.g., "Editor", "Moderator") and assign specific permissions to each role.</p>
                        <div class="space-y-2">
                             <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                                <span class="font-medium text-gray-700">Editor</span>
                                <button class="text-sm text-indigo-600 hover:text-indigo-800">Edit Permissions</button>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                                <span class="font-medium text-gray-700">Moderator</span>
                                <button class="text-sm text-indigo-600 hover:text-indigo-800">Edit Permissions</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Administrator Accounts</h2>
                        <p class="text-gray-500 mb-4">List of users with the 'Admin' role.</p>
                        <div class="space-y-3" id="admin-user-list">
                           <p class="text-gray-500">Loading admin users...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-report" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Main Report (Placeholder)</h1>
                 <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">Total Paid Users</p><p id="report-paid-users" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">Total PDFs Viewed</p><p id="report-pdf-views" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-md col-span-1 md:col-span-2 lg:col-span-2"><p class="text-sm font-medium text-gray-500">Top Clicked PDF</p><p id="report-top-pdf" class="text-2xl font-bold text-indigo-600 mt-1 truncate">N/A</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">Total Blog Views</p><p id="report-blog-views" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">Active Users Today</p><p id="report-active-users" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md mb-8 flex flex-col md:flex-row gap-4">
                    <div class="flex-1"><label for="report-date-range" class="block text-sm font-medium text-gray-700">Date Range</label><input type="text" id="report-date-range" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="Select date range..."></div>
                    <div class="flex-1"><label for="report-content-type" class="block text-sm font-medium text-gray-700">Content Type</label><select id="report-content-type" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"><option value="all">All Content</option><option value="pdf">PDFs</option><option value="blog">Blog Posts</option></select></div>
                    <div class="flex-1"><label for="report-subject-filter" class="block text-sm font-medium text-gray-700">Subject/Year (for PDFs)</label><select id="report-subject-filter" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"><option value="all">All Subjects/Years</option></select></div>
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                     <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold text-gray-800 mb-4">Website Traffic (Placeholder)</h2><div class="h-80 bg-gray-50 rounded-lg flex items-center justify-center"><p class="text-gray-400">Line Chart Placeholder</p></div></div>
                     <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold text-gray-800 mb-4">PDF Views by Subject (Placeholder)</h2><div class="h-80 bg-gray-50 rounded-lg flex items-center justify-center"><p class="text-gray-400">Pie Chart Placeholder</p></div></div>
                </div>
            </div>

            <div id="settings" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>
                <div class="bg-white p-8 rounded-xl shadow-md">
                    <p class="text-gray-500">Placeholder for application settings, API keys, and configurations.</p>
                </div>
            </div>

        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 m-4 fade-in">
            </div>
    </div>

    <div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 fade-in h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Assign File to <span id="assign-item-type" class="capitalize">Item</span></h2>
            <p class="mb-4">Select a file below to assign to <strong id="assign-item-name"></strong>.</p>
            <input type="text" id="assign-pdf-search" placeholder="Search available files..." class="w-full p-2 border border-gray-300 rounded-lg mb-4">
            <div id="assign-pdf-list-container" class="flex-1 overflow-y-auto border p-4 rounded-lg bg-gray-50">
                 <p class="text-center text-gray-500">Loading files...</p>
            </div>
            <div class="mt-6 flex justify-end space-x-3"><button id="assign-modal-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button></div>
        </div>
    </div>

     <div id="assign-pdf-to-content-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 fade-in h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Assign File to Content</h2>
            <p class="mb-4 truncate">Assigning file: <strong id="assign-pdf-name-display" class="text-indigo-600"></strong></p>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4">
                <button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="subjects"><i data-lucide="book-copy" class="w-4 h-4 mr-2 inline-block"></i>Assign to Subject</button>
                <button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="exams"><i data-lucide="file-check-2" class="w-4 h-4 mr-2 inline-block"></i>Assign to Exam</button>
                <button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="generalBooks"><i data-lucide="book-open" class="w-4 h-4 mr-2 inline-block"></i>Assign to General Book</button>
            </div>
            <input type="text" id="assign-content-search" placeholder="Search for content..." class="w-full p-2 border border-gray-300 rounded-lg mb-4 hidden">
            <div id="assign-content-list-container" class="flex-1 overflow-y-auto border p-4 rounded-lg bg-gray-50">
                 <p class="text-center text-gray-500">Please select a content type above (Subject, Exam, or Book).</p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="assign-pdf-to-content-modal-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>

    <div id="quiz-modal" class="quiz-modal-overlay hidden">
        <div class="quiz-modal-container">
             <form id="quiz-form" class="p-6 sm:p-8">
                <div class="flex justify-between items-center pb-4 border-b mb-6">
                    <h2 id="modal-title" class="text-3xl font-extrabold text-gray-900">Add New Quiz</h2>
                    <div class="flex gap-3 items-center">
                        <button id="import-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Import Quiz from JSON"><i class="fa-solid fa-file-import mr-1"></i> Import</button>
                        <input type="file" id="json-file-input" accept=".json" class="hidden">
                        <button id="export-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Export Quiz to JSON"><i class="fa-solid fa-file-export mr-1"></i> Export</button>
                        <button id="close-modal-btn" type="button" class="text-gray-500 hover:text-gray-700 transition"><i class="fa-solid fa-xmark text-3xl"></i></button>
                    </div>
                </div>
                <input type="hidden" id="quiz-id-input">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="quiz-title" class="block text-sm font-semibold text-gray-700 mb-1">Quiz Title*</label><input type="text" id="quiz-title" class="quiz-form-input" placeholder="e.g., The French Revolution" required></div>
                        <div><label for="subject-select" class="block text-sm font-semibold text-gray-700 mb-1">Subject*</label><select id="subject-select" class="quiz-form-select" required><option value="">-- Select a Subject --</option></select></div>
                    </div>
                    <div class="p-4 rounded-xl bg-blue-50 border border-blue-200">
                        <label for="cover-image-input" class="block text-sm font-semibold text-blue-700 mb-2 flex items-center"><i class="fa-solid fa-image mr-2"></i> Quiz Cover Image (Optional)</label>
                        <input type="file" id="cover-image-input" class="quiz-form-input p-2 bg-white" accept="image/*">
                        <p id="cover-image-filename" class="text-xs text-blue-500 mt-1 italic"></p><input type="hidden" id="cover-image-url-input">
                        <div id="cover-image-preview" class="mt-4 border-2 border-dashed border-blue-300 p-2 bg-white rounded-lg flex justify-center items-center h-40 overflow-hidden"><span class="text-blue-400 text-sm">Image Preview will appear here</span></div>
                    </div>
                    <hr class="border-gray-200"/>
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center"><i class="fa-solid fa-clipboard-question mr-2 text-gray-400"></i> Questions</h3>
                    <div id="questions-container" class="space-y-5 max-h-[50vh] overflow-y-auto pr-3"><p class="text-gray-500 text-center py-4 text-sm" id="question-placeholder">Add your first question below.</p></div>
                    <button type="button" id="add-question-btn" class="quiz-btn quiz-btn-secondary w-full text-blue-600 border-blue-300 bg-blue-100 hover:bg-blue-200"><i class="fa-solid fa-plus mr-2"></i> Add New Question</button>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="save-quiz-btn" class="quiz-btn quiz-btn-primary flex-grow text-lg py-3"><i class="fa-solid fa-floppy-disk mr-2"></i> Save Quiz</button>
                    <button id="delete-quiz-btn" type="button" class="quiz-btn quiz-btn-danger flex-grow hidden"><i class="fa-solid fa-trash-alt mr-2"></i> Delete Quiz</button>
                </div>
            </form>
        </div>
    </div>

    <div id="user-modal" class="user-modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6 border-b flex justify-between items-center"><h2 id="user-modal-title" class="text-2xl font-bold">Add New User</h2><button id="user-modal-close" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="mb-4"><label for="name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="user-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="user-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="phone" class="block text-sm font-medium text-gray-700">Phone</label><div class="flex"><span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-md">252</span><input type="tel" id="phone" pattern="\d{9,}" title="Phone number must be at least 9 digits (without 252)" required class="rounded-none rounded-r-lg bg-gray-50 border text-gray-900 focus:ring-blue-500 focus:border-blue-500 block flex-1 min-w-0 w-full text-sm border-gray-300 p-2.5"></div></div>
                    <div class="flex justify-end gap-4 mt-6"><button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save User</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="user-modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6 text-center">
                <i id="confirm-icon" class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h3 id="confirm-title" class="text-xl font-bold mb-2">Are you sure?</h3>
                <p id="confirm-message" class="text-gray-600 mb-6">You won't be able to revert this!</p>
                <div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button id="confirm-action-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg">Yes, do it!</button></div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal">
         <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="trash-2" class="w-8 h-8 text-red-600"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Delete Post</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this post **and all its comments**? This action cannot be undone.</p>
                <div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Cancel</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Delete</button></div>
            </div>
        </div>
    </div>

    <div id="reply-modal" class="modal">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Reply to Comment</h2>
            <div class="mb-4 bg-gray-50 p-4 rounded-lg border"><p class="text-sm font-medium text-gray-800" id="reply-author"></p><p class="text-sm text-gray-600 mt-1" id="reply-original-text"></p></div>
            <form id="reply-form"><input type="hidden" id="reply-comment-id"><textarea id="reply-text" rows="4" placeholder="Write your reply..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea><div class="flex justify-end gap-4 mt-6"><button id="cancel-reply-btn" type="button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Cancel</button><button id="submit-reply-btn" type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Submit Reply</button></div></form>
        </div>
    </div>

    <div id="share-modal" class="modal">
         <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Share Post</h2><button id="cancel-share-btn" class="p-1 text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <p class="text-gray-600 mb-2">Share this post:</p><p class="text-lg font-semibold text-gray-800 mb-4" id="share-post-title">Post Title Here</p>
            <div class="flex items-center space-x-2"><input type="text" id="share-post-url" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none"><button id="copy-url-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 flex items-center"><i data-lucide="copy" class="w-4 h-4 mr-2"></i> Copy</button></div>
            <div class="flex justify-center space-x-4 mt-6"><a id="share-twitter" href="#" target="_blank" class="p-3 bg-blue-400 text-white rounded-full hover:bg-blue-500"><i data-lucide="twitter" class="w-5 h-5"></i></a><a id="share-facebook" href="#" target="_blank" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700"><i data-lucide="facebook" class="w-5 h-5"></i></a><a id="share-linkedin" href="#" target="_blank" class="p-3 bg-blue-700 text-white rounded-full hover:bg-blue-800"><i data-lucide="linkedin" class="w-5 h-5"></i></a></div>
        </div>
    </div>


    <div id="toast"></div>

<script type="module">
    // --- CONSOLIDATED FIREBASE V10 IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        addDoc,
        doc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        serverTimestamp,
        query,
        where,
        orderBy,
        writeBatch,
        Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
        getStorage,
        ref,
        uploadBytesResumable,
        listAll,
        getDownloadURL,
        getMetadata,
        deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"; // <-- Corrected: Included all needed functions

    // --- CONFIGURATION ---
    const firebaseConfig = {
         apiKey: "AIzaSyDuqswofpquk8aUbCOZCGjdYLUivBEh7a8", // Use your actual API key
         authDomain: "ardaycaawiye-18b89.firebaseapp.com",
         projectId: "ardaycaawiye-18b89",
         storageBucket: "ardaycaawiye-18b89.firebasestorage.app", // Corrected name
         messagingSenderId: "590874185284",
         appId: "1:590874185284:web:6ee7df602c45068e38b611",
         measurementId: "G-SBGSTJWDMR"
    };

    // --- INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- GLOBAL STATE ---
    let currentUser = null;
    let currentActiveTab = 'dashboard';
    let isLoginMode = true; // For auth form toggle

    // State for CRUD managers and dropdowns
    let editingPostId = null; // Specifically for blog posts
    let currentEditingId = null; // Generic for CRUD modal
    let allPdfFiles = []; // Cache for PDF library
    let availableSubjects = []; // Cache for dropdowns
    let availableExams = [];
    let availableGeneralBooks = [];
    let availableBlogCategories = []; // Blog categories cache
    let currentAssignTarget = { type: null, id: null, field: null }; // For assign PDF modal
    let currentPdfToAssign = { path: null, name: null }; // For assign PDF modal

    // State for Blog specific features
    let postToDeleteId = null;
    let commentToReplyId = null;
    let allPosts = []; // Local cache for blog posts
    let allComments = []; // Local cache for blog comments

    // Lib Instances
    let quill, tagify, schedulePicker, reportDatePicker;

    // Active manager/listener state
    let activeManagers = {
        subjects: null, exams: null, generalBooks: null, pdfLibrary: null,
        quiz: null, users: null, blogPosts: null, blogCategories: null,
        blogComments: null, blogAnalytics: null, // Added blog listeners
        reports: null, dashboard: null
    };

    // --- DOM ELEMENTS (Consolidated & Checked) ---
    const loginPage = document.getElementById('login-page');
    const mainApp = document.getElementById('main-app');
    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authToggleLink = document.getElementById('auth-toggle-link');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const logoutBtn = document.getElementById('logout-btn');
    const authStatus = document.getElementById('auth-status');
    const allTabs = document.querySelectorAll('.tab-content');
    const allSidebarLinks = document.querySelectorAll('#sidebar .sidebar-link');
    const dropdownToggles = document.querySelectorAll('#sidebar .has-dropdown');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mainSidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const toast = document.getElementById('toast');
    const modal = document.getElementById('modal'); // Generic CRUD Modal
    const modalContent = document.getElementById('modal-content');

    // Dashboard Stats Elements
    const dashTotalSubjects = document.getElementById('total-subjects');
    const dashTotalExams = document.getElementById('total-exams');
    const dashTotalBooks = document.getElementById('total-books');
    const dashTotalQuizzes = document.getElementById('total-quizzes');
    const dashTotalUsers = document.getElementById('dash-total-users');
    const dashPaidUsers = document.getElementById('dash-paid-users');
    const dashBannedUsers = document.getElementById('dash-banned-users');
    const dashTotalRevenue = document.getElementById('dash-total-revenue');

    // User Management Elements
    const userTableBody = document.getElementById('user-table-body');
    const addUserBtn = document.getElementById('add-user-btn');
    const userModal = document.getElementById('user-modal');
    const userModalCloseBtn = document.getElementById('user-modal-close');
    const userForm = document.getElementById('user-form');
    const userModalTitle = document.getElementById('user-modal-title');
    const userIdInput = document.getElementById('user-id');
    const userNameInput = document.getElementById('name');
    const userEmailInput = document.getElementById('user-email');
    const userPhoneInput = document.getElementById('phone');
    const userCancelBtn = document.getElementById('cancel-btn');
    const confirmActionModal = document.getElementById('confirm-modal');
    const confirmActionBtn = document.getElementById('confirm-action-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmIcon = document.getElementById('confirm-icon');
    const searchUserInput = document.getElementById('search-input');
    const userFilterBtns = document.querySelectorAll('.user-filter-btn');
    const userSortBtns = document.querySelectorAll('.user-sort-btn');
    const adminUserListContainer = document.getElementById('admin-user-list');
    const usersTotal = document.getElementById('total-users'); // Stats in User tab
    const usersPaid = document.getElementById('paid-users');
    const usersNotPaid = document.getElementById('not-paid-users');
    const usersRevenue = document.getElementById('total-revenue');

    // Blog Elements
    const postsTableBody = document.getElementById('posts-table-body');
    const blogPostForm = document.getElementById('blog-post-form');
    const postFormTitle = document.getElementById('form-title');
    const postIdInput = document.getElementById('post-id');
    const postTitleInput = document.getElementById('post-title');
    const postStatusSelect = document.getElementById('post-status');
    const scheduleDateWrapper = document.getElementById('schedule-date-wrapper');
    const postCategorySelect = document.getElementById('post-category');
    const filterCategorySelect = document.getElementById('filter-category');
    const imageDropzone = document.getElementById('image-dropzone');
    const imageInput = document.getElementById('post-image');
    const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const attachmentDropzone = document.getElementById('attachment-dropzone');
    const attachmentInput = document.getElementById('post-attachments');
    const attachmentList = document.getElementById('attachment-list');
    const commentsListView = document.getElementById('comments-list');
    const deleteModal = document.getElementById('delete-modal'); // Blog delete modal
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const replyModal = document.getElementById('reply-modal');
    const replyForm = document.getElementById('reply-form');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const shareModal = document.getElementById('share-modal');
    const cancelShareBtn = document.getElementById('cancel-share-btn');
    const copyUrlBtn = document.getElementById('copy-url-btn');
    const selectAllCheckbox = document.getElementById('select-all-posts');
    const categoriesList = document.getElementById('categories-list'); // Blog categories list
    const addCategoryForm = document.getElementById('add-category-form');
    const addNewBtnMain = document.getElementById('add-new-post-btn-main'); // Blog add button
    const searchPostsInput = document.getElementById('search-posts'); // Blog search
    const filterStatusSelect = document.getElementById('filter-status'); // Blog status filter
    const searchCommentsInput = document.getElementById('search-comments'); // Blog comments search
    const filterCommentStatusSelect = document.getElementById('filter-comment-status'); // Blog comments filter


    // --- UTILS ---
    const showToast = (message, type = 'success') => {
        toast.textContent = message;
        toast.className = `toast-${type}`; // Use specific classes for styling
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 4000);
    };

    const showModal = (html) => { // For Generic CRUD
        modalContent.innerHTML = html;
        modal.classList.remove('hidden');
        attachFileInputListeners(); // Attach listeners AFTER injecting HTML
    };

    const hideModal = () => { // For Generic CRUD
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
        currentEditingId = null; // Reset generic ID
    };

    const formatDate = (date) => {
        if (!date) return 'N/A';
        const d = date.toDate ? date.toDate() : new Date(date);
        // Ensure date is valid before formatting
        if (isNaN(d.getTime())) return 'Invalid Date';
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    };

    const formatBytes = (bytes, decimals = 2) => {
        if (!bytes || bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    };

    // Mock Upload (Used by Blog Section) - Replace with actual uploads if needed
    async function mockUploadFile(file) {
        showToast(`Simulating upload for ${file.name}...`);
        await new Promise(resolve => setTimeout(resolve, 500)); // Shorter delay
        const mockUrl = `https://mockstorage.com/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
        console.log(`Mock Upload: ${file.name} -> ${mockUrl}`);
        // showToast(`Upload complete for ${file.name}!`); // Can be noisy
        return { name: file.name, url: mockUrl };
    }


    // --- MASTER AUTHENTICATION ---
    onAuthStateChanged(auth, (user) => {
        console.log("onAuthStateChanged fired. User:", user); // Debug log
        if (user) {
            console.log("User detected, showing main app."); // Debug log
            currentUser = user;
            authStatus.textContent = `Logged in as ${user.email}`;
            authStatus.classList.add('text-green-400');
            authStatus.classList.remove('text-gray-400', 'text-red-400');
            mainApp.classList.remove('hidden');
            loginPage.classList.add('hidden');
            initializeAppLogic(); // Initialize managers and show default tab
        } else {
            console.log("No user detected, showing login page."); // Debug log
            currentUser = null;
            authStatus.textContent = 'Not Authenticated';
            authStatus.classList.add('text-red-400');
            authStatus.classList.remove('text-gray-400', 'text-green-400');
            mainApp.classList.add('hidden');
            loginPage.classList.remove('hidden');
            stopAppLogic(); // Stop listeners on logout
        }
        lucide.createIcons();
    });

    const handleAuthForm = async (e) => {
        e.preventDefault();
        console.log("Auth form submitted!"); // Debug log
        const email = emailInput.value;
        const password = passwordInput.value;
        authSubmitBtn.disabled = true;
        authSubmitBtn.textContent = 'Processing...';

        const action = isLoginMode ? signInWithEmailAndPassword : createUserWithEmailAndPassword;

        try {
            const userCredential = await action(auth, email, password);
            console.log("Firebase auth successful:", userCredential); // Debug log
             if (!isLoginMode) {
                 // Optionally add a user document to Firestore on sign up
                 console.log("Creating Firestore user doc for new user:", userCredential.user.uid);
                 await setDoc(doc(db, "users", userCredential.user.uid), { // Use setDoc with UID
                    uid: userCredential.user.uid,
                    name: email.split('@')[0], // Default name
                    email: email,
                    phone: '', // Empty phone initially
                    role: 'student', // Default role
                    paymentStatus: 'not_paid', // Default status
                    createdAt: serverTimestamp()
                });
             }
            // onAuthStateChanged will handle showing the dashboard
        } catch (error) {
            console.error("Firebase auth error:", error); // Debug log
            showToast(error.message, "error");
            authSubmitBtn.disabled = false;
            authSubmitBtn.textContent = isLoginMode ? 'Sign in' : 'Sign up';
        }
        // No finally block needed here, button state reset on error or handled by onAuthStateChanged
    };

    const toggleAuthMode = (e) => {
        e.preventDefault();
        isLoginMode = !isLoginMode;
        authTitle.textContent = isLoginMode ? 'Sign in to your account' : 'Create a new account';
        authSubmitBtn.textContent = isLoginMode ? 'Sign in' : 'Sign up';
        authToggleLink.textContent = isLoginMode ? "Don't have an account? Sign up" : 'Already have an account? Sign in';
    };

    const handleLogout = async () => {
        try {
            await signOut(auth);
            // onAuthStateChanged will handle UI changes
        } catch (error) {
            console.error("Logout Error:", error);
            showToast(error.message, "error");
        }
    };


    // --- MASTER NAVIGATION & LISTENER MANAGEMENT ---
    const stopAllManagers = () => {
        console.log("Stopping all managers...");
        Object.keys(activeManagers).forEach(key => {
            if (activeManagers[key] && typeof activeManagers[key].stop === 'function') {
                try {
                     activeManagers[key].stop();
                     console.log(`Stopped manager: ${key}`);
                } catch (error) {
                    console.error(`Error stopping manager ${key}:`, error);
                }
            }
            activeManagers[key] = null; // Reset manager state
        });
        // Explicitly reset blog listeners as they might be managed separately
        if (typeof unsubscribePosts === 'function') unsubscribePosts();
        if (typeof unsubscribeComments === 'function') unsubscribeComments();
        if (typeof unsubscribeCategories === 'function') unsubscribeCategories();
        unsubscribePosts = unsubscribeComments = unsubscribeCategories = () => {};
    };

    const switchTab = (tabId) => {
        console.log(`Switching to tab: ${tabId}`);
        stopAllManagers(); // Stop listeners from the previous tab
        currentActiveTab = tabId; // Remember the current tab

        // Hide all content tabs
        allTabs.forEach(tab => tab.classList.add('hidden'));

        // Show the selected tab
        const newTab = document.getElementById(tabId);
        if (newTab) {
            newTab.classList.remove('hidden');
        } else {
            console.warn(`Tab with ID "${tabId}" not found. Defaulting to dashboard.`);
            document.getElementById('dashboard').classList.remove('hidden'); // Fallback
            currentActiveTab = 'dashboard';
            tabId = 'dashboard'; // Ensure tabId reflects the fallback
        }

        // Update active link in sidebar
        allSidebarLinks.forEach(link => link.classList.remove('active'));
        dropdownToggles.forEach(btn => {
            btn.classList.remove('open', 'active'); // Close dropdown and remove active state from parent
            const menu = btn.nextElementSibling;
            if (menu && menu.classList.contains('dropdown-menu')) {
                 menu.style.display = 'none'; // Ensure menu is hidden
            }
            const icon = btn.querySelector('.dropdown-icon');
            if (icon) icon.style.transform = 'rotate(0deg)';
        });


        const activeLink = document.querySelector(`#sidebar .sidebar-link[data-tab="${tabId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
            // If it's inside a dropdown, open the parent and mark parent as active
            const parentDropdownMenu = activeLink.closest('.dropdown-menu');
            if (parentDropdownMenu) {
                const parentButton = parentDropdownMenu.previousElementSibling;
                if (parentButton && parentButton.classList.contains('has-dropdown')) {
                    parentButton.classList.add('open', 'active'); // Add active class to parent button
                    parentDropdownMenu.style.display = 'block';
                    const icon = parentButton.querySelector('.dropdown-icon');
                    if(icon) icon.style.transform = 'rotate(180deg)';
                }
            }
        } else {
            console.warn(`Sidebar link for tab "${tabId}" not found.`);
             // If no specific link found, activate the dashboard link
            const dashboardLink = document.querySelector(`#sidebar .sidebar-link[data-tab="dashboard"]`);
            if (dashboardLink) dashboardLink.classList.add('active');
        }

        // --- Initialize logic/listeners for the new tab ---
         console.log(`Starting manager for: ${tabId}`);
        switch (tabId) {
            case 'dashboard':
                activeManagers.dashboard = startDashboardManager();
                break;
            case 'subjects':
                activeManagers.subjects = managers.subjects.start();
                break;
            case 'exams':
                activeManagers.exams = managers.exams.start();
                break;
            case 'generalBooks':
                activeManagers.generalBooks = managers.generalBooks.start();
                break;
            case 'quizzes':
                activeManagers.quiz = startQuizManager();
                break;
            case 'pdf-library':
                activeManagers.pdfLibrary = startPdfLibraryManager();
                break;
             // --- BLOG TABS ---
            case 'list-posts':
                initPostsListener();
                initCategoriesListener(); // For filter dropdown
                break;
            case 'post-form-view': // The actual form tab
                initCategoriesListener(); // For category dropdown
                 // If triggered by "Add New", reset form; otherwise, load if editingPostId is set
                if (!editingPostId) {
                    console.log("Showing empty post form (Add New)");
                    showPostForm(); // Reset/Prepare the form for adding new
                } else {
                    console.log("Showing post form for editing:", editingPostId);
                    showPostForm(editingPostId); // Load existing post data
                }
                break;
            case 'categories': // Blog categories
                 initCategoriesListener(renderCategoriesList); // Pass render callback
                break;
            case 'comments': // Blog comments
                 initPostsListener(); // Need posts for context
                 initCommentsListener();
                break;
            case 'analytics': // Blog analytics
                 fetchAllDataForAnalytics();
                break;
             // --- USER TABS ---
            case 'users-students':
                activeManagers.users = startUserManager(); // Start user manager
                break;
            case 'users-roles':
                 initUsersListener(renderAdminList); // Use basic listener to show admin list
                console.log(`Tab "${tabId}" - Placeholder for full Role Management`);
                break;
             // --- REPORT TABS ---
            case 'main-report':
                // initMainReport(); // Add function later
                console.log(`Tab "${tabId}" - Placeholder for Main Report`);
                 if (reportDatePicker) reportDatePicker.destroy(); // Destroy previous instance if exists
                 reportDatePicker = flatpickr("#report-date-range", { mode: "range", dateFormat: "Y-m-d" });
                 // Add logic to fetch/render report data
                 break;
            // --- SETTINGS ---
            case 'settings':
                console.log(`Tab "${tabId}" - Placeholder`);
                break;
            default:
                console.warn(`No specific manager defined for tab: ${tabId}`);
        }

        lucide.createIcons(); // Re-run lucide for any newly displayed icons
    };


    // --- APP INITIALIZATION & SHUTDOWN ---
    const initializeAppLogic = () => {
        console.log("Initializing app logic...");
        // Pre-fetch data needed for dropdowns across different sections
        fetchSubjectsForDropdown();
        fetchBlogCategoriesForDropdown(); // Fetch blog categories

        // Initialize Blog specific libs here as they are complex
        initBlogLibs();

        // Setup common event listeners (like modals, sidebar toggles) that persist
        setupCommonEventListeners();

        // Start on the dashboard by default
        switchTab(currentActiveTab || 'dashboard');
    };

    const stopAppLogic = () => {
        console.log("Stopping app logic...");
        stopAllManagers(); // Ensure all listeners are cleared on logout
        // Destroy library instances if necessary (optional)
        if (quill) quill = null;
        if (tagify) tagify.destroy(); tagify = null;
        if (schedulePicker) schedulePicker.destroy(); schedulePicker = null;
        if (reportDatePicker) reportDatePicker.destroy(); reportDatePicker = null;
    };


    // --- Setup Common Event Listeners (Run once after login) ---
    function setupCommonEventListeners() {
         console.log("Setting up common event listeners...");
        // Sidebar Dropdowns
        dropdownToggles.forEach(button => {
            // Remove previous listener if exists (idempotency)
             button.replaceWith(button.cloneNode(true));
             document.getElementById(button.id || `dropdown-${Math.random()}`).addEventListener('click', (e) => { // Use ID or generate temp one if needed
                const targetButton = e.currentTarget;
                const dropdownMenu = targetButton.nextElementSibling;
                const icon = targetButton.querySelector('.dropdown-icon');
                const isOpen = targetButton.classList.contains('open');

                if (isOpen) {
                    targetButton.classList.remove('open');
                    dropdownMenu.style.display = 'none';
                    if(icon) icon.style.transform = 'rotate(0deg)';
                } else {
                     // Close other open dropdowns first
                    dropdownToggles.forEach(otherBtn => {
                        if (otherBtn !== targetButton && otherBtn.classList.contains('open')) {
                            otherBtn.classList.remove('open');
                            otherBtn.nextElementSibling.style.display = 'none';
                             const otherIcon = otherBtn.querySelector('.dropdown-icon');
                             if(otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                        }
                    });
                    // Open the clicked one
                    targetButton.classList.add('open');
                    dropdownMenu.style.display = 'block';
                     if(icon) icon.style.transform = 'rotate(180deg)';
                }
            });
        });

        // Sidebar Links
        allSidebarLinks.forEach(link => {
            // Remove previous listener if exists
            link.replaceWith(link.cloneNode(true));
             document.querySelector(`[data-tab="${link.dataset.tab}"]`).addEventListener('click', (e) => { // Re-select after clone
                e.preventDefault();
                const targetLink = e.currentTarget;
                const tabId = targetLink.dataset.tab;

                if (targetLink.classList.contains('has-dropdown')) return; // Ignore dropdown toggles here

                if (tabId) {
                    // Special handling for "Add New Post" link
                    if (tabId === 'post-form-view' && targetLink.dataset.action === 'add') {
                        editingPostId = null; // Ensure we are adding
                    }
                     switchTab(tabId);
                }

                // Close mobile sidebar on any link click
                if (window.innerWidth < 768 && !mainSidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            });
        });

        // Mobile Sidebar Toggle
        mobileMenuBtn.onclick = toggleSidebar; // Use onclick for simplicity after potential clones
        sidebarOverlay.onclick = toggleSidebar;

        // Logout Button
        logoutBtn.onclick = handleLogout;

        // Generic CRUD Modal Cancel Button
        modal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-cancel-btn') || e.target === modal) {
                hideModal();
            }
        });
        // Generic CRUD Modal Form Submission (delegated)
         modal.addEventListener('submit', (e) => {
             if (e.target.id === 'crud-form') {
                 const type = e.target.dataset.type;
                 if (managers[type] && typeof managers[type].handleFormSubmit === 'function') {
                     managers[type].handleFormSubmit(e);
                 } else {
                     console.warn(`No submit handler found for CRUD type: ${type}`);
                 }
             }
         });


        // Global handler for Add buttons (delegated)
        document.body.addEventListener('click', (e) => {
            const addBtn = e.target.closest('.add-btn');
            if (addBtn) {
                const type = addBtn.dataset.type;
                 if (managers[type] && typeof managers[type].handleAdd === 'function') {
                     managers[type].handleAdd();
                 } else {
                     console.warn(`No add handler found for CRUD type: ${type}`);
                 }
            }
        });

         // Assign PDF Modals Listeners (Attach once)
        document.getElementById('assign-modal-cancel').addEventListener('click', closeAssignModal);
        document.getElementById('assign-pdf-search').addEventListener('input', renderAssignablePdfs); // Search within Assign PDF
        document.getElementById('assign-pdf-to-content-modal-cancel').addEventListener('click', closeAssignPdfToContentModal);
        document.querySelectorAll('.assign-pdf-select-type-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const type = e.currentTarget.dataset.type;
                document.querySelectorAll('.assign-pdf-select-type-btn').forEach(b => b.classList.remove('bg-indigo-100', 'text-indigo-700'));
                e.currentTarget.classList.add('bg-indigo-100', 'text-indigo-700');
                document.getElementById('assign-content-search').value = '';
                renderAssignableContent(type);
            });
        });
        document.getElementById('assign-content-search').addEventListener('input', (e) => { // Search within Assign To Content
            const activeBtn = document.querySelector('.assign-pdf-select-type-btn.bg-indigo-100');
            if (activeBtn) {
                renderAssignableContent(activeBtn.dataset.type);
            }
        });

         // Setup Blog specific event listeners (like modals, form specifics)
         setupBlogEventListeners();

    } // --- End of setupCommonEventListeners ---

    // Mobile Sidebar Toggle Function
    const toggleSidebar = () => {
        mainSidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
    };

    // --- Authentication Form Listeners (outside common setup) ---
    authForm.addEventListener('submit', handleAuthForm);
    authToggleLink.addEventListener('click', toggleAuthMode);


    // =============================================
    // =========== DASHBOARD MANAGER START =========
    // =============================================
    const startDashboardManager = () => {
        let unsubscribers = [];
        console.log("Starting Dashboard Manager");

        const updateStat = (elementId, value) => {
            const element = document.getElementById(elementId);
            if (element) element.textContent = value;
            else console.warn(`Dashboard element ${elementId} not found`);
        }

        try {
            // Subjects Count
            unsubscribers.push(onSnapshot(collection(db, "subjects"), (snapshot) => {
                updateStat('total-subjects', snapshot.size);
            }, err => console.error("Snapshot error (subjects):", err)));

            // Exams Count
            unsubscribers.push(onSnapshot(collection(db, "exams"), (snapshot) => {
                updateStat('total-exams', snapshot.size);
            }, err => console.error("Snapshot error (exams):", err)));

            // Books Count
             unsubscribers.push(onSnapshot(collection(db, "generalBooks"), (snapshot) => {
                updateStat('total-books', snapshot.size);
            }, err => console.error("Snapshot error (generalBooks):", err)));

            // Quizzes Count
            unsubscribers.push(onSnapshot(collection(db, "quizzes"), (snapshot) => {
                updateStat('total-quizzes', snapshot.size);
            }, err => console.error("Snapshot error (quizzes):", err)));

            // Users Stats
             unsubscribers.push(onSnapshot(collection(db, "users"), (snapshot) => {
                let total = 0;
                let paid = 0;
                let banned = 0;
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Optional: Exclude admin users from stats if needed
                    // if (data.role === 'admin') return;
                    total++;
                    if (data.paymentStatus === 'paid') paid++; // Check paymentStatus
                    if (data.banned) banned++;
                });
                let revenue = paid * 5; // Assuming $5 per paid user

                updateStat('dash-total-users', total);
                updateStat('dash-paid-users', paid);
                updateStat('dash-banned-users', banned);
                updateStat('dash-total-revenue', `$${revenue}`);
            }, err => console.error("Snapshot error (users):", err)));

        } catch (error) {
            console.error("Error setting up dashboard listeners:", error);
            showToast("Failed to load dashboard data.", "error");
        }

        lucide.createIcons(); // Update icons if any were missed

        return {
            stop: () => {
                console.log("Stopping Dashboard Manager");
                unsubscribers.forEach(unsub => {
                    if (typeof unsub === 'function') unsub();
                });
                unsubscribers = [];
            }
        };
    };
    // =========== DASHBOARD MANAGER END ===========


    // =============================================
    // ======== PDF / CONTENT MANAGER START ========
    // =============================================

    // --- File Upload Helper ---
    const uploadFileToStorage = (file, pathPrefix) => new Promise((resolve, reject) => {
        if (!file) { resolve(null); return; }
        const uniqueFileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`; // Sanitize filename
        const storageRef = ref(storage, `${pathPrefix}${uniqueFileName}`);
        const uploadTask = uploadBytesResumable(storageRef, file);

        // Find progress bar specific to this file if in CRUD modal
        let progressBar = null;
         if (modal && !modal.classList.contains('hidden')) { // Check if CRUD modal is open
            const form = modal.querySelector('#crud-form');
             if (form) progressBar = form.querySelector(`.file-upload-progress[data-for="${file.inputId}"] div`);
        }

        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                if (progressBar) progressBar.style.width = progress + '%';
                 // Update global progress bar if not in modal
                else if (document.getElementById('upload-progress-bar')) {
                     document.getElementById('upload-progress-bar').style.width = progress + '%';
                }
            },
            (error) => {
                console.error(`Upload failed for ${file.name}:`, error);
                showToast(`Upload failed for ${file.name}.`, 'error');
                if (progressBar) progressBar.parentElement.textContent = 'Upload Failed!';
                reject(error);
            },
            async () => {
                try {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    if (progressBar) progressBar.parentElement.textContent = 'Upload Complete!';
                    console.log(`File ${file.name} uploaded to ${downloadURL}`);
                    resolve(downloadURL); // Resolve with the URL
                } catch (error) {
                    console.error(`Failed to get URL for ${file.name}:`, error);
                    showToast(`Error getting URL for ${file.name}.`, 'error');
                    if (progressBar) progressBar.parentElement.textContent = 'Error getting URL!';
                    reject(error);
                }
            }
        );
    });

     // --- Attach Listeners to File Inputs in CRUD Modal ---
    const attachFileInputListeners = () => {
        modalContent.querySelectorAll('input[type="file"]').forEach(input => {
             // Use克隆和替换来避免重复的监听器
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);

            newInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const previewEl = modalContent.querySelector(`.file-preview[data-for="${e.target.id}"]`);
                const progressContainer = modalContent.querySelector(`.file-upload-progress[data-for="${e.target.id}"]`);
                if (file && previewEl) {
                    previewEl.textContent = `Selected: ${file.name} (${formatBytes(file.size)})`;
                     if (progressContainer) {
                        progressContainer.classList.remove('hidden'); // Show progress bar container
                         progressContainer.querySelector('div').style.width = '0%';
                        progressContainer.querySelector('div').textContent = ''; // Clear status text
                    }
                     // Store inputId on file object for upload progress lookup
                    file.inputId = e.target.id;
                } else if (previewEl) {
                    previewEl.textContent = 'No file selected.';
                     if (progressContainer) progressContainer.classList.add('hidden');
                }
            });
        });
    };


    // --- DYNAMIC HTML TEMPLATES for CRUD ---
    const createTableHTML = (id, title, headers) => `
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
            <h2 class="text-xl font-semibold">${title}</h2>
            <button class="add-btn bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center w-full md:w-auto" data-type="${id}">
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add New ${title.slice(0, -1)}
            </button>
        </div>
        <div class="mb-4">
            <input type="text" id="${id}-search" placeholder="Search ${title}..." class="w-full p-2 border border-gray-300 rounded-lg">
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        ${headers.map(h => `<th class="p-3 font-semibold text-sm text-gray-600 uppercase tracking-wider">${h}</th>`).join('')}
                        <th class="p-3 font-semibold text-sm text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="${id}-table" class="divide-y divide-gray-200">
                    <tr><td colspan="${headers.length + 1}" class="p-6 text-center text-gray-500">Loading ${title.toLowerCase()}...</td></tr>
                </tbody>
            </table>
        </div>`;

    // --- GENERIC CRUD LOGIC FACTORY ---
    const createCrudManager = (config) => {
        const { type, title, headers, fields, renderRow } = config;
        const collectionRef = collection(db, type);
        const container = document.getElementById(type);
        let localItems = [];
        let unsubscribe = null;
        let searchInputListener = null; // Store listener reference

        const render = () => {
            const tableBody = document.getElementById(`${type}-table`);
            if (!tableBody) return; // Exit if table body isn't rendered yet
            const searchInput = document.getElementById(`${type}-search`);
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            console.log(`Rendering ${type} table. Search: "${searchTerm}", Items: ${localItems.length}`); // Debug log

            const filteredItems = localItems.filter(item =>
                Object.values(item).some(val => val && String(val).toLowerCase().includes(searchTerm))
            );

            if (filteredItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="p-4 text-center text-gray-500">${localItems.length === 0 ? `No ${title.toLowerCase()} found. Add one!` : `No ${title.toLowerCase()} match your search.`}</td></tr>`;
            } else {
                 try {
                     tableBody.innerHTML = filteredItems.map(item => renderRow(item)).join('');
                } catch (error) {
                    console.error(`Error rendering rows for ${type}:`, error);
                    tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="p-4 text-center text-red-500">Error rendering ${title.toLowerCase()}. Check console.</td></tr>`;
                }
            }
            lucide.createIcons(); // Ensure icons are rendered
        };

        const renderForm = (item = {}) => {
            console.log(`Rendering form for ${type}. Editing ID: ${currentEditingId}`);
            let formHTML = `<h2 class="text-2xl font-bold mb-6">${currentEditingId ? 'Edit' : 'Add'} ${title.slice(0, -1)}</h2><form id="crud-form" data-type="${type}" class="space-y-4">`;
            fields.forEach(f => {
                formHTML += `<div><label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}${f.required ? '<span class="text-red-500">*</span>' : ''}</label>`;
                const currentValue = item[f.id] || (f.type === 'checkbox' ? false : (f.defaultValue || ''));
                const requiredAttr = f.required ? 'required' : '';
                switch(f.type) {
                     case 'textarea': formHTML += `<textarea id="${f.id}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" rows="5">${currentValue}</textarea>`; break;
                     case 'checkbox': formHTML += `<div class="mt-1"><input id="${f.id}" type="checkbox" ${currentValue ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></div>`; break;
                     case 'date': let dateValue = ''; if (currentValue) { try { const d = currentValue.toDate ? currentValue.toDate() : new Date(currentValue); dateValue = d.toISOString().split('T')[0]; } catch(e){ console.warn("Error parsing date:", currentValue)} } formHTML += `<input id="${f.id}" type="date" value="${dateValue}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">`; break;
                     case 'select':
                        formHTML += `<select id="${f.id}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"><option value="">-- Select ${f.label} --</option>`;
                        let optionsSource = [];
                        if (f.optionsSource === 'subjects') optionsSource = availableSubjects;
                        else if (f.optionsSource === 'blogCategories') optionsSource = availableBlogCategories;
                        else if (f.optionsSource === 'static' && f.options) optionsSource = f.options;

                        if (optionsSource.length > 0) {
                            optionsSource.forEach(opt => {
                                const value = opt.id || opt.value; // Use id for Firestore docs, value for static
                                const label = opt.name || opt.label || opt.title; // Allow name, label, or title
                                // Special case for subjects to show grade
                                const displayLabel = (f.optionsSource === 'subjects' && opt.grade) ? `${label} (G${opt.grade})` : label;
                                const selected = String(value) === String(currentValue) ? 'selected' : ''; // Compare as strings
                                if (value) formHTML += `<option value="${value}" ${selected}>${displayLabel}</option>`;
                             });
                        } else {
                             console.warn(`Options source '${f.optionsSource}' for field '${f.id}' is empty or not found.`);
                        }
                        formHTML += `</select>`; break;
                     case 'file':
                        formHTML += `<input id="${f.id}" type="file" ${f.accept ? `accept="${f.accept}"` : ''} class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">`;
                        // Display current file name if exists
                         const fileName = currentValue ? currentValue.split('/').pop().split('?')[0].split('%2F').pop().replace(/%20/g, ' ').substring(14) : 'No file uploaded.';
                        formHTML += `<div class="file-preview text-xs text-gray-500 mt-1" data-for="${f.id}">${currentValue ? `Current: <a href="${currentValue}" target="_blank" class="text-indigo-600 hover:underline">${decodeURIComponent(fileName)}</a>` : 'No file uploaded.'}</div>`;
                        formHTML += `<div class="file-upload-progress w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700 mt-1 hidden" data-for="${f.id}"><div class="bg-indigo-600 h-1.5 rounded-full" style="width: 0%"></div></div>`; break;
                     default: formHTML += `<input id="${f.id}" type="${f.type || 'text'}" value="${currentValue}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">`;
                }
                formHTML += `</div>`;
            });
            formHTML += `<div class="flex justify-end space-x-3 pt-4 border-t mt-4">
                            <button type="button" class="modal-cancel-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700">Save</button>
                         </div></form>`;
            return formHTML;
        };

        const start = () => {
            console.log(`Starting CRUD Manager for: ${type}`);
            if (unsubscribe) {
                 console.log(`Manager for ${type} already running.`);
                 // Ensure table exists and render
                if (!container.innerHTML.includes('tbody')) container.innerHTML = createTableHTML(type, title, headers);
                render(); // Re-render with current data
                return { stop: () => {} }; // Return dummy stop
            }

            // Render table structure if container is empty
            if (!container.innerHTML.includes('tbody')) {
                container.innerHTML = createTableHTML(type, title, headers);
                 lucide.createIcons(); // Render icons in the new structure
            }

             // Define search listener function
            searchInputListener = () => render(); // Simple render on input

            // Attach search listener
            const searchInput = document.getElementById(`${type}-search`);
            if (searchInput) {
                 searchInput.removeEventListener('input', searchInputListener); // Remove old listener first
                 searchInput.addEventListener('input', searchInputListener);
            } else {
                 console.warn(`Search input not found for ${type}`);
            }


            // Firestore listener
            const q = query(collectionRef, orderBy("createdAt", "desc")); // Default sort by creation time
            unsubscribe = onSnapshot(q, (snapshot) => {
                localItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`Received ${localItems.length} items for ${type}`); // Debug log
                render(); // Render table on data update

                // Update global caches needed for dropdowns
                if (type === 'subjects') {
                    availableSubjects = [...localItems].sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                     console.log("Updated availableSubjects cache:", availableSubjects.length);
                }
                if (type === 'exams') {
                    availableExams = [...localItems].sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                }
                if (type === 'generalBooks') {
                    availableGeneralBooks = [...localItems].sort((a,b) => (a.title || '').localeCompare(b.title || ''));
                }
                 if (type === 'blogCategories') { // Update blog categories cache
                    availableBlogCategories = [...localItems].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    console.log("Updated availableBlogCategories cache:", availableBlogCategories.length);
                     // If blog form or list is active, update dropdowns
                    if (currentActiveTab === 'post-form-view' || currentActiveTab === 'list-posts') {
                         updateBlogCategoryDropdowns();
                    }
                }

            }, (error) => {
                console.error(`Error fetching ${type}:`, error);
                showToast(`Could not fetch ${type}.`, 'error');
                const tableBody = document.getElementById(`${type}-table`);
                if (tableBody) tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="p-4 text-center text-red-500">Error fetching data. Check console.</td></tr>`;
            });

            return {
                stop: () => {
                     console.log(`Stopping CRUD Manager for: ${type}`);
                    if (unsubscribe) {
                        unsubscribe();
                        unsubscribe = null;
                         console.log(`Unsubscribed Firestore listener for ${type}`);
                    }
                    const searchInput = document.getElementById(`${type}-search`);
                    if (searchInput && searchInputListener) {
                         searchInput.removeEventListener('input', searchInputListener);
                         searchInputListener = null; // Clear listener reference
                         console.log(`Removed search listener for ${type}`);
                    }
                     // Optional: Clear the container's HTML to ensure fresh state on next start
                    // container.innerHTML = '';
                }
            };
        };

        const handleAdd = () => { currentEditingId = null; showModal(renderForm()); };
        const handleEdit = (item) => { currentEditingId = item.id; showModal(renderForm(item)); };
        const handleDelete = async (id) => {
            if (confirm(`Are you sure you want to delete this ${title.slice(0, -1)}?\nID: ${id}\nThis action cannot be undone.`)) {
                try {
                     // Check for dependencies (e.g., if deleting a subject used by exams)
                    if (type === 'subjects') {
                        const examsUsingSubject = await getDocs(query(collection(db, 'exams'), where('subjectId', '==', id)));
                        if (!examsUsingSubject.empty) {
                            showToast(`Cannot delete subject. It's used by ${examsUsingSubject.size} exam(s).`, 'error');
                            return;
                        }
                        // Add similar checks for quizzes, etc.
                    }
                    if (type === 'blogCategories') {
                        // Optionally, find posts using this category and update them to 'Uncategorized'
                         // For simplicity now, we just delete the category.
                    }

                    // Proceed with deletion
                    await deleteDoc(doc(db, type, id));
                    showToast(`${title.slice(0, -1)} deleted!`);
                    // Firestore listener will update the UI
                } catch (e) {
                    console.error("Error deleting:", e);
                    showToast(`Error deleting ${title.slice(0, -1)}.`, 'error');
                }
            }
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            const formData = {};
            const fileUploadPromises = [];

             console.log(`Submitting form for ${type}. Editing ID: ${currentEditingId}`);

            // Gather form data
             fields.forEach(f => {
                const input = form.querySelector(`#${f.id}`);
                 if (!input) { console.warn(`Input not found for field ${f.id}`); return; }

                if (f.type === 'file') {
                    const file = input.files[0];
                    if (file) {
                        const progressContainer = form.querySelector(`.file-upload-progress[data-for="${f.id}"]`);
                        if(progressContainer) progressContainer.classList.remove('hidden');
                        let uploadPath = `${type}/`; // Default folder based on type
                        if (f.uploadPath) uploadPath = f.uploadPath; // Use specific path if provided
                        file.inputId = f.id; // Pass input ID for progress bar linking
                        fileUploadPromises.push(uploadFileToStorage(file, uploadPath).then(url => ({ fieldId: f.id, url: url })));
                     } else {
                        // If not editing, or if editing and no new file selected, keep existing URL
                        if (currentEditingId) {
                            const existingItem = localItems.find(item => item.id === currentEditingId);
                            if (existingItem && existingItem[f.id]) {
                                formData[f.id] = existingItem[f.id]; // Keep old URL
                            } else {
                                formData[f.id] = null; // No existing or new file
                            }
                        } else {
                             formData[f.id] = null; // No file for new item
                        }
                     }
                } else if (f.type === 'checkbox') { formData[f.id] = input.checked; }
                else if (f.type === 'number') { formData[f.id] = input.value === '' ? null : Number(input.value); } // Handle empty number input
                else if (f.type === 'date') { formData[f.id] = input.value ? Timestamp.fromDate(new Date(input.value + 'T00:00:00')) : null; } // Add time part for consistency
                else { formData[f.id] = input.value; } // Trim might remove leading/trailing spaces needed
            });

             console.log("Form Data Collected (before uploads):", formData);

            try {
                // Wait for all file uploads to complete
                const uploadResults = await Promise.all(fileUploadPromises);
                uploadResults.forEach(result => { if (result && result.url) formData[result.fieldId] = result.url; });

                 console.log("Form Data (after uploads):", formData);

                // Save to Firestore
                if (currentEditingId) {
                    formData.modifiedAt = serverTimestamp();
                    await updateDoc(doc(db, type, currentEditingId), formData);
                    showToast(`${title.slice(0, -1)} updated!`);
                } else {
                    formData.createdAt = serverTimestamp();
                    await addDoc(collectionRef, formData);
                    showToast(`${title.slice(0, -1)} added!`);
                }
                hideModal(); // Close modal on success
            } catch (e) {
                console.error("Error saving:", e);
                showToast(`Error saving ${title.slice(0, -1)}: ${e.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Save';
            }
        };


        return { start, stop, handleAdd, handleEdit, handleDelete, handleFormSubmit };
    };


    // --- FETCHERS FOR DROPDOWNS (used by CRUD) ---
    const fetchSubjectsForDropdown = async () => {
        if (availableSubjects.length > 0) return; // Use cache if available
        try {
            console.log("Fetching subjects for dropdown...");
            const snapshot = await getDocs(query(collection(db, 'subjects'), orderBy('name')));
            availableSubjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             console.log(`Fetched ${availableSubjects.length} subjects.`);
        } catch (error) {
            console.error("Error fetching subjects for dropdown:", error);
        }
    };
    const fetchBlogCategoriesForDropdown = async () => {
         if (availableBlogCategories.length > 0) return; // Use cache
        try {
             console.log("Fetching blog categories for dropdown...");
            const snapshot = await getDocs(query(collection(db, 'blogCategories'), orderBy('name')));
            availableBlogCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log(`Fetched ${availableBlogCategories.length} blog categories.`);
            // Update dropdowns if the blog section is active
            if (currentActiveTab === 'post-form-view' || currentActiveTab === 'list-posts') {
                 updateBlogCategoryDropdowns();
            }
        } catch (error) {
            console.error("Error fetching blog categories for dropdown:", error);
        }
    };


    // --- CRUD MANAGERS DEFINITIONS ---
    const managers = {
        subjects: createCrudManager({
            type: 'subjects', title: 'Subjects',
            headers: ['Cover', 'Name', 'Grade', 'Book PDF', 'Created'],
            fields: [
                { id: 'name', label: 'Subject Name', required: true },
                { id: 'grade', label: 'Grade (e.g., F1, F2)', required: true },
                { id: 'coverImage', label: 'Cover Image', type: 'file', accept: 'image/*', uploadPath: 'subject_covers/' },
                { id: 'bookPdfUrl', label: 'Book PDF', type: 'file', accept: '.pdf,.zip', uploadPath: 'subject_pdfs/' } // Allow ZIP
            ],
            renderRow: (item) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><img src="${item.coverImage || 'https://via.placeholder.com/40'}" alt="cover" class="w-10 h-10 rounded-md object-cover bg-gray-100"></td>
                    <td class="p-3 font-medium">${item.name || 'N/A'}</td>
                    <td class="p-3">${item.grade || 'N/A'}</td>
                    <td class="p-3">${item.bookPdfUrl ? `<a href="${item.bookPdfUrl}" target="_blank" class="text-indigo-600 hover:underline flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-1"></i>View File</a>` : '<span class="text-gray-400">No File</span>'}</td>
                    <td class="p-3 text-sm text-gray-500">${formatDate(item.createdAt)}</td>
                    <td class="p-3 space-x-1 whitespace-nowrap">
                        <button class="action-btn text-indigo-600 hover:bg-indigo-100 p-1" onclick="window.app.editItem('subjects', '${item.id}')" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button class="action-btn text-blue-600 hover:bg-blue-100 p-1" onclick="window.app.openAssignModal('subjects', '${item.id}', 'bookPdfUrl', '${item.name.replace(/'/g, "\\'")}')" title="Assign File"><i data-lucide="link" class="w-4 h-4"></i></button>
                        <button class="action-btn text-red-600 hover:bg-red-100 p-1" onclick="window.app.deleteItem('subjects', '${item.id}')" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`
        }),
        exams: createCrudManager({
            type: 'exams', title: 'Exams',
            headers: ['Cover', 'Name', 'Year', 'Subject', 'PDF', 'Created'],
            fields: [
                { id: 'name', label: 'Exam Name (e.g., Midterm)', required: true },
                { id: 'year', label: 'Year', type: 'number', required: true },
                { id: 'subjectId', label: 'Subject', type: 'select', optionsSource: 'subjects', required: true },
                { id: 'coverImage', label: 'Cover Image', type: 'file', accept: 'image/*', uploadPath: 'exam_covers/' },
                { id: 'pdfUrl', label: 'Exam PDF', type: 'file', accept: '.pdf,.zip', uploadPath: 'exam_pdfs/' } // Allow ZIP
            ],
            renderRow: (item) => {
                const subject = availableSubjects.find(s => s.id === item.subjectId);
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><img src="${item.coverImage || 'https://via.placeholder.com/40'}" alt="cover" class="w-10 h-10 rounded-md object-cover bg-gray-100"></td>
                    <td class="p-3 font-medium">${item.name || 'N/A'}</td>
                    <td class="p-3">${item.year || 'N/A'}</td>
                    <td class="p-3">${subject ? `${subject.name} (G${subject.grade})` : '<span class="text-gray-400">?</span>'}</td>
                    <td class="p-3">${item.pdfUrl ? `<a href="${item.pdfUrl}" target="_blank" class="text-indigo-600 hover:underline flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-1"></i>View File</a>` : '<span class="text-gray-400">No File</span>'}</td>
                    <td class="p-3 text-sm text-gray-500">${formatDate(item.createdAt)}</td>
                    <td class="p-3 space-x-1 whitespace-nowrap">
                        <button class="action-btn text-indigo-600 hover:bg-indigo-100 p-1" onclick="window.app.editItem('exams', '${item.id}')" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button class="action-btn text-blue-600 hover:bg-blue-100 p-1" onclick="window.app.openAssignModal('exams', '${item.id}', 'pdfUrl', '${item.name.replace(/'/g, "\\'")}')" title="Assign File"><i data-lucide="link" class="w-4 h-4"></i></button>
                        <button class="action-btn text-red-600 hover:bg-red-100 p-1" onclick="window.app.deleteItem('exams', '${item.id}')" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`
            }
        }),
         generalBooks: createCrudManager({
            type: 'generalBooks', title: 'General Books',
            headers: ['Cover', 'Title', 'Author', 'PDF', 'Created'],
            fields: [
                { id: 'title', label: 'Book Title', required: true },
                { id: 'author', label: 'Author', required: false },
                { id: 'coverImageUrl', label: 'Cover Image', type: 'file', accept: 'image/*', uploadPath: 'generalBooks_covers/' },
                { id: 'pdfUrl', label: 'Book PDF', type: 'file', accept: '.pdf,.zip', uploadPath: 'generalBooks_pdfs/' } // Allow ZIP
            ],
            renderRow: (item) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><img src="${item.coverImageUrl || 'https://via.placeholder.com/40'}" alt="cover" class="w-10 h-10 rounded-md object-cover bg-gray-100"></td>
                    <td class="p-3 font-medium">${item.title || 'N/A'}</td>
                    <td class="p-3">${item.author || 'N/A'}</td>
                    <td class="p-3">${item.pdfUrl ? `<a href="${item.pdfUrl}" target="_blank" class="text-indigo-600 hover:underline flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-1"></i>View File</a>` : '<span class="text-gray-400">No File</span>'}</td>
                    <td class="p-3 text-sm text-gray-500">${formatDate(item.createdAt)}</td>
                    <td class="p-3 space-x-1 whitespace-nowrap">
                        <button class="action-btn text-indigo-600 hover:bg-indigo-100 p-1" onclick="window.app.editItem('generalBooks', '${item.id}')" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button class="action-btn text-blue-600 hover:bg-blue-100 p-1" onclick="window.app.openAssignModal('generalBooks', '${item.id}', 'pdfUrl', '${item.title.replace(/'/g, "\\'")}')" title="Assign File"><i data-lucide="link" class="w-4 h-4"></i></button>
                        <button class="action-btn text-red-600 hover:bg-red-100 p-1" onclick="window.app.deleteItem('generalBooks', '${item.id}')" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`
        }),
        // No Blog CRUD here, handled separately below due to complexity
    };
    // =========== PDF / CONTENT MANAGER END ==========


    // =============================================
    // =========== PDF LIBRARY MANAGER START =======
    // =============================================
    let pdfListTable, selectAllPdfsCheckbox, deleteSelectedPdfsBtn; // Make them accessible globally within the module scope

    const startPdfLibraryManager = () => {
        console.log("Starting PDF Library Manager");
        pdfListTable = document.getElementById('pdf-list-table');
        selectAllPdfsCheckbox = document.getElementById('select-all-pdfs');
        deleteSelectedPdfsBtn = document.getElementById('delete-selected-pdfs-btn');
        const pdfSearch = document.getElementById('pdf-search');
        const uploadBtn = document.getElementById('upload-pdf-btn');
        const uploadInput = document.getElementById('pdf-upload-input');
        const progressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('upload-progress-bar');


        const renderPdfList = () => {
            if (!pdfListTable) return; // Ensure element exists
             const searchTerm = pdfSearch.value.toLowerCase();
            const filteredPdfs = allPdfFiles.filter(pdf => pdf.name.toLowerCase().includes(searchTerm));

             console.log(`Rendering PDF list. Search: "${searchTerm}", Files: ${filteredPdfs.length}`);

            if (filteredPdfs.length === 0) {
                pdfListTable.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">${allPdfFiles.length === 0 ? "No files found in storage." : "No files match your search."}</td></tr>`;
                return;
            }

            pdfListTable.innerHTML = filteredPdfs.map(pdf => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><input type="checkbox" class="pdf-checkbox" data-path="${pdf.fullPath}"></td>
                    <td class="p-3 font-medium text-gray-800 break-all">${pdf.name}</td>
                    <td class="p-3 text-gray-600">${formatBytes(pdf.size)}</td>
                    <td class="p-3 text-gray-600">${formatDate(pdf.updated)}</td>
                    <td class="p-3 space-x-1 whitespace-nowrap">
                        <button class="action-btn text-green-600 hover:bg-green-100 p-1" onclick="window.app.copyToClipboard('${pdf.fullPath}')" title="Copy URL"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        <button class="action-btn text-blue-600 hover:bg-blue-100 p-1" onclick="window.app.openAssignPdfToContentModal('${pdf.fullPath}', '${pdf.name.replace(/'/g, "\\'")}')" title="Assign to Content"><i data-lucide="link" class="w-4 h-4"></i></button>
                        <button class="action-btn text-red-600 hover:bg-red-100 p-1" onclick="window.app.deletePdf('${pdf.fullPath}')" title="Delete File"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateDeleteSelectedButton(); // Update button state after rendering
        };

        const fetchAllPdfs = async () => {
             console.log("Fetching all files from storage...");
             pdfListTable.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-gray-500">Loading files...</td></tr>`;
            try {
                const listRef = ref(storage, ''); // List all files from root
                const res = await listAll(listRef);
                const allFilesPromises = [];

                 const processItems = async (items) => {
                    for (const itemRef of items) {
                        allFilesPromises.push(
                            getMetadata(itemRef)
                                .then(metadata => ({ ref: itemRef, name: metadata.name, fullPath: metadata.fullPath, size: metadata.size, updated: metadata.updated, type: metadata.contentType }))
                                .catch(e => { console.error("Error getting metadata for item:", itemRef.fullPath, e); return null; })
                        );
                    }
                };

                 await processItems(res.items); // Files in root

                 // Process files in top-level folders (adjust depth if needed)
                for (const folderRef of res.prefixes) {
                     console.log(`Listing files in folder: ${folderRef.name}`);
                    try {
                        const folderRes = await listAll(folderRef);
                        await processItems(folderRes.items);
                    } catch (folderError) {
                         console.error(`Error listing folder ${folderRef.name}:`, folderError);
                    }
                }

                 const results = await Promise.all(allFilesPromises);
                 allPdfFiles = results.filter(file => file !== null) // Filter out nulls from errors
                                     .sort((a, b) => b.size - a.size); // Sort by size descending

                 console.log(`Fetched ${allPdfFiles.length} files.`);
                 renderPdfList();

            } catch (error) {
                console.error("Error fetching file list:", error);
                showToast("Error fetching file list.", "error");
                if(pdfListTable) pdfListTable.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error fetching files. Check console.</td></tr>`;
            }
        };

        const updateDeleteSelectedButton = () => {
             if (!pdfListTable || !deleteSelectedPdfsBtn) return;
            const selected = pdfListTable.querySelectorAll('.pdf-checkbox:checked');
            if (selected.length > 0) {
                deleteSelectedPdfsBtn.classList.remove('hidden');
                // Update text content safely
                 const icon = deleteSelectedPdfsBtn.querySelector('i');
                 if (icon) icon.nextSibling.textContent = ` Delete Selected (${selected.length})`;
            } else {
                deleteSelectedPdfsBtn.classList.add('hidden');
            }
        };

        const deleteSelectedPdfs = async () => {
             if (!pdfListTable) return;
            const selected = pdfListTable.querySelectorAll('.pdf-checkbox:checked');
            if (selected.length === 0) return;

            if (confirm(`Are you sure you want to delete ${selected.length} file(s)? This cannot be undone.`)) {
                let deletePromises = [];
                let deletedPaths = [];
                selected.forEach(cb => {
                    const path = cb.dataset.path;
                    deletedPaths.push(path);
                    deletePromises.push(deleteObject(ref(storage, path)).catch(err => ({ path: path, error: err }))); // Catch individual errors
                });

                try {
                    const results = await Promise.all(deletePromises);
                    const failedDeletions = results.filter(r => r && r.error);

                    if (failedDeletions.length > 0) {
                        console.error("Failed to delete some files:", failedDeletions);
                        showToast(`Error deleting ${failedDeletions.length} file(s). See console.`, "error");
                    }
                    const successCount = selected.length - failedDeletions.length;
                    if (successCount > 0) {
                         showToast(`${successCount} file(s) deleted successfully!`);
                    }

                    // Refresh list from cache or re-fetch
                    allPdfFiles = allPdfFiles.filter(pdf => !deletedPaths.includes(pdf.fullPath));
                    renderPdfList();
                    if(selectAllPdfsCheckbox) selectAllPdfsCheckbox.checked = false;
                    updateDeleteSelectedButton();

                } catch (error) { // Catch potential Promise.all errors (less likely with individual catches)
                    console.error("Error during batch delete:", error);
                    showToast("An error occurred during deletion.", "error");
                    fetchAllPdfs(); // Re-fetch on major error
                }
            }
        };

         const handleFileUpload = async (files) => {
            if (!files || files.length === 0) return;

             console.log(`Starting upload for ${files.length} files...`);
             uploadBtn.disabled = true;
             uploadBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Uploading...';
             lucide.createIcons(); // Render loading icon
             progressContainer.classList.remove('hidden');
             progressBar.style.width = '0%';

             let uploadPromises = [];
             for (const file of files) {
                 let pathPrefix = 'general_uploads/'; // Default path
                 if (file.type === 'application/pdf') pathPrefix = 'general_pdfs/';
                 else if (file.type.startsWith('image/')) pathPrefix = 'general_images/';
                 else if (file.type === 'application/zip') pathPrefix = 'zips/';
                // Pass a callback to update global progress bar for non-modal uploads
                 uploadPromises.push(uploadFileToStorage(file, pathPrefix));
             }

             try {
                 await Promise.all(uploadPromises);
                 showToast(`Successfully uploaded ${files.length} file(s)!`);
                 await fetchAllPdfs(); // Refresh the list after uploads complete
             } catch (error) {
                 console.error("Error during bulk file upload:", error);
                 showToast("An error occurred during upload. Some files may not have uploaded.", "error");
                 await fetchAllPdfs(); // Refresh list even on error to see what succeeded
             } finally {
                 uploadBtn.disabled = false;
                 uploadBtn.innerHTML = '<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload Files';
                 lucide.createIcons(); // Restore upload icon
                 progressContainer.classList.add('hidden'); // Hide progress bar
             }
         };

        // --- Event Listener Functions for PDF Library ---
        const onPdfSearchInput = () => renderPdfList();
        const onUploadBtnClick = () => uploadInput.click();
        const onUploadInputChange = (e) => handleFileUpload(e.target.files);
        const onSelectAllChange = (e) => {
             if (!pdfListTable) return;
            pdfListTable.querySelectorAll('.pdf-checkbox').forEach(cb => cb.checked = e.target.checked);
            updateDeleteSelectedButton();
        };
        const onPdfListTableChange = (e) => {
            if (e.target.classList.contains('pdf-checkbox')) {
                updateDeleteSelectedButton();
            }
        };
        const onDeleteSelectedClick = () => deleteSelectedPdfs();


        // --- Add Listeners ---
        pdfSearch.addEventListener('input', onPdfSearchInput);
        uploadBtn.addEventListener('click', onUploadBtnClick);
        uploadInput.addEventListener('change', onUploadInputChange);
        selectAllPdfsCheckbox.addEventListener('change', onSelectAllChange);
         // Use event delegation on the table body for checkboxes
        pdfListTable.addEventListener('change', onPdfListTableChange);
        deleteSelectedPdfsBtn.addEventListener('click', onDeleteSelectedClick);

        // --- Initial Fetch ---
        fetchAllPdfs();

        // --- Return stop function ---
        return {
            stop: () => {
                console.log("Stopping PDF Library Manager");
                pdfSearch.removeEventListener('input', onPdfSearchInput);
                uploadBtn.removeEventListener('click', onUploadBtnClick);
                uploadInput.removeEventListener('change', onUploadInputChange);
                selectAllPdfsCheckbox.removeEventListener('change', onSelectAllChange);
                pdfListTable.removeEventListener('change', onPdfListTableChange);
                deleteSelectedPdfsBtn.removeEventListener('click', onDeleteSelectedClick);
                // Clear state if needed
                allPdfFiles = [];
                 pdfListTable.innerHTML = ''; // Clear table content
            }
        };
    };
    // =========== PDF LIBRARY MANAGER END =========


    // =============================================
    // =========== QUIZ MANAGER START ==============
    // =============================================
    const startQuizManager = () => {
        console.log("Starting Quiz Manager");
        // --- DOM ELEMENTS ---
        const quizListContainer = document.getElementById('quiz-list-container');
        const paginationContainer = document.getElementById('pagination-container');
        const subjectFilter = document.getElementById('subject-filter');
        const quizModal = document.getElementById('quiz-modal');
        const quizForm = document.getElementById('quiz-form');
        const quizModalTitle = document.getElementById('modal-title'); // Shared ID, ensure correct one
        const quizIdInput = document.getElementById('quiz-id-input');
        const quizTitleInput = document.getElementById('quiz-title');
        const subjectSelect = document.getElementById('subject-select'); // Specific to quiz modal
        const questionsContainer = document.getElementById('questions-container');
        const deleteQuizBtn = document.getElementById('delete-quiz-btn');
        const coverImageInput = document.getElementById('cover-image-input');
        const coverImageUrlInput = document.getElementById('cover-image-url-input');
        const coverImagePreview = document.getElementById('cover-image-preview');
        const coverImageFilename = document.getElementById('cover-image-filename');
        const importJsonBtn = document.getElementById('import-json-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const jsonFileInput = document.getElementById('json-file-input');
        const questionPlaceholder = document.getElementById('question-placeholder');
        const addQuizFab = document.getElementById('add-quiz-fab');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addQuestionBtn = document.getElementById('add-question-btn');

        // --- STATE ---
        let allQuizzes = [];
        // subjectsCache (availableSubjects) is fetched globally now
        let currentPage = 1;
        const ITEMS_PER_PAGE = 12;
        let unsubscribeQuizListener = null;

        // --- UTILITY ---
        const getSubjectName = (subjectId) => {
            const subject = availableSubjects.find(s => s.id === subjectId); // Use global cache
            return subject ? `${subject.name} (G${subject.grade})` : 'Unknown Subject';
        };

        // --- DATA FETCHING & RENDERING ---
        async function fetchAndRenderSubjects() {
            // Use global fetcher, then populate dropdowns
            await fetchSubjectsForDropdown();

            const populateSelect = (selectEl) => {
                selectEl.innerHTML = `<option value="">-- Select a Subject --</option>`; // Reset options
                availableSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = `${subject.name} (G${subject.grade})`;
                    selectEl.appendChild(option);
                });
            };
            populateSelect(subjectSelect); // Populate modal select

            // Populate filter select
            subjectFilter.innerHTML = '<option value="all">All Subjects</option>';
            availableSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.name} (G${subject.grade})`;
                subjectFilter.appendChild(option);
            });
        }

        function listenForQuizzes() {
            if (unsubscribeQuizListener) unsubscribeQuizListener(); // Stop previous listener

            const q = query(collection(db, "quizzes"), orderBy("title")); // Order by title
            unsubscribeQuizListener = onSnapshot(q, (snapshot) => {
                 console.log(`Received ${snapshot.size} quizzes from listener.`);
                allQuizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPage(); // Re-render the current page on updates
            }, error => {
                console.error("Error fetching quizzes:", error);
                if(quizListContainer) quizListContainer.innerHTML = `<p class="text-red-500 col-span-full text-center p-8">Failed to load quizzes.</p>`;
            });
        }

        function renderPage() {
            if (!quizListContainer) return; // Check if element exists
            const selectedSubject = subjectFilter.value;
            const filteredQuizzes = selectedSubject === 'all'
                ? allQuizzes
                : allQuizzes.filter(quiz => quiz.subjectId === selectedSubject);

            const totalPages = Math.ceil(filteredQuizzes.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1;
            }
             console.log(`Rendering quiz page ${currentPage}/${totalPages}. Filter: ${selectedSubject}. Total items: ${filteredQuizzes.length}`);
            renderQuizList(filteredQuizzes);
            renderPagination(filteredQuizzes.length);
        }

        function renderQuizList(quizzes) {
            quizListContainer.innerHTML = ''; // Clear previous items
            if (quizzes.length === 0) {
                quizListContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-12"><i class="fa-solid fa-box-open text-5xl mb-4 text-gray-300"></i><br>No quizzes found for this filter.</p>`;
                return;
            }

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedQuizzes = quizzes.slice(startIndex, endIndex);

            paginatedQuizzes.forEach(quiz => {
                const subjectName = getSubjectName(quiz.subjectId);
                const coverImageHtml = quiz.coverImageUrl && quiz.coverImageUrl.startsWith('http')
                    ? `<div class="h-16 w-full mb-3 overflow-hidden rounded-lg"><img src="${quiz.coverImageUrl}" alt="Cover" class="w-full h-full object-cover"></div>`
                    : `<div class="h-16 w-full mb-3 bg-indigo-50 rounded-lg flex items-center justify-center text-indigo-500"><i class="fa-solid fa-puzzle-piece text-2xl"></i></div>`;

                const quizCard = document.createElement('div');
                quizCard.className = 'bg-white p-4 rounded-xl shadow-md border border-gray-100 transition-all hover:shadow-lg hover:-translate-y-0.5 cursor-pointer';
                quizCard.innerHTML = `
                    ${coverImageHtml}
                    <h3 class="text-lg font-bold text-gray-800 truncate mb-1" title="${quiz.title}">${quiz.title}</h3>
                    <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                        <span class="inline-flex items-center truncate"><i class="fa-solid fa-book-open mr-1 text-gray-400"></i> ${subjectName}</span>
                        <span class="inline-flex items-center font-semibold text-gray-600">${quiz.questionCount || 0} Qs</span>
                    </div>
                    <button class="edit-quiz-btn quiz-btn quiz-btn-secondary w-full text-sm !py-1.5" data-id="${quiz.id}"><i class="fa-solid fa-pen-to-square mr-1"></i> Edit Quiz</button>
                `;
                 // Attach listener directly here for simplicity in this manager structure
                 quizCard.querySelector('.edit-quiz-btn').addEventListener('click', (e) => {
                     openModal(e.currentTarget.dataset.id);
                 });
                quizListContainer.appendChild(quizCard);
            });
        }

        function renderPagination(totalItems) {
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `w-8 h-8 rounded-full text-sm font-semibold transition ${currentPage === i ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200'}`;
                pageButton.onclick = () => { // Direct onclick for pagination buttons
                    currentPage = i;
                    renderPage();
                };
                paginationContainer.appendChild(pageButton);
            }
        }

        // --- MODAL & FORM ---
         function openModal(quizId = null) {
            resetForm();
            if (quizId) {
                quizModalTitle.textContent = 'Edit Quiz';
                deleteQuizBtn.classList.remove('hidden');
                quizIdInput.value = quizId;
                const quiz = allQuizzes.find(q => q.id === quizId);
                if (quiz) {
                    quizTitleInput.value = quiz.title;
                    // Use setTimeout to ensure options are populated before setting value
                     setTimeout(() => { subjectSelect.value = quiz.subjectId || ''; }, 10);
                    coverImageUrlInput.value = quiz.coverImageUrl || '';
                    if (quiz.coverImageUrl) {
                        coverImagePreview.innerHTML = `<img src="${quiz.coverImageUrl}" alt="Cover Preview" class="max-h-full max-w-full object-contain rounded-md">`;
                        coverImageFilename.textContent = `Current URL: ${quiz.coverImageUrl.substring(0, 50)}${quiz.coverImageUrl.length > 50 ? '...' : ''}`;
                    }
                    loadQuestionsForEdit(quizId); // Load associated questions
                } else {
                     showToast("Quiz not found in local cache.", "error");
                     return;
                }
            } else {
                quizModalTitle.textContent = 'Add New Quiz';
                deleteQuizBtn.classList.add('hidden');
                addQuestionElement(); // Add one empty question for new quizzes
            }
            quizModal.classList.remove('hidden');
        }

        function closeModal() { quizModal.classList.add('hidden'); }

        function resetForm() {
            quizForm.reset();
            quizIdInput.value = '';
            questionsContainer.innerHTML = ''; // Clear questions
            questionPlaceholder.classList.remove('hidden'); // Show placeholder
            coverImageUrlInput.value = '';
            coverImagePreview.innerHTML = `<span class="text-blue-400 text-sm">Image Preview will appear here</span>`;
            coverImageFilename.textContent = '';
            coverImageInput.value = ''; // Reset file input
             subjectSelect.value = ''; // Reset subject dropdown
        }

        // Add/Remove Questions & Options
        function addQuestionElement(question = { questionText: '', options: ['', ''], correctAnswerIndex: null }) {
            questionPlaceholder.classList.add('hidden');
            const index = questionsContainer.children.length;
            const questionId = `question-${Date.now()}-${index}`; // Unique ID for radio group name
            const questionWrapper = document.createElement('div');
            questionWrapper.className = 'p-4 rounded-lg border border-gray-200 bg-white shadow-sm'; // Slightly less prominent than card
            questionWrapper.id = questionId;

            // Ensure at least two options exist for rendering
            while (question.options.length < 2) { question.options.push(''); }

            const renderOptions = () => {
                const optionsContainer = questionWrapper.querySelector('.options-container');
                if (!optionsContainer) return;
                const optionsHtml = question.options.map((opt, optIndex) =>
                    createOptionHtml(questionId, optIndex, opt, question.correctAnswerIndex === optIndex)
                ).join('');
                optionsContainer.innerHTML = optionsHtml;
            }

            questionWrapper.innerHTML = `
                <div class="flex justify-between items-center mb-3 border-b pb-2">
                    <h4 class="font-semibold text-md text-gray-700">Question ${index + 1}</h4>
                    <button type="button" class="remove-question-btn text-red-500 hover:text-red-700 transition" title="Remove Question"><i class="fa-solid fa-trash-alt"></i></button>
                </div>
                <textarea class="quiz-form-input question-text mb-3" rows="2" placeholder="Enter the quiz question here..." required>${question.questionText}</textarea>
                <h5 class="text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">Options & Correct Answer:</h5>
                <div class="options-container space-y-2"></div>
                <button type="button" class="add-option-btn mt-3 text-sm text-green-600 hover:text-green-800 font-semibold flex items-center"><i class="fa-solid fa-circle-plus mr-1"></i> Add Option</button>
            `;

            questionsContainer.appendChild(questionWrapper);
            renderOptions(); // Render initial options

            // Attach listeners specific to this question element
            questionWrapper.querySelector('.add-option-btn').addEventListener('click', () => {
                const optionsContainer = questionWrapper.querySelector('.options-container');
                const newIndex = optionsContainer.children.length;
                const newOptionHtml = createOptionHtml(questionId, newIndex, '', false);
                optionsContainer.insertAdjacentHTML('beforeend', newOptionHtml);
            });
             questionWrapper.querySelector('.remove-question-btn').addEventListener('click', (e) => handleQuestionContainerClick(e));
             questionWrapper.querySelector('.options-container').addEventListener('click', (e) => handleQuestionContainerClick(e)); // Delegate option removal

        }

        function createOptionHtml(questionId, optIndex, optionText, isChecked) {
            // Ensure optionText is properly escaped to prevent HTML injection if loading from unsafe source
            const escapedText = optionText.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
            return `
            <div class="flex items-start option-item bg-gray-50 p-2 rounded transition hover:bg-gray-100">
                <div class="pt-1"><input type="radio" id="${questionId}-opt-${optIndex}" name="${questionId}-correct" class="radio-custom" value="${optIndex}" ${isChecked ? 'checked' : ''} required></div>
                <input type="text" class="quiz-form-input flex-grow ml-2 option-text !p-1.5 !text-sm" placeholder="Option ${optIndex + 1}" value="${escapedText}" required>
                <button type="button" class="remove-option-btn text-gray-400 hover:text-red-500 ml-2 pt-1 flex-shrink-0" title="Remove Option"><i class="fa-solid fa-xmark"></i></button>
            </div>`;
        }


        async function loadQuestionsForEdit(quizId) {
            questionsContainer.innerHTML = ''; // Clear existing before loading
            try {
                const q = query(collection(db, `quizzes/${quizId}/questions`));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    console.log("No questions found for quiz, adding one empty.");
                    addQuestionElement(); // Add an empty one if none exist
                } else {
                    console.log(`Loading ${querySnapshot.size} questions for edit.`);
                    querySnapshot.forEach(doc => addQuestionElement(doc.data()));
                }
            } catch (error) {
                console.error("Error loading questions for edit:", error);
                showToast("Failed to load questions.", "error");
                questionsContainer.innerHTML = `<p class="text-red-500">Error loading questions.</p>`;
                 questionPlaceholder.classList.add('hidden'); // Hide placeholder even on error
            }
        }

        // --- Event Listener Functions ---
        const onSubjectFilterChange = () => { currentPage = 1; renderPage(); };
        const onAddQuizFabClick = () => openModal();
        const onCloseModalBtnClick = () => closeModal();
        // Quiz list edit clicks are handled directly in renderQuizList

        const onAddQuestionBtnClick = () => addQuestionElement();

        // Consolidated handler for clicks within questions container (delegation)
         const handleQuestionContainerClick = (e) => {
            const removeQuestionBtn = e.target.closest('.remove-question-btn');
            const removeOptionBtn = e.target.closest('.remove-option-btn');

            if (removeQuestionBtn) {
                 const questionCard = removeQuestionBtn.closest('.question-card');
                 if (questionsContainer.children.length > 1) {
                     questionCard.remove();
                     // Renumber remaining questions
                     Array.from(questionsContainer.children).forEach((card, index) => {
                         card.querySelector('h4').textContent = `Question ${index + 1}`;
                     });
                 } else {
                     showToast("A quiz must have at least one question.", "error");
                 }
            }

            if (removeOptionBtn) {
                const optionItem = removeOptionBtn.closest('.option-item');
                 const optionsContainer = optionItem.parentElement;
                 if (optionsContainer.children.length > 2) {
                     optionItem.remove();
                 } else {
                     showToast("A question must have at least two options.", "error");
                 }
            }

            // Show placeholder if no questions are left
             questionPlaceholder.classList.toggle('hidden', questionsContainer.children.length > 0);
        };


        // --- Submit, Delete, Import/Export --- (Mostly Unchanged, added logging)
        const onQuizFormSubmit = async (e) => {
            e.preventDefault();
            const quizId = quizIdInput.value;
            const isEditing = !!quizId;
            const saveBtn = document.getElementById('save-quiz-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> ${isEditing ? 'Updating...' : 'Saving...'}`;
            saveBtn.disabled = true;
             console.log(`Submitting quiz. Editing: ${isEditing}, ID: ${quizId}`);

            try {
                // Validate required fields early
                 if (!quizTitleInput.value.trim() || !subjectSelect.value) {
                     throw new Error("Quiz Title and Subject are required.");
                 }

                const quizData = {
                    title: quizTitleInput.value.trim(),
                    subjectId: subjectSelect.value,
                    coverImageUrl: coverImageUrlInput.value || null, // Get URL from hidden input
                };

                const questions = Array.from(document.querySelectorAll('#questions-container .question-card')).map((card, index) => {
                    const questionText = card.querySelector('.question-text').value.trim();
                    const options = Array.from(card.querySelectorAll('.option-text')).map(input => input.value.trim());
                    const correctRadio = card.querySelector('input[type="radio"]:checked');

                    card.style.borderColor = '#e5e7eb'; // Reset border

                    if (!questionText || options.some(opt => !opt) || !correctRadio) {
                         card.style.borderColor = '#ef4444'; // Highlight error
                        throw new Error(`Please complete all fields for Question ${index + 1}.`);
                    }
                    return { questionText, options, correctAnswerIndex: parseInt(correctRadio.value) };
                });

                if (questions.length === 0) throw new Error("A quiz must have at least one question.");

                quizData.questionCount = questions.length; // Add question count

                console.log("Quiz Data to save:", quizData);
                console.log("Questions to save:", questions);

                const batch = writeBatch(db);
                const quizRef = isEditing ? doc(db, 'quizzes', quizId) : doc(collection(db, 'quizzes')); // Generate new ID if not editing

                if (isEditing) {
                    batch.update(quizRef, quizData);
                    // Delete old questions before adding new ones
                     console.log(`Deleting old questions for quiz ${quizId}`);
                    const oldQuestionsSnapshot = await getDocs(collection(db, `quizzes/${quizId}/questions`));
                    oldQuestionsSnapshot.forEach(doc => batch.delete(doc.ref));
                     console.log(`Deleted ${oldQuestionsSnapshot.size} old questions.`);
                } else {
                    quizData.createdAt = serverTimestamp(); // Add timestamp for new quizzes
                    batch.set(quizRef, quizData);
                }

                // Add new questions (works for both add and edit)
                 console.log(`Adding ${questions.length} new questions to quiz ${quizRef.id}`);
                questions.forEach(qData => {
                    const questionRef = doc(collection(db, `quizzes/${quizRef.id}/questions`)); // Let Firestore generate question IDs
                    batch.set(questionRef, qData);
                });

                await batch.commit();
                console.log("Batch commit successful.");
                showToast(`Quiz successfully ${isEditing ? 'updated' : 'saved'}! 🥳`);
                closeModal();
                // Listener will auto-refresh the list (listenForQuizzes)

            } catch (error) {
                console.error("Error saving quiz:", error);
                showToast(error.message || "Failed to save quiz.", "error");
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        };

        const onDeleteQuizBtnClick = async () => { /* ... unchanged ... */ };
        const onCoverImageInputChange = async (e) => { /* ... unchanged (still uses mock) ... */ };
        const getQuizDataFromForm = () => { /* ... unchanged ... */ };
        const downloadJson = (data, filename) => { /* ... unchanged ... */ };
        const onExportJsonBtnClick = () => { /* ... unchanged ... */ };
        const loadFormFromQuizData = (data) => { /* ... unchanged ... */ };
        const onImportJsonBtnClick = () => jsonFileInput.click();
        const onJsonFileInputChange = (e) => { /* ... unchanged ... */ };

        // --- Add Listeners for Quiz Manager ---
        subjectFilter.addEventListener('change', onSubjectFilterChange);
        addQuizFab.addEventListener('click', onAddQuizFabClick);
        closeModalBtn.addEventListener('click', onCloseModalBtnClick);
        // Edit clicks handled in renderQuizList
        addQuestionBtn.addEventListener('click', onAddQuestionBtnClick);
         // Use event delegation for question/option removal
        questionsContainer.addEventListener('click', handleQuestionContainerClick);
        quizForm.addEventListener('submit', onQuizFormSubmit);
        deleteQuizBtn.addEventListener('click', onDeleteQuizBtnClick);
        coverImageInput.addEventListener('change', onCoverImageInputChange);
        exportJsonBtn.addEventListener('click', onExportJsonBtnClick);
        importJsonBtn.addEventListener('click', onImportJsonBtnClick);
        jsonFileInput.addEventListener('change', onJsonFileInputChange);

        // --- INIT ---
        (async () => {
             console.log("Quiz Manager: Fetching subjects...");
            await fetchAndRenderSubjects(); // Fetch subjects and populate dropdowns
             console.log("Quiz Manager: Starting quiz listener...");
            listenForQuizzes(); // Start listening for quiz data
        })();

        // --- Return Stop Function ---
        return {
            stop: () => {
                console.log("Stopping Quiz Manager");
                if (unsubscribeQuizListener) unsubscribeQuizListener();
                unsubscribeQuizListener = null;

                // Remove specific listeners added by this manager
                subjectFilter.removeEventListener('change', onSubjectFilterChange);
                addQuizFab.removeEventListener('click', onAddQuizFabClick);
                closeModalBtn.removeEventListener('click', onCloseModalBtnClick);
                addQuestionBtn.removeEventListener('click', onAddQuestionBtnClick);
                questionsContainer.removeEventListener('click', handleQuestionContainerClick); // Remove delegation listener
                quizForm.removeEventListener('submit', onQuizFormSubmit);
                deleteQuizBtn.removeEventListener('click', onDeleteQuizBtnClick);
                coverImageInput.removeEventListener('change', onCoverImageInputChange);
                exportJsonBtn.removeEventListener('click', onExportJsonBtnClick);
                importJsonBtn.removeEventListener('click', onImportJsonBtnClick);
                jsonFileInput.removeEventListener('change', onJsonFileInputChange);

                // Clear UI elements managed by this section
                if(quizListContainer) quizListContainer.innerHTML = '';
                if(paginationContainer) paginationContainer.innerHTML = '';
                 closeModal(); // Ensure modal is closed
            }
        };
    };
    // =========== QUIZ MANAGER END ================


    // =============================================
    // =========== USER MANAGER START ==============
    // =============================================
    const startUserManager = () => {
        console.log("Starting User Manager");
        // --- DOM ELEMENTS --- (Already defined globally)
        // userModal, confirmModal, userModalClose, cancelBtn, confirmCancelBtn, addUserBtn, userForm, userTableBody, searchInput, userFilterBtns, userSortBtns, adminUserListContainer, usersTotal, usersPaid, usersNotPaid, usersRevenue

        // --- STATE ---
        let allUsers = [];
        let unsubscribeUsers = null;
        let searchTimeout = null;
        let currentUsersFilter = 'all'; // 'all', 'paid', 'not_paid'
        let currentUsersSort = 'recent'; // 'recent', 'asc'

        // --- MODALS ---
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        // --- DATA & RENDERING ---
        function listenForUsers() {
            if (unsubscribeUsers) unsubscribeUsers(); // Stop previous listener

            const usersRef = collection(db, "users"); // Reference to the users collection
            console.log("Setting up Firestore listener for users...");
            unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                 console.log(`Received ${snapshot.size} users from listener.`);
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUsers(); // Re-render table with current filters/sort
                updateUserStats(); // Update stats cards
            }, error => {
                console.error("Error fetching users:", error);
                showToast("Error loading user data.", "error");
                if (userTableBody) userTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading users.</td></tr>`;
                if (adminUserListContainer && currentActiveTab === 'users-roles') adminUserListContainer.innerHTML = `<p class="text-center text-red-500">Error loading admin users.</p>`;
            });
        }

        function renderUsers() {
             if (!userTableBody) return; // Ensure table body exists
            userTableBody.innerHTML = ''; // Clear existing table
            const searchTerm = searchUserInput.value.toLowerCase();

            // Filter
            let filteredUsers = allUsers.filter(user => user.role !== 'admin'); // Exclude admins from main list
            if (currentUsersFilter === 'paid') {
                filteredUsers = filteredUsers.filter(user => user.paymentStatus === 'paid');
            } else if (currentUsersFilter === 'not_paid') {
                filteredUsers = filteredUsers.filter(user => user.paymentStatus !== 'paid');
            }
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user =>
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.phone && user.phone.includes(searchTerm))
                );
            }

            // Sort
             filteredUsers.sort((a, b) => {
                 if (currentUsersSort === 'asc') {
                     return (a.name || '').localeCompare(b.name || '');
                 } else { // 'recent' or default
                     const timeA = a.createdAt?.toMillis() || 0;
                     const timeB = b.createdAt?.toMillis() || 0;
                     return timeB - timeA; // Descending
                 }
             });

             console.log(`Rendering user table. Filter: ${currentUsersFilter}, Sort: ${currentUsersSort}, Search: "${searchTerm}", Count: ${filteredUsers.length}`);


            if (filteredUsers.length === 0) {
                userTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No users found matching criteria.</td></tr>`;
                return;
            }

            filteredUsers.forEach(user => {
                const isBanned = user.banned || false;
                 const paymentStatus = user.paymentStatus === 'paid';
                const tr = document.createElement('tr');
                 tr.className = `border-b hover:bg-gray-50 ${isBanned ? 'opacity-50 bg-red-50' : ''}`;
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-medium text-gray-800">${user.name || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${user.email || 'N/A'}</div>
                    </td>
                    <td class="p-4 text-sm text-gray-600">${user.phone ? `${user.phone}` : 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-600 capitalize">${user.role || 'student'}</td>
                    <td class="p-4">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${paymentStatus ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${paymentStatus ? 'Paid' : 'Not Paid'}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="flex space-x-1">
                            <button class="edit-user-btn p-1 text-indigo-600 hover:text-indigo-900" data-id="${user.id}" title="Edit User"> <i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i> </button>
                            <button class="delete-user-btn p-1 text-red-600 hover:text-red-900" data-id="${user.id}" title="Delete User"> <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i> </button>
                            <button class="ban-user-btn p-1 ${isBanned ? 'text-green-600 hover:text-green-800' : 'text-yellow-600 hover:text-yellow-800'}" data-id="${user.id}" data-banned="${isBanned}" title="${isBanned ? 'Unban User' : 'Ban User'}">
                                <i data-lucide="${isBanned ? 'rotate-ccw' : 'ban'}" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                             <button class="toggle-payment-btn p-1 ${paymentStatus ? 'text-red-600 hover:text-red-800' : 'text-green-600 hover:text-green-800'}" data-id="${user.id}" data-current="${paymentStatus}" title="${paymentStatus ? 'Mark as Not Paid' : 'Mark as Paid'}">
                                <i data-lucide="dollar-sign" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                        </div>
                    </td>
                `;
                userTableBody.appendChild(tr);
            });
            lucide.createIcons(); // Redraw icons
        }

         function renderAdminList() { // Used for the Roles tab
             if (!adminUserListContainer) return;
             adminUserListContainer.innerHTML = '';
             const adminUsers = allUsers.filter(user => user.role === 'admin');

             if (adminUsers.length === 0) {
                 adminUserListContainer.innerHTML = `<p class="text-center text-gray-500">No administrator accounts found.</p>`;
                 return;
             }
             adminUsers.forEach(admin => {
                 const div = document.createElement('div');
                 div.className = "flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg";
                 div.innerHTML = `
                    <div>
                        <p class="font-semibold text-blue-800">${admin.name || 'Admin User'}</p>
                        <p class="text-sm text-blue-600">${admin.email}</p>
                    </div>
                    <span class="text-sm font-medium text-blue-700 capitalize">${admin.role}</span>
                `;
                 adminUserListContainer.appendChild(div);
             });
         }


        function updateUserStats() {
            const nonAdminUsers = allUsers.filter(user => user.role !== 'admin');
            const paidCount = nonAdminUsers.filter(user => user.paymentStatus === 'paid').length;
            const totalRevenue = paidCount * 5; // Assuming $5 per paid user

            if (usersTotal) usersTotal.textContent = nonAdminUsers.length;
            if (usersPaid) usersPaid.textContent = paidCount;
            if (usersNotPaid) usersNotPaid.textContent = nonAdminUsers.length - paidCount;
            if (usersRevenue) usersRevenue.textContent = `$${totalRevenue}`;
        }

        // --- CRUD Operations ---
        async function showUserModal(userId = null) {
            userForm.reset();
            userIdInput.value = ''; // Clear hidden ID input
            userEmailInput.disabled = false; // Enable email for adding
            if (userId) {
                // Edit mode
                userModalTitle.textContent = 'Edit User';
                const user = allUsers.find(u => u.id === userId); // Use cache
                if (user) {
                    userIdInput.value = userId;
                    userNameInput.value = user.name || '';
                    userEmailInput.value = user.email || '';
                    userEmailInput.disabled = true; // Disable email editing
                    userPhoneInput.value = user.phone ? user.phone.replace(/^252/, '') : ''; // Remove prefix for display
                } else {
                    showToast('User not found in cache.', "error"); return;
                }
            } else {
                // Add mode
                userModalTitle.textContent = 'Add New User';
            }
            openModal(userModal);
        }

        async function handleUserFormSubmit(e) { /* ... unchanged ... */ } // Uses global showToast, addDoc, updateDoc, serverTimestamp, doc
        async function deleteUser(userId) { /* ... unchanged ... */ } // Uses global showToast, deleteDoc, doc
        async function toggleBanUser(userId, currentBanStatus) {
            const newBanStatus = !currentBanStatus;
            try {
                await updateDoc(doc(db, "users", userId), { banned: newBanStatus });
                showToast(`User ${newBanStatus ? 'banned' : 'unbanned'} successfully!`);
                // Listener will update UI
            } catch (error) {
                console.error("Error toggling ban status:", error);
                showToast(`Error updating ban status: ${error.message}`, "error");
            }
        }
         async function togglePaymentStatus(userId, currentPaymentStatus) {
             const newPaymentStatus = currentPaymentStatus ? 'not_paid' : 'paid'; // Toggle the string status
             try {
                 await updateDoc(doc(db, "users", userId), { paymentStatus: newPaymentStatus });
                 showToast(`User payment status updated to ${newPaymentStatus}!`);
                 // Listener will update UI
             } catch (error) {
                 console.error("Error toggling payment status:", error);
                 showToast(`Error updating payment status: ${error.message}`, "error");
             }
         }


        // Generic Confirmation Modal (used by User Manager)
        let confirmActionCallback = null;
        function showConfirmModal(title, message, onConfirm, isDanger = false) { /* ... unchanged ... */ } // Uses confirmActionModal, confirmTitle, confirmMessage, confirmIcon, confirmActionBtn, hideConfirmModal
        function hideConfirmModal() { /* ... unchanged ... */ } // Uses confirmActionModal


        // --- Event Listener Functions ---
        const onAddUserBtnClick = () => showUserModal();
        const onUserModalCloseClick = () => closeModal(userModal);
        const onUserCancelBtnClick = () => closeModal(userModal);
        const onConfirmCancelBtnClick = () => hideConfirmModal();

        const handleUserTableClick = (e) => {
            const editButton = e.target.closest('.edit-user-btn');
            const deleteButton = e.target.closest('.delete-user-btn');
            const banButton = e.target.closest('.ban-user-btn');
            const paymentButton = e.target.closest('.toggle-payment-btn');


            if (editButton) { showUserModal(editButton.dataset.id); }
            if (deleteButton) {
                 const userId = deleteButton.dataset.id;
                showConfirmModal('Delete User', 'Are you sure? This action cannot be undone.', () => deleteUser(userId), true);
            }
            if (banButton) {
                 const userId = banButton.dataset.id;
                 const isBanned = banButton.dataset.banned === 'true';
                 showConfirmModal(
                     isBanned ? 'Unban User' : 'Ban User',
                     `Are you sure you want to ${isBanned ? 'unban' : 'ban'} this user?`,
                     () => toggleBanUser(userId, isBanned),
                     !isBanned // Danger=true if banning, false if unbanning
                 );
            }
             if (paymentButton) {
                const userId = paymentButton.dataset.id;
                const isPaid = paymentButton.dataset.current === 'true';
                 showConfirmModal(
                     isPaid ? 'Mark as Not Paid' : 'Mark as Paid',
                     `Update payment status for this user?`,
                     () => togglePaymentStatus(userId, isPaid),
                     false // Not a destructive action
                 );
            }
        };

        const handleUserFilterClick = (e) => {
             userFilterBtns.forEach(btn => btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'active')); // Use 'active' class
             e.target.classList.add('bg-indigo-100', 'text-indigo-700', 'active');
            currentUsersFilter = e.target.dataset.filter;
            renderUsers(); // Re-render with new filter
        };
        const handleUserSortClick = (e) => {
             userSortBtns.forEach(btn => btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'active'));
             e.target.classList.add('bg-indigo-100', 'text-indigo-700', 'active');
            currentUsersSort = e.target.dataset.sort;
            renderUsers(); // Re-render with new sort
        };
        const handleSearchInput = (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(renderUsers, 300); // Debounce search input
        };

        // --- Add Listeners ---
        addUserBtn.addEventListener('click', onAddUserBtnClick);
        userModalCloseBtn.addEventListener('click', onUserModalCloseClick);
        userCancelBtn.addEventListener('click', onUserCancelBtnClick);
        userForm.addEventListener('submit', handleUserFormSubmit);
        confirmCancelBtn.addEventListener('click', onConfirmCancelBtnClick);
        // Action button listener is added dynamically in showConfirmModal
        searchUserInput.addEventListener('input', handleSearchInput);
        userFilterBtns.forEach(btn => btn.addEventListener('click', handleUserFilterClick));
        userSortBtns.forEach(btn => btn.addEventListener('click', handleUserSortClick));
        userTableBody.addEventListener('click', handleUserTableClick); // Use event delegation for buttons

        // --- Initial Fetch ---
        listenForUsers(); // Start listening

        // --- Return Stop Function ---
        return {
            stop: () => {
                 console.log("Stopping User Manager");
                if (unsubscribeUsers) unsubscribeUsers();
                unsubscribeUsers = null;
                // Remove listeners added by this manager
                addUserBtn.removeEventListener('click', onAddUserBtnClick);
                userModalCloseBtn.removeEventListener('click', onUserModalCloseClick);
                userCancelBtn.removeEventListener('click', onUserCancelBtnClick);
                userForm.removeEventListener('submit', handleUserFormSubmit);
                confirmCancelBtn.removeEventListener('click', onConfirmCancelBtnClick);
                searchUserInput.removeEventListener('input', handleSearchInput);
                userFilterBtns.forEach(btn => btn.removeEventListener('click', handleUserFilterClick));
                userSortBtns.forEach(btn => btn.removeEventListener('click', handleUserSortClick));
                userTableBody.removeEventListener('click', handleUserTableClick);
                 // Clear table and stats
                 if (userTableBody) userTableBody.innerHTML = '';
                 updateUserStats([]); // Clear stats
            }
        };
    };
    // =========== USER MANAGER END ================


    // =============================================
    // =========== BLOG MANAGER START ==============
    // =============================================
    // Note: Blog uses separate state variables (allPosts, allComments, etc.)
    // and specific listeners (unsubscribePosts, etc.)

    // --- BLOG: Listeners ---
    let unsubscribePosts = () => {};
    let unsubscribeComments = () => {};
    let unsubscribeCategories = () => {};

     function initPostsListener() {
         if (unsubscribePosts && typeof unsubscribePosts === 'function') unsubscribePosts(); // Stop previous listener
         console.log("Initializing Blog Posts listener...");
         const q = query(postsCollection, orderBy("createdAt", "desc"));
         unsubscribePosts = onSnapshot(q, (snapshot) => {
             allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             console.log(`Received ${allPosts.length} blog posts.`);
             if (currentActiveTab === 'list-posts') renderPostsTable(); // Only render if tab is active
             if (currentActiveTab === 'analytics') renderAnalytics(); // Update analytics if active
         }, error => {
             console.error("Error fetching blog posts: ", error);
             showToast("Error fetching blog posts.", "error");
             if (postsTableBody && currentActiveTab === 'list-posts') postsTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">Error loading posts.</td></tr>`;
         });
     }

     function initCommentsListener() {
        if (unsubscribeComments && typeof unsubscribeComments === 'function') unsubscribeComments();
        console.log("Initializing Blog Comments listener...");
        const q = query(commentsCollection, orderBy("createdAt", "desc"));
        unsubscribeComments = onSnapshot(q, (snapshot) => {
            allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             console.log(`Received ${allComments.length} blog comments.`);
            if (currentActiveTab === 'comments') renderCommentsList(); // Only render if tab is active
             if (currentActiveTab === 'analytics') renderAnalytics(); // Update analytics if active
        }, error => {
            console.error("Error fetching comments: ", error);
            showToast("Error fetching comments.", "error");
            if (commentsListView && currentActiveTab === 'comments') commentsListView.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center text-red-500">Error loading comments.</div>`;
        });
    }

    function initCategoriesListener(onUpdateCallback = null) {
        if (unsubscribeCategories && typeof unsubscribeCategories === 'function') unsubscribeCategories();
         console.log("Initializing Blog Categories listener...");
        const q = query(categoriesCollection, orderBy("name"));
        unsubscribeCategories = onSnapshot(q, (snapshot) => {
            availableBlogCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Update global cache too
             console.log(`Received ${availableBlogCategories.length} blog categories.`);
            updateBlogCategoryDropdowns(); // Update all relevant dropdowns
            if (onUpdateCallback && typeof onUpdateCallback === 'function' && currentActiveTab === 'categories') {
                 onUpdateCallback(); // e.g., renderCategoriesList if on categories tab
            }
        }, error => {
            console.error("Error fetching categories: ", error);
            showToast("Error fetching categories.", "error");
            if (categoriesList && onUpdateCallback && currentActiveTab === 'categories') {
                categoriesList.innerHTML = `<li class="p-6 text-center text-red-500">Error loading categories.</li>`;
            }
        });
    }

    async function fetchAllDataForAnalytics() {
        // This function might be redundant if listeners are always active,
        // but can be useful for initial load or manual refresh.
         console.log("Fetching all blog data for analytics...");
        try {
            const postSnapshot = await getDocs(postsCollection);
            allPosts = postSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const commentSnapshot = await getDocs(commentsCollection);
            allComments = commentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Categories are likely already fetched by their listener
            renderAnalytics(); // Render stats
        } catch (error) {
            console.error("Error fetching analytics data:", error);
            showToast("Error fetching analytics data.", "error");
        }
    }


    // --- BLOG: Init Libs ---
    function initBlogLibs() {
         console.log("Initializing Blog Libraries (Quill, Tagify, Flatpickr)...");
         if (!quill && document.getElementById('quill-editor')) {
             quill = new Quill('#quill-editor', {
                 theme: 'snow',
                 modules: { toolbar: [
                     [{ 'header': [1, 2, 3, false] }],
                     ['bold', 'italic', 'underline', 'strike'],
                     [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                     ['link', 'image', 'video', 'code-block'],
                     ['clean']
                 ]}
             });
         }
         if (!tagify && document.getElementById('post-tags')) {
             const tagsInput = document.getElementById('post-tags');
             tagify = new Tagify(tagsInput);
         }
         if (!schedulePicker && document.getElementById('post-schedule-date')) {
            schedulePicker = flatpickr("#post-schedule-date", { enableTime: true, dateFormat: "Y-m-d H:i" });
         }
    }

    // --- BLOG: Rendering Functions ---
     function renderPostsTable() { /* ... unchanged ... */ } // Uses allPosts, filterCategorySelect, filterStatusSelect, searchPostsInput, formatDate, showPostForm, showShareModal, showDeleteModal
     function renderCommentsList() { /* ... unchanged ... */ } // Uses allComments, allPosts, searchCommentsInput, filterCommentStatusSelect, formatDate, updateCommentStatus, deleteComment, showReplyModal
     function renderCategoriesList() { /* ... unchanged ... */ } // Uses availableBlogCategories, categoriesList
     function updateBlogCategoryDropdowns() { /* ... unchanged ... */ } // Uses availableBlogCategories, filterCategorySelect, postCategorySelect
     function renderAnalytics() { /* ... unchanged ... */ } // Uses allPosts, allComments


    // --- BLOG: Form Handling & Actions ---
    async function showPostForm(postId = null) { /* ... unchanged ... */ } // Uses blogPostForm, quill, tagify, imagePreview, attachmentList, postIdInput, postFormTitle, db, doc, getDoc, Timestamp, schedulePicker, showToast, showTab
    async function handleBlogPostFormSubmit(e) { /* ... unchanged ... */ } // Uses blogPostForm, quill, tagify, imagePreview, attachmentList, postStatusSelect, schedulePicker, postIdInput, editingPostId, currentUser, db, doc, updateDoc, addDoc, serverTimestamp, Timestamp, showToast, showTab
    async function handleImageUpload(file) { /* ... unchanged ... */ } // Uses mockUploadFile, imagePreview, imagePreviewWrapper, showToast
    function addAttachmentToList(fileName, fileUrl) { /* ... unchanged ... */ } // Uses attachmentList, lucide
    async function handleAttachmentUpload(files) { /* ... unchanged ... */ } // Uses mockUploadFile, addAttachmentToList, showToast
    function showDeleteModal(postId) { /* ... unchanged ... */ } // Uses postToDeleteId, deleteModal
    async function confirmDelete() { /* ... unchanged ... */ } // Uses postToDeleteId, db, writeBatch, doc, query, commentsCollection, where, getDocs, showToast, deleteModal
    async function updateCommentStatus(commentId, newStatus) { /* ... unchanged ... */ } // Uses db, doc, updateDoc, showToast
    async function deleteComment(commentId) { /* ... unchanged ... */ } // Uses db, doc, deleteDoc, showToast
    function showReplyModal(commentId) { /* ... unchanged ... */ } // Uses allComments, commentToReplyId, replyModal, replyForm
    async function handleReplySubmit(e) { /* ... unchanged ... */ } // Uses replyForm, commentToReplyId, db, doc, updateDoc, showToast, replyModal
    function showShareModal(postId, postTitle) { /* ... unchanged ... */ } // Uses shareModal, lucide


    // --- BLOG: Event Listeners Setup ---
    function setupBlogEventListeners() {
         console.log("Setting up Blog specific event listeners...");
        // Add New button in list view
        if (addNewBtnMain) addNewBtnMain.addEventListener('click', () => {
            editingPostId = null; // Ensure add mode
            showPostForm(); // Show the blank form
        });

        // List View Filters & Select All
        if (searchPostsInput) searchPostsInput.addEventListener('input', renderPostsTable);
        if (filterCategorySelect) filterCategorySelect.addEventListener('change', renderPostsTable);
        if (filterStatusSelect) filterStatusSelect.addEventListener('change', renderPostsTable);
        if (selectAllCheckbox) selectAllCheckbox.addEventListener('change', (e) => {
            if(postsTableBody) postsTableBody.querySelectorAll('.post-checkbox').forEach(checkbox => { checkbox.checked = e.target.checked; });
        });

        // List View Table Actions (Delegation)
         if (postsTableBody) postsTableBody.addEventListener('click', e => {
             const viewBtn = e.target.closest('.view-btn');
             const editBtn = e.target.closest('.edit-btn');
             const shareBtn = e.target.closest('.share-btn');
             const deleteBtn = e.target.closest('.delete-btn');
             if (viewBtn) window.open(`/blog/post/${viewBtn.dataset.id}`, '_blank'); // Adjust URL if needed
             if (editBtn) showPostForm(editBtn.dataset.id);
             if (shareBtn) showShareModal(shareBtn.dataset.id, shareBtn.dataset.title);
             if (deleteBtn) showDeleteModal(deleteBtn.dataset.id);
         });

         // Delete Modal Buttons
         if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', confirmDelete);
         if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => deleteModal.style.display = 'none');

         // Share Modal Buttons
         if (cancelShareBtn) cancelShareBtn.addEventListener('click', () => shareModal.style.display = 'none');
         if (copyUrlBtn) copyUrlBtn.addEventListener('click', () => {
             const urlInput = document.getElementById('share-post-url');
             urlInput.select(); urlInput.setSelectionRange(0, 99999);
             try { document.execCommand('copy'); showToast("URL copied!"); }
             catch (err) { console.error('Copy failed:', err); showToast("Failed to copy.", true); }
         });

         // Post Form Submit & Save Draft
         if (blogPostForm) blogPostForm.addEventListener('submit', handleBlogPostFormSubmit);
         const saveDraftBtn = document.getElementById('save-draft-btn');
         if (saveDraftBtn) saveDraftBtn.addEventListener('click', () => {
             postStatusSelect.value = "Draft"; // Set status
             // Simulate form submit event
             blogPostForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
         });
         if (postStatusSelect) postStatusSelect.addEventListener('change', e => {
             scheduleDateWrapper.classList.toggle('hidden', e.target.value !== 'Scheduled');
             const pubBtn = document.getElementById('publish-btn');
             if (pubBtn) pubBtn.textContent = e.target.value === 'Scheduled' ? 'Schedule' : 'Publish';
         });

         // Image Upload
         if (imageDropzone) imageDropzone.addEventListener('click', () => imageInput.click());
         if (imageInput) imageInput.addEventListener('change', e => handleImageUpload(e.target.files[0]));
         if (removeImageBtn) removeImageBtn.addEventListener('click', () => {
             imageInput.value = ''; imagePreview.src = '#'; imagePreviewWrapper.classList.add('hidden');
         });

         // Attachment Upload
         if (attachmentDropzone) attachmentDropzone.addEventListener('click', () => attachmentInput.click());
         if (attachmentInput) attachmentInput.addEventListener('change', e => handleAttachmentUpload(e.target.files));

        // Comments View Filters
        if (searchCommentsInput) searchCommentsInput.addEventListener('input', renderCommentsList);
        if (filterCommentStatusSelect) filterCommentStatusSelect.addEventListener('change', renderCommentsList);

        // Comments List Actions (Delegation)
        if (commentsListView) commentsListView.addEventListener('click', e => {
             const target = e.target.closest('button'); if (!target) return;
             const id = target.dataset.id;
             if (target.classList.contains('approve-comment-btn')) updateCommentStatus(id, 'Approved');
             if (target.classList.contains('spam-comment-btn')) updateCommentStatus(id, 'Spam');
             if (target.classList.contains('delete-comment-btn')) {
                 if(confirm("Delete this comment?")) deleteComment(id);
             }
             if (target.classList.contains('reply-comment-btn')) showReplyModal(id);
         });

        // Reply Modal
        if (replyForm) replyForm.addEventListener('submit', handleReplySubmit);
        if (cancelReplyBtn) cancelReplyBtn.addEventListener('click', () => replyModal.style.display = 'none');

        // Category Management
        if (addCategoryForm) addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('new-category-name');
            const categoryName = nameInput.value.trim();
            const btn = document.getElementById('add-category-btn');
            if (categoryName && btn) {
                 btn.disabled = true; btn.textContent = "Adding...";
                 // Check if category already exists (case-insensitive)
                 if (availableBlogCategories.find(cat => cat.name.toLowerCase() === categoryName.toLowerCase())) {
                     showToast("Category already exists.", "error");
                 } else {
                     try {
                         await addDoc(categoriesCollection, { name: categoryName, createdAt: serverTimestamp() }); // Add timestamp
                         showToast("Category added!"); nameInput.value = '';
                     } catch (error) { console.error("Error adding category:", error); showToast("Error adding category.", "error"); }
                 }
                 btn.disabled = false; btn.textContent = "Add Category";
            }
        });
        if (categoriesList) categoriesList.addEventListener('click', async (e) => {
            const deleteCatBtn = e.target.closest('.delete-category-btn');
            if (deleteCatBtn) {
                const id = deleteCatBtn.dataset.id;
                 if (confirm("Delete category? Posts using it won't be updated automatically.")) {
                     try {
                         await deleteDoc(doc(db, "blogCategories", id)); showToast("Category deleted.");
                     } catch (error) { console.error("Error deleting category:", error); showToast("Error deleting category.", "error"); }
                 }
            }
        });
    } // --- End of setupBlogEventListeners ---

    // =========== BLOG MANAGER END ================


    // --- Global App Object (for inline onclicks) ---
    window.app = {
        // CRUD actions
        editItem: (type, id) => {
             let item = null;
             // Find item in respective cache
             if (type === 'subjects') item = availableSubjects.find(i => i.id === id);
             else if (type === 'exams') item = availableExams.find(i => i.id === id);
             else if (type === 'generalBooks') item = availableGeneralBooks.find(i => i.id === id);
             // Blog items handled differently if needed, but standard CRUD might work
             else if (type === 'blogCategories') item = availableBlogCategories.find(i => i.id === id);
             // Add other types as needed

             if (item && managers[type]) {
                 managers[type].handleEdit(item);
             } else {
                 console.error(`Cannot edit: Item ${id} of type ${type} not found or manager missing.`);
                 showToast("Could not find item data to edit.", "error");
             }
        },
        deleteItem: (type, id) => {
            if (managers[type]) {
                managers[type].handleDelete(id);
            } else {
                 console.error(`Cannot delete: Manager for type ${type} not found.`);
            }
        },
        // PDF Library actions
        copyToClipboard: async (path) => {
            try {
                const url = await getDownloadURL(ref(storage, path));
                navigator.clipboard.writeText(url);
                showToast("Download URL copied!");
            } catch (error) {
                console.error("Error getting/copying download URL:", error);
                showToast("Could not copy URL.", "error");
            }
        },
        deletePdf: async (path) => { /* ... unchanged ... */ },
        // Assign Modals actions
        openAssignModal: (type, id, field, name) => { openAssignModal(type, id, field, name); },
        assignPdf: (path) => { assignPdf(path); },
        openAssignPdfToContentModal: (path, name) => { openAssignPdfToContentModal(path, name); },
        assignPdfToContent: (type, id, field) => { assignPdfToContent(type, id, field); }
    };

    // --- Initial call to setup icons ---
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM Loaded, creating initial icons.");
         lucide.createIcons();
         // Authentication state will trigger initializeAppLogic or show login page
     });

</script>
</body>
</html>
