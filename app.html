<!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            getDoc, 
            addDoc, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            serverTimestamp,
            query,
            where,
            orderBy,
            writeBatch,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Note: Firebase Storage is NOT imported. File uploads are mocked.
        
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        // DO NOT use this config in production
        // This is a placeholder config.
        const firebaseConfig = {
            apiKey: "AIzaSyDuqswofpquk8aUbCOZCGjdYLUivBEh7a8",
            authDomain: "ardaycaawiye-18b89.firebaseapp.com",
            projectId: "ardaycaawiye-18b89",
            storageBucket: "ardaycaawiye-18b89.firebasestorage.app",
            messagingSenderId: "590874185284",
            appId: "1:590874185284:web:6ee7df602c45068e38b611",
            measurementId: "G-SBGSTJWDMR"
        };
        // -----------------------------------------

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const postsCollection = collection(db, "blogPosts"); // Collection for posts
        const commentsCollection = collection(db, "blogComments"); // Separate collection for comments
        const categoriesCollection = collection(db, "blogCategories"); // NEW: Collection for categories

        // --- Global State ---
        let currentView = 'list-posts';
        let editingPostId = null;
        let postToDeleteId = null;
        let commentToReplyId = null;
        let allPosts = []; // Local cache for posts
        let allComments = []; // Local cache for comments
        let allCategories = []; // NEW: Local cache for categories
        let unsubscribePosts = () => {}; // Function to stop the posts listener
        let unsubscribeComments = () => {}; // Function to stop the comments listener
        let unsubscribeCategories = () => {}; // NEW: Function to stop the categories listener

        // --- Lib Instances ---
        let quill, tagify, schedulePicker;

        // --- DOM Elements ---
        const views = document.querySelectorAll('.app-view');
        const sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
        const postsTableBody = document.getElementById('posts-table-body');
        const postFormView = document.getElementById('post-form-view'); // Renamed view
        const postForm = document.getElementById('blog-post-form');
        const postFormTitle = document.getElementById('form-title');
        const postIdInput = document.getElementById('post-id');
        const postTitleInput = document.getElementById('post-title');
        const postStatusSelect = document.getElementById('post-status');
        const scheduleDateWrapper = document.getElementById('schedule-date-wrapper');
        const postCategorySelect = document.getElementById('post-category');
        const filterCategorySelect = document.getElementById('filter-category');
        const imageDropzone = document.getElementById('image-dropzone');
        const imageInput = document.getElementById('post-image');
        const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const attachmentDropzone = document.getElementById('attachment-dropzone');
        const attachmentInput = document.getElementById('post-attachments');
        const attachmentList = document.getElementById('attachment-list');
        const commentsListView = document.getElementById('comments-list');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const replyModal = document.getElementById('reply-modal');
        const replyForm = document.getElementById('reply-form');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const shareModal = document.getElementById('share-modal'); // NEW
        const cancelShareBtn = document.getElementById('cancel-share-btn'); // NEW
        const copyUrlBtn = document.getElementById('copy-url-btn'); // NEW
        const toast = document.getElementById('toast');
        const selectAllCheckbox = document.getElementById('select-all-posts');
        const categoriesList = document.getElementById('categories-list'); // NEW
        const addCategoryForm = document.getElementById('add-category-form'); // NEW
        const sidebar = document.getElementById('sidebar'); // NEW
        const menuToggle = document.getElementById('menu-toggle'); // NEW
        const closeMenuBtn = document.getElementById('close-menu-btn'); // NEW
        const mobileViewTitle = document.getElementById('mobile-view-title'); // NEW

        // =============================================
        // Initialization
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            initLibs();
            setupEventListeners();
            showView('list-posts'); // Start on the main page
            lucide.createIcons();
        });

        function initLibs() {
            quill = new Quill('#quill-editor', {
                theme: 'snow',
                modules: { toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image', 'video', 'code-block'],
                    ['clean']
                ]}
            });
            
            const tagsInput = document.getElementById('post-tags');
            tagify = new Tagify(tagsInput);
            
            schedulePicker = flatpickr("#post-schedule-date", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
            });
        }
        
        // =============================================
        // Toast Notification Utility
        // =============================================
        function showToast(message, isError = false) {
            toast.textContent = message;
            // Use descriptive classes for toast position and appearance
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform ${isError ? 'toast-error' : 'toast-success'}`;
            toast.classList.add('show');
            
            // Set timeout to hide the toast
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // =============================================
        // Mock File Upload (!!! IMPORTANT !!!)
        // =============================================
        async function mockUploadFile(file) {
            showToast(`Simulating upload for ${file.name}...`);
            await new Promise(resolve => setTimeout(resolve, 1500));
            // Create a mock URL
            const mockUrl = `https://mockstorage.com/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
            console.log(`Mock Upload: ${file.name} -> ${mockUrl}`);
            showToast(`Upload complete for ${file.name}!`);
            return { name: file.name, url: mockUrl };
        }

        // =============================================
        // Navigation / View Switching
        // =============================================
        function showView(viewId) {
            // Stop all active listeners
            unsubscribePosts();
            unsubscribeComments();
            unsubscribeCategories();

            views.forEach(view => view.classList.remove('active'));
            const newView = document.getElementById(viewId);
            if (newView) {
                newView.classList.add('active');
            }

            // Handle 'add-post' view which is inside 'post-form-view'
            if (viewId === 'add-post') {
                document.getElementById('post-form-view').classList.add('active');
                showPostForm(); // Special case for "Add New"
            }

            sidebarLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-link[data-view="${viewId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                mobileViewTitle.textContent = activeLink.textContent.trim(); // Update mobile title
            }
            
            // Start listeners for the new view
            if (viewId === 'list-posts') {
                initPostsListener();
                initCategoriesListener(); // Need categories for filter
            } else if (viewId === 'comments') {
                initPostsListener(); // Need posts data for comment context
                initCommentsListener();
            } else if (viewId === 'analytics') {
                fetchAllDataForAnalytics();
            } else if (viewId === 'categories') {
                initCategoriesListener(renderCategoriesList); // Pass render callback
            } else if (viewId === 'add-post') {
                initCategoriesListener(); // Need categories for dropdown
            }
        }

        // =============================================
        // Data Listeners
        // =============================================
        
        function initPostsListener() {
            unsubscribePosts = onSnapshot(query(postsCollection, orderBy("createdAt", "desc")), (snapshot) => {
                allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPostsTable(); // Re-render table on any change
            }, error => {
                console.error("Error fetching posts: ", error);
                showToast("Error fetching posts.", true);
                postsTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">Error loading posts.</td></tr>`;
            });
        }
        
        function initCommentsListener() {
            unsubscribeComments = onSnapshot(query(commentsCollection, orderBy("date", "desc")), (snapshot) => {
                allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCommentsList(); // Re-render comments on any change
            }, error => {
                console.error("Error fetching comments: ", error);
                showToast("Error fetching comments.", true);
                commentsListView.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center text-red-500">Error loading comments.</div>`;
            });
        }

        // NEW: Categories Listener
        function initCategoriesListener(onUpdateCallback = null) {
            unsubscribeCategories = onSnapshot(query(categoriesCollection, orderBy("name")), (snapshot) => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCategoryDropdowns();
                if (onUpdateCallback) {
                    onUpdateCallback(); // e.g., renderCategoriesList
                }
            }, error => {
                console.error("Error fetching categories: ", error);
                showToast("Error fetching categories.", true);
                if (onUpdateCallback) { // Show error in categories list if visible
                    categoriesList.innerHTML = `<li class="p-6 text-center text-red-500">Error loading categories.</li>`;
                }
            });
        }
        
        async function fetchAllDataForAnalytics() {
            try {
                const postSnapshot = await getDocs(postsCollection);
                allPosts = postSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const commentSnapshot = await getDocs(commentsCollection);
                allComments = commentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // NEW: Fetch categories for analytics if needed (though not used in cards)
                const categorySnapshot = await getDocs(categoriesCollection);
                allCategories = categorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderAnalytics();
            } catch (error) {
                console.error("Error fetching analytics data:", error);
                showToast("Error fetching analytics data.", true);
            }
        }

        // =============================================
        // Render Functions (Dynamic)
        // =============================================
        function renderPostsTable() {
            postsTableBody.innerHTML = ''; // Clear table
            
            const search = document.getElementById('search-posts').value.toLowerCase();
            const category = filterCategorySelect.value;
            const status = document.getElementById('filter-status').value;

            let filteredPosts = allPosts.filter(post => {
                return (post.title.toLowerCase().includes(search) || (post.author || '').toLowerCase().includes(search)) &&
                       (category === '' || post.category === category) &&
                       (status === '' || post.status === status);
            });
            
            if (filteredPosts.length === 0) {
                postsTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">No posts found matching criteria.</td></tr>`;
                return;
            }

            filteredPosts.forEach(post => {
                const statusColors = {
                    Published: "bg-green-100 text-green-800",
                    Draft: "bg-yellow-100 text-yellow-800",
                    Scheduled: "bg-blue-100 text-blue-800"
                };
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="post-checkbox" data-id="${post.id}"></td>
                    <td class="p-4">
                        <div class="font-medium text-gray-800">${post.title}</div>
                        <div class="text-sm text-gray-500">${(post.tags || []).join(', ')}</div>
                    </td>
                    <td class="p-4 text-sm text-gray-600">${post.author || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-600">${post.category || 'Uncategorized'}</td>
                    <td class="p-4">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColors[post.status] || 'bg-gray-100 text-gray-800'}">
                            ${post.status}
                        </span>
                    </td>
                    <td class="p-4 text-sm text-gray-600">
                        ${post.publishDate ? new Date(post.publishDate.toDate()).toLocaleDateString() : '—'}
                    </td>
                    <td class="p-4">
                        <div class="flex space-x-2">
                            <!-- NEW: View Button -->
                            <button class="view-btn p-1 text-blue-600 hover:text-blue-900" data-id="${post.id}" title="View Post">
                                <i data-lucide="eye" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <button class="edit-btn p-1 text-indigo-600 hover:text-indigo-900" data-id="${post.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                             <!-- NEW: Share Button -->
                            <button class="share-btn p-1 text-green-600 hover:text-green-900" data-id="${post.id}" data-title="${post.title}" title="Share">
                                <i data-lucide="share-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <button class="delete-btn p-1 text-red-600 hover:text-red-900" data-id="${post.id}" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                        </div>
                    </td>
                `;
                postsTableBody.appendChild(tr);
            });

            lucide.createIcons();
            selectAllCheckbox.checked = false; // Uncheck "select all" on re-render
        }

        function renderCommentsList() {
            commentsListView.innerHTML = ''; // Clear list
            
            const search = document.getElementById('search-comments').value.toLowerCase();
            const status = document.getElementById('filter-comment-status').value;

            let filteredComments = allComments.filter(comment => {
                return (comment.author.toLowerCase().includes(search) || comment.text.toLowerCase().includes(search)) &&
                       (status === '' || comment.status === status);
            });
            
            if (filteredComments.length === 0) {
                commentsListView.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center text-gray-500">No comments found matching criteria.</div>`;
                return;
            }

            filteredComments.forEach(comment => {
                const post = allPosts.find(p => p.id === comment.postId);
                const statusColors = {
                    Approved: "border-green-500",
                    Pending: "border-yellow-500",
                    Spam: "border-red-500"
                };

                const div = document.createElement('div');
                div.className = `bg-white rounded-lg shadow-sm border-l-4 ${statusColors[comment.status] || 'border-gray-300'}`;
                div.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold text-gray-800">${comment.author} <span class="text-sm text-gray-500 font-normal">(${comment.email})</span></div>
                                <div class="text-sm text-gray-500 mt-1">${comment.date ? new Date(comment.date.toDate()).toLocaleString() : 'No date'}</div>
                            </div>
                            <div class="text-sm text-gray-500">
                                On: <span class="text-indigo-600">${post ? post.title : 'Deleted Post'}</span>
                            </div>
                        </div>
                        <p class="text-gray-700 my-4">${comment.text}</p>
                        ${comment.reply ? `
                            <div class="bg-gray-50 p-3 rounded-lg border ml-8">
                                <p class="text-sm font-semibold text-gray-700">Reply from Admin:</p>
                                <p class="text-sm text-gray-600 mt-1">${comment.reply}</p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="bg-gray-50 px-6 py-3 rounded-b-lg flex flex-wrap gap-2">
                        ${comment.status !== 'Approved' ? `<button class="approve-comment-btn text-sm font-medium text-green-600 hover:text-green-800" data-id="${comment.id}"><i data-lucide="check" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Approve</button>` : ''}
                        ${comment.status === 'Approved' && !comment.reply ? `<button class="reply-comment-btn text-sm font-medium text-blue-600 hover:text-blue-800" data-id="${comment.id}"><i data-lucide="corner-up-left" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Reply</button>` : ''}
                        ${comment.status !== 'Spam' ? `<button class="spam-comment-btn text-sm font-medium text-yellow-600 hover:text-yellow-800" data-id="${comment.id}"><i data-lucide="shield-alert" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Spam</button>` : ''}
                        <button class="delete-comment-btn text-sm font-medium text-red-600 hover:text-red-800 ml-auto" data-id="${comment.id}"><i data-lucide="trash-2" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Delete</button>
                    </div>
                `;
                commentsListView.appendChild(div);
            });
            
            lucide.createIcons();
        }

        // NEW: Render Category List
        function renderCategoriesList() {
            categoriesList.innerHTML = ''; // Clear list
            if (allCategories.length === 0) {
                categoriesList.innerHTML = `<li class="p-6 text-center text-gray-500">No categories added yet.</li>`;
                return;
            }
            allCategories.forEach(cat => {
                const li = document.createElement('li');
                li.className = "flex items-center justify-between p-4";
                li.innerHTML = `
                    <span class="font-medium text-gray-700">${cat.name}</span>
                    <button class="delete-category-btn text-red-600 hover:text-red-800" data-id="${cat.id}" title="Delete Category">
                        <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                    </button>
                `;
                categoriesList.appendChild(li);
            });
            lucide.createIcons();
        }

        // NEW: Update Category Dropdowns
        function updateCategoryDropdowns() {
            const selects = [filterCategorySelect, postCategorySelect];
            
            selects.forEach(select => {
                const currentValue = select.value;
                // Clear existing options, preserving the first one ("All" or "Uncategorized")
                while (select.options.length > 1) {
                    select.remove(1);
                }

                allCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
                
                // Try to restore the previously selected value
                select.value = currentValue;
            });
        }

        function renderAnalytics() {
            const totalPosts = allPosts.length;
            // REAL DATA: Read 'views' field from Firestore posts
            const totalViews = allPosts.reduce((acc, post) => acc + (post.views || 0), 0);
            const pendingComments = allComments.filter(c => c.status === 'Pending').length;
            const publishedCount = allPosts.filter(p => p.status === 'Published').length;
            const draftCount = allPosts.filter(p => p.status === 'Draft').length;

            document.getElementById('stats-total-posts').textContent = totalPosts;
            document.getElementById('stats-total-views').textContent = totalViews.toLocaleString();
            document.getElementById('stats-total-comments').textContent = pendingComments;
            document.getElementById('stats-published-drafts').textContent = `${publishedCount} / ${draftCount}`;

            const popularList = document.getElementById('popular-posts-list');
            popularList.innerHTML = '';
            // REAL DATA: Sort by 'views' field
            const popularPosts = [...allPosts].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 5);
            
            if(popularPosts.length === 0) {
                 popularList.innerHTML = `<li class="py-3 text-center text-gray-500">No data available</li>`;
                 return;
            }

            popularPosts.forEach(post => {
                const li = document.createElement('li');
                li.className = "py-4 flex justify-between items-center";
                li.innerHTML = `
                    <span class="font-medium text-gray-800">${post.title}</span>
                    <span class="text-sm text-gray-500">${(post.views || 0).toLocaleString()} views</span>
                `;
                popularList.appendChild(li);
            });
        }
        
        // =============================================
        // Form Handling
        // =============================================
        async function showPostForm(postId = null) {
            postForm.reset();
            quill.setContents([]);
            tagify.removeAllTags();
            imagePreview.src = "#";
            imagePreviewWrapper.classList.add('hidden');
            attachmentList.innerHTML = '';
            
            if (postId) {
                // Edit Mode
                editingPostId = postId;
                postFormTitle.textContent = "Edit Post";
                
                try {
                    const postRef = doc(db, "blogPosts", postId);
                    const postSnap = await getDoc(postRef);
                    
                    if (postSnap.exists()) {
                        const post = postSnap.data();
                        postIdInput.value = postSnap.id;
                        postTitleInput.value = post.title;
                        
                        // --- FIX: PARSE CONTENT ---
                        if (post.content && typeof post.content === 'string') {
                            try {
                                quill.setContents(JSON.parse(post.content));
                            } catch (e) {
                                console.error("Error parsing content JSON:", e);
                                quill.setText("Error loading content."); // Show error in editor
                            }
                        } else if (post.content && typeof post.content === 'object') {
                             // It might already be an object if read from cache or similar
                             quill.setContents(post.content);
                        } else {
                            quill.setText(""); // Clear if no content
                        }
                        // --- END FIX ---

                        postStatusSelect.value = post.status;
                        postCategorySelect.value = post.category || 'Uncategorized'; // Default if missing
                        if (post.tags) {
                            tagify.loadOriginalValues(post.tags);
                        }
                        if (post.publishDate && post.status === 'Scheduled') {
                            schedulePicker.setDate(post.publishDate.toDate(), true);
                            scheduleDateWrapper.classList.remove('hidden');
                        } else {
                             scheduleDateWrapper.classList.add('hidden');
                             schedulePicker.clear();
                        }
                        if (post.featureImage) {
                            imagePreview.src = post.featureImage;
                            imagePreviewWrapper.classList.remove('hidden'); // SHOW preview
                        } else {
                            imagePreviewWrapper.classList.add('hidden'); // HIDE preview
                        }
                        (post.attachments || []).forEach(file => addAttachmentToList(file.name, file.url));
                        
                        // Load SEO fields
                        document.getElementById('seo-title').value = post.seoTitle || '';
                        document.getElementById('seo-description').value = post.seoDescription || '';
                        document.getElementById('seo-keywords').value = post.seoKeywords || '';

                    } else {
                        showToast("Error: Post not found.", true);
                        showView('list-posts');
                        return; // Exit if post not found
                    }
                } catch (error) {
                    console.error("Error loading post: ", error);
                    showToast("Error loading post data.", true);
                }
                
            } else {
                // Add Mode
                editingPostId = null;
                postFormTitle.textContent = "Add New Post";
                scheduleDateWrapper.classList.add('hidden');
                schedulePicker.clear();
            }
            showView('post-form-view'); // Switch view AFTER loading/resetting
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const publishBtn = document.getElementById('publish-btn');
            publishBtn.disabled = true;
            publishBtn.textContent = "Saving...";
            
            const title = postTitleInput.value;
            const status = postStatusSelect.value;
            if (!title) {
                showToast("Please enter a title.", true);
                publishBtn.disabled = false;
                publishBtn.textContent = "Publish";
                return;
            }
            
            // --- FIX: STRINGIFY CONTENT ---
            const contentString = JSON.stringify(quill.getContents());
            // --- END FIX ---

            let publishDate = null;
            if (status === 'Scheduled') {
                if (schedulePicker.selectedDates[0]) {
                    publishDate = Timestamp.fromDate(schedulePicker.selectedDates[0]);
                } else {
                    showToast("Please select a schedule date.", true);
                    publishBtn.disabled = false;
                    publishBtn.textContent = "Schedule";
                    return;
                }
            } else if (status === 'Published' && editingPostId) {
                // If editing and changing status TO published, check if it already had a date
                const originalPost = allPosts.find(p => p.id === editingPostId);
                if (!originalPost || !originalPost.publishDate) {
                     publishDate = serverTimestamp(); // Set publish date only if it wasn't published before
                } else {
                    publishDate = originalPost.publishDate; // Keep original publish date
                }
            } else if (status === 'Published' && !editingPostId) {
                publishDate = serverTimestamp(); // New post, publish now
            }
            
            const postData = {
                title: title,
                content: contentString, // SAVE THE STRING
                status: status,
                category: postCategorySelect.value,
                tags: tagify.value.map(tag => tag.value),
                publishDate: publishDate,
                featureImage: imagePreview.src.startsWith('http') ? imagePreview.src : null,
                attachments: Array.from(attachmentList.children).map(item => ({
                    name: item.dataset.name,
                    url: item.dataset.url
                })),
                seoTitle: document.getElementById('seo-title').value,
                seoDescription: document.getElementById('seo-description').value,
                seoKeywords: document.getElementById('seo-keywords').value,
                modifiedAt: serverTimestamp()
            };

            try {
                if (editingPostId) {
                    const postRef = doc(db, "blogPosts", editingPostId);
                    await updateDoc(postRef, postData);
                    showToast("Post updated successfully!");
                } else {
                    postData.createdAt = serverTimestamp();
                    postData.author = "Admin"; // Hardcode author for new posts
                    postData.views = 0; // Initialize views count
                    postData.commentsCount = 0;
                    await addDoc(postsCollection, postData);
                    showToast("Post created successfully!");
                }
                
                editingPostId = null;
                showView('list-posts');
                
            } catch (error) {
                console.error("Error saving post: ", error);
                showToast(`Error saving post: ${error.message}`, true);
            } finally {
                publishBtn.disabled = false;
                // Restore button text based on status
                publishBtn.textContent = postStatusSelect.value === 'Scheduled' ? 'Schedule' : 'Publish';
            }
        }

        // =============================================
        // File / Image Handling
        // =============================================
        async function handleImageUpload(file) {
            if (file) {
                try {
                    const { url } = await mockUploadFile(file); // MOCK UPLOAD
                    imagePreview.src = url; // Use mock URL
                    imagePreviewWrapper.classList.remove('hidden');
                } catch(error) {
                     showToast("Image upload simulation failed.", true);
                }
            }
        }
        
        function addAttachmentToList(fileName, fileUrl) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-gray-100 p-2 rounded-lg";
            div.dataset.name = fileName;
            div.dataset.url = fileUrl;
            div.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="file-text" class="w-4 h-4 text-gray-500 mr-2"></i>
                    <span class="text-sm font-medium text-gray-700">${fileName}</span>
                </div>
                <div>
                    <button type="button" class="remove-attachment-btn text-sm text-red-600 hover:text-red-800">&times; Remove</button>
                </div>
            `;
            attachmentList.appendChild(div);
            lucide.createIcons();
            
            div.querySelector('.remove-attachment-btn').addEventListener('click', () => {
                div.remove();
                // If using real storage, you might want to delete the file here too
            });
        }
        
        async function handleAttachmentUpload(files) {
            for (const file of files) {
                try {
                    const { name, url } = await mockUploadFile(file); // MOCK UPLOAD
                    addAttachmentToList(name, url);
                } catch(error) {
                     showToast(`Attachment upload simulation failed for ${file.name}.`, true);
                }
            }
        }
        
        // =============================================
        // Post / Comment / Category Actions
        // =============================================
        function showDeleteModal(postId) {
            postToDeleteId = postId;
            deleteModal.classList.add('open');
        }
        
        async function confirmDelete() {
            if (postToDeleteId) {
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = "Deleting...";
                try {
                    const batch = writeBatch(db);
                    
                    // 1. Delete the post itself
                    const postRef = doc(db, "blogPosts", postToDeleteId);
                    batch.delete(postRef);
                    
                    // 2. Find and delete all comments for that post
                    const q = query(commentsCollection, where("postId", "==", postToDeleteId));
                    const commentsSnapshot = await getDocs(q);
                    commentsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // 3. Commit the batch
                    await batch.commit();
                    
                    showToast("Post and all its comments deleted!");
                    
                } catch (error) {
                    console.error("Error deleting post: ", error);
                    showToast(`Error deleting post: ${error.message}`, true);
                } finally {
                    postToDeleteId = null;
                    deleteModal.classList.remove('open');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = "Delete";
                }
            }
        }
        
        async function updateCommentStatus(commentId, newStatus) {
            try {
                const commentRef = doc(db, "blogComments", commentId);
                await updateDoc(commentRef, {
                    status: newStatus
                });
                showToast(`Comment status updated to ${newStatus}.`);
                // The onSnapshot listener will handle the re-render
            } catch (error) {
                console.error("Error updating comment: ", error);
                showToast("Error updating comment status.", true);
            }
        }
        
        async function deleteComment(commentId) {
            // Using custom modal logic instead of confirm()
            // For simplicity, we'll skip the custom modal for this one
            // if (confirm("Are you sure you want to delete this comment?")) {
                try {
                    const commentRef = doc(db, "blogComments", commentId);
                    await deleteDoc(commentRef);
                    showToast("Comment deleted.");
                } catch (error) {
                    console.error("Error deleting comment: ", error);
                    showToast("Error deleting comment.", true);
                }
            // }
        }

        function showReplyModal(commentId) {
            const comment = allComments.find(c => c.id === commentId);
            if (comment) {
                commentToReplyId = commentId;
                document.getElementById('reply-author').textContent = `Replying to: ${comment.author}`;
                document.getElementById('reply-original-text').textContent = `"${comment.text}"`;
                replyForm.reset();
                replyModal.classList.add('open');
            }
        }
        
        async function handleReplySubmit(e) {
            e.preventDefault();
            const replyBtn = document.getElementById('submit-reply-btn');
            replyBtn.disabled = true;
            replyBtn.textContent = "Submitting...";

            const replyText = document.getElementById('reply-text').value;
            if (commentToReplyId && replyText) {
                try {
                    const commentRef = doc(db, "blogComments", commentToReplyId);
                    await updateDoc(commentRef, {
                        reply: replyText
                    });
                    showToast("Reply submitted!");
                    replyModal.classList.remove('open');
                } catch (error) {
                    console.error("Error submitting reply: ", error);
                    showToast("Error submitting reply.", true);
                } finally {
                    commentToReplyId = null;
                    replyBtn.disabled = false;
                    replyBtn.textContent = "Submit Reply";
                }
            } else {
                 replyBtn.disabled = false; // Re-enable if no text
                 replyBtn.textContent = "Submit Reply";
            }
        }

        // NEW: Show Share Modal
        function showShareModal(postId, postTitle) {
            const postUrl = `${window.location.origin}/blog/post/${postId}`;
            document.getElementById('share-post-title').textContent = postTitle;
            document.getElementById('share-post-url').value = postUrl;

            // Update social links
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(postUrl)}&text=${encodeURIComponent(postTitle)}`;
            document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postUrl)}`;
            document.getElementById('share-linkedin').href = `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(postUrl)}&title=${encodeURIComponent(postTitle)}`;

            shareModal.classList.add('open');
            lucide.createIcons();
        }

        // =============================================
        // Event Listeners
        // =============================================
        function setupEventListeners() {
            // --- Sidebar Navigation ---
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView(link.dataset.view);
                    if (window.innerWidth < 768) { // Close sidebar on mobile nav
                        sidebar.classList.remove('open');
                    }
                });
            });

            // --- Mobile Sidebar Toggle ---
            menuToggle.addEventListener('click', () => {
                sidebar.classList.add('open');
            });
            closeMenuBtn.addEventListener('click', () => {
                sidebar.classList.remove('open');
            });

            // "Add New" Button
            document.getElementById('add-new-post-btn-main').addEventListener('click', () => showView('add-post'));

            // List View Filters
            document.getElementById('search-posts').addEventListener('input', renderPostsTable);
            filterCategorySelect.addEventListener('change', renderPostsTable);
            document.getElementById('filter-status').addEventListener('change', renderPostsTable);

            // Select All Checkbox
            selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                postsTableBody.querySelectorAll('.post-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });

            // List View Table Actions (Event Delegation)
            postsTableBody.addEventListener('click', e => {
                const viewBtn = e.target.closest('.view-btn');
                const editBtn = e.target.closest('.edit-btn');
                const shareBtn = e.target.closest('.share-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                
                if (viewBtn) {
                    const id = viewBtn.dataset.id;
                    // Open in new tab - placeholder URL structure
                    window.open(`/blog/post/${id}`, '_blank');
                }
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    showPostForm(id); // Uses showPostForm which switches to the form view
                }
                if (shareBtn) {
                    const id = shareBtn.dataset.id;
                    const title = shareBtn.dataset.title;
                    showShareModal(id, title);
                }
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    showDeleteModal(id);
                }
            });
            
            // Delete Modal
            confirmDeleteBtn.addEventListener('click', confirmDelete);
            cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('open'));
            
            // --- Share Modal ---
            cancelShareBtn.addEventListener('click', () => shareModal.classList.remove('open'));
            copyUrlBtn.addEventListener('click', () => {
                const urlInput = document.getElementById('share-post-url');
                urlInput.select();
                urlInput.setSelectionRange(0, 99999); // For mobile
                try {
                    // Use execCommand for iframe compatibility
                    document.execCommand('copy');
                    showToast("URL copied to clipboard!");
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    showToast("Failed to copy URL.", true);
                }
            });

            // Post Form
            postForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('save-draft-btn').addEventListener('click', () => {
                postStatusSelect.value = "Draft"; // Ensure status is draft
                handleFormSubmit(new Event('submit', { bubbles: true, cancelable: true })); // Trigger submit
            });
            postStatusSelect.addEventListener('change', e => {
                scheduleDateWrapper.classList.toggle('hidden', e.target.value !== 'Scheduled');
                const publishBtn = document.getElementById('publish-btn');
                 if (e.target.value === 'Scheduled') {
                     publishBtn.textContent = "Schedule";
                 } else {
                     publishBtn.textContent = "Publish";
                 }
            });
            
            // Image Upload
            imageDropzone.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', e => handleImageUpload(e.target.files[0]));
            removeImageBtn.addEventListener('click', () => {
                imageInput.value = '';
                imagePreview.src = '#';
                imagePreviewWrapper.classList.add('hidden');
            });
            
            // Attachment Upload
            attachmentDropzone.addEventListener('click', () => attachmentInput.click());
            attachmentInput.addEventListener('change', e => handleAttachmentUpload(e.target.files));

            // Comments View Filters
            document.getElementById('search-comments').addEventListener('input', renderCommentsList);
            document.getElementById('filter-comment-status').addEventListener('change', renderCommentsList);
            
            // Comments List Actions (Event Delegation)
            commentsListView.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                if (target.classList.contains('approve-comment-btn')) updateCommentStatus(id, 'Approved');
                if (target.classList.contains('spam-comment-btn')) updateCommentStatus(id, 'Spam');
                if (target.classList.contains('delete-comment-btn')) {
                    // Simple confirm for comment deletion
                    if(confirm("Are you sure you want to delete this comment?")) {
                        deleteComment(id);
                    }
                }
                if (target.classList.contains('reply-comment-btn')) showReplyModal(id);
            });
            
            // Reply Modal
            replyForm.addEventListener('submit', handleReplySubmit);
            cancelReplyBtn.addEventListener('click', () => replyModal.classList.remove('open'));

            // --- Category Management ---
            addCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('new-category-name');
                const categoryName = nameInput.value.trim();
                const btn = document.getElementById('add-category-btn');
                
                if (categoryName) {
                    btn.disabled = true;
                    btn.textContent = "Adding...";
                    // Check if category already exists
                    if (allCategories.find(cat => cat.name.toLowerCase() === categoryName.toLowerCase())) {
                        showToast("Category already exists.", true);
                        btn.disabled = false;
                        btn.textContent = "Add Category";
                        return;
                    }

                    try {
                        await addDoc(categoriesCollection, {
                            name: categoryName
                        });
                        showToast("Category added!");
                        nameInput.value = '';
                    } catch (error) {
                        console.error("Error adding category: ", error);
                        showToast("Error adding category.", true);
                    } finally {
                        btn.disabled = false;
                        btn.textContent = "Add Category";
                    }
                }
            });

            categoriesList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-category-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm("Are you sure you want to delete this category? Posts using it will be set to 'Uncategorized'.")) {
                        try {
                            await deleteDoc(doc(db, "blogCategories", id));
                            showToast("Category deleted.");
                            // Note: We are not updating posts here, just deleting the category.
                            // The dropdowns will update automatically.
                        } catch (error) {
                            console.error("Error deleting category: ", error);
                            showToast("Error deleting category.", true);
                        }
                    }
                }
            });
        }

    </script>


<!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            getDoc, 
            addDoc, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            serverTimestamp,
            query,
            where,
            orderBy,
            writeBatch,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Note: Firebase Storage is NOT imported. File uploads are mocked.
        
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        // DO NOT use this config in production
        // This is a placeholder config.
        const firebaseConfig = {
            apiKey: "AIzaSyDuqswofpquk8aUbCOZCGjdYLUivBEh7a8",
            authDomain: "ardaycaawiye-18b89.firebaseapp.com",
            projectId: "ardaycaawiye-18b89",
            storageBucket: "ardaycaawiye-18b89.firebasestorage.app",
            messagingSenderId: "590874185284",
            appId: "1:590874185284:web:6ee7df602c45068e38b611",
            measurementId: "G-SBGSTJWDMR"
        };
        // -----------------------------------------

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const postsCollection = collection(db, "blogPosts"); // Collection for posts
        const commentsCollection = collection(db, "blogComments"); // Separate collection for comments
        const categoriesCollection = collection(db, "blogCategories"); // NEW: Collection for categories

        // --- Global State ---
        let currentView = 'list-posts';
        let editingPostId = null;
        let postToDeleteId = null;
        let commentToReplyId = null;
        let allPosts = []; // Local cache for posts
        let allComments = []; // Local cache for comments
        let allCategories = []; // NEW: Local cache for categories
        let unsubscribePosts = () => {}; // Function to stop the posts listener
        let unsubscribeComments = () => {}; // Function to stop the comments listener
        let unsubscribeCategories = () => {}; // NEW: Function to stop the categories listener

        // --- Lib Instances ---
        let quill, tagify, schedulePicker;

        // --- DOM Elements ---
        const views = document.querySelectorAll('.app-view');
        const sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
        const postsTableBody = document.getElementById('posts-table-body');
        const postFormView = document.getElementById('post-form-view'); // Renamed view
        const postForm = document.getElementById('blog-post-form');
        const postFormTitle = document.getElementById('form-title');
        const postIdInput = document.getElementById('post-id');
        const postTitleInput = document.getElementById('post-title');
        const postStatusSelect = document.getElementById('post-status');
        const scheduleDateWrapper = document.getElementById('schedule-date-wrapper');
        const postCategorySelect = document.getElementById('post-category');
        const filterCategorySelect = document.getElementById('filter-category');
        const imageDropzone = document.getElementById('image-dropzone');
        const imageInput = document.getElementById('post-image');
        const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const attachmentDropzone = document.getElementById('attachment-dropzone');
        const attachmentInput = document.getElementById('post-attachments');
        const attachmentList = document.getElementById('attachment-list');
        const commentsListView = document.getElementById('comments-list');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const replyModal = document.getElementById('reply-modal');
        const replyForm = document.getElementById('reply-form');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const shareModal = document.getElementById('share-modal'); // NEW
        const cancelShareBtn = document.getElementById('cancel-share-btn'); // NEW
        const copyUrlBtn = document.getElementById('copy-url-btn'); // NEW
        const toast = document.getElementById('toast');
        const selectAllCheckbox = document.getElementById('select-all-posts');
        const categoriesList = document.getElementById('categories-list'); // NEW
        const addCategoryForm = document.getElementById('add-category-form'); // NEW
        const sidebar = document.getElementById('sidebar'); // NEW
        const menuToggle = document.getElementById('menu-toggle'); // NEW
        const closeMenuBtn = document.getElementById('close-menu-btn'); // NEW
        const mobileViewTitle = document.getElementById('mobile-view-title'); // NEW

        // =============================================
        // Initialization
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            initLibs();
            setupEventListeners();
            showView('list-posts'); // Start on the main page
            lucide.createIcons();
        });

        function initLibs() {
            quill = new Quill('#quill-editor', {
                theme: 'snow',
                modules: { toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image', 'video', 'code-block'],
                    ['clean']
                ]}
            });
            
            const tagsInput = document.getElementById('post-tags');
            tagify = new Tagify(tagsInput);
            
            schedulePicker = flatpickr("#post-schedule-date", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
            });
        }
        
        // =============================================
        // Toast Notification Utility
        // =============================================
        function showToast(message, isError = false) {
            toast.textContent = message;
            // Use descriptive classes for toast position and appearance
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform ${isError ? 'toast-error' : 'toast-success'}`;
            toast.classList.add('show');
            
            // Set timeout to hide the toast
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // =============================================
        // Mock File Upload (!!! IMPORTANT !!!)
        // =============================================
        async function mockUploadFile(file) {
            showToast(`Simulating upload for ${file.name}...`);
            await new Promise(resolve => setTimeout(resolve, 1500));
            // Create a mock URL
            const mockUrl = `https://mockstorage.com/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
            console.log(`Mock Upload: ${file.name} -> ${mockUrl}`);
            showToast(`Upload complete for ${file.name}!`);
            return { name: file.name, url: mockUrl };
        }

        // =============================================
        // Navigation / View Switching
        // =============================================
        function showView(viewId) {
            // Stop all active listeners
            unsubscribePosts();
            unsubscribeComments();
            unsubscribeCategories();

            views.forEach(view => view.classList.remove('active'));
            const newView = document.getElementById(viewId);
            if (newView) {
                newView.classList.add('active');
            }

            // Handle 'add-post' view which is inside 'post-form-view'
            if (viewId === 'add-post') {
                document.getElementById('post-form-view').classList.add('active');
                showPostForm(); // Special case for "Add New"
            }

            sidebarLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-link[data-view="${viewId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                mobileViewTitle.textContent = activeLink.textContent.trim(); // Update mobile title
            }
            
            // Start listeners for the new view
            if (viewId === 'list-posts') {
                initPostsListener();
                initCategoriesListener(); // Need categories for filter
            } else if (viewId === 'comments') {
                initPostsListener(); // Need posts data for comment context
                initCommentsListener();
            } else if (viewId === 'analytics') {
                fetchAllDataForAnalytics();
            } else if (viewId === 'categories') {
                initCategoriesListener(renderCategoriesList); // Pass render callback
            } else if (viewId === 'add-post') {
                initCategoriesListener(); // Need categories for dropdown
            }
        }

        // =============================================
        // Data Listeners
        // =============================================
        
        function initPostsListener() {
            unsubscribePosts = onSnapshot(query(postsCollection, orderBy("createdAt", "desc")), (snapshot) => {
                allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPostsTable(); // Re-render table on any change
            }, error => {
                console.error("Error fetching posts: ", error);
                showToast("Error fetching posts.", true);
                postsTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">Error loading posts.</td></tr>`;
            });
        }
        
        function initCommentsListener() {
            unsubscribeComments = onSnapshot(query(commentsCollection, orderBy("date", "desc")), (snapshot) => {
                allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCommentsList(); // Re-render comments on any change
            }, error => {
                console.error("Error fetching comments: ", error);
                showToast("Error fetching comments.", true);
                commentsListView.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center text-red-500">Error loading comments.</div>`;
            });
        }

        // NEW: Categories Listener
        function initCategoriesListener(onUpdateCallback = null) {
            unsubscribeCategories = onSnapshot(query(categoriesCollection, orderBy("name")), (snapshot) => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCategoryDropdowns();
                if (onUpdateCallback) {
                    onUpdateCallback(); // e.g., renderCategoriesList
                }
            }, error => {
                console.error("Error fetching categories: ", error);
                showToast("Error fetching categories.", true);
                if (onUpdateCallback) { // Show error in categories list if visible
                    categoriesList.innerHTML = `<li class="p-6 text-center text-red-500">Error loading categories.</li>`;
                }
            });
        }
        
        async function fetchAllDataForAnalytics() {
            try {
                const postSnapshot = await getDocs(postsCollection);
                allPosts = postSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const commentSnapshot = await getDocs(commentsCollection);
                allComments = commentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // NEW: Fetch categories for analytics if needed (though not used in cards)
                const categorySnapshot = await getDocs(categoriesCollection);
                allCategories = categorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderAnalytics();
            } catch (error) {
                console.error("Error fetching analytics data:", error);
                showToast("Error fetching analytics data.", true);
            }
        }

        // =============================================
        // Render Functions (Dynamic)
        // =============================================
        function renderPostsTable() {
            postsTableBody.innerHTML = ''; // Clear table
            
            const search = document.getElementById('search-posts').value.toLowerCase();
            const category = filterCategorySelect.value;
            const status = document.getElementById('filter-status').value;

            let filteredPosts = allPosts.filter(post => {
                return (post.title.toLowerCase().includes(search) || (post.author || '').toLowerCase().includes(search)) &&
                       (category === '' || post.category === category) &&
                       (status === '' || post.status === status);
            });
            
            if (filteredPosts.length === 0) {
                postsTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">No posts found matching criteria.</td></tr>`;
                return;
            }

            filteredPosts.forEach(post => {
                const statusColors = {
                    Published: "bg-green-100 text-green-800",
                    Draft: "bg-yellow-100 text-yellow-800",
                    Scheduled: "bg-blue-100 text-blue-800"
                };
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="post-checkbox" data-id="${post.id}"></td>
                    <td class="p-4">
                        <div class="font-medium text-gray-800">${post.title}</div>
                        <div class="text-sm text-gray-500">${(post.tags || []).join(', ')}</div>
                    </td>
                    <td class="p-4 text-sm text-gray-600">${post.author || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-600">${post.category || 'Uncategorized'}</td>
                    <td class="p-4">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColors[post.status] || 'bg-gray-100 text-gray-800'}">
                            ${post.status}
                        </span>
                    </td>
                    <td class="p-4 text-sm text-gray-600">
                        ${post.publishDate ? new Date(post.publishDate.toDate()).toLocaleDateString() : '—'}
                    </td>
                    <td class="p-4">
                        <div class="flex space-x-2">
                            <!-- NEW: View Button -->
                            <button class="view-btn p-1 text-blue-600 hover:text-blue-900" data-id="${post.id}" title="View Post">
                                <i data-lucide="eye" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <button class="edit-btn p-1 text-indigo-600 hover:text-indigo-900" data-id="${post.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                             <!-- NEW: Share Button -->
                            <button class="share-btn p-1 text-green-600 hover:text-green-900" data-id="${post.id}" data-title="${post.title}" title="Share">
                                <i data-lucide="share-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <button class="delete-btn p-1 text-red-600 hover:text-red-900" data-id="${post.id}" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                        </div>
                    </td>
                `;
                postsTableBody.appendChild(tr);
            });

            lucide.createIcons();
            selectAllCheckbox.checked = false; // Uncheck "select all" on re-render
        }

        function renderCommentsList() {
            commentsListView.innerHTML = ''; // Clear list
            
            const search = document.getElementById('search-comments').value.toLowerCase();
            const status = document.getElementById('filter-comment-status').value;

            let filteredComments = allComments.filter(comment => {
                return (comment.author.toLowerCase().includes(search) || comment.text.toLowerCase().includes(search)) &&
                       (status === '' || comment.status === status);
            });
            
            if (filteredComments.length === 0) {
                commentsListView.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center text-gray-500">No comments found matching criteria.</div>`;
                return;
            }

            filteredComments.forEach(comment => {
                const post = allPosts.find(p => p.id === comment.postId);
                const statusColors = {
                    Approved: "border-green-500",
                    Pending: "border-yellow-500",
                    Spam: "border-red-500"
                };

                const div = document.createElement('div');
                div.className = `bg-white rounded-lg shadow-sm border-l-4 ${statusColors[comment.status] || 'border-gray-300'}`;
                div.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold text-gray-800">${comment.author} <span class="text-sm text-gray-500 font-normal">(${comment.email})</span></div>
                                <div class="text-sm text-gray-500 mt-1">${comment.date ? new Date(comment.date.toDate()).toLocaleString() : 'No date'}</div>
                            </div>
                            <div class="text-sm text-gray-500">
                                On: <span class="text-indigo-600">${post ? post.title : 'Deleted Post'}</span>
                            </div>
                        </div>
                        <p class="text-gray-700 my-4">${comment.text}</p>
                        ${comment.reply ? `
                            <div class="bg-gray-50 p-3 rounded-lg border ml-8">
                                <p class="text-sm font-semibold text-gray-700">Reply from Admin:</p>
                                <p class="text-sm text-gray-600 mt-1">${comment.reply}</p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="bg-gray-50 px-6 py-3 rounded-b-lg flex flex-wrap gap-2">
                        ${comment.status !== 'Approved' ? `<button class="approve-comment-btn text-sm font-medium text-green-600 hover:text-green-800" data-id="${comment.id}"><i data-lucide="check" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Approve</button>` : ''}
                        ${comment.status === 'Approved' && !comment.reply ? `<button class="reply-comment-btn text-sm font-medium text-blue-600 hover:text-blue-800" data-id="${comment.id}"><i data-lucide="corner-up-left" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Reply</button>` : ''}
                        ${comment.status !== 'Spam' ? `<button class="spam-comment-btn text-sm font-medium text-yellow-600 hover:text-yellow-800" data-id="${comment.id}"><i data-lucide="shield-alert" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Spam</button>` : ''}
                        <button class="delete-comment-btn text-sm font-medium text-red-600 hover:text-red-800 ml-auto" data-id="${comment.id}"><i data-lucide="trash-2" class="w-4 h-4 inline-block mr-1 pointer-events-none"></i> Delete</button>
                    </div>
                `;
                commentsListView.appendChild(div);
            });
            
            lucide.createIcons();
        }

        // NEW: Render Category List
        function renderCategoriesList() {
            categoriesList.innerHTML = ''; // Clear list
            if (allCategories.length === 0) {
                categoriesList.innerHTML = `<li class="p-6 text-center text-gray-500">No categories added yet.</li>`;
                return;
            }
            allCategories.forEach(cat => {
                const li = document.createElement('li');
                li.className = "flex items-center justify-between p-4";
                li.innerHTML = `
                    <span class="font-medium text-gray-700">${cat.name}</span>
                    <button class="delete-category-btn text-red-600 hover:text-red-800" data-id="${cat.id}" title="Delete Category">
                        <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                    </button>
                `;
                categoriesList.appendChild(li);
            });
            lucide.createIcons();
        }

        // NEW: Update Category Dropdowns
        function updateCategoryDropdowns() {
            const selects = [filterCategorySelect, postCategorySelect];
            
            selects.forEach(select => {
                const currentValue = select.value;
                // Clear existing options, preserving the first one ("All" or "Uncategorized")
                while (select.options.length > 1) {
                    select.remove(1);
                }

                allCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
                
                // Try to restore the previously selected value
                select.value = currentValue;
            });
        }

        function renderAnalytics() {
            const totalPosts = allPosts.length;
            // REAL DATA: Read 'views' field from Firestore posts
            const totalViews = allPosts.reduce((acc, post) => acc + (post.views || 0), 0);
            const pendingComments = allComments.filter(c => c.status === 'Pending').length;
            const publishedCount = allPosts.filter(p => p.status === 'Published').length;
            const draftCount = allPosts.filter(p => p.status === 'Draft').length;

            document.getElementById('stats-total-posts').textContent = totalPosts;
            document.getElementById('stats-total-views').textContent = totalViews.toLocaleString();
            document.getElementById('stats-total-comments').textContent = pendingComments;
            document.getElementById('stats-published-drafts').textContent = `${publishedCount} / ${draftCount}`;

            const popularList = document.getElementById('popular-posts-list');
            popularList.innerHTML = '';
            // REAL DATA: Sort by 'views' field
            const popularPosts = [...allPosts].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 5);
            
            if(popularPosts.length === 0) {
                 popularList.innerHTML = `<li class="py-3 text-center text-gray-500">No data available</li>`;
                 return;
            }

            popularPosts.forEach(post => {
                const li = document.createElement('li');
                li.className = "py-4 flex justify-between items-center";
                li.innerHTML = `
                    <span class="font-medium text-gray-800">${post.title}</span>
                    <span class="text-sm text-gray-500">${(post.views || 0).toLocaleString()} views</span>
                `;
                popularList.appendChild(li);
            });
        }
        
        // =============================================
        // Form Handling
        // =============================================
        async function showPostForm(postId = null) {
            postForm.reset();
            quill.setContents([]);
            tagify.removeAllTags();
            imagePreview.src = "#";
            imagePreviewWrapper.classList.add('hidden');
            attachmentList.innerHTML = '';
            
            if (postId) {
                // Edit Mode
                editingPostId = postId;
                postFormTitle.textContent = "Edit Post";
                
                try {
                    const postRef = doc(db, "blogPosts", postId);
                    const postSnap = await getDoc(postRef);
                    
                    if (postSnap.exists()) {
                        const post = postSnap.data();
                        postIdInput.value = postSnap.id;
                        postTitleInput.value = post.title;
                        
                        // --- FIX: PARSE CONTENT ---
                        if (post.content && typeof post.content === 'string') {
                            try {
                                quill.setContents(JSON.parse(post.content));
                            } catch (e) {
                                console.error("Error parsing content JSON:", e);
                                quill.setText("Error loading content."); // Show error in editor
                            }
                        } else if (post.content && typeof post.content === 'object') {
                             // It might already be an object if read from cache or similar
                             quill.setContents(post.content);
                        } else {
                            quill.setText(""); // Clear if no content
                        }
                        // --- END FIX ---

                        postStatusSelect.value = post.status;
                        postCategorySelect.value = post.category || 'Uncategorized'; // Default if missing
                        if (post.tags) {
                            tagify.loadOriginalValues(post.tags);
                        }
                        if (post.publishDate && post.status === 'Scheduled') {
                            schedulePicker.setDate(post.publishDate.toDate(), true);
                            scheduleDateWrapper.classList.remove('hidden');
                        } else {
                             scheduleDateWrapper.classList.add('hidden');
                             schedulePicker.clear();
                        }
                        if (post.featureImage) {
                            imagePreview.src = post.featureImage;
                            imagePreviewWrapper.classList.remove('hidden'); // SHOW preview
                        } else {
                            imagePreviewWrapper.classList.add('hidden'); // HIDE preview
                        }
                        (post.attachments || []).forEach(file => addAttachmentToList(file.name, file.url));
                        
                        // Load SEO fields
                        document.getElementById('seo-title').value = post.seoTitle || '';
                        document.getElementById('seo-description').value = post.seoDescription || '';
                        document.getElementById('seo-keywords').value = post.seoKeywords || '';

                    } else {
                        showToast("Error: Post not found.", true);
                        showView('list-posts');
                        return; // Exit if post not found
                    }
                } catch (error) {
                    console.error("Error loading post: ", error);
                    showToast("Error loading post data.", true);
                }
                
            } else {
                // Add Mode
                editingPostId = null;
                postFormTitle.textContent = "Add New Post";
                scheduleDateWrapper.classList.add('hidden');
                schedulePicker.clear();
            }
            showView('post-form-view'); // Switch view AFTER loading/resetting
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const publishBtn = document.getElementById('publish-btn');
            publishBtn.disabled = true;
            publishBtn.textContent = "Saving...";
            
            const title = postTitleInput.value;
            const status = postStatusSelect.value;
            if (!title) {
                showToast("Please enter a title.", true);
                publishBtn.disabled = false;
                publishBtn.textContent = "Publish";
                return;
            }
            
            // --- FIX: STRINGIFY CONTENT ---
            const contentString = JSON.stringify(quill.getContents());
            // --- END FIX ---

            let publishDate = null;
            if (status === 'Scheduled') {
                if (schedulePicker.selectedDates[0]) {
                    publishDate = Timestamp.fromDate(schedulePicker.selectedDates[0]);
                } else {
                    showToast("Please select a schedule date.", true);
                    publishBtn.disabled = false;
                    publishBtn.textContent = "Schedule";
                    return;
                }
            } else if (status === 'Published' && editingPostId) {
                // If editing and changing status TO published, check if it already had a date
                const originalPost = allPosts.find(p => p.id === editingPostId);
                if (!originalPost || !originalPost.publishDate) {
                     publishDate = serverTimestamp(); // Set publish date only if it wasn't published before
                } else {
                    publishDate = originalPost.publishDate; // Keep original publish date
                }
            } else if (status === 'Published' && !editingPostId) {
                publishDate = serverTimestamp(); // New post, publish now
            }
            
            const postData = {
                title: title,
                content: contentString, // SAVE THE STRING
                status: status,
                category: postCategorySelect.value,
                tags: tagify.value.map(tag => tag.value),
                publishDate: publishDate,
                featureImage: imagePreview.src.startsWith('http') ? imagePreview.src : null,
                attachments: Array.from(attachmentList.children).map(item => ({
                    name: item.dataset.name,
                    url: item.dataset.url
                })),
                seoTitle: document.getElementById('seo-title').value,
                seoDescription: document.getElementById('seo-description').value,
                seoKeywords: document.getElementById('seo-keywords').value,
                modifiedAt: serverTimestamp()
            };

            try {
                if (editingPostId) {
                    const postRef = doc(db, "blogPosts", editingPostId);
                    await updateDoc(postRef, postData);
                    showToast("Post updated successfully!");
                } else {
                    postData.createdAt = serverTimestamp();
                    postData.author = "Admin"; // Hardcode author for new posts
                    postData.views = 0; // Initialize views count
                    postData.commentsCount = 0;
                    await addDoc(postsCollection, postData);
                    showToast("Post created successfully!");
                }
                
                editingPostId = null;
                showView('list-posts');
                
            } catch (error) {
                console.error("Error saving post: ", error);
                showToast(`Error saving post: ${error.message}`, true);
            } finally {
                publishBtn.disabled = false;
                // Restore button text based on status
                publishBtn.textContent = postStatusSelect.value === 'Scheduled' ? 'Schedule' : 'Publish';
            }
        }

        // =============================================
        // File / Image Handling
        // =============================================
        async function handleImageUpload(file) {
            if (file) {
                try {
                    const { url } = await mockUploadFile(file); // MOCK UPLOAD
                    imagePreview.src = url; // Use mock URL
                    imagePreviewWrapper.classList.remove('hidden');
                } catch(error) {
                     showToast("Image upload simulation failed.", true);
                }
            }
        }
        
        function addAttachmentToList(fileName, fileUrl) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-gray-100 p-2 rounded-lg";
            div.dataset.name = fileName;
            div.dataset.url = fileUrl;
            div.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="file-text" class="w-4 h-4 text-gray-500 mr-2"></i>
                    <span class="text-sm font-medium text-gray-700">${fileName}</span>
                </div>
                <div>
                    <button type="button" class="remove-attachment-btn text-sm text-red-600 hover:text-red-800">&times; Remove</button>
                </div>
            `;
            attachmentList.appendChild(div);
            lucide.createIcons();
            
            div.querySelector('.remove-attachment-btn').addEventListener('click', () => {
                div.remove();
                // If using real storage, you might want to delete the file here too
            });
        }
        
        async function handleAttachmentUpload(files) {
            for (const file of files) {
                try {
                    const { name, url } = await mockUploadFile(file); // MOCK UPLOAD
                    addAttachmentToList(name, url);
                } catch(error) {
                     showToast(`Attachment upload simulation failed for ${file.name}.`, true);
                }
            }
        }
        
        // =============================================
        // Post / Comment / Category Actions
        // =============================================
        function showDeleteModal(postId) {
            postToDeleteId = postId;
            deleteModal.classList.add('open');
        }
        
        async function confirmDelete() {
            if (postToDeleteId) {
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = "Deleting...";
                try {
                    const batch = writeBatch(db);
                    
                    // 1. Delete the post itself
                    const postRef = doc(db, "blogPosts", postToDeleteId);
                    batch.delete(postRef);
                    
                    // 2. Find and delete all comments for that post
                    const q = query(commentsCollection, where("postId", "==", postToDeleteId));
                    const commentsSnapshot = await getDocs(q);
                    commentsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // 3. Commit the batch
                    await batch.commit();
                    
                    showToast("Post and all its comments deleted!");
                    
                } catch (error) {
                    console.error("Error deleting post: ", error);
                    showToast(`Error deleting post: ${error.message}`, true);
                } finally {
                    postToDeleteId = null;
                    deleteModal.classList.remove('open');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = "Delete";
                }
            }
        }
        
        async function updateCommentStatus(commentId, newStatus) {
            try {
                const commentRef = doc(db, "blogComments", commentId);
                await updateDoc(commentRef, {
                    status: newStatus
                });
                showToast(`Comment status updated to ${newStatus}.`);
                // The onSnapshot listener will handle the re-render
            } catch (error) {
                console.error("Error updating comment: ", error);
                showToast("Error updating comment status.", true);
            }
        }
        
        async function deleteComment(commentId) {
            // Using custom modal logic instead of confirm()
            // For simplicity, we'll skip the custom modal for this one
            // if (confirm("Are you sure you want to delete this comment?")) {
                try {
                    const commentRef = doc(db, "blogComments", commentId);
                    await deleteDoc(commentRef);
                    showToast("Comment deleted.");
                } catch (error) {
                    console.error("Error deleting comment: ", error);
                    showToast("Error deleting comment.", true);
                }
            // }
        }

        function showReplyModal(commentId) {
            const comment = allComments.find(c => c.id === commentId);
            if (comment) {
                commentToReplyId = commentId;
                document.getElementById('reply-author').textContent = `Replying to: ${comment.author}`;
                document.getElementById('reply-original-text').textContent = `"${comment.text}"`;
                replyForm.reset();
                replyModal.classList.add('open');
            }
        }
        
        async function handleReplySubmit(e) {
            e.preventDefault();
            const replyBtn = document.getElementById('submit-reply-btn');
            replyBtn.disabled = true;
            replyBtn.textContent = "Submitting...";

            const replyText = document.getElementById('reply-text').value;
            if (commentToReplyId && replyText) {
                try {
                    const commentRef = doc(db, "blogComments", commentToReplyId);
                    await updateDoc(commentRef, {
                        reply: replyText
                    });
                    showToast("Reply submitted!");
                    replyModal.classList.remove('open');
                } catch (error) {
                    console.error("Error submitting reply: ", error);
                    showToast("Error submitting reply.", true);
                } finally {
                    commentToReplyId = null;
                    replyBtn.disabled = false;
                    replyBtn.textContent = "Submit Reply";
                }
            } else {
                 replyBtn.disabled = false; // Re-enable if no text
                 replyBtn.textContent = "Submit Reply";
            }
        }

        // NEW: Show Share Modal
        function showShareModal(postId, postTitle) {
            const postUrl = `${window.location.origin}/blog/post/${postId}`;
            document.getElementById('share-post-title').textContent = postTitle;
            document.getElementById('share-post-url').value = postUrl;

            // Update social links
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(postUrl)}&text=${encodeURIComponent(postTitle)}`;
            document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postUrl)}`;
            document.getElementById('share-linkedin').href = `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(postUrl)}&title=${encodeURIComponent(postTitle)}`;

            shareModal.classList.add('open');
            lucide.createIcons();
        }

        // =============================================
        // Event Listeners
        // =============================================
        function setupEventListeners() {
            // --- Sidebar Navigation ---
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView(link.dataset.view);
                    if (window.innerWidth < 768) { // Close sidebar on mobile nav
                        sidebar.classList.remove('open');
                    }
                });
            });

            // --- Mobile Sidebar Toggle ---
            menuToggle.addEventListener('click', () => {
                sidebar.classList.add('open');
            });
            closeMenuBtn.addEventListener('click', () => {
                sidebar.classList.remove('open');
            });

            // "Add New" Button
            document.getElementById('add-new-post-btn-main').addEventListener('click', () => showView('add-post'));

            // List View Filters
            document.getElementById('search-posts').addEventListener('input', renderPostsTable);
            filterCategorySelect.addEventListener('change', renderPostsTable);
            document.getElementById('filter-status').addEventListener('change', renderPostsTable);

            // Select All Checkbox
            selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                postsTableBody.querySelectorAll('.post-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });

            // List View Table Actions (Event Delegation)
            postsTableBody.addEventListener('click', e => {
                const viewBtn = e.target.closest('.view-btn');
                const editBtn = e.target.closest('.edit-btn');
                const shareBtn = e.target.closest('.share-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                
                if (viewBtn) {
                    const id = viewBtn.dataset.id;
                    // Open in new tab - placeholder URL structure
                    window.open(`/blog/post/${id}`, '_blank');
                }
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    showPostForm(id); // Uses showPostForm which switches to the form view
                }
                if (shareBtn) {
                    const id = shareBtn.dataset.id;
                    const title = shareBtn.dataset.title;
                    showShareModal(id, title);
                }
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    showDeleteModal(id);
                }
            });
            
            // Delete Modal
            confirmDeleteBtn.addEventListener('click', confirmDelete);
            cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('open'));
            
            // --- Share Modal ---
            cancelShareBtn.addEventListener('click', () => shareModal.classList.remove('open'));
            copyUrlBtn.addEventListener('click', () => {
                const urlInput = document.getElementById('share-post-url');
                urlInput.select();
                urlInput.setSelectionRange(0, 99999); // For mobile
                try {
                    // Use execCommand for iframe compatibility
                    document.execCommand('copy');
                    showToast("URL copied to clipboard!");
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    showToast("Failed to copy URL.", true);
                }
            });

            // Post Form
            postForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('save-draft-btn').addEventListener('click', () => {
                postStatusSelect.value = "Draft"; // Ensure status is draft
                handleFormSubmit(new Event('submit', { bubbles: true, cancelable: true })); // Trigger submit
            });
            postStatusSelect.addEventListener('change', e => {
                scheduleDateWrapper.classList.toggle('hidden', e.target.value !== 'Scheduled');
                const publishBtn = document.getElementById('publish-btn');
                 if (e.target.value === 'Scheduled') {
                     publishBtn.textContent = "Schedule";
                 } else {
                     publishBtn.textContent = "Publish";
                 }
            });
            
            // Image Upload
            imageDropzone.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', e => handleImageUpload(e.target.files[0]));
            removeImageBtn.addEventListener('click', () => {
                imageInput.value = '';
                imagePreview.src = '#';
                imagePreviewWrapper.classList.add('hidden');
            });
            
            // Attachment Upload
            attachmentDropzone.addEventListener('click', () => attachmentInput.click());
            attachmentInput.addEventListener('change', e => handleAttachmentUpload(e.target.files));

            // Comments View Filters
            document.getElementById('search-comments').addEventListener('input', renderCommentsList);
            document.getElementById('filter-comment-status').addEventListener('change', renderCommentsList);
            
            // Comments List Actions (Event Delegation)
            commentsListView.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                if (target.classList.contains('approve-comment-btn')) updateCommentStatus(id, 'Approved');
                if (target.classList.contains('spam-comment-btn')) updateCommentStatus(id, 'Spam');
                if (target.classList.contains('delete-comment-btn')) {
                    // Simple confirm for comment deletion
                    if(confirm("Are you sure you want to delete this comment?")) {
                        deleteComment(id);
                    }
                }
                if (target.classList.contains('reply-comment-btn')) showReplyModal(id);
            });
            
            // Reply Modal
            replyForm.addEventListener('submit', handleReplySubmit);
            cancelReplyBtn.addEventListener('click', () => replyModal.classList.remove('open'));

            // --- Category Management ---
            addCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('new-category-name');
                const categoryName = nameInput.value.trim();
                const btn = document.getElementById('add-category-btn');
                
                if (categoryName) {
                    btn.disabled = true;
                    btn.textContent = "Adding...";
                    // Check if category already exists
                    if (allCategories.find(cat => cat.name.toLowerCase() === categoryName.toLowerCase())) {
                        showToast("Category already exists.", true);
                        btn.disabled = false;
                        btn.textContent = "Add Category";
                        return;
                    }

                    try {
                        await addDoc(categoriesCollection, {
                            name: categoryName
                        });
                        showToast("Category added!");
                        nameInput.value = '';
                    } catch (error) {
                        console.error("Error adding category: ", error);
                        showToast("Error adding category.", true);
                    } finally {
                        btn.disabled = false;
                        btn.textContent = "Add Category";
                    }
                }
            });

            categoriesList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-category-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm("Are you sure you want to delete this category? Posts using it will be set to 'Uncategorized'.")) {
                        try {
                            await deleteDoc(doc(db, "blogCategories", id));
                            showToast("Category deleted.");
                            // Note: We are not updating posts here, just deleting the category.
                            // The dropdowns will update automatically.
                        } catch (error) {
                            console.error("Error deleting category: ", error);
                            showToast("Error deleting category.", true);
                        }
                    }
                }
            });
        }

    </script>
    
    
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdayCaawiye - Complete CMS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #d1d5db; /* gray-400 */
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link:hover {
            background-color: #374151; /* gray-700 */
            color: white;
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        .sidebar-link .icon {
            width: 1.125rem; /* w-4.5 */
            height: 1.125rem; /* h-4.5 */
            margin-right: 0.75rem; /* mr-3 */
            flex-shrink: 0;
        }
        .dropdown-menu {
            display: none;
            padding-left: 1.5rem; /* pl-6 */
        }
        .sidebar-link.has-dropdown.open + .dropdown-menu {
            display: block;
        }
        .sidebar-link.has-dropdown.open .dropdown-icon {
            transform: rotate(180deg);
        }
        .dropdown-menu .sidebar-link {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        .dropdown-menu .sidebar-link:hover {
            background-color: #374151; /* gray-700 */
        }
        .dropdown-menu .sidebar-link.active {
            color: #a5b4fc; /* indigo-300 */
            background-color: transparent;
            font-weight: 500;
        }

        /* Fade-in animation for tabs */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Quiz Modal Styles */
        .quiz-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        .quiz-modal-container {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 56rem; /* max-w-5xl */
            margin: auto;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #quiz-form {
            overflow-y: auto;
        }
        .quiz-form-input, .quiz-form-select {
            width: 100%;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.65rem 1rem;
            font-size: 0.875rem; /* text-sm */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .quiz-form-input:focus, .quiz-form-select:focus {
            outline: none;
            border-color: #4f46e5; /* border-indigo-500 */
            box-shadow: 0 0 0 2px #c7d2fe; /* ring-2 ring-indigo-200 */
        }
        .quiz-btn {
            padding: 0.65rem 1.25rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .quiz-btn-primary {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
        }
        .quiz-btn-primary:hover { background-color: #4338ca; }
        .quiz-btn-secondary {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #374151; /* text-gray-700 */
            border: 1px solid #d1d5db; /* border-gray-300 */
        }
        .quiz-btn-secondary:hover { background-color: #e5e7eb; }
        .quiz-btn-danger {
            background-color: #dc2626; /* bg-red-600 */
            color: white;
        }
        .quiz-btn-danger:hover { background-color: #b91c1c; }
        .quiz-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 4rem;
            height: 4rem;
            border-radius: 9999px; /* rounded-full */
            z-index: 40;
        }
        .quiz-fab .fa-solid {
            font-size: 1.5rem; /* text-2xl */
        }

        /* User/Confirm Modal Styles */
        .user-modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            display: none; /* Hidden by default */
        }

        /* Blog-specific Styles */
        .app-view { display: none; }
        .app-view.active { display: block; }

        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            overflow-y: auto;
            padding: 1rem;
            display: none; /* Hidden by default */
        }
        .modal-content {
            animation: fadeIn 0.2s ease-out;
        }
        /* Quill Editor Height */
        #quill-editor { height: 400px; }

        /* Tagify */
        .tagify {
            --tags-border-color: #d1d5db;
            border-radius: 0.5rem;
        }
        .tagify:hover { --tags-border-color: #4f46e5; }
        .tagify.tagify--focus { --tags-border-color: #4f46e5; }
    </style>
    
</head>
<body class="flex h-screen overflow-hidden" style="font-family: 'Inter', sans-serif;">

    <div id="login-page" class="w-full h-full flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg m-4">
            <div><h2 id="auth-title" class="text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2></div>
            <form id="auth-form" class="space-y-6">
                <div>
                    <label for="email" class="sr-only">Email address</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address" value="dausfilms@gmail.com">
                </div>
                <div>
                    <label for="password" class="sr-only">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password" value="siciid23">
                </div>
                <div><button id="auth-submit-btn" type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign in</button></div>
            </form>
            <p class="text-center text-sm text-gray-600"><a href="#" id="auth-toggle-link" class="font-medium text-indigo-600 hover:text-indigo-500">Don't have an account? Sign up</a></p>
        </div>
    </div>
    
    <div id="main-app" class="flex w-full h-full hidden">
        
        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col fixed h-full z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-5 text-2xl font-bold border-b border-gray-700 flex items-center">
                <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.appspot.com/o/logo.png?alt=media&token=5b34de54-86a0-47e1-8848-033190897645" alt="Logo" class="h-8 mr-2">
                <span>ArdayCaawiye</span>
            </div>
            
            <nav class="flex-1 p-3 space-y-1.5 overflow-y-auto">
                <a href="#" class="sidebar-link active" data-tab="dashboard">
                    <i data-lucide="home" class="icon"></i> Dashboard
                </a>
                
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="folder-kanban" class="icon"></i>
                        <span class="flex-1 text-left">Manage Content</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="subjects"><i data-lucide="book-copy" class="icon"></i> Subjects</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="exams"><i data-lucide="file-check-2" class="icon"></i> Exams</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="quizzes"><i data-lucide="puzzle" class="icon"></i> Quizzes</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="generalBooks"><i data-lucide="book-open" class="icon"></i> General Books</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="pdf-library"><i data-lucide="library" class="icon"></i> PDF Library</a></li>
                    </ul>
                </div>
                
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="newspaper" class="icon"></i>
                        <span class="flex-1 text-left">Blog Management</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="list-posts"><i data-lucide="layout-list" class="icon"></i> All Posts</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="post-form-view"><i data-lucide="plus-square" class="icon"></i> Add New Post</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="categories"><i data-lucide="tag" class="icon"></i> Categories</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="comments"><i data-lucide="messages-square" class="icon"></i> Comments</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="analytics"><i data-lucide="bar-chart-3" class="icon"></i> Analytics</a></li>
                    </ul>
                </div>

                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="users" class="icon"></i>
                        <span class="flex-1 text-left">User Management</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="users-students"><i data-lucide="user" class="icon"></i> Students / Members</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="users-roles"><i data-lucide="shield-check" class="icon"></i> Roles & Permissions</a></li>
                    </ul>
                </div>

                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full">
                        <i data-lucide="bar-chart-3" class="icon"></i>
                        <span class="flex-1 text-left">Reports & Analytics</span>
                        <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="main-report"><i data-lucide="activity" class="icon"></i> Main Report</a></li>
                    </ul>
                </div>
                
                <a href="#" class="sidebar-link" data-tab="settings">
                    <i data-lucide="settings" class="icon"></i> Settings
                </a>
                
            </nav>
            
            <div class="p-4 border-t border-gray-700">
                <div id="auth-status" class="text-xs text-gray-400 truncate mb-2">Not Authenticated</div>
                <button id="logout-btn" class="w-full flex items-center justify-center p-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors text-white font-medium text-sm">
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>
        
        <div class="md:hidden flex justify-between items-center bg-white p-4 border-b fixed top-0 left-0 right-0 z-10">
            <span class="text-xl font-bold text-gray-800">ArdayCaawiye CMS</span>
            <button id="mobile-menu-btn" class="text-gray-800">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <main class="flex-1 ml-0 md:ml-64 pt-20 md:pt-4 p-4 md:p-8 overflow-y-auto bg-gray-50">
            
            <div id="dashboard" class="tab-content fade-in">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-indigo-100 p-4 rounded-full mr-4"><i data-lucide="book-copy" class="w-8 h-8 text-indigo-600"></i></div><div><p class="text-gray-500">Total Subjects</p><p id="total-subjects" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-green-100 p-4 rounded-full mr-4"><i data-lucide="file-check-2" class="w-8 h-8 text-green-600"></i></div><div><p class="text-gray-500">Total Exams</p><p id="total-exams" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-amber-100 p-4 rounded-full mr-4"><i data-lucide="book-open" class="w-8 h-8 text-amber-600"></i></div><div><p class="text-gray-500">Total Books</p><p id="total-books" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-sky-100 p-4 rounded-full mr-4"><i data-lucide="puzzle" class="w-8 h-8 text-sky-600"></i></div><div><p class="text-gray-500">Total Quizzes</p><p id="total-quizzes" class="text-3xl font-bold">0</p></div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-blue-100 p-4 rounded-full mr-4"><i data-lucide="users" class="w-8 h-8 text-blue-600"></i></div><div><p class="text-gray-500">Total Users</p><p id="dash-total-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-emerald-100 p-4 rounded-full mr-4"><i data-lucide="user-check" class="w-8 h-8 text-emerald-600"></i></div><div><p class="text-gray-500">Paid Users</p><p id="dash-paid-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-rose-100 p-4 rounded-full mr-4"><i data-lucide="user-x" class="w-8 h-8 text-rose-600"></i></div><div><p class="text-gray-500">Banned Users</p><p id="dash-banned-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-purple-100 p-4 rounded-full mr-4"><i data-lucide="wallet" class="w-8 h-8 text-purple-600"></i></div><div><p class="text-gray-500">Total Revenue</p><p id="dash-total-revenue" class="text-3xl font-bold">$0</p></div></div>
                </div>
            </div>
            
            <div id="subjects" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Subjects</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    </div>
            </div>

            <div id="exams" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Exams</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    </div>
            </div>
            
            <div id="quizzes" class="tab-content fade-in hidden">
                <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                    <div>
                        <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Quiz Manager 💡</h1>
                        <p class="text-gray-500 mt-1">Create, edit, and organize your educational content.</p>
                    </div>
                </header>
                        
                <div class="bg-white rounded-xl shadow-md p-4 mb-8 border border-gray-100">
                    <label for="subject-filter" class="block text-sm font-semibold text-gray-700 mb-2">Filter Quizzes by Subject</label>
                    <select id="subject-filter" class="quiz-form-select text-gray-700">
                        <option value="all">All Subjects</option>
                        </select>
                </div>
    
                <div id="quiz-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse transition-all"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden sm:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden lg:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden xl:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                </div>
    
                <div id="pagination-container" class="mt-10 flex justify-center items-center gap-2"></div>
                
                <button id="add-quiz-fab" class="quiz-btn quiz-btn-primary quiz-fab shadow-xl" title="Add New Quiz">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>
            </div>

            <div id="generalBooks" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage General Books</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    </div>
            </div>
            
            <div id="pdf-library" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">PDF Library</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold">All Uploaded Files (sorted by size)</h2>
                        <div>
                            <input type="file" id="pdf-upload-input" multiple accept=".pdf,.zip,.png,.jpg,.jpeg" class="hidden">
                            <button id="upload-pdf-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center w-full md:w-auto"><i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload Files</button>
                        </div>
                    </div>
                    <div id="upload-progress-container" class="hidden my-4"><div class="text-sm font-medium text-gray-700 mb-1">Uploading...</div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div></div>
                    <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <input type="text" id="pdf-search" placeholder="Search files..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg">
                        <button id="delete-selected-pdfs-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center hidden w-full md:w-auto"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 w-8"><input type="checkbox" id="select-all-pdfs"></th>
                                    <th class="p-3 font-semibold text-sm">File Name</th>
                                    <th class="p-3 font-semibold text-sm">Size</th>
                                    <th class="p-3 font-semibold text-sm">Upload Date</th>
                                    <th class="p-3 font-semibold text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pdf-list-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="list-posts" class="tab-content fade-in hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">All Posts</h1>
                    <button id="add-new-post-btn-main" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center hover:bg-indigo-700 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Post
                    </button>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="search-posts" placeholder="Search posts..." class="md:col-span-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        
                        <select id="filter-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Categories</option>
                            </select>
                        
                        <select id="filter-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Statuses</option>
                            <option value="Published">Published</option>
                            <option value="Draft">Draft</option>
                            <option value="Scheduled">Scheduled</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="p-4 w-12 text-left"><input type="checkbox" id="select-all-posts"></th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Title</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Author</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Published</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="posts-table-body" class="divide-y divide-gray-200">
                                <tr><td colspan="7" class="p-8 text-center text-gray-500">Loading posts from Firebase...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="post-form-view" class="tab-content fade-in hidden">
                <h1 id="form-title" class="text-3xl font-bold text-gray-800 mb-6">Add New Post</h1>
                
                <form id="blog-post-form">
                    <input type="hidden" id="post-id">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <label for="post-title" class="block text-lg font-semibold text-gray-700 mb-2">Title</label>
                                <input type="text" id="post-title" placeholder="Your Post Title" class="w-full text-2xl font-bold px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>

                            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                                <div class="p-6 border-b">
                                    <label class="block text-lg font-semibold text-gray-700">Content</label>
                                </div>
                                <div id="quill-editor"></div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <label class="block text-lg font-semibold text-gray-700 mb-2">Attachments</label>
                                <div id="attachment-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50">
                                    <i data-lucide="paperclip" class="w-10 h-10 mx-auto text-gray-400"></i>
                                    <p class="mt-2 text-gray-500">Drop files (PDF, ZIP, etc.) here or click to upload</p>
                                    <input type="file" class="hidden" id="post-attachments" multiple>
                                </div>
                                <div id="attachment-list" class="mt-4 space-y-2">
                                    </div>
                            </div>

                            <details class="bg-white rounded-lg shadow-sm">
                                <summary class="p-6 cursor-pointer text-lg font-semibold text-gray-700 flex justify-between items-center">
                                    SEO Metadata (Optional)
                                    <i data-lucide="chevron-down" class="w-5 h-5 transform transition-transform"></i>
                                </summary>
                                <div class="p-6 border-t space-y-4">
                                    <div>
                                        <label for="seo-title" class="block text-sm font-medium text-gray-700">Meta Title</label>
                                        <input type="text" id="seo-title" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label for="seo-description" class="block text-sm font-medium text-gray-700">Meta Description</label>
                                        <textarea id="seo-description" rows="3" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                    </div>
                                    <div>
                                        <label for="seo-keywords" class="block text-sm font-medium text-gray-700">Keywords (comma-separated)</label>
                                        <input type="text" id="seo-keywords" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                </div>
                            </details>
                        </div>

                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Publish</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="post-status" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="post-status" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="Draft">Draft</option>
                                            <option value="Published">Published</option>
                                            <option value="Scheduled">Scheduled</option>
                                        </select>
                                    </div>
                                    <div id="schedule-date-wrapper" class="hidden">
                                        <label for="post-schedule-date" class="block text-sm font-medium text-gray-700">Schedule Date</label>
                                        <input type="text" id="post-schedule-date" placeholder="Select date and time" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-6 pt-4 border-t">
                                    <button type="button" id="save-draft-btn" class="text-gray-600 font-medium hover:text-indigo-600">Save Draft</button>
                                    <button type="submit" id="publish-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                                        Publish
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4">Category</h2>
                                <select id="post-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="Uncategorized">Uncategorized</option>
                                    </select>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4">Tags</h2>
                                <input id="post-tags" placeholder="Add tags...">
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <h2 class="text-lg font-semibold text-gray-700 mb-4">Feature Image</h2>
                                <div id="image-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50">
                                    <i data-lucide="image" class="w-10 h-10 mx-auto text-gray-400"></i>
                                    <p class="mt-2 text-gray-500">Drop image here or click to upload</p>
                                    <input type="file" class="hidden" id="post-image" accept="image/*">
                                </div>
                                <div id="image-preview-wrapper" class="mt-4 hidden">
                                    <img id="image-preview" src="#" alt="Image Preview" class="w-full h-auto rounded-lg">
                                    <button type="button" id="remove-image-btn" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove Image</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>

            <div id="categories" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Categories</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <form id="add-category-form" class="bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-lg font-semibold text-gray-700 mb-4">Add New Category</h2>
                            <div>
                                <label for="new-category-name" class="block text-sm font-medium text-gray-700">Category Name</label>
                                <input type="text" id="new-category-name" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <button type="submit" id="add-category-btn" class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                                Add Category
                            </button>
                        </form>
                    </div>
                    <div class="md:col-span-2">
                        <div class="bg-white rounded-lg shadow-sm">
                            <h2 class="text-lg font-semibold text-gray-700 p-6 border-b">Existing Categories</h2>
                            <ul id="categories-list" class="divide-y divide-gray-200">
                               <li class="p-6 text-center text-gray-500">Loading categories...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="comments" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Comments</h1>
                
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="search-comments" placeholder="Search comments or author..." class="md:col-span-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        
                        <select id="filter-comment-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Spam">Spam</option>
                        </select>
                    </div>
                </div>

                <div id="comments-list" class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm text-center text-gray-500">Loading comments from Firebase...</div>
                </div>
            </div>

            <div id="analytics" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Blog Analytics</h1>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-500">Total Posts</p>
                            <i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i>
                        </div>
                        <p id="stats-total-posts" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-500">Total Views</p>
                            <i data-lucide="eye" class="w-5 h-5 text-green-500"></i>
                        </div>
                        <p id="stats-total-views" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-500">Pending Comments</p>
                            <i data-lucide="messages-square" class="w-5 h-5 text-yellow-500"></i>
                        </div>
                        <p id="stats-total-comments" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-500">Published / Drafts</p>
                            <i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i>
                        </div>
                        <p id="stats-published-drafts" class="text-3xl font-bold text-gray-800 mt-2">0 / 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Popular Posts (by Views)</h2>
                        <ul id="popular-posts-list" class="divide-y divide-gray-200">
                            <li class="py-3 text-center text-gray-500">Loading data...</li>
                        </ul>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Views Over Time (Mock)</h2>
                        <div class="h-64 bg-gray-50 rounded-lg flex items-end justify-center p-4">
                            <p class="text-gray-400 m-auto">Analytics chart would be loaded here.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="users-students" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">User Management</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                        <div><p class="text-gray-500 text-sm">Total Users</p><p id="total-users" class="text-2xl font-bold">0</p></div>
                        <div class="bg-blue-100 text-blue-500 p-3 rounded-full"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                        <div><p class="text-gray-500 text-sm">Paid Users</p><p id="paid-users" class="text-2xl font-bold">0</p></div>
                        <div class="bg-green-100 text-green-500 p-3 rounded-full"><i class="fas fa-dollar-sign"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                        <div><p class="text-gray-500 text-sm">Not Paid Users</p><p id="not-paid-users" class="text-2xl font-bold">0</p></div>
                        <div class="bg-red-100 text-red-500 p-3 rounded-full"><i class="fas fa-exclamation-triangle"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                        <div><p class="text-gray-500 text-sm">Total Revenue</p><p id="total-revenue" class="text-2xl font-bold">$0</p></div>
                        <div class="bg-purple-100 text-purple-500 p-3 rounded-full"><i class="fas fa-wallet"></i></div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap gap-3 items-center">
                    <span class="text-sm font-medium text-gray-700 mr-2">Filter by:</span>
                    <button class="user-filter-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" data-filter="all">All</button>
                    <button class="user-filter-btn px-3 py-1 text-sm font-medium text-green-700 bg-green-100 rounded-full hover:bg-green-200" data-filter="paid">Paid</button>
                    <button class="user-filter-btn px-3 py-1 text-sm font-medium text-red-700 bg-red-100 rounded-full hover:bg-red-200" data-filter="not_paid">Not Paid</button>
                    
                    <span class="text-sm font-medium text-gray-700 ml-auto mr-2">Sort by:</span>
                    <button class="user-sort-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" data-sort="recent">Most Recent</button>
                    <button class="user-sort-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" data-sort="asc">Ascending (A-Z)</button>
                </div>
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="relative w-full md:w-1/3">
                        <input type="text" id="search-input" placeholder="Search by name, email, or phone..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button id="add-user-btn" class="w-full md:w-auto bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add User
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">User</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Phone</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Role</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Payment</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="users-roles" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Roles & Permissions</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-8 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Manage Roles</h2>
                        <p class="text-gray-500 mb-4">Define custom roles (e.g., "Editor", "Moderator") and assign specific permissions to each role.</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                                <span class="font-medium text-gray-700">Editor</span>
                                <button class="text-sm text-indigo-600 hover:text-indigo-800">Edit Permissions</button>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                                <span class="font-medium text-gray-700">Moderator</span>
                                <button class="text-sm text-indigo-600 hover:text-indigo-800">Edit Permissions</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Administrator Accounts</h2>
                        <p class="text-gray-500 mb-4">List of users with the 'Admin' role.</p>
                        <div class="space-y-3" id="admin-user-list">
                            <div class="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div>
                                    <p class="font-semibold text-blue-800">Admin User 1 (Loading...)</p>
                                    <p class="text-sm text-blue-600">admin@example.com</p>
                                </div>
                                <span class="text-sm font-medium text-blue-700">Admin</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="main-report" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Main Report</h1>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Total Paid Users</p>
                        <p id="report-paid-users" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Total PDFs Viewed</p>
                        <p id="report-pdf-views" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md col-span-1 md:col-span-2 lg:col-span-2">
                        <p class="text-sm font-medium text-gray-500">Top Clicked PDF</p>
                        <p id="report-top-pdf" class="text-2xl font-bold text-indigo-600 mt-1 truncate">N/A</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Total Blog Views</p>
                        <p id="report-blog-views" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <p class="text-sm font-medium text-gray-500">Active Users Today</p>
                        <p id="report-active-users" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md mb-8 flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label for="report-date-range" class="block text-sm font-medium text-gray-700">Date Range</label>
                        <input type="text" id="report-date-range" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="Select date range...">
                    </div>
                    <div class="flex-1">
                        <label for="report-content-type" class="block text-sm font-medium text-gray-700">Content Type</label>
                        <select id="report-content-type" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                            <option value="all">All Content</option>
                            <option value="pdf">PDFs</option>
                            <option value="blog">Blog Posts</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="report-subject-filter" class="block text-sm font-medium text-gray-700">Subject/Year (for PDFs)</label>
                        <select id="report-subject-filter" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                            <option value="all">All Subjects/Years</option>
                            </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Website Traffic (Last 30 Days)</h2>
                        <div class="h-80 bg-gray-50 rounded-lg flex items-center justify-center">
                            <p class="text-gray-400">Line Chart Placeholder</p>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">PDF Views by Subject</h2>
                        <div class="h-80 bg-gray-50 rounded-lg flex items-center justify-center">
                            <p class="text-gray-400">Pie Chart Placeholder</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Top 5 PDFs by Clicks</h2>
                        <div class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
                            <p class="text-gray-400">Bar Chart Placeholder</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Top Blog Posts</h2>
                        <div class="overflow-y-auto h-64">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b">
                                        <th class="p-2 text-sm font-semibold text-gray-600">Post Name</th>
                                        <th class="p-2 text-sm font-semibold text-gray-600">Views</th>
                                        <th class="p-2 text-sm font-semibold text-gray-600">Comments</th>
                                    </tr>
                                </thead>
                                <tbody id="report-blog-table">
                                    <tr><td colspan="3" class="p-4 text-center text-gray-500">Loading blog data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="settings" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>
                <div class="bg-white p-8 rounded-xl shadow-md">
                    <p class="text-gray-500">Placeholder for application settings, API keys, and configurations.</p>
                </div>
            </div>

        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 m-4 fade-in">
            </div>
    </div>

    <div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 fade-in h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Assign PDF to <span id="assign-item-type" class="capitalize">Item</span></h2>
            <p class="mb-4">Select a PDF below to assign to <strong id="assign-item-name"></strong>.</p>
            <input type="text" id="assign-pdf-search" placeholder="Search available PDFs..." class="w-full p-2 border border-gray-300 rounded-lg mb-4">
            <div id="assign-pdf-list-container" class="flex-1 overflow-y-auto border p-4 rounded-lg bg-gray-50">
                 <p class="text-center text-gray-500">Loading PDFs...</p>
            </div>
            <div class="mt-6 flex justify-end space-x-3"><button id="assign-modal-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button></div>
        </div>
    </div>
    
    <div id="assign-pdf-to-content-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 fade-in h-[80vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Assign File to Content</h2>
            <p class="mb-4 truncate">Assigning file: <strong id="assign-pdf-name-display" class="text-indigo-600"></strong></p>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4">
                <button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="subjects"><i data-lucide="book-copy" class="w-4 h-4 mr-2 inline-block"></i>Assign to Subject</button>
                <button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="exams"><i data-lucide="file-check-2" class="w-4 h-4 mr-2 inline-block"></i>Assign to Exam</button>
                <button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="generalBooks"><i data-lucide="book-open" class="w-4 h-4 mr-2 inline-block"></i>Assign to General Book</button>
            </div>
            <input type="text" id="assign-content-search" placeholder="Search for content..." class="w-full p-2 border border-gray-300 rounded-lg mb-4 hidden">
            <div id="assign-content-list-container" class="flex-1 overflow-y-auto border p-4 rounded-lg bg-gray-50">
                 <p class="text-center text-gray-500">Please select a content type above (Subject, Exam, or Book).</p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="assign-pdf-to-content-modal-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="quiz-modal" class="quiz-modal-overlay hidden">
        <div class="quiz-modal-container">
            <form id="quiz-form" class="p-6 sm:p-8">
                <div class="flex justify-between items-center pb-4 border-b mb-6">
                    <h2 id="modal-title" class="text-3xl font-extrabold text-gray-900">Add New Quiz</h2>
                    <div class="flex gap-3 items-center">
                        <button id="import-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Import Quiz from JSON"><i class="fa-solid fa-file-import mr-1"></i> Import</button>
                        <input type="file" id="json-file-input" accept=".json" class="hidden">
                        <button id="export-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Export Quiz to JSON"><i class="fa-solid fa-file-export mr-1"></i> Export</button>
                        <button id="close-modal-btn" type="button" class="text-gray-500 hover:text-gray-700 transition"><i class="fa-solid fa-xmark text-3xl"></i></button>
                    </div>
                </div>
                <input type="hidden" id="quiz-id-input">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="quiz-title" class="block text-sm font-semibold text-gray-700 mb-1">Quiz Title*</label>
                            <input type="text" id="quiz-title" class="quiz-form-input" placeholder="e.g., The French Revolution" required>
                        </div>
                        <div>
                            <label for="subject-select" class="block text-sm font-semibold text-gray-700 mb-1">Subject*</label>
                            <select id="subject-select" class="quiz-form-select" required>
                                <option value="">-- Select a Subject --</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-4 rounded-xl bg-blue-50 border border-blue-200">
                        <label for="cover-image-input" class="block text-sm font-semibold text-blue-700 mb-2 flex items-center"><i class="fa-solid fa-image mr-2"></i> Quiz Cover Image (Optional)</label>
                        <input type="file" id="cover-image-input" class="quiz-form-input p-2 bg-white" accept="image/*">
                        <p id="cover-image-filename" class="text-xs text-blue-500 mt-1 italic"></p>
                        <input type="hidden" id="cover-image-url-input">
                        <div id="cover-image-preview" class="mt-4 border-2 border-dashed border-blue-300 p-2 bg-white rounded-lg flex justify-center items-center h-40 overflow-hidden">
                            <span class="text-blue-400 text-sm">Image Preview will appear here</span>
                        </div>
                    </div>
                    <hr class="border-gray-200"/>
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center"><i class="fa-solid fa-clipboard-question mr-2 text-gray-400"></i> Questions</h3>
                    <div id="questions-container" class="space-y-5 max-h-[50vh] overflow-y-auto pr-3">
                        <p class="text-gray-500 text-center py-4 text-sm" id="question-placeholder">Add your first question below.</p>
                    </div>
                    <button type="button" id="add-question-btn" class="quiz-btn quiz-btn-secondary w-full text-blue-600 border-blue-300 bg-blue-100 hover:bg-blue-200">
                        <i class="fa-solid fa-plus mr-2"></i> Add New Question
                    </button>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button type="submit" id="save-quiz-btn" class="quiz-btn quiz-btn-primary flex-grow text-lg py-3"><i class="fa-solid fa-floppy-disk mr-2"></i> Save Quiz</button>
                    <button id="delete-quiz-btn" type="button" class="quiz-btn quiz-btn-danger flex-grow hidden"><i class="fa-solid fa-trash-alt mr-2"></i> Delete Quiz</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="user-modal" class="user-modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="user-modal-title" class="text-2xl font-bold">Add New User</h2>
                <button id="user-modal-close" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="user-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="user-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-md">252</span>
                            <input type="tel" id="phone" pattern="\d{9,}" title="Phone number must be at least 9 digits" required class="rounded-none rounded-r-lg bg-gray-50 border text-gray-900 focus:ring-blue-500 focus:border-blue-500 block flex-1 min-w-0 w-full text-sm border-gray-300 p-2.5">
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="user-modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6 text-center">
                <i id="confirm-icon" class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h3 id="confirm-title" class="text-xl font-bold mb-2">Are you sure?</h3>
                <p id="confirm-message" class="text-gray-600 mb-6">You won't be able to revert this!</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="confirm-action-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg">Yes, do it!</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="delete-modal" class="modal">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="trash-2" class="w-8 h-8 text-red-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Delete Post</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this post **and all its comments**? This action cannot be undone.</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Cancel</button>
                    <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reply-modal" class="modal">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Reply to Comment</h2>
            <div class="mb-4 bg-gray-50 p-4 rounded-lg border">
                <p class="text-sm font-medium text-gray-800" id="reply-author"></p>
                <p class="text-sm text-gray-600 mt-1" id="reply-original-text"></p>
            </div>
            <form id="reply-form">
                <input type="hidden" id="reply-comment-id">
                <textarea id="reply-text" rows="4" placeholder="Write your reply..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-reply-btn" type="button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Cancel</button>
                    <button id="submit-reply-btn" type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Submit Reply</button>
                </div>
            </form>
        </div>
    </div>

    <div id="share-modal" class="modal">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Share Post</h2>
                <button id="cancel-share-btn" class="p-1 text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-2">Share this post:</p>
            <p class="text-lg font-semibold text-gray-800 mb-4" id="share-post-title">Post Title Here</p>
            
            <div class="flex items-center space-x-2">
                <input type="text" id="share-post-url" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none">
                <button id="copy-url-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 flex items-center">
                    <i data-lucide="copy" class="w-4 h-4 mr-2"></i> Copy
                </button>
            </div>

            <div class="flex justify-center space-x-4 mt-6">
                <a id="share-twitter" href="#" target="_blank" class="p-3 bg-blue-400 text-white rounded-full hover:bg-blue-500">
                    <i data-lucide="twitter" class="w-5 h-5"></i>
                </a>
                <a id="share-facebook" href="#" target="_blank" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700">
                    <i data-lucide="facebook" class="w-5 h-5"></i>
                </a>
                <a id="share-linkedin" href="#" target="_blank" class="p-3 bg-blue-700 text-white rounded-full hover:bg-blue-800">
                    <i data-lucide="linkedin" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>

</body>
</html>
