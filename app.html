<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdayCaawiye - Complete CMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #374151; color: white; }
        .sidebar-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .sidebar-link .icon { width: 1.125rem; height: 1.125rem; margin-right: 0.75rem; flex-shrink: 0; }
        .dropdown-menu { display: none; padding-left: 1.5rem; }
        .sidebar-link.has-dropdown.open + .dropdown-menu { display: block; }
        .sidebar-link.has-dropdown.open .dropdown-icon { transform: rotate(180deg); }
        .dropdown-menu .sidebar-link { padding-top: 0.5rem; padding-bottom: 0.5rem; font-size: 0.875rem; }
        .dropdown-menu .sidebar-link:hover { background-color: #374151; }
        .dropdown-menu .sidebar-link.active { color: #a5b4fc; background-color: transparent; font-weight: 500; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .quiz-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 2rem 1rem; } /* Hidden by default */
        .quiz-modal-container { background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 56rem; margin: auto; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        #quiz-form { overflow-y: auto; }
        .quiz-form-input, .quiz-form-select { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.65rem 1rem; font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .quiz-form-input:focus, .quiz-form-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .quiz-btn { padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
        .quiz-btn-primary { background-color: #4f46e5; color: white; }
        .quiz-btn-primary:hover { background-color: #4338ca; }
        .quiz-btn-secondary { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .quiz-btn-secondary:hover { background-color: #e5e7eb; }
        .quiz-btn-danger { background-color: #dc2626; color: white; }
        .quiz-btn-danger:hover { background-color: #b91c1c; }
        .quiz-fab { position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem; border-radius: 9999px; z-index: 40; }
        .quiz-fab .fa-solid { font-size: 1.5rem; }
        .user-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 60; display: none; }
        .app-view { display: none; } .app-view.active { display: block; } /* Keep for blog compatibility */
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 1rem; display: none; }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        #quill-editor { height: 400px; }
        .tagify { --tags-border-color: #d1d5db; border-radius: 0.5rem; }
        .tagify:hover { --tags-border-color: #4f46e5; }
        .tagify.tagify--focus { --tags-border-color: #4f46e5; }
        .user-filter-btn.active, .user-sort-btn.active { background-color: #e0e7ff; color: #4338ca; font-weight: 600; }
        /* Add basic styles for content lists */
        .content-list { list-style: none; padding: 0; margin: 0; }
        .content-list li { background-color: #f9fafb; padding: 0.75rem 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .content-actions button { margin-left: 0.5rem; }
    </style>
</head>
<body class="flex h-screen overflow-hidden" style="font-family: 'Inter', sans-serif;">

    <div id="main-app" class="flex w-full h-full">

        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col fixed h-full z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-5 text-2xl font-bold border-b border-gray-700 flex items-center">
                <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.appspot.com/o/logo.png?alt=media&token=5b34de54-86a0-47e1-8848-033190897645" alt="Logo" class="h-8 mr-2">
                <span>ArdayCaawiye</span>
            </div>
            <nav class="flex-1 p-3 space-y-1.5 overflow-y-auto">
                <a href="#" class="sidebar-link active" data-tab="dashboard"><i data-lucide="home" class="icon"></i> Dashboard</a>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="folder-kanban" class="icon"></i><span class="flex-1 text-left">Manage Content</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="subjects"><i data-lucide="book-copy" class="icon"></i> Subjects</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="exams"><i data-lucide="file-check-2" class="icon"></i> Exams</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="quizzes"><i data-lucide="puzzle" class="icon"></i> Quizzes</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="generalBooks"><i data-lucide="book-open" class="icon"></i> General Books</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="pdf-library"><i data-lucide="library" class="icon"></i> PDF Library</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="newspaper" class="icon"></i><span class="flex-1 text-left">Blog Management</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="list-posts"><i data-lucide="layout-list" class="icon"></i> All Posts</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="post-form-view"><i data-lucide="plus-square" class="icon"></i> Add New Post</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="categories"><i data-lucide="tag" class="icon"></i> Categories</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="comments"><i data-lucide="messages-square" class="icon"></i> Comments</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="analytics"><i data-lucide="bar-chart-3" class="icon"></i> Analytics</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="users" class="icon"></i><span class="flex-1 text-left">User Management</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="users-students"><i data-lucide="user" class="icon"></i> Students / Members</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="users-roles"><i data-lucide="shield-check" class="icon"></i> Roles & Permissions</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="bar-chart-3" class="icon"></i><span class="flex-1 text-left">Reports & Analytics</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="main-report"><i data-lucide="activity" class="icon"></i> Main Report</a></li>
                    </ul>
                </div>
                <a href="#" class="sidebar-link" data-tab="settings"><i data-lucide="settings" class="icon"></i> Settings</a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div id="auth-status" class="text-xs text-gray-400 truncate mb-2">Admin Access</div>
                <button id="logout-btn" class="w-full flex items-center justify-center p-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium text-sm"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout</button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>

        <div class="md:hidden flex justify-between items-center bg-white p-4 border-b fixed top-0 left-0 right-0 z-10">
            <span class="text-xl font-bold text-gray-800">ArdayCaawiye CMS</span>
            <button id="mobile-menu-btn" class="text-gray-800"><i data-lucide="menu" class="w-6 h-6"></i></button>
        </div>

        <main class="flex-1 ml-0 md:ml-64 pt-20 md:pt-4 p-4 md:p-8 overflow-y-auto bg-gray-50">

            <div id="dashboard" class="tab-content fade-in">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h1>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-indigo-100 p-4 rounded-full mr-4"><i data-lucide="book-copy" class="w-8 h-8 text-indigo-600"></i></div><div><p class="text-gray-500">Total Subjects</p><p id="total-subjects" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-green-100 p-4 rounded-full mr-4"><i data-lucide="file-check-2" class="w-8 h-8 text-green-600"></i></div><div><p class="text-gray-500">Total Exams</p><p id="total-exams" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-amber-100 p-4 rounded-full mr-4"><i data-lucide="book-open" class="w-8 h-8 text-amber-600"></i></div><div><p class="text-gray-500">Total Books</p><p id="total-books" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-sky-100 p-4 rounded-full mr-4"><i data-lucide="puzzle" class="w-8 h-8 text-sky-600"></i></div><div><p class="text-gray-500">Total Quizzes</p><p id="total-quizzes" class="text-3xl font-bold">0</p></div></div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-blue-100 p-4 rounded-full mr-4"><i data-lucide="users" class="w-8 h-8 text-blue-600"></i></div><div><p class="text-gray-500">Total Users</p><p id="dash-total-users" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-emerald-100 p-4 rounded-full mr-4"><i data-lucide="user-check" class="w-8 h-8 text-emerald-600"></i></div><div><p class="text-gray-500">Paid Users</p><p id="dash-paid-users" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-rose-100 p-4 rounded-full mr-4"><i data-lucide="user-x" class="w-8 h-8 text-rose-600"></i></div><div><p class="text-gray-500">Banned Users</p><p id="dash-banned-users" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-purple-100 p-4 rounded-full mr-4"><i data-lucide="wallet" class="w-8 h-8 text-purple-600"></i></div><div><p class="text-gray-500">Total Revenue</p><p id="dash-total-revenue" class="text-3xl font-bold">$0</p></div></div>
                 </div>
            </div>

            <div id="subjects" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Subjects</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700">Add Subject</button>
                    <ul id="subjects-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>

            <div id="exams" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Exams</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                     <button class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700">Add Exam</button>
                     <ul id="exams-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>

            <div id="quizzes" class="tab-content fade-in hidden">
                <header class="flex justify-between items-center mb-8">
                    <div><h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Quiz Manager ðŸ’¡</h1><p class="text-gray-500 mt-1">Create, edit, and organize quizzes.</p></div>
                    <button id="add-quiz-fab-header" class="quiz-btn quiz-btn-primary shadow-lg"><i class="fa-solid fa-plus mr-2"></i> Add New Quiz</button> </header>
                <div class="bg-white rounded-xl shadow-md p-4 mb-8 border"><label for="quiz-subject-filter" class="block text-sm font-semibold mb-2">Filter by Subject</label><select id="quiz-subject-filter" class="quiz-form-select text-gray-700"><option value="all">All Subjects</option></select></div>
                <div id="quiz-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"><div class="bg-white p-4 rounded-xl shadow border animate-pulse"><div class="h-16 bg-gray-200 rounded mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div></div>
                <div id="quiz-pagination-container" class="mt-10 flex justify-center items-center gap-2"></div>
                </div>

            <div id="generalBooks" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage General Books</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700">Add Book</button>
                    <ul id="books-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>

            <div id="pdf-library" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">PDF Library</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-xl font-semibold">All Uploaded Files</h2><div><input type="file" id="pdf-upload-input" multiple accept=".pdf,.zip,.png,.jpg,.jpeg,.docx,.pptx" class="hidden"><button id="upload-pdf-btn" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700 flex items-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload</button></div></div>
                    <div id="upload-progress-container" class="hidden my-4"><div class="text-sm mb-1">Uploading...</div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div></div>
                    <div class="mb-4 flex flex-col md:flex-row justify-between items-center gap-4"><input type="text" id="pdf-search" placeholder="Search files..." class="w-full md:w-1/2 p-2 border rounded"><button id="delete-selected-pdfs-btn" class="bg-red-600 text-white px-4 py-2 rounded font-medium hover:bg-red-700 flex items-center hidden"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected</button></div>
                    <div class="overflow-x-auto"><table class="w-full text-left"> <thead class="bg-gray-50"><tr><th class="p-3 w-8"><input type="checkbox" id="select-all-pdfs"></th><th class="p-3 font-semibold text-sm">File Name</th><th class="p-3 font-semibold text-sm">Size</th><th class="p-3 font-semibold text-sm">Upload Date</th><th class="p-3 font-semibold text-sm">Actions</th></tr></thead><tbody id="pdf-list-table"><tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr></tbody></table></div>
                </div>
            </div>

            <div id="list-posts" class="tab-content fade-in hidden"> /* ... (Keep Blog HTML as is) ... */ </div>
            <div id="post-form-view" class="tab-content fade-in hidden"> /* ... (Keep Blog HTML as is) ... */ </div>
            <div id="categories" class="tab-content fade-in hidden"> /* ... (Keep Blog HTML as is) ... */ </div>
            <div id="comments" class="tab-content fade-in hidden"> /* ... (Keep Blog HTML as is) ... */ </div>
            <div id="analytics" class="tab-content fade-in hidden"> /* ... (Keep Blog HTML as is) ... */ </div>

            <div id="users-students" class="tab-content fade-in hidden"> /* ... (Keep User HTML as is) ... */ </div>
            <div id="users-roles" class="tab-content fade-in hidden"> /* ... (Keep User HTML as is) ... */ </div>

            <div id="main-report" class="tab-content fade-in hidden"> /* ... (Keep Report HTML as is) ... */ </div>

            <div id="settings" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>
                <div class="bg-white p-8 rounded-xl shadow-md"><p class="text-gray-500">Application settings...</p></div>
            </div>

        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-10"><div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 m-4 fade-in"></div></div>
    <div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"> /* ... */ </div>
    <div id="assign-pdf-to-content-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"> /* ... */ </div>
    <div id="quiz-modal" class="quiz-modal-overlay"> /* ... (Make sure 'hidden' class is present) ... */ </div>
    <div id="user-modal" class="user-modal-backdrop p-4"> /* ... */ </div>
    <div id="confirm-modal" class="user-modal-backdrop"> /* ... */ </div>
    <div id="delete-modal" class="modal"> /* ... (Blog delete) ... */ </div>
    <div id="reply-modal" class="modal"> /* ... (Blog reply) ... */ </div>
    <div id="share-modal" class="modal"> /* ... (Blog share) ... */ </div>

    <div id="toast" class="hidden fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform translate-x-full opacity-0"></div>


    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; // Only Auth needed if using logout
        import {
            getFirestore, collection, getDocs, getDoc, addDoc, doc,
            updateDoc, deleteDoc, onSnapshot, serverTimestamp, query,
            where, orderBy, writeBatch, Timestamp, collectionGroup,getCountFromServer // Added getCountFromServer
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace
            authDomain: "ardaycaawiye-18b89.firebaseapp.com", projectId: "ardaycaawiye-18b89", storageBucket: "ardaycaawiye-18b89.firebasestorage.app", messagingSenderId: "590874185284", appId: "1:590874185284:web:6ee7df602c45068e38b611", measurementId: "G-SBGSTJWDMR"
        };

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Keep for potential logout
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Collections ---
        const postsCollection = collection(db, "blogPosts");
        const commentsCollection = collection(db, "blogComments");
        const categoriesCollection = collection(db, "blogCategories");
        const usersCollection = collection(db, "users");
        // *** ADDED: Content Collections ***
        const subjectsCollection = collection(db, "subjects");
        const examsCollection = collection(db, "exams");
        const quizzesCollection = collection(db, "quizzes");
        const booksCollection = collection(db, "generalBooks");
        const pdfsCollectionRef = ref(storage); // Reference to storage root for listing PDFs


        // --- Global State ---
        let currentUser = null; // Keep null or manage based on non-Firebase auth
        let currentActiveTab = 'dashboard';
        let allPosts = [], allComments = [], allCategories = [], allUsers = [];
        let allSubjects = [], allExams = [], allQuizzes = [], allBooks = [], allPdfs = []; // Added content state
        let unsubscribePosts = () => {}, unsubscribeComments = () => {}, unsubscribeCategories = () => {}, unsubscribeUsers = () => {};
        let unsubscribeSubjects = () => {}, unsubscribeExams = () => {}, unsubscribeQuizzes = () => {}, unsubscribeBooks = () => {}, unsubscribePdfs = () => {}; // Added content unsubscribers

        // --- Lib Instances ---
        let quill, tagify, schedulePicker, reportDatePicker;

        // --- DOM Elements ---
        const mainApp = document.getElementById('main-app');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatus = document.getElementById('auth-status');
        const allTabs = document.querySelectorAll('.tab-content');
        const allSidebarLinks = document.querySelectorAll('#sidebar .sidebar-link');
        const dropdownToggles = document.querySelectorAll('#sidebar .has-dropdown');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mainSidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const toast = document.getElementById('toast');
        // Blog Elements... (Keep as before)
        const postsTableBody = document.getElementById('posts-table-body'); /* ... etc ... */
        const blogPostForm = document.getElementById('blog-post-form'); const postFormTitle = document.getElementById('form-title'); const postIdInput = document.getElementById('post-id'); const postTitleInput = document.getElementById('post-title'); const postStatusSelect = document.getElementById('post-status'); const scheduleDateWrapper = document.getElementById('schedule-date-wrapper'); const postCategorySelect = document.getElementById('post-category'); const filterCategorySelect = document.getElementById('filter-category'); const imageDropzone = document.getElementById('image-dropzone'); const imageInput = document.getElementById('post-image'); const imagePreviewWrapper = document.getElementById('image-preview-wrapper'); const imagePreview = document.getElementById('image-preview'); const removeImageBtn = document.getElementById('remove-image-btn'); const attachmentDropzone = document.getElementById('attachment-dropzone'); const attachmentInput = document.getElementById('post-attachments'); const attachmentList = document.getElementById('attachment-list'); const commentsListView = document.getElementById('comments-list'); const deleteModal = document.getElementById('delete-modal'); const confirmDeleteBtn = document.getElementById('confirm-delete-btn'); const cancelDeleteBtn = document.getElementById('cancel-delete-btn'); const replyModal = document.getElementById('reply-modal'); const replyForm = document.getElementById('reply-form'); const cancelReplyBtn = document.getElementById('cancel-reply-btn'); const shareModal = document.getElementById('share-modal'); const cancelShareBtn = document.getElementById('cancel-share-btn'); const copyUrlBtn = document.getElementById('copy-url-btn'); const selectAllCheckbox = document.getElementById('select-all-posts'); const categoriesList = document.getElementById('categories-list'); const addCategoryForm = document.getElementById('add-category-form');
        // User Elements... (Keep as before)
        const userTableBody = document.getElementById('user-table-body'); /* ... etc ... */
        const addUserBtn = document.getElementById('add-user-btn'); const userModal = document.getElementById('user-modal'); const userModalCloseBtn = document.getElementById('user-modal-close'); const userForm = document.getElementById('user-form'); const userModalTitle = document.getElementById('user-modal-title'); const userIdInput = document.getElementById('user-id'); const userNameInput = document.getElementById('name'); const userEmailInput = document.getElementById('user-email'); const userPhoneInput = document.getElementById('phone'); const userCancelBtn = document.getElementById('cancel-btn'); const confirmActionModal = document.getElementById('confirm-modal'); const confirmActionBtn = document.getElementById('confirm-action-btn'); const confirmCancelBtn = document.getElementById('confirm-cancel-btn'); const confirmTitle = document.getElementById('confirm-title'); const confirmMessage = document.getElementById('confirm-message'); const confirmIcon = document.getElementById('confirm-icon'); const searchUserInput = document.getElementById('search-input'); const userFilterBtns = document.querySelectorAll('.user-filter-btn'); const userSortBtns = document.querySelectorAll('.user-sort-btn'); const adminUserListContainer = document.getElementById('admin-user-list');
        // Dashboard Stats... (Keep as before)
        const dashTotalSubjects = document.getElementById('total-subjects'); /* ... etc ... */
        const dashTotalExams = document.getElementById('total-exams'); const dashTotalBooks = document.getElementById('total-books'); const dashTotalQuizzes = document.getElementById('total-quizzes'); const dashTotalUsers = document.getElementById('dash-total-users'); const dashPaidUsers = document.getElementById('dash-paid-users'); const dashBannedUsers = document.getElementById('dash-banned-users'); const dashTotalRevenue = document.getElementById('dash-total-revenue');
        // User Tab Stats... (Keep as before)
        const usersTotal = document.getElementById('total-users'); /* ... etc ... */
        const usersPaid = document.getElementById('paid-users'); const usersNotPaid = document.getElementById('not-paid-users'); const usersRevenue = document.getElementById('total-revenue');
        // Report Tab Elements... (Keep as before)
        const reportPaidUsersEl = document.getElementById('report-paid-users'); /* ... etc ... */
        const reportPdfViewsEl = document.getElementById('report-pdf-views'); const reportTopPdfEl = document.getElementById('report-top-pdf'); const reportBlogViewsEl = document.getElementById('report-blog-views'); const reportActiveUsersEl = document.getElementById('report-active-users');
        // *** ADDED: Content List Elements ***
        const subjectsListEl = document.getElementById('subjects-list');
        const examsListEl = document.getElementById('exams-list');
        const quizzesListEl = document.getElementById('quiz-list-container'); // Reuse existing quiz container
        const booksListEl = document.getElementById('books-list');
        const pdfListTableBody = document.getElementById('pdf-list-table');
        const pdfUploadBtn = document.getElementById('upload-pdf-btn');
        const pdfUploadInput = document.getElementById('pdf-upload-input');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const pdfSearchInput = document.getElementById('pdf-search');
        const deleteSelectedPdfsBtn = document.getElementById('delete-selected-pdfs-btn');
        const selectAllPdfsCheckbox = document.getElementById('select-all-pdfs');
        // Quiz specific elements (already defined but listed here for clarity)
        const addQuizFabHeader = document.getElementById('add-quiz-fab-header');
        const quizModal = document.getElementById('quiz-modal');
        const closeQuizModalBtn = document.getElementById('close-modal-btn');
        // ... other quiz form elements ...


        // =============================================
        // Initialization
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupMainEventListeners();
            initBlogLibs();
            setupBlogEventListeners();
            setupContentEventListeners(); // Added setup for content sections

            reportDatePicker = flatpickr("#report-date-range", { mode: "range", dateFormat: "Y-m-d" });

            // Assume logged in
            authStatus.textContent = 'Admin Access';
            mainApp.classList.remove('hidden');
            showTab(currentActiveTab || 'dashboard');
        });

        // =============================================
        // Toast Notification (Keep as is)
        // =============================================
        function showToast(message, isError = false) { /* ... keep implementation ... */
             toast.textContent = message; toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform ${isError ? 'bg-red-600' : 'bg-green-600'}`; toast.style.transform = 'translateX(100%)'; toast.style.opacity = '0'; toast.classList.remove('hidden'); void toast.offsetWidth; toast.style.transition = 'all 0.3s ease-out'; toast.style.transform = 'translateX(0)'; toast.style.opacity = '1'; setTimeout(() => { toast.style.transform = 'translateX(100%)'; toast.style.opacity = '0'; setTimeout(() => toast.classList.add('hidden'), 300); }, 3000);
        }

        // =============================================
        // Navigation & Listener Management
        // =============================================
        function stopAllListeners() {
            // console.log("Stopping all listeners...");
            unsubscribePosts(); unsubscribeComments(); unsubscribeCategories(); unsubscribeUsers();
            unsubscribeSubjects(); unsubscribeExams(); unsubscribeQuizzes(); unsubscribeBooks(); // unsubscribePdfs(); // PDF listing doesn't use snapshot
            unsubscribePosts=()=>{}; unsubscribeComments=()=>{}; unsubscribeCategories=()=>{}; unsubscribeUsers=()=>{};
            unsubscribeSubjects=()=>{}; unsubscribeExams=()=>{}; unsubscribeQuizzes=()=>{}; unsubscribeBooks=()=>{}; //unsubscribePdfs=()=>{};
        }

        function showTab(tabId) {
            console.log(`Switching to tab: ${tabId}`);
            stopAllListeners();
            currentActiveTab = tabId;
            allTabs.forEach(tab => tab.classList.add('hidden'));
            const newTab = document.getElementById(tabId);
            if (newTab) { newTab.classList.remove('hidden'); }
            else { document.getElementById('dashboard').classList.remove('hidden'); currentActiveTab = 'dashboard'; }

            allSidebarLinks.forEach(link => link.classList.remove('active'));
            dropdownToggles.forEach(btn => btn.classList.remove('open'));
            const activeLink = document.querySelector(`#sidebar .sidebar-link[data-tab="${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                const parentDropdownMenu = activeLink.closest('.dropdown-menu');
                if (parentDropdownMenu) {
                    const parentButton = parentDropdownMenu.previousElementSibling;
                    if (parentButton?.classList.contains('has-dropdown')) { parentButton.classList.add('open'); }
                }
            }

            // Init logic for the new tab
            switch (tabId) {
                case 'dashboard': loadDashboardStats(); break;
                case 'users-students': initUsersListener(renderUserTable); break;
                case 'users-roles': initUsersListener(renderAdminList); break;
                case 'main-report': console.log("Init Main Report..."); /* initMainReport(); */ break;
                // Blog
                case 'list-posts': initPostsListener(); initCategoriesListener(); break;
                case 'post-form-view': initCategoriesListener(); if (!editingPostId) showPostForm(); break;
                case 'categories': initCategoriesListener(renderCategoriesList); break;
                case 'comments': initPostsListener(); initCommentsListener(); break;
                case 'analytics': fetchAllDataForAnalytics(); break;
                // *** ADDED: Content Tabs ***
                case 'subjects': initSubjectsListener(); break;
                case 'exams': initExamsListener(); break;
                case 'quizzes': initQuizzesListener(); initSubjectsListener(populateQuizSubjectFilter); break; // Also load subjects for filter
                case 'generalBooks': initBooksListener(); break;
                case 'pdf-library': loadPdfList(); break; // PDF uses load on demand, not listener
                // Settings
                case 'settings': console.log("Settings Tab - Placeholder"); break;
            }
            lucide.createIcons();
        }

        // =============================================
        // Main Event Listeners Setup
        // =============================================
        function setupMainEventListeners() {
            // Logout (Keep or remove based on needs)
            logoutBtn.addEventListener('click', () => { showToast("Logout action triggered."); /* Add real logout logic */ });
            // Sidebar Navigation (Keep as is)
            allSidebarLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); if (link.classList.contains('has-dropdown')) { link.classList.toggle('open'); } else if (link.dataset.tab) { editingPostId = null; showTab(link.dataset.tab); if (!mainSidebar.classList.contains('-translate-x-full')) { mainSidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); } } }); });
            // Mobile Sidebar (Keep as is)
            mobileMenuBtn.addEventListener('click', () => { mainSidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); });
            sidebarOverlay.addEventListener('click', () => { mainSidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); });
            // User Management (Keep as is)
            addUserBtn.addEventListener('click', () => showUserModal()); userModalCloseBtn.addEventListener('click', () => hideUserModal()); userCancelBtn.addEventListener('click', () => hideUserModal()); userForm.addEventListener('submit', handleUserFormSubmit); searchUserInput.addEventListener('input', () => renderUserTable()); userFilterBtns.forEach(btn => btn.addEventListener('click', handleUserFilterClick)); userSortBtns.forEach(btn => btn.addEventListener('click', handleUserSortClick)); confirmCancelBtn.addEventListener('click', () => hideConfirmModal()); userTableBody.addEventListener('click', (e) => { const editBtn=e.target.closest('.edit-user-btn'),delBtn=e.target.closest('.delete-user-btn'); if(editBtn)showUserModal(editBtn.dataset.id); if(delBtn)showConfirmModal('Delete User','Are you sure?',()=>deleteUser(delBtn.dataset.id),!0); });
        }

        // =============================================
        // Dashboard Logic (Updated)
        // =============================================
        async function loadDashboardStats() {
            console.log("Loading dashboard stats...");
            try {
                // Use getCountFromServer for efficiency
                const usersQuery = query(usersCollection, where("role", "!=", "admin"));
                const paidUsersQuery = query(usersCollection, where("paymentStatus", "==", "paid"), where("role", "!=", "admin"));
                const subjectsQuery = query(subjectsCollection);
                const examsQuery = query(examsCollection);
                const booksQuery = query(booksCollection);
                const quizzesQuery = query(quizzesCollection);

                const [
                    usersCountSnap, paidUsersCountSnap, subjectsCountSnap,
                    examsCountSnap, booksCountSnap, quizzesCountSnap
                ] = await Promise.all([
                    getCountFromServer(usersQuery),
                    getCountFromServer(paidUsersQuery),
                    getCountFromServer(subjectsQuery),
                    getCountFromServer(examsQuery),
                    getCountFromServer(booksQuery),
                    getCountFromServer(quizzesQuery)
                ]);

                const totalUsers = usersCountSnap.data().count;
                const paidUsers = paidUsersCountSnap.data().count;
                const totalSubjects = subjectsCountSnap.data().count;
                const totalExams = examsCountSnap.data().count;
                const totalBooks = booksCountSnap.data().count;
                const totalQuizzes = quizzesCountSnap.data().count;

                dashTotalUsers.textContent = totalUsers;
                dashPaidUsers.textContent = paidUsers;
                dashTotalSubjects.textContent = totalSubjects;
                dashTotalExams.textContent = totalExams;
                dashTotalBooks.textContent = totalBooks;
                dashTotalQuizzes.textContent = totalQuizzes;

                const revenue = paidUsers * 5; // Example calc
                dashTotalRevenue.textContent = `$${revenue}`;
                // dashBannedUsers.textContent = '0'; // Add banned user count if tracked

            } catch (error) {
                console.error("Error loading dashboard stats:", error);
                showToast("Failed to load dashboard statistics.", true);
                // Reset stats on error
                dashTotalUsers.textContent = 'Err'; dashPaidUsers.textContent = 'Err'; dashTotalSubjects.textContent = 'Err'; dashTotalExams.textContent = 'Err'; dashTotalBooks.textContent = 'Err'; dashTotalQuizzes.textContent = 'Err'; dashTotalRevenue.textContent = '$Err';
            }
        }

        // =============================================
        // User Management Logic (Keep as is)
        // =============================================
        let currentUsersFilter = 'all'; let currentUsersSort = 'recent'; function handleUserFilterClick(e) { /* ... */ userFilterBtns.forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentUsersFilter=e.target.dataset.filter; renderUserTable(); } function handleUserSortClick(e) { /* ... */ userSortBtns.forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentUsersSort=e.target.dataset.sort; renderUserTable(); } function initUsersListener(renderCallback) { /* ... */ unsubscribeUsers = onSnapshot(usersCollection,snap=>{allUsers=snap.docs.map(d=>({id:d.id,...d.data()}));if(renderCallback)renderCallback();updateUserStats();},e=>{console.error(e);showToast("Err users.",!0);/* UI Error */}); } function renderUserTable() { /* ... keep full implementation ... */ userTableBody.innerHTML = ''; const searchTerm = searchUserInput.value.toLowerCase(); let filteredUsers = allUsers.filter(user => user.role !== 'admin'); if (currentUsersFilter === 'paid') filteredUsers = filteredUsers.filter(u => u.paymentStatus === 'paid'); else if (currentUsersFilter === 'not_paid') filteredUsers = filteredUsers.filter(u => u.paymentStatus !== 'paid'); if (searchTerm) filteredUsers = filteredUsers.filter(u => (u.name?.toLowerCase().includes(searchTerm)) || (u.email?.toLowerCase().includes(searchTerm)) || (u.phone?.includes(searchTerm))); filteredUsers.sort((a, b) => { if (currentUsersSort === 'asc') return (a.name || '').localeCompare(b.name || ''); else { const timeA = a.createdAt?.toMillis() || 0; const timeB = b.createdAt?.toMillis() || 0; return timeB - timeA; } }); if (filteredUsers.length === 0) { userTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No users found.</td></tr>`; return; } filteredUsers.forEach(user => { const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50"; const pStatus = user.paymentStatus === 'paid'; tr.innerHTML = `<td class="p-4"><div class="font-medium">${user.name||'N/A'}</div><div class="text-sm text-gray-500">${user.email||'N/A'}</div></td><td class="p-4 text-sm">${user.phone?`252${user.phone}`:'N/A'}</td><td class="p-4 text-sm capitalize">${user.role||'student'}</td><td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded ${pStatus?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${pStatus?'Paid':'Not Paid'}</span></td><td class="p-4"><div class="flex space-x-1"><button class="edit-user-btn p-1 text-indigo-600 hover:text-indigo-800" data-id="${user.id}" title="Edit"><i data-lucide="edit-2" class="w-4 h-4 p-e-none"></i></button><button class="delete-user-btn p-1 text-red-600 hover:text-red-800" data-id="${user.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button></div></td>`; userTableBody.appendChild(tr); }); lucide.createIcons(); } function renderAdminList() { /* ... keep implementation ... */ adminUserListContainer.innerHTML='';const admins=allUsers.filter(u=>u.role==='admin');if(admins.length===0){adminUserListContainer.innerHTML=`<p class="text-center text-gray-500">No admins.</p>`;return;}admins.forEach(a=>{const d=document.createElement('div');d.className="flex items-center justify-between p-3 bg-blue-50 border rounded";d.innerHTML=`<div><p class="font-semibold text-blue-800">${a.name||'Admin'}</p><p class="text-sm text-blue-600">${a.email}</p></div><span class="text-sm font-medium text-blue-700 capitalize">${a.role}</span>`;adminUserListContainer.appendChild(d);}); } function updateUserStats() { /* ... keep implementation ... */ const nonAdmin=allUsers.filter(u=>u.role!=='admin'),paid=nonAdmin.filter(u=>u.paymentStatus==='paid').length,rev=paid*5;usersTotal.textContent=nonAdmin.length;usersPaid.textContent=paid;usersNotPaid.textContent=nonAdmin.length-paid;usersRevenue.textContent=`$${rev}`; } async function showUserModal(userId=null) { /* ... keep implementation ... */ userForm.reset();userIdInput.value='';if(userId){userModalTitle.textContent='Edit';try{const snap=await getDoc(doc(db,"users",userId));if(snap.exists()){const d=snap.data();userIdInput.value=userId;userNameInput.value=d.name||'';userEmailInput.value=d.email||'';userPhoneInput.value=d.phone||'';}else{showToast('User not found.',!0);return;}}catch(e){console.error(e);showToast('Load failed.',!0);return;}}else{userModalTitle.textContent='Add New';}userModal.style.display='flex'; } function hideUserModal() { /* ... keep implementation ... */ userModal.style.display='none'; } async function handleUserFormSubmit(e) { /* ... keep implementation ... */ e.preventDefault();const id=userIdInput.value,name=userNameInput.value.trim(),email=userEmailInput.value.trim(),phone=userPhoneInput.value.trim();if(!name||!email){showToast('Name/Email required.',!0);return;}if(phone&&!/^\d+$/.test(phone)){showToast('Phone digits only.',!0);return;}const data={name,email,phone,role:'student',paymentStatus:'not_paid'};const btn=userForm.querySelector('button[type="submit"]');btn.disabled=!0;btn.textContent='Saving...';try{if(id){await updateDoc(doc(db,"users",id),data);showToast('User updated!');}else{data.createdAt=serverTimestamp();await addDoc(usersCollection,data);showToast('User added!');}hideUserModal();}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);}finally{btn.disabled=!1;btn.textContent='Save';} } async function deleteUser(userId) { /* ... keep implementation ... */ try{await deleteDoc(doc(db,"users",userId));showToast('User deleted!');}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);} } let confirmActionCallback=null; function showConfirmModal(title,msg,onConfirm,isDanger=!1) { /* ... keep implementation ... */ confirmTitle.textContent=title;confirmMessage.textContent=msg;confirmActionCallback=onConfirm;confirmActionBtn.className=`px-6 py-2 text-white rounded font-medium ${isDanger?'bg-red-600 hover:bg-red-700':'bg-indigo-600 hover:bg-indigo-700'}`;confirmIcon.className=`text-4xl mb-4 ${isDanger?'fas fa-exclamation-triangle text-red-500':'fas fa-question-circle text-indigo-500'}`;confirmActionBtn.textContent=isDanger?'Yes, delete!':'Yes';confirmActionBtn.replaceWith(confirmActionBtn.cloneNode(!0));document.getElementById('confirm-action-btn').addEventListener('click',()=>{if(confirmActionCallback)confirmActionCallback();hideConfirmModal();});confirmActionModal.style.display='flex'; } function hideConfirmModal() { /* ... keep implementation ... */ confirmActionModal.style.display='none';confirmActionCallback=null; }

        // =============================================
        // === CONTENT MANAGEMENT LOGIC (NEW) ===
        // =============================================

        // --- Subjects ---
        function initSubjectsListener() {
            unsubscribeSubjects = onSnapshot(query(subjectsCollection, orderBy("name")), (snapshot) => {
                allSubjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContentList(subjectsListEl, allSubjects, 'Subject');
            }, error => { console.error("Error fetching subjects:", error); subjectsListEl.innerHTML = `<li class="text-red-500">Error loading subjects.</li>`; });
        }

        // --- Exams ---
        function initExamsListener() {
            unsubscribeExams = onSnapshot(query(examsCollection, orderBy("title")), (snapshot) => {
                allExams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContentList(examsListEl, allExams, 'Exam');
            }, error => { console.error("Error fetching exams:", error); examsListEl.innerHTML = `<li class="text-red-500">Error loading exams.</li>`; });
        }

        // --- Quizzes ---
        function initQuizzesListener() {
            // NOTE: Quiz rendering is more complex and likely handled by separate functions
            // This listener just fetches data for potential use (e.g., dashboard count)
             unsubscribeQuizzes = onSnapshot(query(quizzesCollection, orderBy("title")), (snapshot) => {
                allQuizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Existing quiz rendering logic should be triggered here if needed
                console.log(`Fetched ${allQuizzes.length} quizzes`);
                // For now, just log it. The existing quiz functions handle rendering.
            }, error => { console.error("Error fetching quizzes:", error); /* Show error in quiz list */ });
        }
        function populateQuizSubjectFilter() {
             const filterSelect = document.getElementById('quiz-subject-filter');
             // Add subject options from allSubjects to the quiz filter dropdown
             // (Ensure this runs *after* subjects are fetched)
             console.log("Populating quiz subject filter (placeholder)");
        }

        // --- General Books ---
        function initBooksListener() {
            unsubscribeBooks = onSnapshot(query(booksCollection, orderBy("title")), (snapshot) => {
                allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContentList(booksListEl, allBooks, 'Book');
            }, error => { console.error("Error fetching books:", error); booksListEl.innerHTML = `<li class="text-red-500">Error loading books.</li>`; });
        }

        // --- Generic Content Renderer ---
        function renderContentList(listElement, items, itemType) {
            listElement.innerHTML = ''; // Clear list
            if (!items || items.length === 0) {
                listElement.innerHTML = `<li class="text-gray-500">No ${itemType.toLowerCase()}s found.</li>`;
                return;
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="font-medium">${item.name || item.title || 'Unnamed Item'}</span>
                    <div class="content-actions">
                        <button class="edit-${itemType.toLowerCase()}-btn p-1 text-indigo-600 hover:text-indigo-800" data-id="${item.id}" title="Edit ${itemType}">
                            <i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                        <button class="delete-${itemType.toLowerCase()}-btn p-1 text-red-600 hover:text-red-800" data-id="${item.id}" title="Delete ${itemType}">
                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                    </div>`;
                listElement.appendChild(li);
            });
            lucide.createIcons();
        }

        // --- PDF Library ---
        async function loadPdfList() {
             pdfListTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading files from storage...</td></tr>';
             try {
                // NOTE: Listing directly from Firebase Storage requires careful permission setup
                // and can be less efficient than storing metadata in Firestore.
                // This is a basic example; a Firestore metadata collection is recommended for large libraries.
                 const listRef = ref(storage, '/'); // List root or a specific folder e.g., 'pdfs/'
                 const res = await listAll(listRef); // Consider list() for pagination if many files

                 allPdfs = await Promise.all(res.items.map(async (itemRef) => {
                     const metadata = await getMetadata(itemRef);
                     return {
                         name: itemRef.name,
                         fullPath: itemRef.fullPath,
                         size: metadata.size,
                         timeCreated: metadata.timeCreated,
                         // url: await getDownloadURL(itemRef) // Get URL if needed immediately
                     };
                 }));

                 renderPdfTable();

             } catch (error) {
                 console.error("Error listing PDF files:", error);
                 pdfListTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading files. Check storage permissions.</td></tr>';
                 showToast("Error loading files from storage.", true);
             }
         }

        function renderPdfTable() {
            pdfListTableBody.innerHTML = '';
            const searchTerm = pdfSearchInput.value.toLowerCase();
            const filteredPdfs = allPdfs.filter(pdf => pdf.name.toLowerCase().includes(searchTerm));

            // Sort by size (descending) - modify if needed
            filteredPdfs.sort((a, b) => b.size - a.size);

            if (filteredPdfs.length === 0) {
                 pdfListTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No files found.</td></tr>';
                 return;
             }

            filteredPdfs.forEach(pdf => {
                 const tr = document.createElement('tr');
                 tr.className = "border-b hover:bg-gray-50";
                 tr.innerHTML = `
                     <td class="p-3"><input type="checkbox" class="pdf-checkbox" data-path="${pdf.fullPath}"></td>
                     <td class="p-3 font-medium text-gray-700">${pdf.name}</td>
                     <td class="p-3 text-sm text-gray-600">${formatBytes(pdf.size)}</td>
                     <td class="p-3 text-sm text-gray-600">${new Date(pdf.timeCreated).toLocaleDateString()}</td>
                     <td class="p-3">
                         <div class="flex space-x-1">
                             <button class="view-pdf-btn p-1 text-blue-600 hover:text-blue-800" data-path="${pdf.fullPath}" title="View/Download">
                                 <i data-lucide="external-link" class="w-4 h-4 pointer-events-none"></i>
                             </button>
                             <button class="delete-pdf-btn p-1 text-red-600 hover:text-red-800" data-path="${pdf.fullPath}" title="Delete File">
                                 <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                             </button>
                              </div>
                     </td>`;
                 pdfListTableBody.appendChild(tr);
             });
             lucide.createIcons();
             updateDeleteSelectedButtonState(); // Show/hide delete button
             selectAllPdfsCheckbox.checked = false;
         }

         function formatBytes(bytes, decimals = 2) {
             if (bytes === 0) return '0 Bytes';
             const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
             const i = Math.floor(Math.log(bytes) / Math.log(k));
             return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
         }

         async function handlePdfUpload(files) {
             if (!files || files.length === 0) return;
             uploadProgressContainer.classList.remove('hidden');
             uploadProgressBar.style.width = '0%';

             for (const file of files) {
                 const fileRef = ref(storage, `${file.name}`); // Upload to root or specific folder
                 const uploadTask = uploadBytesResumable(fileRef, file);

                 uploadTask.on('state_changed',
                     (snapshot) => {
                         const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                         uploadProgressBar.style.width = progress + '%';
                         console.log('Upload is ' + progress + '% done for ' + file.name);
                     },
                     (error) => {
                         console.error("Upload Error:", error);
                         showToast(`Error uploading ${file.name}: ${error.code}`, true);
                         uploadProgressContainer.classList.add('hidden'); // Hide progress on error
                     },
                     () => {
                         getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                             console.log('File available at', downloadURL);
                             showToast(`${file.name} uploaded successfully!`);
                             // Optionally add metadata to Firestore here
                             loadPdfList(); // Refresh the list
                             uploadProgressContainer.classList.add('hidden'); // Hide progress on completion
                         });
                     }
                 );
                 // Wait for one upload to finish before starting next? Or run in parallel?
                 // await uploadTask; // Uncomment to upload sequentially
             }
             pdfUploadInput.value = ''; // Clear file input
         }

         async function deletePdfFile(filePath) {
             const fileRef = ref(storage, filePath);
             try {
                 await deleteObject(fileRef);
                 showToast('File deleted successfully.');
                 loadPdfList(); // Refresh list
             } catch (error) {
                 console.error("Error deleting file:", error);
                 showToast(`Error deleting file: ${error.message}`, true);
             }
         }

        function updateDeleteSelectedButtonState() {
             const selected = pdfListTableBody.querySelectorAll('.pdf-checkbox:checked');
             deleteSelectedPdfsBtn.classList.toggle('hidden', selected.length === 0);
         }

         async function deleteSelectedPdfs() {
             const selectedCheckboxes = pdfListTableBody.querySelectorAll('.pdf-checkbox:checked');
             if (selectedCheckboxes.length === 0) return;

             showConfirmModal(
                 `Delete ${selectedCheckboxes.length} Files`,
                 'Are you sure you want to permanently delete these files from storage?',
                 async () => {
                     deleteSelectedPdfsBtn.disabled = true;
                     deleteSelectedPdfsBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Deleting...';
                     lucide.createIcons();

                     let successCount = 0;
                     for (const checkbox of selectedCheckboxes) {
                         try {
                             await deleteObject(ref(storage, checkbox.dataset.path));
                             successCount++;
                         } catch (error) {
                             console.error(`Failed to delete ${checkbox.dataset.path}:`, error);
                             showToast(`Error deleting ${checkbox.dataset.path.split('/').pop()}`, true);
                         }
                     }
                     showToast(`${successCount} of ${selectedCheckboxes.length} files deleted.`);
                     loadPdfList(); // Refresh
                     deleteSelectedPdfsBtn.disabled = false;
                     deleteSelectedPdfsBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected';
                     lucide.createIcons();
                 },
                 true // isDanger
             );
         }


        // --- Setup Content Event Listeners ---
        function setupContentEventListeners() {
            // PDF Library Specific
            pdfUploadBtn.addEventListener('click', () => pdfUploadInput.click());
            pdfUploadInput.addEventListener('change', (e) => handlePdfUpload(e.target.files));
            pdfSearchInput.addEventListener('input', renderPdfTable);
            selectAllPdfsCheckbox.addEventListener('change', (e) => {
                 pdfListTableBody.querySelectorAll('.pdf-checkbox').forEach(cb => cb.checked = e.target.checked);
                 updateDeleteSelectedButtonState();
            });
            pdfListTableBody.addEventListener('change', (e) => { // Update button state on individual checkbox change
                 if (e.target.classList.contains('pdf-checkbox')) { updateDeleteSelectedButtonState(); }
            });
            deleteSelectedPdfsBtn.addEventListener('click', deleteSelectedPdfs);
            pdfListTableBody.addEventListener('click', async (e) => {
                 const deleteBtn = e.target.closest('.delete-pdf-btn');
                 const viewBtn = e.target.closest('.view-pdf-btn');
                 if (deleteBtn) {
                     const path = deleteBtn.dataset.path;
                     showConfirmModal('Delete File', `Permanently delete ${path.split('/').pop()}?`, () => deletePdfFile(path), true);
                 }
                 if (viewBtn) {
                     const path = viewBtn.dataset.path;
                     try { const url = await getDownloadURL(ref(storage, path)); window.open(url, '_blank'); }
                     catch(err) { console.error(err); showToast("Could not get download URL.", true); }
                 }
            });

             // Quiz Specific
             if(addQuizFabHeader) addQuizFabHeader.addEventListener('click', () => { /* showQuizModal(); */ console.log("Show Quiz Modal..."); quizModal.style.display = 'flex'; });
             if(closeQuizModalBtn) closeQuizModalBtn.addEventListener('click', () => { /* hideQuizModal(); */ quizModal.style.display = 'none'; });
             // Add event listeners for quiz form submission, add question button, etc.

             // Generic Listeners for other content types (example for subjects)
             if(subjectsListEl) subjectsListEl.addEventListener('click', (e) => {
                 const editBtn = e.target.closest('.edit-subject-btn');
                 const deleteBtn = e.target.closest('.delete-subject-btn');
                 if (editBtn) { console.log('Edit Subject:', editBtn.dataset.id); /* Show edit form */ }
                 if (deleteBtn) { console.log('Delete Subject:', deleteBtn.dataset.id); /* Show confirm */ }
             });
             // Add similar listeners for examsListEl, booksListEl
        }


        // =============================================
        // BLOG LOGIC (Keep all functions as is)
        // =============================================
        function initBlogLibs() { /* ... keep implementation ... */ try{quill = new Quill('#quill-editor', { theme: 'snow', modules: { toolbar: [[{'header': [1,2,3,!1]}],['bold','italic','underline','strike'],[{'list':'ordered'},{'list':'bullet'}],['link','image','video','code-block'],['clean']] }}); const t=document.getElementById('post-tags');if(t)tagify=new Tagify(t); schedulePicker=flatpickr("#post-schedule-date",{enableTime:!0,dateFormat:"Y-m-d H:i"});}catch(e){console.warn("Blog Libs Init Error (maybe not on this tab):", e)} }
        async function mockUploadFile(file) { /* ... keep implementation ... */ showToast(`Simulating upload: ${file.name}`);await new Promise(r=>setTimeout(r,500));const u=`https://placehold.co/600x400?text=${encodeURIComponent(file.name)}`;console.log(`Mock: ${file.name}->${u}`);return {name:file.name,url:u}; }
        function initPostsListener() { /* ... keep implementation ... */ unsubscribePosts=onSnapshot(query(postsCollection,orderBy("createdAt","desc")),s=>{allPosts=s.docs.map(d=>({id:d.id,...d.data()}));if(currentActiveTab==='list-posts')renderPostsTable();},e=>{console.error(e);showToast("Err posts.",!0);if(postsTableBody)postsTableBody.innerHTML=`<tr><td colspan="7" class="p-4 text-center text-red-500">Error loading.</td></tr>`;}); }
        function initCommentsListener() { /* ... keep implementation ... */ unsubscribeComments=onSnapshot(query(commentsCollection,orderBy("date","desc")),s=>{allComments=s.docs.map(d=>({id:d.id,...d.data()}));if(currentActiveTab==='comments')renderCommentsList();},e=>{console.error(e);showToast("Err comments.",!0);if(commentsListView)commentsListView.innerHTML=`<div class="p-4 text-center text-red-500">Error loading.</div>`;}); }
        function initCategoriesListener(cb=null) { /* ... keep implementation ... */ unsubscribeCategories=onSnapshot(query(categoriesCollection,orderBy("name")),s=>{allCategories=s.docs.map(d=>({id:d.id,...d.data()}));updateCategoryDropdowns();if(cb)cb();},e=>{console.error(e);showToast("Err cats.",!0);if(cb&&categoriesList)categoriesList.innerHTML=`<li class="p-4 text-center text-red-500">Error loading.</li>`;}); }
        async function fetchAllDataForAnalytics() { /* ... keep implementation ... */ try{const[pS,cS,catS]=await Promise.all([getDocs(postsCollection),getDocs(commentsCollection),getDocs(categoriesCollection)]);allPosts=pS.docs.map(d=>({id:d.id,...d.data()}));allComments=cS.docs.map(d=>({id:d.id,...d.data()}));allCategories=catS.docs.map(d=>({id:d.id,...d.data()}));renderAnalytics();}catch(e){console.error(e);showToast("Err analytics.",!0);} }
        function renderPostsTable() { /* ... keep implementation ... */ postsTableBody.innerHTML='';const s=document.getElementById('search-posts').value.toLowerCase(),c=filterCategorySelect.value,st=document.getElementById('filter-status').value;let f=allPosts.filter(p=>(p.title.toLowerCase().includes(s)||(p.author||'').toLowerCase().includes(s))&&(c===''||p.category===c)&&(st===''||p.status===st));if(f.length===0){postsTableBody.innerHTML=`<tr><td colspan="7" class="p-4 text-center text-gray-500">No posts.</td></tr>`;return;}f.forEach(p=>{const sc={Published:"bg-green-100 text-green-800",Draft:"bg-yellow-100 text-yellow-800",Scheduled:"bg-blue-100 text-blue-800"};const tr=document.createElement('tr');tr.className="hover:bg-gray-50";tr.innerHTML=`<td class="p-4"><input type="checkbox" class="post-checkbox" data-id="${p.id}"></td><td class="p-4"><div class="font-medium">${p.title}</div><div class="text-sm text-gray-500">${(p.tags||[]).join(', ')}</div></td><td class="p-4 text-sm">${p.author||'N/A'}</td><td class="p-4 text-sm">${p.category||'Uncat'}</td><td class="p-4"><span class="px-2 py-1 text-xs rounded ${sc[p.status]||'bg-gray-100'}">${p.status}</span></td><td class="p-4 text-sm">${p.publishDate?new Date(p.publishDate.toDate()).toLocaleDateString():'â€”'}</td><td class="p-4"><div class="flex space-x-1"><button class="view-btn p-1 text-blue-600" data-id="${p.id}" title="View"><i data-lucide="eye" class="w-4 h-4 p-e-none"></i></button><button class="edit-btn p-1 text-indigo-600" data-id="${p.id}" title="Edit"><i data-lucide="edit-2" class="w-4 h-4 p-e-none"></i></button><button class="share-btn p-1 text-green-600" data-id="${p.id}" data-title="${p.title}" title="Share"><i data-lucide="share-2" class="w-4 h-4 p-e-none"></i></button><button class="delete-btn p-1 text-red-600" data-id="${p.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button></div></td>`;postsTableBody.appendChild(tr);});lucide.createIcons();if(selectAllCheckbox)selectAllCheckbox.checked=!1; }
        function renderCommentsList() { /* ... keep implementation ... */ commentsListView.innerHTML='';const s=document.getElementById('search-comments').value.toLowerCase(),st=document.getElementById('filter-comment-status').value;let f=allComments.filter(c=>(c.author.toLowerCase().includes(s)||c.text.toLowerCase().includes(s))&&(st===''||c.status===st));if(f.length===0){commentsListView.innerHTML=`<div class="p-4 text-center text-gray-500">No comments.</div>`;return;}f.forEach(c=>{const p=allPosts.find(p=>p.id===c.postId),sc={Approved:"border-green-500",Pending:"border-yellow-500",Spam:"border-red-500"};const d=document.createElement('div');d.className=`bg-white rounded shadow-sm border-l-4 ${sc[c.status]||'border-gray-300'}`;d.innerHTML=`<div class="p-4"><div class="flex justify-between items-start"><div class="font-semibold">${c.author}<span class="text-sm font-normal text-gray-500">(${c.email})</span><div class="text-xs text-gray-500">${c.date?new Date(c.date.toDate()).toLocaleString():''}</div></div><div class="text-xs text-right text-gray-500">On:<span class="text-indigo-600">${p?p.title:'Deleted'}</span></div></div><p class="text-gray-700 my-3">${c.text}</p>${c.reply?`<div class="bg-gray-50 p-2 rounded border ml-6 text-sm"><p class="font-semibold">Reply:</p><p>${c.reply}</p></div>`:''}</div><div class="bg-gray-50 px-4 py-2 rounded-b flex flex-wrap gap-2 text-xs">${c.status!=='Approved'?`<button class="approve-comment-btn font-medium text-green-600" data-id="${c.id}"><i data-lucide="check" class="w-3 h-3 inline mr-1 p-e-none"></i>Approve</button>`:''}${c.status==='Approved'&&!c.reply?`<button class="reply-comment-btn font-medium text-blue-600" data-id="${c.id}"><i data-lucide="corner-up-left" class="w-3 h-3 inline mr-1 p-e-none"></i>Reply</button>`:''}${c.status!=='Spam'?`<button class="spam-comment-btn font-medium text-yellow-600" data-id="${c.id}"><i data-lucide="shield-alert" class="w-3 h-3 inline mr-1 p-e-none"></i>Spam</button>`:''}<button class="delete-comment-btn font-medium text-red-600 ml-auto" data-id="${c.id}"><i data-lucide="trash-2" class="w-3 h-3 inline mr-1 p-e-none"></i>Delete</button></div>`;commentsListView.appendChild(d);});lucide.createIcons(); }
        function renderCategoriesList() { /* ... keep implementation ... */ categoriesList.innerHTML='';if(allCategories.length===0){categoriesList.innerHTML=`<li class="p-4 text-center text-gray-500">No cats.</li>`;return;}allCategories.forEach(c=>{const li=document.createElement('li');li.className="flex items-center justify-between p-3";li.innerHTML=`<span class="font-medium">${c.name}</span><button class="delete-category-btn text-red-600" data-id="${c.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button>`;categoriesList.appendChild(li);});lucide.createIcons(); }
        function updateCategoryDropdowns() { /* ... keep implementation ... */ const s=[filterCategorySelect,postCategorySelect];s.forEach(sel=>{if(!sel)return;const v=sel.value;while(sel.options.length>1)sel.remove(1);allCategories.forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=c.name;sel.appendChild(o);});if(Array.from(sel.options).some(o=>o.value===v))sel.value=v;}); }
        function renderAnalytics() { /* ... keep implementation ... */ const stp=document.getElementById('stats-total-posts'),stv=document.getElementById('stats-total-views'),stc=document.getElementById('stats-total-comments'),spd=document.getElementById('stats-published-drafts'),ppl=document.getElementById('popular-posts-list');if(!stp)return;const tp=allPosts.length,tv=allPosts.reduce((a,p)=>a+(p.views||0),0),pc=allComments.filter(c=>c.status==='Pending').length,pub=allPosts.filter(p=>p.status==='Published').length,dr=allPosts.filter(p=>p.status==='Draft').length;stp.textContent=tp;stv.textContent=tv.toLocaleString();stc.textContent=pc;spd.textContent=`${pub}/${dr}`;ppl.innerHTML='';const pop=[...allPosts].sort((a,b)=>(b.views||0)-(a.views||0)).slice(0,5);if(pop.length===0){ppl.innerHTML=`<li class="py-2 text-center text-gray-500">No data</li>`;return;}pop.forEach(p=>{const li=document.createElement('li');li.className="py-2 flex justify-between items-center";li.innerHTML=`<span class="font-medium text-sm">${p.title}</span><span class="text-xs text-gray-500">${(p.views||0).toLocaleString()} views</span>`;ppl.appendChild(li);}); }
        async function showPostForm(postId=null) { /* ... keep implementation ... */ blogPostForm.reset();quill.setContents([]);if(tagify)tagify.removeAllTags();imagePreview.src="#";imagePreviewWrapper.classList.add('hidden');attachmentList.innerHTML='';postIdInput.value='';if(postId){editingPostId=postId;postFormTitle.textContent="Edit";try{const snap=await getDoc(doc(db,"blogPosts",postId));if(snap.exists()){const p=snap.data();postIdInput.value=snap.id;postTitleInput.value=p.title;try{if(p.content&&typeof p.content==='string')quill.setContents(JSON.parse(p.content));else if(p.content&&typeof p.content==='object')quill.setContents(p.content);else quill.setText('');}catch(e){console.error(e);quill.setText('Err');}postStatusSelect.value=p.status;postCategorySelect.value=p.category||'Uncat';if(tagify&&p.tags)tagify.loadOriginalValues(p.tags);if(p.publishDate&&p.status==='Scheduled'){schedulePicker.setDate(p.publishDate.toDate(),!0);scheduleDateWrapper.classList.remove('hidden');}else{scheduleDateWrapper.classList.add('hidden');schedulePicker.clear();}if(p.featureImage){imagePreview.src=p.featureImage;imagePreviewWrapper.classList.remove('hidden');}else imagePreviewWrapper.classList.add('hidden');(p.attachments||[]).forEach(f=>addAttachmentToList(f.name,f.url));document.getElementById('seo-title').value=p.seoTitle||'';document.getElementById('seo-description').value=p.seoDescription||'';document.getElementById('seo-keywords').value=p.seoKeywords||'';if(currentActiveTab!=='post-form-view')showTab('post-form-view');}else{showToast("Post not found.",!0);editingPostId=null;showTab('list-posts');return;}}catch(e){console.error(e);showToast("Err loading post.",!0);editingPostId=null;showTab('list-posts');}}else{editingPostId=null;postFormTitle.textContent="Add New";scheduleDateWrapper.classList.add('hidden');schedulePicker.clear();imagePreviewWrapper.classList.add('hidden');if(currentActiveTab!=='post-form-view')showTab('post-form-view');} }
        async function handleBlogPostFormSubmit(e) { /* ... keep implementation ... */ e.preventDefault();const btn=document.getElementById('publish-btn');btn.disabled=!0;btn.textContent="Saving...";const title=postTitleInput.value.trim(),status=postStatusSelect.value;if(!title){showToast("Title required.",!0);btn.disabled=!1;btn.textContent="Publish";return;}const content=JSON.stringify(quill.getContents());let pubDate=null;if(status==='Scheduled'){if(schedulePicker.selectedDates[0])pubDate=Timestamp.fromDate(schedulePicker.selectedDates[0]);else{showToast("Date required.",!0);btn.disabled=!1;btn.textContent="Schedule";return;}}else if(status==='Published'){const op=editingPostId?allPosts.find(p=>p.id===editingPostId):null;if(!editingPostId||(op&&!op.publishDate))pubDate=serverTimestamp();else if(op&&op.publishDate)pubDate=op.publishDate;}const data={title,content,status,category:postCategorySelect.value,tags:tagify?tagify.value.map(t=>t.value):[],publishDate:pubDate,featureImage:imagePreview.src.startsWith('http')?imagePreview.src:null,attachments:Array.from(attachmentList.children).map(i=>({name:i.dataset.name,url:i.dataset.url})),seoTitle:document.getElementById('seo-title').value,seoDescription:document.getElementById('seo-description').value,seoKeywords:document.getElementById('seo-keywords').value,modifiedAt:serverTimestamp()};try{if(editingPostId){await updateDoc(doc(db,"blogPosts",editingPostId),data);showToast("Post updated!");}else{data.createdAt=serverTimestamp();data.author=currentUser?.email||"Admin";data.views=0;data.commentsCount=0;await addDoc(postsCollection,data);showToast("Post created!");}editingPostId=null;showTab('list-posts');}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);}finally{btn.disabled=!1;btn.textContent=postStatusSelect.value==='Scheduled'?'Schedule':'Publish';} }
        async function handleImageUpload(file) { /* ... keep implementation ... */ if(file)try{const{url}=await mockUploadFile(file);imagePreview.src=url;imagePreviewWrapper.classList.remove('hidden');}catch(e){console.error(e);showToast("Img upload failed.",!0);} }
        function addAttachmentToList(name, url) { /* ... keep implementation ... */ const d=document.createElement('div');d.className="flex items-center justify-between bg-gray-100 p-2 rounded";d.dataset.name=name;d.dataset.url=url;d.innerHTML=`<div class="flex items-center overflow-hidden mr-2"><i data-lucide="file-text" class="w-4 h-4 text-gray-500 mr-2 shrink-0"></i><span class="text-sm truncate">${name}</span></div><button type="button" class="remove-attachment-btn text-sm text-red-600 shrink-0">&times;Remove</button>`;attachmentList.appendChild(d);lucide.createIcons();d.querySelector('.remove-attachment-btn').addEventListener('click',()=>{d.remove();}); }
        async function handleAttachmentUpload(files) { /* ... keep implementation ... */ for(const f of files)try{const{name,url}=await mockUploadFile(f);addAttachmentToList(name,url);}catch(e){console.error(e);showToast(`Attach failed:${f.name}`,!0);} }
        function showDeleteModal(postId) { /* ... keep implementation ... */ postToDeleteId=postId;deleteModal.style.display='flex'; }
        async function confirmDelete() { /* ... keep implementation ... */ if(postToDeleteId){confirmDeleteBtn.disabled=!0;confirmDeleteBtn.textContent="Deleting...";try{const batch=writeBatch(db);batch.delete(doc(db,"blogPosts",postToDeleteId));const q=query(commentsCollection,where("postId","==",postToDeleteId));const snap=await getDocs(q);snap.forEach(d=>batch.delete(d.ref));await batch.commit();showToast("Post deleted!");}catch(e){console.error(e);showToast(`Err delete: ${e.message}`,!0);}finally{postToDeleteId=null;deleteModal.style.display='none';confirmDeleteBtn.disabled=!1;confirmDeleteBtn.textContent="Delete";}} }
        async function updateCommentStatus(id, status) { /* ... keep implementation ... */ try{await updateDoc(doc(db,"blogComments",id),{status});showToast(`Comment: ${status}.`);}catch(e){console.error(e);showToast("Err update comment.",!0);} }
        async function deleteComment(id) { /* ... keep implementation ... */ if(confirm("Delete comment?")){try{await deleteDoc(doc(db,"blogComments",id));showToast("Comment deleted.");}catch(e){console.error(e);showToast("Err deleting.",!0);}} }
        function showReplyModal(id) { /* ... keep implementation ... */ const c=allComments.find(c=>c.id===id);if(c){commentToReplyId=id;document.getElementById('reply-author').textContent=`Replying to:${c.author}`;document.getElementById('reply-original-text').textContent=`"${c.text}"`;replyForm.reset();replyModal.style.display='flex';} }
        async function handleReplySubmit(e) { /* ... keep implementation ... */ e.preventDefault();const btn=document.getElementById('submit-reply-btn');btn.disabled=!0;btn.textContent="Submitting...";const txt=document.getElementById('reply-text').value;if(commentToReplyId&&txt){try{await updateDoc(doc(db,"blogComments",commentToReplyId),{reply:txt});showToast("Reply sent!");replyModal.style.display='none';}catch(e){console.error(e);showToast("Error replying.",!0);}finally{commentToReplyId=null;btn.disabled=!1;btn.textContent="Submit Reply";}}else{btn.disabled=!1;btn.textContent="Submit Reply";} }
        function showShareModal(id, title) { /* ... keep implementation ... */ const url=`${location.origin}/blog/post/${id}`;document.getElementById('share-post-title').textContent=title;document.getElementById('share-post-url').value=url;document.getElementById('share-twitter').href=`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;document.getElementById('share-facebook').href=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;document.getElementById('share-linkedin').href=`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;shareModal.style.display='flex';lucide.createIcons(); }
        function setupBlogEventListeners() { /* ... keep implementation ... */ const abm=document.getElementById('add-new-post-btn-main');if(abm)abm.addEventListener('click',()=>{editingPostId=null;showPostForm();});const spi=document.getElementById('search-posts');if(spi)spi.addEventListener('input',renderPostsTable);if(filterCategorySelect)filterCategorySelect.addEventListener('change',renderPostsTable);const fss=document.getElementById('filter-status');if(fss)fss.addEventListener('change',renderPostsTable);if(selectAllCheckbox)selectAllCheckbox.addEventListener('change',e=>{postsTableBody.querySelectorAll('.post-checkbox').forEach(c=>c.checked=e.target.checked);});if(postsTableBody)postsTableBody.addEventListener('click',e=>{const vb=e.target.closest('.view-btn'),eb=e.target.closest('.edit-btn'),sb=e.target.closest('.share-btn'),db=e.target.closest('.delete-btn');if(vb)window.open(`/blog/post/${vb.dataset.id}`,'_blank');if(eb)showPostForm(eb.dataset.id);if(sb)showShareModal(sb.dataset.id,sb.dataset.title);if(db)showDeleteModal(db.dataset.id);});if(confirmDeleteBtn)confirmDeleteBtn.addEventListener('click',confirmDelete);if(cancelDeleteBtn)cancelDeleteBtn.addEventListener('click',()=>deleteModal.style.display='none');if(cancelShareBtn)cancelShareBtn.addEventListener('click',()=>shareModal.style.display='none');if(copyUrlBtn)copyUrlBtn.addEventListener('click',()=>{const ui=document.getElementById('share-post-url');ui.select();ui.setSelectionRange(0,99999);try{document.execCommand('copy');showToast("URL copied!");}catch(e){console.error(e);showToast("Copy failed.",!0);}});if(blogPostForm)blogPostForm.addEventListener('submit',handleBlogPostFormSubmit);const sdb=document.getElementById('save-draft-btn');if(sdb)sdb.addEventListener('click',()=>{postStatusSelect.value="Draft";handleBlogPostFormSubmit(new Event('submit',{bubbles:!0,cancelable:!0}));});if(postStatusSelect)postStatusSelect.addEventListener('change',e=>{scheduleDateWrapper.classList.toggle('hidden',e.target.value!=='Scheduled');document.getElementById('publish-btn').textContent=e.target.value==='Scheduled'?'Schedule':'Publish';});if(imageDropzone)imageDropzone.addEventListener('click',()=>imageInput.click());if(imageInput)imageInput.addEventListener('change',e=>handleImageUpload(e.target.files[0]));if(removeImageBtn)removeImageBtn.addEventListener('click',()=>{imageInput.value='';imagePreview.src='#';imagePreviewWrapper.classList.add('hidden');});if(attachmentDropzone)attachmentDropzone.addEventListener('click',()=>attachmentInput.click());if(attachmentInput)attachmentInput.addEventListener('change',e=>handleAttachmentUpload(e.target.files));const sci=document.getElementById('search-comments');if(sci)sci.addEventListener('input',renderCommentsList);const fcsc=document.getElementById('filter-comment-status');if(fcsc)fcsc.addEventListener('change',renderCommentsList);if(commentsListView)commentsListView.addEventListener('click',e=>{const t=e.target.closest('button');if(!t)return;const id=t.dataset.id;if(t.classList.contains('approve-comment-btn'))updateCommentStatus(id,'Approved');if(t.classList.contains('spam-comment-btn'))updateCommentStatus(id,'Spam');if(t.classList.contains('delete-comment-btn'))deleteComment(id);if(t.classList.contains('reply-comment-btn'))showReplyModal(id);});if(replyForm)replyForm.addEventListener('submit',handleReplySubmit);if(cancelReplyBtn)cancelReplyBtn.addEventListener('click',()=>replyModal.style.display='none');if(addCategoryForm)addCategoryForm.addEventListener('submit',async e=>{e.preventDefault();const ni=document.getElementById('new-category-name'),cn=ni.value.trim(),btn=document.getElementById('add-category-btn');if(cn){btn.disabled=!0;btn.textContent="Adding...";if(allCategories.find(c=>c.name.toLowerCase()===cn.toLowerCase())){showToast("Cat exists.",!0);btn.disabled=!1;btn.textContent="Add";return;}try{await addDoc(categoriesCollection,{name:cn});showToast("Cat added!");ni.value='';}catch(e){console.error(e);showToast("Error add cat.",!0);}finally{btn.disabled=!1;btn.textContent="Add";}}});if(categoriesList)categoriesList.addEventListener('click',async e=>{const dcb=e.target.closest('.delete-category-btn');if(dcb){const id=dcb.dataset.id;if(confirm("Delete category?")){try{await deleteDoc(doc(db,"blogCategories",id));showToast("Cat deleted.");}catch(e){console.error(e);showToast("Err delete cat.",!0);}}}}); }


    </script>

</body>
</html>
