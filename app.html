<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdayCaawiye - Complete CMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; /* gray-100 */ }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #374151; color: white; }
        .sidebar-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .sidebar-link .icon { width: 1.125rem; height: 1.125rem; margin-right: 0.75rem; flex-shrink: 0; }
        .dropdown-menu { display: none; padding-left: 1.5rem; /* pl-6 */ }
        .sidebar-link.has-dropdown.open + .dropdown-menu { display: block; }
        .sidebar-link.has-dropdown.open .dropdown-icon { transform: rotate(180deg); }
        .dropdown-menu .sidebar-link { padding-top: 0.5rem; padding-bottom: 0.5rem; font-size: 0.875rem; }
        .dropdown-menu .sidebar-link:hover { background-color: #374151; }
        .dropdown-menu .sidebar-link.active { color: #a5b4fc; background-color: transparent; font-weight: 500; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Quiz Modal Styles */
        .quiz-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 2rem 1rem; }
        .quiz-modal-container { background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 56rem; margin: auto; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        #quiz-form { overflow-y: auto; }
        .quiz-form-input, .quiz-form-select { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.65rem 1rem; font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .quiz-form-input:focus, .quiz-form-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .quiz-btn { padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .quiz-btn-primary { background-color: #4f46e5; color: white; }
        .quiz-btn-primary:hover { background-color: #4338ca; }
        .quiz-btn-secondary { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .quiz-btn-secondary:hover { background-color: #e5e7eb; }
        .quiz-btn-danger { background-color: #dc2626; color: white; }
        .quiz-btn-danger:hover { background-color: #b91c1c; }
        .quiz-fab { position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem; border-radius: 9999px; z-index: 40; }
        .quiz-fab .fa-solid { font-size: 1.5rem; }
         .radio-custom { appearance: none; width: 1.25rem; height: 1.25rem; border: 2px solid #94a3b8; border-radius: 50%; transition: all 0.2s; cursor: pointer; margin-right: 0.5rem; flex-shrink: 0; }
        .radio-custom:checked { border-color: #1d4ed8; background-color: #1d4ed8; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e"); }
        /* User/Confirm Modal Styles */
        .user-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 60; display: none; /* Hidden by default */ }
        /* Blog-specific Styles */
        .app-view { display: none; } /* Used for Blog sections */
        .app-view.active { display: block; }
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 1rem; display: none; /* Hidden by default - Used by Blog Modals */ }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        #quill-editor { height: 400px; background-color: white;} /* Added white background */
        .ql-container.ql-snow { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; } /* Style Quill borders */
        .ql-toolbar.ql-snow { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; border-bottom: 0px;}
        .tagify { --tags-border-color: #d1d5db; border-radius: 0.5rem; background-color: white; padding: 0.5rem;} /* Added background and padding */
        .tagify:hover { --tags-border-color: #4f46e5; }
        .tagify.tagify--focus { --tags-border-color: #4f46e5; }
        /* Toast */
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s ease-in-out; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #toast.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        /* Action Button Style */
        .action-btn { padding: 0.25rem 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; font-size: 0.875rem; display: inline-flex; align-items: center; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="login-page" class="w-full h-full flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg m-4">
            <div><h2 id="auth-title" class="text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2></div>
            <form id="auth-form" class="space-y-6">
                <div><label for="email" class="sr-only">Email address</label><input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address" value="dausfilms@gmail.com"></div>
                <div><label for="password" class="sr-only">Password</label><input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password" value="siciid23"></div>
                <div><button id="auth-submit-btn" type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign in</button></div>
            </form>
            <p class="text-center text-sm text-gray-600"><a href="#" id="auth-toggle-link" class="font-medium text-indigo-600 hover:text-indigo-500">Don't have an account? Sign up</a></p>
        </div>
    </div>

    <div id="main-app" class="flex w-full h-full hidden">

        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col fixed h-full z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-5 text-2xl font-bold border-b border-gray-700 flex items-center"> <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.appspot.com/o/logo.png?alt=media&token=5b34de54-86a0-47e1-8848-033190897645" alt="Logo" class="h-8 mr-2"> <span>ArdayCaawiye</span> </div>
            <nav class="flex-1 p-3 space-y-1.5 overflow-y-auto">
                <a href="#" class="sidebar-link active" data-tab="dashboard"> <i data-lucide="home" class="icon"></i> Dashboard </a>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"> <i data-lucide="folder-kanban" class="icon"></i> <span class="flex-1 text-left">Manage Content</span> <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i> </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="subjects"><i data-lucide="book-copy" class="icon"></i> Subjects</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="exams"><i data-lucide="file-check-2" class="icon"></i> Exams</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="quizzes"><i data-lucide="puzzle" class="icon"></i> Quizzes</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="generalBooks"><i data-lucide="book-open" class="icon"></i> General Books</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="pdf-library"><i data-lucide="library" class="icon"></i> File Library</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"> <i data-lucide="newspaper" class="icon"></i> <span class="flex-1 text-left">Blog Management</span> <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i> </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="list-posts"><i data-lucide="layout-list" class="icon"></i> All Posts</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="post-form-view" data-action="add"><i data-lucide="plus-square" class="icon"></i> Add New Post</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="categories"><i data-lucide="tag" class="icon"></i> Categories</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="comments"><i data-lucide="messages-square" class="icon"></i> Comments</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="analytics"><i data-lucide="bar-chart-3" class="icon"></i> Analytics</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"> <i data-lucide="users" class="icon"></i> <span class="flex-1 text-left">User Management</span> <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i> </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="users-students"><i data-lucide="user" class="icon"></i> Students / Members</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="users-roles"><i data-lucide="shield-check" class="icon"></i> Roles & Permissions</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"> <i data-lucide="bar-chart-3" class="icon"></i> <span class="flex-1 text-left">Reports & Analytics</span> <i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i> </button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="main-report"><i data-lucide="activity" class="icon"></i> Main Report</a></li>
                    </ul>
                </div>
                <a href="#" class="sidebar-link" data-tab="settings"> <i data-lucide="settings" class="icon"></i> Settings </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div id="auth-status" class="text-xs text-gray-400 truncate mb-2">Not Authenticated</div>
                <button id="logout-btn" class="w-full flex items-center justify-center p-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors text-white font-medium text-sm"> <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout </button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>

        <div class="md:hidden flex justify-between items-center bg-white p-4 border-b fixed top-0 left-0 right-0 z-10"> <span class="text-xl font-bold text-gray-800">ArdayCaawiye CMS</span> <button id="mobile-menu-btn" class="text-gray-800"> <i data-lucide="menu" class="w-6 h-6"></i> </button> </div>

        <main class="flex-1 ml-0 md:ml-64 pt-20 md:pt-4 p-4 md:p-8 overflow-y-auto bg-gray-50">
            <div id="dashboard" class="tab-content fade-in">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-indigo-100 p-4 rounded-full mr-4"><i data-lucide="book-copy" class="w-8 h-8 text-indigo-600"></i></div><div><p class="text-gray-500">Total Subjects</p><p id="total-subjects" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-green-100 p-4 rounded-full mr-4"><i data-lucide="file-check-2" class="w-8 h-8 text-green-600"></i></div><div><p class="text-gray-500">Total Exams</p><p id="total-exams" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-amber-100 p-4 rounded-full mr-4"><i data-lucide="book-open" class="w-8 h-8 text-amber-600"></i></div><div><p class="text-gray-500">Total Books</p><p id="total-books" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-sky-100 p-4 rounded-full mr-4"><i data-lucide="puzzle" class="w-8 h-8 text-sky-600"></i></div><div><p class="text-gray-500">Total Quizzes</p><p id="total-quizzes" class="text-3xl font-bold">0</p></div></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-blue-100 p-4 rounded-full mr-4"><i data-lucide="users" class="w-8 h-8 text-blue-600"></i></div><div><p class="text-gray-500">Total Users</p><p id="dash-total-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-emerald-100 p-4 rounded-full mr-4"><i data-lucide="user-check" class="w-8 h-8 text-emerald-600"></i></div><div><p class="text-gray-500">Paid Users</p><p id="dash-paid-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-rose-100 p-4 rounded-full mr-4"><i data-lucide="user-x" class="w-8 h-8 text-rose-600"></i></div><div><p class="text-gray-500">Banned Users</p><p id="dash-banned-users" class="text-3xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-purple-100 p-4 rounded-full mr-4"><i data-lucide="wallet" class="w-8 h-8 text-purple-600"></i></div><div><p class="text-gray-500">Total Revenue</p><p id="dash-total-revenue" class="text-3xl font-bold">$0</p></div></div>
                </div>
            </div>
            <div id="subjects" class="tab-content fade-in hidden">
                </div>
            <div id="exams" class="tab-content fade-in hidden">
                 </div>
            <div id="quizzes" class="tab-content fade-in hidden">
                <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                    <div> <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Quiz Manager 💡</h1> <p class="text-gray-500 mt-1">Create, edit, and organize quizzes.</p> </div>
                </header>
                <div class="bg-white rounded-xl shadow-md p-4 mb-8 border border-gray-100">
                    <label for="subject-filter" class="block text-sm font-semibold text-gray-700 mb-2">Filter Quizzes by Subject</label>
                    <select id="subject-filter" class="quiz-form-select text-gray-700"> <option value="all">All Subjects</option> </select>
                </div>
                <div id="quiz-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden sm:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden lg:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 animate-pulse hidden xl:block"><div class="h-16 bg-gray-200 rounded-lg w-full mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div>
                </div>
                <div id="pagination-container" class="mt-10 flex justify-center items-center gap-2"></div>
                <button id="add-quiz-fab" class="quiz-btn quiz-btn-primary quiz-fab shadow-xl" title="Add New Quiz"> <i class="fa-solid fa-plus text-xl"></i> </button>
            </div>
            <div id="generalBooks" class="tab-content fade-in hidden">
                </div>
            <div id="pdf-library" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">File Library</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold">All Uploaded Files (PDF, ZIP, Images)</h2>
                        <div> <input type="file" id="pdf-upload-input" multiple accept=".pdf,.zip,.png,.jpg,.jpeg,.webp" class="hidden"> <button id="upload-pdf-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center w-full md:w-auto"><i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload Files</button> </div>
                    </div>
                    <div id="upload-progress-container" class="hidden my-4"><div class="text-sm font-medium text-gray-700 mb-1">Uploading...</div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div></div>
                    <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <input type="text" id="pdf-search" placeholder="Search files by name..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-lg">
                        <button id="delete-selected-pdfs-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center hidden w-full md:w-auto"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected (0)</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50"> <tr> <th class="p-3 w-8"><input type="checkbox" id="select-all-pdfs"></th> <th class="p-3 font-semibold text-sm">File Name</th> <th class="p-3 font-semibold text-sm">Size</th> <th class="p-3 font-semibold text-sm">Upload Date</th> <th class="p-3 font-semibold text-sm">Actions</th> </tr> </thead>
                            <tbody id="pdf-list-table"> <tr><td colspan="5" class="p-6 text-center text-gray-500">Loading files...</td></tr> </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="list-posts" class="tab-content fade-in hidden app-view">
                 <div class="flex justify-between items-center mb-6"> <h1 class="text-3xl font-bold text-gray-800">All Posts</h1> <button id="add-new-post-btn-main" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center hover:bg-indigo-700 transition-colors"> <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Post </button> </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6"> <div class="grid grid-cols-1 md:grid-cols-4 gap-4"> <input type="text" id="search-posts" placeholder="Search posts..." class="md:col-span-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"> <select id="filter-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"> <option value="">All Categories</option> </select> <select id="filter-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"> <option value="">All Statuses</option> <option value="Published">Published</option> <option value="Draft">Draft</option> <option value="Scheduled">Scheduled</option> </select> </div> </div>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden"> <div class="overflow-x-auto"> <table class="w-full"> <thead class="bg-gray-50 border-b border-gray-200"> <tr> <th class="p-4 w-12 text-left"><input type="checkbox" id="select-all-posts"></th> <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Title</th> <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Author</th> <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Category</th> <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Status</th> <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Published</th> <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</th> </tr> </thead> <tbody id="posts-table-body" class="divide-y divide-gray-200"> <tr><td colspan="7" class="p-8 text-center text-gray-500">Loading posts...</td></tr> </tbody> </table> </div> </div>
            </div>
            <div id="post-form-view" class="tab-content fade-in hidden app-view">
                <h1 id="form-title" class="text-3xl font-bold text-gray-800 mb-6">Add New Post</h1>
                <form id="blog-post-form"> <input type="hidden" id="post-id"> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div class="lg:col-span-2 space-y-6"> <div class="bg-white p-6 rounded-lg shadow-sm"> <label for="post-title" class="block text-lg font-semibold text-gray-700 mb-2">Title</label> <input type="text" id="post-title" placeholder="Your Post Title" class="w-full text-2xl font-bold px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required> </div> <div class="bg-white rounded-lg shadow-sm overflow-hidden"> <div class="p-6 border-b"><label class="block text-lg font-semibold text-gray-700">Content</label></div> <div id="quill-editor"></div> </div> <div class="bg-white p-6 rounded-lg shadow-sm"> <label class="block text-lg font-semibold text-gray-700 mb-2">Attachments</label> <div id="attachment-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50"> <i data-lucide="paperclip" class="w-10 h-10 mx-auto text-gray-400"></i> <p class="mt-2 text-gray-500">Drop files (PDF, ZIP, etc.) here or click to upload</p> <input type="file" class="hidden" id="post-attachments" multiple> </div> <div id="attachment-list" class="mt-4 space-y-2"></div> </div> <details class="bg-white rounded-lg shadow-sm"> <summary class="p-6 cursor-pointer text-lg font-semibold text-gray-700 flex justify-between items-center">SEO Metadata (Optional)<i data-lucide="chevron-down" class="w-5 h-5 transform transition-transform"></i></summary> <div class="p-6 border-t space-y-4"> <div><label for="seo-title" class="block text-sm font-medium text-gray-700">Meta Title</label><input type="text" id="seo-title" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div> <div><label for="seo-description" class="block text-sm font-medium text-gray-700">Meta Description</label><textarea id="seo-description" rows="3" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea></div> <div><label for="seo-keywords" class="block text-sm font-medium text-gray-700">Keywords (comma-separated)</label><input type="text" id="seo-keywords" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div> </div> </details> </div> <div class="lg:col-span-1 space-y-6"> <div class="bg-white p-6 rounded-lg shadow-sm"> <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Publish</h2> <div class="space-y-4"> <div><label for="post-status" class="block text-sm font-medium text-gray-700">Status</label><select id="post-status" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="Draft">Draft</option><option value="Published">Published</option><option value="Scheduled">Scheduled</option></select></div> <div id="schedule-date-wrapper" class="hidden"><label for="post-schedule-date" class="block text-sm font-medium text-gray-700">Schedule Date</label><input type="text" id="post-schedule-date" placeholder="Select date and time" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div> </div> <div class="flex justify-between items-center mt-6 pt-4 border-t"><button type="button" id="save-draft-btn" class="text-gray-600 font-medium hover:text-indigo-600">Save Draft</button><button type="submit" id="publish-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Publish</button></div> </div> <div class="bg-white p-6 rounded-lg shadow-sm"> <h2 class="text-lg font-semibold text-gray-700 mb-4">Category</h2> <select id="post-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="Uncategorized">Uncategorized</option></select> </div> <div class="bg-white p-6 rounded-lg shadow-sm"> <h2 class="text-lg font-semibold text-gray-700 mb-4">Tags</h2> <input id="post-tags" placeholder="Add tags..."> </div> <div class="bg-white p-6 rounded-lg shadow-sm"> <h2 class="text-lg font-semibold text-gray-700 mb-4">Feature Image</h2> <div id="image-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50"><i data-lucide="image" class="w-10 h-10 mx-auto text-gray-400"></i><p class="mt-2 text-gray-500">Drop image here or click to upload</p><input type="file" class="hidden" id="post-image" accept="image/*"></div> <div id="image-preview-wrapper" class="mt-4 hidden"><img id="image-preview" src="#" alt="Image Preview" class="w-full h-auto rounded-lg"><button type="button" id="remove-image-btn" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove Image</button></div> </div> </div> </div> </form>
            </div>
            <div id="categories" class="tab-content fade-in hidden app-view">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Categories</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> <div class="md:col-span-1"> <form id="add-category-form" class="bg-white p-6 rounded-lg shadow-sm"> <h2 class="text-lg font-semibold text-gray-700 mb-4">Add New Category</h2> <div><label for="new-category-name" class="block text-sm font-medium text-gray-700">Category Name</label><input type="text" id="new-category-name" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div> <button type="submit" id="add-category-btn" class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Add Category</button> </form> </div> <div class="md:col-span-2"> <div class="bg-white rounded-lg shadow-sm"> <h2 class="text-lg font-semibold text-gray-700 p-6 border-b">Existing Categories</h2> <ul id="categories-list" class="divide-y divide-gray-200"><li class="p-6 text-center text-gray-500">Loading categories...</li></ul> </div> </div> </div>
            </div>
            <div id="comments" class="tab-content fade-in hidden app-view">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Comments</h1>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6"> <div class="grid grid-cols-1 md:grid-cols-3 gap-4"> <input type="text" id="search-comments" placeholder="Search comments or author..." class="md:col-span-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"> <select id="filter-comment-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"> <option value="">All Statuses</option><option value="Pending">Pending</option><option value="Approved">Approved</option><option value="Spam">Spam</option> </select> </div> </div>
                <div id="comments-list" class="space-y-6"> <div class="bg-white p-6 rounded-lg shadow-sm text-center text-gray-500">Loading comments...</div> </div>
            </div>
            <div id="analytics" class="tab-content fade-in hidden app-view">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Blog Analytics</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"> <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Posts</p><i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i></div><p id="stats-total-posts" class="text-3xl font-bold text-gray-800 mt-2">0</p></div> <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Views</p><i data-lucide="eye" class="w-5 h-5 text-green-500"></i></div><p id="stats-total-views" class="text-3xl font-bold text-gray-800 mt-2">0</p></div> <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Pending Comments</p><i data-lucide="messages-square" class="w-5 h-5 text-yellow-500"></i></div><p id="stats-total-comments" class="text-3xl font-bold text-gray-800 mt-2">0</p></div> <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Published / Drafts</p><i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i></div><p id="stats-published-drafts" class="text-3xl font-bold text-gray-800 mt-2">0 / 0</p></div> </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"> <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-xl font-semibold text-gray-800 mb-4">Popular Posts (by Views)</h2><ul id="popular-posts-list" class="divide-y divide-gray-200"><li class="py-3 text-center text-gray-500">Loading data...</li></ul></div> <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-xl font-semibold text-gray-800 mb-4">Views Over Time (Placeholder)</h2><div class="h-64 bg-gray-50 rounded-lg flex items-center justify-center p-4"><p class="text-gray-400 m-auto">Analytics chart here.</p></div></div> </div>
            </div>
            <div id="users-students" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">User Management</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"> <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Total Users</p><p id="total-users" class="text-2xl font-bold">0</p></div><div class="bg-blue-100 text-blue-500 p-3 rounded-full"><i class="fas fa-users"></i></div></div> <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Paid Users</p><p id="paid-users" class="text-2xl font-bold">0</p></div><div class="bg-green-100 text-green-500 p-3 rounded-full"><i class="fas fa-dollar-sign"></i></div></div> <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Not Paid Users</p><p id="not-paid-users" class="text-2xl font-bold">0</p></div><div class="bg-red-100 text-red-500 p-3 rounded-full"><i class="fas fa-exclamation-triangle"></i></div></div> <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Total Revenue</p><p id="total-revenue" class="text-2xl font-bold">$0</p></div><div class="bg-purple-100 text-purple-500 p-3 rounded-full"><i class="fas fa-wallet"></i></div></div> </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap gap-3 items-center"> <span class="text-sm font-medium text-gray-700 mr-2">Filter by:</span> <button class="user-filter-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 active" data-filter="all">All</button> <button class="user-filter-btn px-3 py-1 text-sm font-medium text-green-700 bg-green-100 rounded-full hover:bg-green-200" data-filter="paid">Paid</button> <button class="user-filter-btn px-3 py-1 text-sm font-medium text-red-700 bg-red-100 rounded-full hover:bg-red-200" data-filter="not_paid">Not Paid</button> <span class="text-sm font-medium text-gray-700 ml-auto mr-2">Sort by:</span> <button class="user-sort-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 active" data-sort="recent">Most Recent</button> <button class="user-sort-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" data-sort="asc">Ascending (A-Z)</button> </div>
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"> <div class="relative w-full md:w-1/3"><input type="text" id="search-input" placeholder="Search by name, email, or phone..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div> <button id="add-user-btn" class="w-full md:w-auto bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors"><i class="fas fa-plus mr-2"></i>Add User</button> </div>
                <div class="bg-white rounded-lg shadow-md overflow-x-auto"> <table class="w-full table-auto"> <thead class="bg-gray-50 border-b-2 border-gray-200"> <tr> <th class="p-4 text-left text-sm font-semibold text-gray-600">User</th> <th class="p-4 text-left text-sm font-semibold text-gray-600">Phone</th> <th class="p-4 text-left text-sm font-semibold text-gray-600">Role</th> <th class="p-4 text-left text-sm font-semibold text-gray-600">Payment</th> <th class="p-4 text-left text-sm font-semibold text-gray-600">Actions</th> </tr> </thead> <tbody id="user-table-body"> <tr><td colspan="5" class="p-6 text-center text-gray-500">Loading users...</td></tr> </tbody> </table> </div>
            </div>
            <div id="users-roles" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Roles & Permissions</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> <div class="bg-white p-8 rounded-xl shadow-md"> <h2 class="text-xl font-bold text-gray-800 mb-4">Manage Roles</h2> <p class="text-gray-500 mb-4">Define custom roles and assign permissions.</p> <div class="space-y-2"> <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border"> <span class="font-medium text-gray-700">Editor</span> <button class="text-sm text-indigo-600 hover:text-indigo-800">Edit Permissions</button> </div> <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border"> <span class="font-medium text-gray-700">Moderator</span> <button class="text-sm text-indigo-600 hover:text-indigo-800">Edit Permissions</button> </div> </div> </div> <div class="bg-white p-8 rounded-xl shadow-md"> <h2 class="text-xl font-bold text-gray-800 mb-4">Administrator Accounts</h2> <p class="text-gray-500 mb-4">List of users with the 'Admin' role.</p> <div class="space-y-3" id="admin-user-list"> <p class="text-gray-500">Loading admin users...</p> </div> </div> </div>
            </div>
            <div id="main-report" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Main Report (Placeholder)</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8"> <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">Paid Users</p><p id="report-paid-users" class="text-3xl font-bold text-gray-800 mt-1">0</p></div> <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">PDF Views</p><p id="report-pdf-views" class="text-3xl font-bold text-gray-800 mt-1">0</p></div> <div class="bg-white p-5 rounded-xl shadow-md col-span-1 md:col-span-2 lg:col-span-2"><p class="text-sm font-medium text-gray-500">Top PDF</p><p id="report-top-pdf" class="text-2xl font-bold text-indigo-600 mt-1 truncate">N/A</p></div> <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">Blog Views</p><p id="report-blog-views" class="text-3xl font-bold text-gray-800 mt-1">0</p></div> <div class="bg-white p-5 rounded-xl shadow-md"><p class="text-sm font-medium text-gray-500">Active Users Today</p><p id="report-active-users" class="text-3xl font-bold text-gray-800 mt-1">0</p></div> </div>
                <div class="bg-white p-4 rounded-xl shadow-md mb-8 flex flex-col md:flex-row gap-4"> <div class="flex-1"><label for="report-date-range" class="block text-sm font-medium text-gray-700">Date Range</label><input type="text" id="report-date-range" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="Select date range..."></div> <div class="flex-1"><label for="report-content-type" class="block text-sm font-medium text-gray-700">Content Type</label><select id="report-content-type" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"><option value="all">All</option><option value="pdf">PDFs</option><option value="blog">Blog</option></select></div> <div class="flex-1"><label for="report-subject-filter" class="block text-sm font-medium text-gray-700">Subject/Year</label><select id="report-subject-filter" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"><option value="all">All</option></select></div> </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8"> <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold text-gray-800 mb-4">Traffic (Placeholder)</h2><div class="h-80 bg-gray-50 rounded-lg flex items-center justify-center"><p class="text-gray-400">Line Chart</p></div></div> <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold text-gray-800 mb-4">Views by Subject (Placeholder)</h2><div class="h-80 bg-gray-50 rounded-lg flex items-center justify-center"><p class="text-gray-400">Pie Chart</p></div></div> </div>
            </div>
            <div id="settings" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>
                <div class="bg-white p-8 rounded-xl shadow-md"> <p class="text-gray-500">Placeholder for application settings, API keys, etc.</p> </div>
            </div>
            </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-10"> <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 m-4 fade-in"></div> </div>
    <div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"> <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 fade-in h-[80vh] flex flex-col"><h2 class="text-2xl font-bold mb-4">Assign File to <span id="assign-item-type" class="capitalize">Item</span></h2><p class="mb-4">Select a file below to assign to <strong id="assign-item-name"></strong>.</p><input type="text" id="assign-pdf-search" placeholder="Search available files..." class="w-full p-2 border border-gray-300 rounded-lg mb-4"><div id="assign-pdf-list-container" class="flex-1 overflow-y-auto border p-4 rounded-lg bg-gray-50"><p class="text-center text-gray-500">Loading files...</p></div><div class="mt-6 flex justify-end space-x-3"><button id="assign-modal-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button></div></div> </div>
    <div id="assign-pdf-to-content-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"> <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 fade-in h-[80vh] flex flex-col"><h2 class="text-2xl font-bold mb-4">Assign File to Content</h2><p class="mb-4 truncate">Assigning file: <strong id="assign-pdf-name-display" class="text-indigo-600"></strong></p><div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4"><button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="subjects"><i data-lucide="book-copy" class="w-4 h-4 mr-2 inline-block"></i>Assign to Subject</button><button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="exams"><i data-lucide="file-check-2" class="w-4 h-4 mr-2 inline-block"></i>Assign to Exam</button><button class="assign-pdf-select-type-btn flex-1 bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100 hover:text-indigo-700" data-type="generalBooks"><i data-lucide="book-open" class="w-4 h-4 mr-2 inline-block"></i>Assign to General Book</button></div><input type="text" id="assign-content-search" placeholder="Search for content..." class="w-full p-2 border border-gray-300 rounded-lg mb-4 hidden"><div id="assign-content-list-container" class="flex-1 overflow-y-auto border p-4 rounded-lg bg-gray-50"><p class="text-center text-gray-500">Please select a content type above.</p></div><div class="mt-6 flex justify-end space-x-3"><button id="assign-pdf-to-content-modal-cancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button></div></div> </div>
    <div id="quiz-modal" class="quiz-modal-overlay hidden"> <div class="quiz-modal-container"> <form id="quiz-form" class="p-6 sm:p-8"> <div class="flex justify-between items-center pb-4 border-b mb-6"> <h2 id="modal-title" class="text-3xl font-extrabold text-gray-900">Add New Quiz</h2> <div class="flex gap-3 items-center"> <button id="import-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Import Quiz from JSON"><i class="fa-solid fa-file-import mr-1"></i> Import</button> <input type="file" id="json-file-input" accept=".json" class="hidden"> <button id="export-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Export Quiz to JSON"><i class="fa-solid fa-file-export mr-1"></i> Export</button> <button id="close-modal-btn" type="button" class="text-gray-500 hover:text-gray-700 transition"><i class="fa-solid fa-xmark text-3xl"></i></button> </div> </div> <input type="hidden" id="quiz-id-input"> <div class="space-y-6"> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> <div><label for="quiz-title" class="block text-sm font-semibold text-gray-700 mb-1">Quiz Title*</label><input type="text" id="quiz-title" class="quiz-form-input" placeholder="e.g., The French Revolution" required></div> <div><label for="subject-select" class="block text-sm font-semibold text-gray-700 mb-1">Subject*</label><select id="subject-select" class="quiz-form-select" required><option value="">-- Select a Subject --</option></select></div> </div> <div class="p-4 rounded-xl bg-blue-50 border border-blue-200"> <label for="cover-image-input" class="block text-sm font-semibold text-blue-700 mb-2 flex items-center"><i class="fa-solid fa-image mr-2"></i> Quiz Cover Image (Optional)</label> <input type="file" id="cover-image-input" class="quiz-form-input p-2 bg-white" accept="image/*"> <p id="cover-image-filename" class="text-xs text-blue-500 mt-1 italic"></p><input type="hidden" id="cover-image-url-input"> <div id="cover-image-preview" class="mt-4 border-2 border-dashed border-blue-300 p-2 bg-white rounded-lg flex justify-center items-center h-40 overflow-hidden"><span class="text-blue-400 text-sm">Image Preview</span></div> </div> <hr class="border-gray-200"/> <h3 class="text-2xl font-bold text-gray-900 flex items-center"><i class="fa-solid fa-clipboard-question mr-2 text-gray-400"></i> Questions</h3> <div id="questions-container" class="space-y-5 max-h-[50vh] overflow-y-auto pr-3"><p class="text-gray-500 text-center py-4 text-sm" id="question-placeholder">Add question below.</p></div> <button type="button" id="add-question-btn" class="quiz-btn quiz-btn-secondary w-full text-blue-600 border-blue-300 bg-blue-100 hover:bg-blue-200"><i class="fa-solid fa-plus mr-2"></i> Add Question</button> </div> <div class="mt-8 flex flex-col sm:flex-row gap-4"> <button type="submit" id="save-quiz-btn" class="quiz-btn quiz-btn-primary flex-grow text-lg py-3"><i class="fa-solid fa-floppy-disk mr-2"></i> Save Quiz</button> <button id="delete-quiz-btn" type="button" class="quiz-btn quiz-btn-danger flex-grow hidden"><i class="fa-solid fa-trash-alt mr-2"></i> Delete Quiz</button> </div> </form> </div> </div>
    <div id="user-modal" class="user-modal-backdrop p-4"> <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4"> <div class="p-6 border-b flex justify-between items-center"><h2 id="user-modal-title" class="text-2xl font-bold">Add User</h2><button id="user-modal-close" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div> <div class="p-6"> <form id="user-form"> <input type="hidden" id="user-id"> <div class="mb-4"><label for="name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div> <div class="mb-4"><label for="user-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="user-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div> <div class="mb-4"><label for="phone" class="block text-sm font-medium text-gray-700">Phone</label><div class="flex"><span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-md">252</span><input type="tel" id="phone" pattern="\d{9,}" title="Phone (9+ digits, no 252)" required class="rounded-none rounded-r-lg bg-gray-50 border text-gray-900 focus:ring-blue-500 focus:border-blue-500 block flex-1 min-w-0 w-full text-sm border-gray-300 p-2.5"></div></div> <div class="flex justify-end gap-4 mt-6"><button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save User</button></div> </form> </div> </div> </div>
    <div id="confirm-modal" class="user-modal-backdrop"> <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4"> <div class="p-6 text-center"> <i id="confirm-icon" class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i> <h3 id="confirm-title" class="text-xl font-bold mb-2">Are you sure?</h3> <p id="confirm-message" class="text-gray-600 mb-6">Action cannot be undone!</p> <div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button id="confirm-action-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg">Yes, do it!</button></div> </div> </div> </div>
    <div id="delete-modal" class="modal"> <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4"> <div class="text-center"> <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="trash-2" class="w-8 h-8 text-red-600"></i></div> <h2 class="text-2xl font-bold text-gray-800 mb-2">Delete Post</h2> <p class="text-gray-600 mb-6">Delete this post & comments? Cannot be undone.</p> <div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Cancel</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Delete</button></div> </div> </div> </div>
    <div id="reply-modal" class="modal"> <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4"> <h2 class="text-2xl font-bold text-gray-800 mb-4">Reply to Comment</h2> <div class="mb-4 bg-gray-50 p-4 rounded-lg border"><p class="text-sm font-medium text-gray-800" id="reply-author"></p><p class="text-sm text-gray-600 mt-1" id="reply-original-text"></p></div> <form id="reply-form"><input type="hidden" id="reply-comment-id"><textarea id="reply-text" rows="4" placeholder="Write reply..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea><div class="flex justify-end gap-4 mt-6"><button id="cancel-reply-btn" type="button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Cancel</button><button id="submit-reply-btn" type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Submit Reply</button></div></form> </div> </div>
    <div id="share-modal" class="modal"> <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4"> <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Share Post</h2><button id="cancel-share-btn" class="p-1 text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button></div> <p class="text-gray-600 mb-2">Share this post:</p><p class="text-lg font-semibold text-gray-800 mb-4" id="share-post-title">Post Title</p> <div class="flex items-center space-x-2"><input type="text" id="share-post-url" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none"><button id="copy-url-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 flex items-center"><i data-lucide="copy" class="w-4 h-4 mr-2"></i> Copy</button></div> <div class="flex justify-center space-x-4 mt-6"><a id="share-twitter" href="#" target="_blank" class="p-3 bg-blue-400 text-white rounded-full hover:bg-blue-500"><i data-lucide="twitter" class="w-5 h-5"></i></a><a id="share-facebook" href="#" target="_blank" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700"><i data-lucide="facebook" class="w-5 h-5"></i></a><a id="share-linkedin" href="#" target="_blank" class="p-3 bg-blue-700 text-white rounded-full hover:bg-blue-800"><i data-lucide="linkedin" class="w-5 h-5"></i></a></div> </div> </div>
    <div id="toast"></div> <script type="module">
    // --- CONSOLIDATED FIREBASE V10 IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, getDoc, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, orderBy, writeBatch, Timestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Added setDoc
    import { getStorage, ref, uploadBytesResumable, listAll, getDownloadURL, getMetadata, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // --- CONFIGURATION ---
    const firebaseConfig = { apiKey: "AIzaSyDuqswofpquk8aUbCOZCGjdYLUivBEh7a8", authDomain: "ardaycaawiye-18b89.firebaseapp.com", projectId: "ardaycaawiye-18b89", storageBucket: "ardaycaawiye-18b89.appspot.com", messagingSenderId: "590874185284", appId: "1:590874185284:web:6ee7df602c45068e38b611", measurementId: "G-SBGSTJWDMR" };

    // --- INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- GLOBAL STATE ---
    let currentUser = null;
    let currentActiveTab = 'dashboard';
    let isLoginMode = true;
    let editingPostId = null;
    let currentEditingId = null;
    let allPdfFiles = [];
    let availableSubjects = [];
    let availableExams = [];
    let availableGeneralBooks = [];
    let availableBlogCategories = [];
    let currentAssignTarget = { type: null, id: null, field: null };
    let currentPdfToAssign = { path: null, name: null };
    let postToDeleteId = null;
    let commentToReplyId = null;
    let allPosts = [];
    let allComments = [];
    let quill, tagify, schedulePicker, reportDatePicker;
    let activeManagers = { subjects: null, exams: null, generalBooks: null, pdfLibrary: null, quiz: null, users: null, blogPosts: null, blogCategories: null, blogComments: null, blogAnalytics: null, reports: null, dashboard: null };
    let commonListenersAttached = false;

    // --- DOM ELEMENTS (Ensure all IDs match HTML) ---
    const loginPage = document.getElementById('login-page');
    const mainApp = document.getElementById('main-app');
    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authToggleLink = document.getElementById('auth-toggle-link');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const logoutBtn = document.getElementById('logout-btn');
    const authStatus = document.getElementById('auth-status');
    const allTabs = document.querySelectorAll('.tab-content');
    const allSidebarLinks = document.querySelectorAll('#sidebar .sidebar-link');
    const dropdownToggles = document.querySelectorAll('#sidebar .has-dropdown');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mainSidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const toast = document.getElementById('toast');
    const modal = document.getElementById('modal'); // Generic CRUD Modal
    const modalContent = document.getElementById('modal-content');
    const userModal = document.getElementById('user-modal');
    const userForm = document.getElementById('user-form');
    const userModalCloseBtn = document.getElementById('user-modal-close');
    const userCancelBtn = document.getElementById('cancel-btn'); // In user modal
    const confirmActionModal = document.getElementById('confirm-modal'); // Generic confirm
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const deleteModal = document.getElementById('delete-modal'); // Blog delete modal
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const replyModal = document.getElementById('reply-modal');
    const replyForm = document.getElementById('reply-form');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const shareModal = document.getElementById('share-modal');
    const cancelShareBtn = document.getElementById('cancel-share-btn');
    const copyUrlBtn = document.getElementById('copy-url-btn');
    // Dashboard Stats
    const dashTotalSubjects = document.getElementById('total-subjects');
    const dashTotalExams = document.getElementById('total-exams');
    const dashTotalBooks = document.getElementById('total-books');
    const dashTotalQuizzes = document.getElementById('total-quizzes');
    const dashTotalUsers = document.getElementById('dash-total-users');
    const dashPaidUsers = document.getElementById('dash-paid-users');
    const dashBannedUsers = document.getElementById('dash-banned-users');
    const dashTotalRevenue = document.getElementById('dash-total-revenue');
    // User Management Specific
    const userTableBody = document.getElementById('user-table-body');
    const addUserBtn = document.getElementById('add-user-btn');
    const userIdInput = document.getElementById('user-id');
    const userNameInput = document.getElementById('name');
    const userEmailInput = document.getElementById('user-email');
    const userPhoneInput = document.getElementById('phone');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmIcon = document.getElementById('confirm-icon');
    const confirmActionBtn = document.getElementById('confirm-action-btn');
    const searchUserInput = document.getElementById('search-input');
    const userFilterBtns = document.querySelectorAll('.user-filter-btn');
    const userSortBtns = document.querySelectorAll('.user-sort-btn');
    const adminUserListContainer = document.getElementById('admin-user-list');
    const usersTotal = document.getElementById('total-users'); // Stats in User tab
    const usersPaid = document.getElementById('paid-users');
    const usersNotPaid = document.getElementById('not-paid-users');
    const usersRevenue = document.getElementById('total-revenue');
    // PDF Library Specific
    const pdfListTable = document.getElementById('pdf-list-table');
    const selectAllPdfsCheckbox = document.getElementById('select-all-pdfs');
    const deleteSelectedPdfsBtn = document.getElementById('delete-selected-pdfs-btn');
    const pdfSearch = document.getElementById('pdf-search');
    const uploadBtn = document.getElementById('upload-pdf-btn');
    const uploadInput = document.getElementById('pdf-upload-input');
    const progressContainer = document.getElementById('upload-progress-container');
    const progressBar = document.getElementById('upload-progress-bar');
    // Blog Specific
    const postsTableBody = document.getElementById('posts-table-body');
    const blogPostForm = document.getElementById('blog-post-form');
    const postFormTitle = document.getElementById('form-title'); // Shared ID, ensure correct usage
    const postIdInput = document.getElementById('post-id');
    const postTitleInput = document.getElementById('post-title');
    const postStatusSelect = document.getElementById('post-status');
    const scheduleDateWrapper = document.getElementById('schedule-date-wrapper');
    const postCategorySelect = document.getElementById('post-category'); // In blog form
    const filterCategorySelect = document.getElementById('filter-category'); // In blog list filter
    const imageDropzone = document.getElementById('image-dropzone');
    const imageInput = document.getElementById('post-image');
    const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const attachmentDropzone = document.getElementById('attachment-dropzone');
    const attachmentInput = document.getElementById('post-attachments');
    const attachmentList = document.getElementById('attachment-list');
    const commentsListView = document.getElementById('comments-list');
    const selectAllCheckbox = document.getElementById('select-all-posts'); // Blog post select all
    const categoriesList = document.getElementById('categories-list'); // Blog categories list
    const addCategoryForm = document.getElementById('add-category-form'); // Blog category form
    const addNewBtnMain = document.getElementById('add-new-post-btn-main'); // Blog add button
    const searchPostsInput = document.getElementById('search-posts'); // Blog search
    const filterStatusSelect = document.getElementById('filter-status'); // Blog status filter
    const searchCommentsInput = document.getElementById('search-comments'); // Blog comments search
    const filterCommentStatusSelect = document.getElementById('filter-comment-status'); // Blog comments filter
    // Assign Modals Specific
    const assignModal = document.getElementById('assign-modal');
    const assignItemNameEl = document.getElementById('assign-item-name');
    const assignItemTypeEl = document.getElementById('assign-item-type');
    const assignPdfListContainerEl = document.getElementById('assign-pdf-list-container');
    const assignPdfSearchEl = document.getElementById('assign-pdf-search');
    const assignPdfToContentModal = document.getElementById('assign-pdf-to-content-modal');
    const assignPdfNameDisplay = document.getElementById('assign-pdf-name-display');
    const assignContentSearchEl = document.getElementById('assign-content-search');
    const assignContentListContainerEl = document.getElementById('assign-content-list-container');


    // --- UTILS ---
    // ... (showToast, showModal, hideModal, formatDate, formatBytes, mockUploadFile - unchanged) ...
    const showToast = (message, type = 'success') => { toast.textContent = message; toast.className = `toast-${type}`; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 4000); };
    const showModal = (html) => { modalContent.innerHTML = html; modal.classList.remove('hidden'); attachFileInputListeners(); };
    const hideModal = () => { modal.classList.add('hidden'); modalContent.innerHTML = ''; currentEditingId = null; };
    const formatDate = (date) => { if (!date) return 'N/A'; const d = date.toDate ? date.toDate() : new Date(date); if (isNaN(d.getTime())) return 'Invalid Date'; return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }); };
    const formatBytes = (bytes, decimals = 2) => { if (!bytes || bytes === 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; };
    async function mockUploadFile(file) { showToast(`Simulating upload for ${file.name}...`); await new Promise(resolve => setTimeout(resolve, 500)); const mockUrl = `https://mockstorage.com/${Date.now()}-${file.name.replace(/\s+/g, '_')}`; console.log(`Mock Upload: ${file.name} -> ${mockUrl}`); return { name: file.name, url: mockUrl }; }


    // --- MASTER AUTHENTICATION ---
    onAuthStateChanged(auth, (user) => {
        console.log("onAuthStateChanged fired. User:", user ? user.email : 'null');
        if (user) {
            currentUser = user;
            authStatus.textContent = `Logged in as ${user.email}`;
            authStatus.className = 'text-xs text-green-400 truncate mb-2';
            mainApp.classList.remove('hidden');
            loginPage.classList.add('hidden');
            if (!commonListenersAttached) {
                initializeAppLogic();
                commonListenersAttached = true;
            } else {
                 // Already initialized, just ensure tab is correct
                 if (currentActiveTab && document.getElementById(currentActiveTab)) {
                     switchTab(currentActiveTab);
                 } else {
                     switchTab('dashboard'); // Fallback if current tab is invalid
                 }
            }
        } else {
            currentUser = null;
            authStatus.textContent = 'Not Authenticated';
            authStatus.className = 'text-xs text-red-400 truncate mb-2';
            mainApp.classList.add('hidden');
            loginPage.classList.remove('hidden');
            stopAppLogic();
            commonListenersAttached = false;
        }
        lucide.createIcons();
    });

    const handleAuthForm = async (e) => {
        e.preventDefault();
        console.log("Auth form submitted!");
        const email = emailInput.value;
        const password = passwordInput.value;
        authSubmitBtn.disabled = true;
        authSubmitBtn.textContent = 'Processing...';
        const action = isLoginMode ? signInWithEmailAndPassword : createUserWithEmailAndPassword;
        try {
            const userCredential = await action(auth, email, password);
            console.log("Firebase auth successful:", userCredential.user.uid);
             if (!isLoginMode) {
                 console.log("Creating Firestore user doc for new user:", userCredential.user.uid);
                 await setDoc(doc(db, "users", userCredential.user.uid), {
                    uid: userCredential.user.uid, name: email.split('@')[0], email: email,
                    phone: '', role: 'student', paymentStatus: 'not_paid', createdAt: serverTimestamp(), banned: false
                });
             }
            // onAuthStateChanged will handle UI switch and re-enable button implicitly
        } catch (error) {
            console.error("Firebase auth error:", error);
            showToast(error.message, "error");
            authSubmitBtn.disabled = false; // Re-enable only on error
            authSubmitBtn.textContent = isLoginMode ? 'Sign in' : 'Sign up';
        }
    };

    const toggleAuthMode = (e) => { e.preventDefault(); isLoginMode = !isLoginMode; authTitle.textContent = isLoginMode ? 'Sign in' : 'Create account'; authSubmitBtn.textContent = isLoginMode ? 'Sign in' : 'Sign up'; authToggleLink.textContent = isLoginMode ? "Need account? Sign up" : 'Have account? Sign in'; };
    const handleLogout = async () => { try { await signOut(auth); } catch (error) { console.error("Logout Error:", error); showToast(error.message, "error"); } };

    // --- MASTER NAVIGATION & LISTENER MANAGEMENT ---
    const stopAllManagers = () => { console.log("Stopping all managers..."); Object.keys(activeManagers).forEach(key => { if (activeManagers[key]?.stop) { try { activeManagers[key].stop(); console.log(`Stopped manager: ${key}`); } catch (e) { console.error(`Error stopping ${key}:`, e); } } activeManagers[key] = null; }); if (typeof unsubscribePosts === 'function') unsubscribePosts(); if (typeof unsubscribeComments === 'function') unsubscribeComments(); if (typeof unsubscribeCategories === 'function') unsubscribeCategories(); unsubscribePosts = unsubscribeComments = unsubscribeCategories = () => {}; };

    const switchTab = (tabId) => {
        console.log(`Attempting to switch to tab: ${tabId}`);
        stopAllManagers(); // Stop previous manager/listeners first
        currentActiveTab = tabId;

        allTabs.forEach(tab => tab.classList.add('hidden'));
        const newTab = document.getElementById(tabId);
        if (newTab) {
            newTab.classList.remove('hidden');
            newTab.scrollTop = 0; // Scroll to top of new tab content
        } else {
            console.warn(`Tab "${tabId}" not found. Defaulting to dashboard.`);
            document.getElementById('dashboard')?.classList.remove('hidden');
            currentActiveTab = 'dashboard';
            tabId = 'dashboard';
        }

        // Update sidebar visual state
        allSidebarLinks.forEach(link => link.classList.remove('active'));
        dropdownToggles.forEach(btn => { btn.classList.remove('open', 'active'); const menu = btn.nextElementSibling; if (menu?.classList.contains('dropdown-menu')) menu.style.display = 'none'; const icon = btn.querySelector('.dropdown-icon'); if (icon) icon.style.transform = 'rotate(0deg)'; });

        const activeLink = document.querySelector(`#sidebar .sidebar-link[data-tab="${tabId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
            const parentMenu = activeLink.closest('.dropdown-menu');
            if (parentMenu) {
                const parentBtn = parentMenu.previousElementSibling;
                if (parentBtn?.classList.contains('has-dropdown')) {
                    parentBtn.classList.add('open', 'active'); parentMenu.style.display = 'block'; const icon = parentBtn.querySelector('.dropdown-icon'); if (icon) icon.style.transform = 'rotate(180deg)';
                }
            }
        } else {
             console.warn(`Sidebar link for tab "${tabId}" not found.`);
             document.querySelector(`#sidebar .sidebar-link[data-tab="dashboard"]`)?.classList.add('active');
        }

        console.log(`Starting manager/listeners for: ${tabId}`);
        // --- Initialize logic/listeners for the new tab ---
        switch (tabId) {
            case 'dashboard': activeManagers.dashboard = startDashboardManager(); break;
            case 'subjects': activeManagers.subjects = managers.subjects.start(); break;
            case 'exams': activeManagers.exams = managers.exams.start(); break;
            case 'generalBooks': activeManagers.generalBooks = managers.generalBooks.start(); break;
            case 'quizzes': activeManagers.quiz = startQuizManager(); break;
            case 'pdf-library': activeManagers.pdfLibrary = startPdfLibraryManager(); break;
            case 'list-posts': initPostsListener(); initCategoriesListener(); break;
            case 'post-form-view': initCategoriesListener(); if (!editingPostId) showPostForm(); else showPostForm(editingPostId); break;
            case 'categories': initCategoriesListener(renderCategoriesList); break;
            case 'comments': initPostsListener(); initCommentsListener(); break;
            case 'analytics': fetchAllDataForAnalytics(); break;
            case 'users-students': activeManagers.users = startUserManager(); break;
            case 'users-roles': initUsersListener(renderAdminList); console.log(`Tab "${tabId}" - Placeholder`); break; // Changed from startUserManager
            case 'main-report': if (reportDatePicker) reportDatePicker.destroy(); reportDatePicker = flatpickr("#report-date-range", { mode: "range", dateFormat: "Y-m-d" }); console.log(`Tab "${tabId}" - Placeholder`); break;
            case 'settings': console.log(`Tab "${tabId}" - Placeholder`); break;
            default: console.warn(`No manager defined for tab: ${tabId}`);
        }
        lucide.createIcons();
    };

    // --- APP INITIALIZATION & SHUTDOWN ---
    const initializeAppLogic = () => { console.log("Initializing app logic..."); fetchSubjectsForDropdown(); fetchBlogCategoriesForDropdown(); initBlogLibs(); setupCommonEventListeners(); switchTab(currentActiveTab || 'dashboard'); };
    const stopAppLogic = () => { console.log("Stopping app logic..."); stopAllManagers(); if (quill) quill = null; if (tagify) tagify.destroy(); tagify = null; if (schedulePicker) schedulePicker.destroy(); schedulePicker = null; if (reportDatePicker) reportDatePicker.destroy(); reportDatePicker = null; };

    // --- Setup Common Event Listeners ---
    function setupCommonEventListeners() {
        if (commonListenersAttached) {
            console.log("Common listeners already attached. Skipping setup.");
            return; // Prevent adding listeners multiple times
        }
        console.log("Setting up common event listeners...");

        // ** Sidebar Dropdowns **
        dropdownToggles.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetButton = e.currentTarget;
                const dropdownMenu = targetButton.nextElementSibling;
                const icon = targetButton.querySelector('.dropdown-icon');
                const isOpen = targetButton.classList.contains('open');
                console.log(`Dropdown toggle clicked: ${targetButton.querySelector('span')?.textContent.trim()}, Currently Open: ${isOpen}`);

                // Close others first
                dropdownToggles.forEach(otherBtn => { if (otherBtn !== targetButton && otherBtn.classList.contains('open')) { otherBtn.classList.remove('open', 'active'); otherBtn.nextElementSibling.style.display = 'none'; const otherIcon = otherBtn.querySelector('.dropdown-icon'); if(otherIcon) otherIcon.style.transform = 'rotate(0deg)'; } });

                // Toggle clicked
                targetButton.classList.toggle('open');
                dropdownMenu.style.display = isOpen ? 'none' : 'block';
                if(icon) icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        });

        // ** Sidebar Links ** (All links, including those in dropdowns)
        allSidebarLinks.forEach(link => {
            // Skip dropdown toggle buttons themselves
            if (link.classList.contains('has-dropdown')) return;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetLink = e.currentTarget;
                const tabId = targetLink.dataset.tab;
                console.log(`Sidebar link clicked: ${tabId}`);
                if (tabId) {
                    if (tabId === 'post-form-view' && targetLink.dataset.action === 'add') editingPostId = null;
                    switchTab(tabId);
                } else { console.warn("Link missing data-tab:", targetLink); }
                if (window.innerWidth < 768 && !mainSidebar.classList.contains('-translate-x-full')) toggleSidebar();
            });
        });

        // ** Mobile Sidebar Toggle **
        mobileMenuBtn.addEventListener('click', toggleSidebar); // Use addEventListener
        sidebarOverlay.addEventListener('click', toggleSidebar); // Use addEventListener

        // ** Logout Button **
        logoutBtn.addEventListener('click', handleLogout); // Use addEventListener

        // ** Generic CRUD Modal ** Cancel/Background Click & Submit
        modal.addEventListener('click', (e) => { if (e.target.classList.contains('modal-cancel-btn') || e.target === modal) { hideModal(); } });
        modal.addEventListener('submit', (e) => { if (e.target.id === 'crud-form') { const type = e.target.dataset.type; if (managers[type]?.handleFormSubmit) managers[type].handleFormSubmit(e); else console.warn(`No submit handler for CRUD type: ${type}`); } });

        // ** Global Add Button handler ** (Delegated)
        document.body.addEventListener('click', (e) => { const addBtn = e.target.closest('.add-btn'); if (addBtn) { const type = addBtn.dataset.type; if (managers[type]?.handleAdd) managers[type].handleAdd(); else console.warn(`No add handler for CRUD type: ${type}`); } });

        // ** Assign PDF Modals Listeners **
        document.getElementById('assign-modal-cancel')?.addEventListener('click', closeAssignModal); // Use optional chaining
        document.getElementById('assign-pdf-search')?.addEventListener('input', renderAssignablePdfs);
        document.getElementById('assign-pdf-to-content-modal-cancel')?.addEventListener('click', closeAssignPdfToContentModal);
        document.querySelectorAll('.assign-pdf-select-type-btn').forEach(btn => btn.addEventListener('click', (e) => { const type = e.currentTarget.dataset.type; document.querySelectorAll('.assign-pdf-select-type-btn').forEach(b => b.classList.remove('bg-indigo-100', 'text-indigo-700')); e.currentTarget.classList.add('bg-indigo-100', 'text-indigo-700'); document.getElementById('assign-content-search').value = ''; renderAssignableContent(type); }));
        document.getElementById('assign-content-search')?.addEventListener('input', (e) => { const activeBtn = document.querySelector('.assign-pdf-select-type-btn.bg-indigo-100'); if (activeBtn) renderAssignableContent(activeBtn.dataset.type); });

        // ** User Modals Listeners **
         userModalCloseBtn?.addEventListener('click', () => closeModal(userModal));
         userCancelBtn?.addEventListener('click', () => closeModal(userModal));
         confirmCancelBtn?.addEventListener('click', () => hideConfirmModal());

        // ** Blog specific modals/form listeners **
         setupBlogEventListeners();

        commonListenersAttached = true; // Set flag
    }
    const toggleSidebar = () => { mainSidebar.classList.toggle('-translate-x-full'); sidebarOverlay.classList.toggle('hidden'); };

    // --- Authentication Form Listeners (outside common setup, run once) ---
    authForm.addEventListener('submit', handleAuthForm);
    authToggleLink.addEventListener('click', toggleAuthMode);


    // =============================================
    // =========== MANAGER FUNCTIONS ===============
    // (Keep the full definitions for startDashboardManager, createCrudManager,
    // startPdfLibraryManager, startQuizManager, startUserManager,
    // and all Blog related functions as provided in the previous corrected code)
    // =============================================
    // --- DASHBOARD MANAGER ---
    const startDashboardManager = () => { /* ... Full function definition ... */
        let unsubscribers = [];
        console.log("Starting Dashboard Manager");
        const updateStat = (elementId, value) => { const element = document.getElementById(elementId); if (element) element.textContent = value; else console.warn(`Dashboard element ${elementId} not found`); }
        try {
            unsubscribers.push(onSnapshot(collection(db, "subjects"), s => { console.log(`Subjects: ${s.size}`); updateStat('total-subjects', s.size); }, e => console.error("Snapshot error (subjects):", e)));
            unsubscribers.push(onSnapshot(collection(db, "exams"), s => { console.log(`Exams: ${s.size}`); updateStat('total-exams', s.size); }, e => console.error("Snapshot error (exams):", e)));
            unsubscribers.push(onSnapshot(collection(db, "generalBooks"), s => { console.log(`Books: ${s.size}`); updateStat('total-books', s.size); }, e => console.error("Snapshot error (generalBooks):", e)));
            unsubscribers.push(onSnapshot(collection(db, "quizzes"), s => { console.log(`Quizzes: ${s.size}`); updateStat('total-quizzes', s.size); }, e => console.error("Snapshot error (quizzes):", e)));
            unsubscribers.push(onSnapshot(collection(db, "users"), s => { let t=0, p=0, b=0; s.docs.forEach(d => { const dt=d.data(); t++; if (dt.paymentStatus === 'paid') p++; if (dt.banned) b++; }); console.log(`Users: T${t}, P${p}, B${b}`); updateStat('dash-total-users', t); updateStat('dash-paid-users', p); updateStat('dash-banned-users', b); updateStat('dash-total-revenue', `$${p*5}`); }, e => console.error("Snapshot error (users):", e)));
        } catch (error) { console.error("Error setting up dashboard listeners:", error); showToast("Failed to load dashboard data.", "error"); }
        lucide.createIcons();
        return { stop: () => { console.log("Stopping Dashboard Manager"); unsubscribers.forEach(u => {if (typeof u === 'function') u();}); unsubscribers = []; } };
    };

    // --- PDF / CONTENT MANAGER ---
    const uploadFileToStorage = (file, pathPrefix) => new Promise((resolve, reject) => { /* ... Full function definition ... */
        if (!file) { resolve(null); return; }
        const uniqueFileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
        const storageRef = ref(storage, `${pathPrefix}${uniqueFileName}`);
        const uploadTask = uploadBytesResumable(storageRef, file);
        let progressBar = null;
         if (modal && !modal.classList.contains('hidden')) {
            const form = modal.querySelector('#crud-form');
             if (form) progressBar = form.querySelector(`.file-upload-progress[data-for="${file.inputId}"] div`);
        }
        uploadTask.on('state_changed', (snapshot) => { const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; if (progressBar) progressBar.style.width = progress + '%'; else if (document.getElementById('upload-progress-bar')) { document.getElementById('upload-progress-bar').style.width = progress + '%'; } },
            (error) => { console.error(`Upload failed for ${file.name}:`, error); showToast(`Upload failed for ${file.name}.`, 'error'); if (progressBar) progressBar.parentElement.textContent = 'Upload Failed!'; reject(error); },
            async () => { try { const downloadURL = await getDownloadURL(uploadTask.snapshot.ref); if (progressBar) progressBar.parentElement.textContent = 'Upload Complete!'; console.log(`File ${file.name} uploaded to ${downloadURL}`); resolve(downloadURL); } catch (error) { console.error(`Failed to get URL for ${file.name}:`, error); showToast(`Error getting URL for ${file.name}.`, 'error'); if (progressBar) progressBar.parentElement.textContent = 'Error getting URL!'; reject(error); } } );
    });
    const attachFileInputListeners = () => { /* ... Full function definition ... */
         modalContent.querySelectorAll('input[type="file"]').forEach(input => {
            const newInput = input.cloneNode(true); input.parentNode.replaceChild(newInput, input);
            newInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const previewEl = modalContent.querySelector(`.file-preview[data-for="${e.target.id}"]`);
                const progressContainer = modalContent.querySelector(`.file-upload-progress[data-for="${e.target.id}"]`);
                if (file && previewEl) { previewEl.textContent = `Selected: ${file.name} (${formatBytes(file.size)})`; if (progressContainer) { progressContainer.classList.remove('hidden'); progressContainer.querySelector('div').style.width = '0%'; progressContainer.querySelector('div').textContent = ''; } file.inputId = e.target.id; }
                else if (previewEl) { previewEl.textContent = 'No file selected.'; if (progressContainer) progressContainer.classList.add('hidden'); }
            });
        });
    };
    const createTableHTML = (id, title, headers) => { /* ... Full function definition ... */
        return `
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
            <h2 class="text-xl font-semibold">${title}</h2>
            <button class="add-btn bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center w-full md:w-auto" data-type="${id}">
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add New ${title.slice(0, -1)}
            </button>
        </div>
        <div class="mb-4">
            <input type="text" id="${id}-search" placeholder="Search ${title}..." class="w-full p-2 border border-gray-300 rounded-lg">
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        ${headers.map(h => `<th class="p-3 font-semibold text-sm text-gray-600 uppercase tracking-wider">${h}</th>`).join('')}
                        <th class="p-3 font-semibold text-sm text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="${id}-table" class="divide-y divide-gray-200">
                    <tr><td colspan="${headers.length + 1}" class="p-6 text-center text-gray-500">Loading ${title.toLowerCase()}...</td></tr>
                </tbody>
            </table>
        </div>`;
     };
    const createCrudManager = (config) => { /* ... Full function definition ... */
        const { type, title, headers, fields, renderRow } = config;
        const collectionRef = collection(db, type);
        const container = document.getElementById(type);
        let localItems = [];
        let unsubscribe = null;
        let searchInputListener = null;

        const render = () => {
            const tableBody = document.getElementById(`${type}-table`); if (!tableBody) return;
            const searchInput = document.getElementById(`${type}-search`); const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const filteredItems = localItems.filter(item => Object.values(item).some(val => val && String(val).toLowerCase().includes(searchTerm)));
            if (filteredItems.length === 0) { tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="p-4 text-center text-gray-500">${localItems.length === 0 ? `No ${title.toLowerCase()} found.` : `No ${title.toLowerCase()} match search.`}</td></tr>`; }
            else { try { tableBody.innerHTML = filteredItems.map(item => renderRow(item)).join(''); } catch (e) { console.error(`Error rendering ${type}:`, e); tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="p-4 text-center text-red-500">Error rendering.</td></tr>`; } }
            lucide.createIcons();
        };

        const renderForm = (item = {}) => {
             console.log(`Rendering form for ${type}. Editing ID: ${currentEditingId}`); let formHTML = `<h2 class="text-2xl font-bold mb-6">${currentEditingId ? 'Edit' : 'Add'} ${title.slice(0, -1)}</h2><form id="crud-form" data-type="${type}" class="space-y-4">`;
             fields.forEach(f => { formHTML += `<div><label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}${f.required ? '<span class="text-red-500">*</span>' : ''}</label>`; const currentValue = item[f.id] || (f.type === 'checkbox' ? false : (f.defaultValue || '')); const requiredAttr = f.required ? 'required' : '';
                 switch(f.type) {
                     case 'textarea': formHTML += `<textarea id="${f.id}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" rows="5">${currentValue}</textarea>`; break;
                     case 'checkbox': formHTML += `<div class="mt-1"><input id="${f.id}" type="checkbox" ${currentValue ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></div>`; break;
                     case 'date': let dV = ''; if (currentValue) { try { const d = currentValue.toDate?currentValue.toDate():new Date(currentValue); dV = d.toISOString().split('T')[0];}catch(e){}} formHTML += `<input id="${f.id}" type="date" value="${dV}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">`; break;
                     case 'select': formHTML += `<select id="${f.id}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"><option value="">-- Select ${f.label} --</option>`; let opts = []; if(f.optionsSource==='subjects') opts=availableSubjects; else if(f.optionsSource==='blogCategories') opts=availableBlogCategories; else if(f.optionsSource==='static'&&f.options) opts=f.options; if(opts.length>0){opts.forEach(o=>{ const v=o.id||o.value; const l=o.name||o.label||o.title; const dL=(f.optionsSource==='subjects'&&o.grade)?`${l} (G${o.grade})`:l; const sel=String(v)===String(currentValue)?'selected':''; if(v) formHTML+=`<option value="${v}" ${sel}>${dL}</option>`;});}else{console.warn(`Options source '${f.optionsSource}' for '${f.id}' empty.`);} formHTML += `</select>`; break;
                     case 'file': formHTML += `<input id="${f.id}" type="file" ${f.accept?`accept="${f.accept}"`:''} class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">`; const fN=currentValue?currentValue.split('/').pop().split('?')[0].split('%2F').pop().replace(/%20/g, ' ').substring(14):'No file.'; formHTML += `<div class="file-preview text-xs text-gray-500 mt-1" data-for="${f.id}">${currentValue?`Current: <a href="${currentValue}" target="_blank" class="text-indigo-600 hover:underline">${decodeURIComponent(fN)}</a>`:'No file.'}</div>`; formHTML += `<div class="file-upload-progress w-full bg-gray-200 rounded-full h-1.5 mt-1 hidden" data-for="${f.id}"><div class="bg-indigo-600 h-1.5 rounded-full" style="width: 0%"></div></div>`; break;
                     default: formHTML += `<input id="${f.id}" type="${f.type||'text'}" value="${currentValue}" ${requiredAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">`;
                 } formHTML += `</div>`; });
             formHTML += `<div class="flex justify-end space-x-3 pt-4 border-t mt-4"><button type="button" class="modal-cancel-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700">Save</button></div></form>`; return formHTML;
        };

        const start = () => { /* ... unchanged ... */
            console.log(`Starting CRUD Manager for: ${type}`);
            if (unsubscribe) { console.log(`Manager for ${type} already running.`); if (!container.innerHTML.includes('tbody')) container.innerHTML = createTableHTML(type, title, headers); render(); return { stop: () => {} }; }
            if (!container.innerHTML.includes('tbody')) { container.innerHTML = createTableHTML(type, title, headers); lucide.createIcons(); }
            searchInputListener = () => render();
            const searchInput = document.getElementById(`${type}-search`); if (searchInput) { searchInput.removeEventListener('input', searchInputListener); searchInput.addEventListener('input', searchInputListener); } else { console.warn(`Search input not found for ${type}`);}
            const q = query(collectionRef, orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, (snapshot) => {
                localItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); console.log(`Received ${localItems.length} items for ${type}`); render();
                if (type === 'subjects') { availableSubjects = [...localItems].sort((a,b)=>(a.name||'').localeCompare(b.name||'')); console.log("Updated availableSubjects cache:", availableSubjects.length); }
                if (type === 'exams') { availableExams = [...localItems].sort((a,b)=>(a.name||'').localeCompare(b.name||'')); }
                if (type === 'generalBooks') { availableGeneralBooks = [...localItems].sort((a,b)=>(a.title||'').localeCompare(b.title||'')); }
                if (type === 'blogCategories') { availableBlogCategories = [...localItems].sort((a,b)=>(a.name||'').localeCompare(b.name||'')); console.log("Updated availableBlogCategories cache:", availableBlogCategories.length); if (currentActiveTab === 'post-form-view' || currentActiveTab === 'list-posts') { updateBlogCategoryDropdowns(); } }
            }, (error) => { console.error(`Error fetching ${type}:`, error); showToast(`Could not fetch ${type}.`, 'error'); const tableBody = document.getElementById(`${type}-table`); if (tableBody) tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="p-4 text-center text-red-500">Error fetching data. Check console.</td></tr>`; });
            return { stop: () => { console.log(`Stopping CRUD Manager for: ${type}`); if (unsubscribe) { unsubscribe(); unsubscribe = null; console.log(`Unsubscribed Firestore listener for ${type}`); } const searchInput = document.getElementById(`${type}-search`); if (searchInput && searchInputListener) { searchInput.removeEventListener('input', searchInputListener); searchInputListener = null; console.log(`Removed search listener for ${type}`); } } };
        };

        const handleAdd = () => { currentEditingId = null; showModal(renderForm()); };
        const handleEdit = (item) => { currentEditingId = item.id; showModal(renderForm(item)); };
        const handleDelete = async (id) => { /* ... unchanged ... */
            if (confirm(`Delete this ${title.slice(0, -1)}?\nID: ${id}\nCannot be undone.`)) {
                try {
                    if (type === 'subjects') { const examsUsing = await getDocs(query(collection(db, 'exams'), where('subjectId', '==', id))); if (!examsUsing.empty) { showToast(`Cannot delete subject. Used by ${examsUsing.size} exam(s).`, 'error'); return; } }
                    // Add other dependency checks if needed
                    await deleteDoc(doc(db, type, id)); showToast(`${title.slice(0, -1)} deleted!`);
                } catch (e) { console.error("Error deleting:", e); showToast(`Error deleting ${title.slice(0, -1)}.`, 'error'); }
            }
         };
        const handleFormSubmit = async (e) => { /* ... unchanged ... */
             e.preventDefault(); const form = e.target; const submitButton = form.querySelector('button[type="submit"]'); submitButton.disabled = true; submitButton.textContent = 'Saving...'; const formData = {}; const fileUploadPromises = []; console.log(`Submitting form for ${type}. Editing ID: ${currentEditingId}`);
             fields.forEach(f => { const input = form.querySelector(`#${f.id}`); if (!input) { console.warn(`Input not found for field ${f.id}`); return; }
                 if (f.type === 'file') { const file = input.files[0]; if (file) { const pC = form.querySelector(`.file-upload-progress[data-for="${f.id}"]`); if(pC) pC.classList.remove('hidden'); let uP=`${type}/`; if(f.uploadPath) uP=f.uploadPath; file.inputId=f.id; fileUploadPromises.push(uploadFileToStorage(file, uP).then(url=>({fieldId: f.id, url: url}))); } else { if (currentEditingId) { const existing = localItems.find(item=>item.id===currentEditingId); formData[f.id]=existing?.[f.id] ?? null; } else { formData[f.id]=null; } } }
                 else if (f.type === 'checkbox') { formData[f.id]=input.checked; }
                 else if (f.type === 'number') { formData[f.id]=input.value===''?null:Number(input.value); }
                 else if (f.type === 'date') { formData[f.id]=input.value?Timestamp.fromDate(new Date(input.value+'T00:00:00')):null; }
                 else { formData[f.id]=input.value; } });
             console.log("Form Data Collected (before uploads):", formData);
             try { const uploadResults = await Promise.all(fileUploadPromises); uploadResults.forEach(r => { if (r?.url) formData[r.fieldId]=r.url; }); console.log("Form Data (after uploads):", formData);
                 if (currentEditingId) { formData.modifiedAt = serverTimestamp(); await updateDoc(doc(db, type, currentEditingId), formData); showToast(`${title.slice(0, -1)} updated!`); }
                 else { formData.createdAt = serverTimestamp(); await addDoc(collectionRef, formData); showToast(`${title.slice(0, -1)} added!`); } hideModal();
             } catch (e) { console.error("Error saving:", e); showToast(`Error saving ${title.slice(0, -1)}: ${e.message}`, 'error'); }
             finally { submitButton.disabled = false; submitButton.textContent = 'Save'; }
        };

        return { start, stop, handleAdd, handleEdit, handleDelete, handleFormSubmit, localItems }; // Expose localItems if needed elsewhere
    };
    const fetchSubjectsForDropdown = async () => { /* ... unchanged ... */ if (availableSubjects.length > 0) return; try { console.log("Fetching subjects for dropdown..."); const s = await getDocs(query(collection(db, 'subjects'), orderBy('name'))); availableSubjects = s.docs.map(d=>({id: d.id, ...d.data()})); console.log(`Fetched ${availableSubjects.length} subjects.`); } catch (e) { console.error("Error fetching subjects:", e); } };
    const fetchBlogCategoriesForDropdown = async () => { /* ... unchanged ... */ if (availableBlogCategories.length > 0) return; try { console.log("Fetching blog categories for dropdown..."); const s = await getDocs(query(collection(db, 'blogCategories'), orderBy('name'))); availableBlogCategories = s.docs.map(d=>({id: d.id, ...d.data()})); console.log(`Fetched ${availableBlogCategories.length} blog categories.`); if (currentActiveTab === 'post-form-view' || currentActiveTab === 'list-posts') { updateBlogCategoryDropdowns(); } } catch (e) { console.error("Error fetching blog categories:", e); } };
    const managers = {
        subjects: createCrudManager({ type: 'subjects', title: 'Subjects', headers: ['Cover', 'Name', 'Grade', 'Book PDF', 'Created'], fields: [ { id: 'name', label: 'Subject Name', required: true }, { id: 'grade', label: 'Grade (e.g., F1, F2)', required: true }, { id: 'coverImage', label: 'Cover Image', type: 'file', accept: 'image/*', uploadPath: 'subject_covers/' }, { id: 'bookPdfUrl', label: 'Book PDF/ZIP', type: 'file', accept: '.pdf,.zip', uploadPath: 'subject_pdfs/' } ], renderRow: (item) => `...` }),
        exams: createCrudManager({ type: 'exams', title: 'Exams', headers: ['Cover', 'Name', 'Year', 'Subject', 'PDF', 'Created'], fields: [ { id: 'name', label: 'Exam Name', required: true }, { id: 'year', label: 'Year', type: 'number', required: true }, { id: 'subjectId', label: 'Subject', type: 'select', optionsSource: 'subjects', required: true }, { id: 'coverImage', label: 'Cover Image', type: 'file', accept: 'image/*', uploadPath: 'exam_covers/' }, { id: 'pdfUrl', label: 'Exam PDF/ZIP', type: 'file', accept: '.pdf,.zip', uploadPath: 'exam_pdfs/' } ], renderRow: (item) => { const subj = availableSubjects.find(s=>s.id === item.subjectId); return `... ${subj ? `${subj.name} (G${subj.grade})` : '?'} ...`; } }),
        generalBooks: createCrudManager({ type: 'generalBooks', title: 'General Books', headers: ['Cover', 'Title', 'Author', 'PDF', 'Created'], fields: [ { id: 'title', label: 'Book Title', required: true }, { id: 'author', label: 'Author' }, { id: 'coverImageUrl', label: 'Cover Image', type: 'file', accept: 'image/*', uploadPath: 'generalBooks_covers/' }, { id: 'pdfUrl', label: 'Book PDF/ZIP', type: 'file', accept: '.pdf,.zip', uploadPath: 'generalBooks_pdfs/' } ], renderRow: (item) => `...` }),
    };


    // --- PDF LIBRARY MANAGER ---
    const startPdfLibraryManager = () => { /* ... Full function definition unchanged ... */
        console.log("Starting PDF Library Manager");
        pdfListTable = document.getElementById('pdf-list-table');
        selectAllPdfsCheckbox = document.getElementById('select-all-pdfs');
        deleteSelectedPdfsBtn = document.getElementById('delete-selected-pdfs-btn');
        const pdfSearch = document.getElementById('pdf-search');
        const uploadBtn = document.getElementById('upload-pdf-btn');
        const uploadInput = document.getElementById('pdf-upload-input');
        const progressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('upload-progress-bar');

        const renderPdfList = () => { /* ... unchanged ... */
            if (!pdfListTable) return; const searchTerm = pdfSearch.value.toLowerCase(); const filteredPdfs = allPdfFiles.filter(pdf => pdf.name.toLowerCase().includes(searchTerm)); console.log(`Rendering PDF list. Search: "${searchTerm}", Files: ${filteredPdfs.length}`); if (filteredPdfs.length === 0) { pdfListTable.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">${allPdfFiles.length === 0 ? "No files found." : "No files match search."}</td></tr>`; return; }
            pdfListTable.innerHTML = filteredPdfs.map(pdf => ` <tr class="border-b hover:bg-gray-50"> <td class="p-3"><input type="checkbox" class="pdf-checkbox" data-path="${pdf.fullPath}"></td> <td class="p-3 font-medium text-gray-800 break-all">${pdf.name}</td> <td class="p-3 text-gray-600">${formatBytes(pdf.size)}</td> <td class="p-3 text-gray-600">${formatDate(pdf.updated)}</td> <td class="p-3 space-x-1 whitespace-nowrap"> <button class="action-btn text-green-600 hover:bg-green-100 p-1" onclick="window.app.copyToClipboard('${pdf.fullPath}')" title="Copy URL"><i data-lucide="copy" class="w-4 h-4"></i></button> <button class="action-btn text-blue-600 hover:bg-blue-100 p-1" onclick="window.app.openAssignPdfToContentModal('${pdf.fullPath}', '${pdf.name.replace(/'/g, "\\'")}')" title="Assign to Content"><i data-lucide="link" class="w-4 h-4"></i></button> <button class="action-btn text-red-600 hover:bg-red-100 p-1" onclick="window.app.deletePdf('${pdf.fullPath}')" title="Delete File"><i data-lucide="trash-2" class="w-4 h-4"></i></button> </td> </tr> `).join('');
            lucide.createIcons(); updateDeleteSelectedButton();
         };
        const fetchAllPdfs = async () => { /* ... unchanged ... */
             console.log("Fetching all files from storage..."); if(pdfListTable) pdfListTable.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-gray-500">Loading files...</td></tr>`; try { const listRef = ref(storage, ''); const res = await listAll(listRef); const allFilesPromises = []; const processItems = async (items) => { for (const itemRef of items) { allFilesPromises.push( getMetadata(itemRef) .then(md => ({ ref: itemRef, name: md.name, fullPath: md.fullPath, size: md.size, updated: md.updated, type: md.contentType })) .catch(e => { console.error("Metadata error:", itemRef.fullPath, e); return null; }) ); } }; await processItems(res.items); for (const folderRef of res.prefixes) { console.log(`Listing folder: ${folderRef.name}`); try { const folderRes = await listAll(folderRef); await processItems(folderRes.items); } catch (folderError) { console.error(`Error listing ${folderRef.name}:`, folderError); } } const results = await Promise.all(allFilesPromises); allPdfFiles = results.filter(f => f !== null).sort((a, b) => b.size - a.size); console.log(`Fetched ${allPdfFiles.length} files.`); renderPdfList(); } catch (error) { console.error("Error fetching file list:", error); showToast("Error fetching file list.", "error"); if(pdfListTable) pdfListTable.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error fetching files.</td></tr>`; }
         };
        const updateDeleteSelectedButton = () => { /* ... unchanged ... */
            if (!pdfListTable || !deleteSelectedPdfsBtn) return; const selected = pdfListTable.querySelectorAll('.pdf-checkbox:checked'); if (selected.length > 0) { deleteSelectedPdfsBtn.classList.remove('hidden'); const icon = deleteSelectedPdfsBtn.querySelector('i'); if (icon) icon.nextSibling.textContent = ` Delete Selected (${selected.length})`; } else { deleteSelectedPdfsBtn.classList.add('hidden'); }
         };
        const deleteSelectedPdfs = async () => { /* ... unchanged ... */
            if (!pdfListTable) return; const selected = pdfListTable.querySelectorAll('.pdf-checkbox:checked'); if (selected.length === 0) return; if (confirm(`Delete ${selected.length} file(s)? Cannot be undone.`)) { let delPromises=[], delPaths=[]; selected.forEach(cb => { const p=cb.dataset.path; delPaths.push(p); delPromises.push(deleteObject(ref(storage, p)).catch(err=>({path:p, error:err}))); }); try { const results = await Promise.all(delPromises); const failed = results.filter(r=>r?.error); if(failed.length>0){console.error("Failed deletes:", failed); showToast(`Error deleting ${failed.length} file(s).`, "error");} const successCount = selected.length-failed.length; if(successCount>0) showToast(`${successCount} file(s) deleted!`); allPdfFiles = allPdfFiles.filter(pdf => !delPaths.includes(pdf.fullPath)); renderPdfList(); if(selectAllPdfsCheckbox) selectAllPdfsCheckbox.checked=false; updateDeleteSelectedButton(); } catch (e) { console.error("Batch delete error:", e); showToast("Error during deletion.", "error"); fetchAllPdfs(); } }
        };
        const handleFileUpload = async (files) => { /* ... unchanged ... */
            if (!files || files.length === 0) return; console.log(`Starting upload for ${files.length} files...`); uploadBtn.disabled = true; uploadBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Uploading...'; lucide.createIcons(); progressContainer.classList.remove('hidden'); progressBar.style.width = '0%'; let uploadPromises = []; let totalSize = Array.from(files).reduce((acc, file) => acc + file.size, 0); let uploadedSize = 0; for (const file of files) { let pP = 'general_uploads/'; if(file.type==='application/pdf') pP='general_pdfs/'; else if(file.type.startsWith('image/')) pP='general_images/'; else if(file.type==='application/zip') pP='zips/'; const sRef = ref(storage, `${pP}${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`); const uT = uploadBytesResumable(sRef, file); const p = new Promise((res, rej)=>{ uT.on('state_changed', (snap)=>{ uploadedSize += snap.bytesTransferred; const totalProgress = totalSize > 0 ? (uploadedSize / totalSize) * 100 : 0; progressBar.style.width = `${totalProgress}%`; }, (err)=>rej(err), ()=>getDownloadURL(uT.snapshot.ref).then(()=>res()) ); }); uploadPromises.push(p); } try { await Promise.all(uploadPromises); showToast(`Uploaded ${files.length} file(s)!`); await fetchAllPdfs(); } catch (e) { console.error("Bulk upload error:", e); showToast("Error during upload.", "error"); await fetchAllPdfs(); } finally { uploadBtn.disabled = false; uploadBtn.innerHTML = '<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload Files'; lucide.createIcons(); progressContainer.classList.add('hidden'); }
         };
        const onPdfSearchInput = () => renderPdfList();
        const onUploadBtnClick = () => uploadInput.click();
        const onUploadInputChange = (e) => handleFileUpload(e.target.files);
        const onSelectAllChange = (e) => { if (!pdfListTable) return; pdfListTable.querySelectorAll('.pdf-checkbox').forEach(cb => cb.checked = e.target.checked); updateDeleteSelectedButton(); };
        const onPdfListTableChange = (e) => { if (e.target.classList.contains('pdf-checkbox')) { updateDeleteSelectedButton(); } };
        const onDeleteSelectedClick = () => deleteSelectedPdfs();

        pdfSearch?.addEventListener('input', onPdfSearchInput);
        uploadBtn?.addEventListener('click', onUploadBtnClick);
        uploadInput?.addEventListener('change', onUploadInputChange);
        selectAllPdfsCheckbox?.addEventListener('change', onSelectAllChange);
        pdfListTable?.addEventListener('change', onPdfListTableChange);
        deleteSelectedPdfsBtn?.addEventListener('click', onDeleteSelectedClick);
        fetchAllPdfs();
        return { stop: () => { console.log("Stopping PDF Library Manager"); pdfSearch?.removeEventListener('input', onPdfSearchInput); uploadBtn?.removeEventListener('click', onUploadBtnClick); uploadInput?.removeEventListener('change', onUploadInputChange); selectAllPdfsCheckbox?.removeEventListener('change', onSelectAllChange); pdfListTable?.removeEventListener('change', onPdfListTableChange); deleteSelectedPdfsBtn?.removeEventListener('click', onDeleteSelectedClick); allPdfFiles = []; if(pdfListTable) pdfListTable.innerHTML = ''; } };
     };
    // Assign PDF Modals functions
    const assignModal = document.getElementById('assign-modal');
    const assignItemNameEl = document.getElementById('assign-item-name');
    const assignItemTypeEl = document.getElementById('assign-item-type');
    const assignPdfListContainerEl = document.getElementById('assign-pdf-list-container');
    const assignPdfSearchEl = document.getElementById('assign-pdf-search');
    const assignPdfToContentModal = document.getElementById('assign-pdf-to-content-modal');
    const assignPdfNameDisplay = document.getElementById('assign-pdf-name-display');
    const assignContentSearchEl = document.getElementById('assign-content-search');
    const assignContentListContainerEl = document.getElementById('assign-content-list-container');
    const openAssignModal = (type, id, field, name) => { /* ... unchanged ... */ currentAssignTarget = { type, id, field }; assignItemNameEl.textContent = name; assignItemTypeEl.textContent = type.slice(0,-1); assignPdfSearchEl.value=''; renderAssignablePdfs(); assignModal.classList.remove('hidden'); };
    const closeAssignModal = () => { assignModal.classList.add('hidden'); currentAssignTarget = {type:null,id:null,field:null}; };
    const renderAssignablePdfs = () => { /* ... unchanged ... */ const searchTerm = assignPdfSearchEl.value.toLowerCase(); const files = allPdfFiles.filter(pdf => pdf.name.toLowerCase().includes(searchTerm) && (pdf.type?.includes('pdf') || pdf.type?.includes('zip'))); if (files.length === 0) { assignPdfListContainerEl.innerHTML = `<p class="text-center text-gray-500">No matching files.</p>`; return; } assignPdfListContainerEl.innerHTML = files.map(pdf => ` <div class="flex justify-between items-center p-3 hover:bg-gray-100 rounded-lg"> <div><p class="font-medium text-gray-800">${pdf.name}</p><p class="text-sm text-gray-500">${pdf.fullPath} (${formatBytes(pdf.size)})</p></div> <button class="action-btn bg-indigo-600 text-white hover:bg-indigo-700" onclick="window.app.assignPdf('${pdf.fullPath}')"><i data-lucide="link" class="w-4 h-4 mr-1"></i>Assign</button> </div> `).join(''); lucide.createIcons(); };
    const assignPdf = async (path) => { /* ... unchanged ... */ if (!currentAssignTarget.type || !currentAssignTarget.id) return; try { const url = await getDownloadURL(ref(storage, path)); const { type, id, field } = currentAssignTarget; const dRef = doc(db, type, id); let updateData={}; updateData[field] = url; await updateDoc(dRef, updateData); showToast(`File assigned!`); closeAssignModal(); } catch (e) { console.error("Assign PDF error:", e); showToast("Error assigning file.", "error"); } };
    const openAssignPdfToContentModal = (path, name) => { /* ... unchanged ... */ currentPdfToAssign = { path: path, name: name }; assignPdfNameDisplay.textContent = name; assignContentSearchEl.value=''; assignContentSearchEl.classList.add('hidden'); assignContentListContainerEl.innerHTML = `<p class="text-center text-gray-500">Select content type above.</p>`; document.querySelectorAll('.assign-pdf-select-type-btn').forEach(b => b.classList.remove('bg-indigo-100', 'text-indigo-700')); assignPdfToContentModal.classList.remove('hidden'); };
    const closeAssignPdfToContentModal = () => { assignPdfToContentModal.classList.add('hidden'); currentPdfToAssign = {path:null, name:null}; };
    const renderAssignableContent = (type) => { /* ... unchanged ... */ assignContentSearchEl.classList.remove('hidden'); assignContentSearchEl.placeholder = `Search for ${type.slice(0,-1)}...`; let items=[]; if(type==='subjects') items=availableSubjects; else if(type==='exams') items=availableExams; else if(type==='generalBooks') items=availableGeneralBooks; const term = assignContentSearchEl.value.toLowerCase(); const filtered = items.filter(i => (i.name||i.title||'').toLowerCase().includes(term)); if(filtered.length===0){ assignContentListContainerEl.innerHTML=`<p class="text-center text-gray-500">No matching ${type}.</p>`; return; } assignContentListContainerEl.innerHTML = filtered.map(item => { const name = item.name||item.title; let field='pdfUrl'; if(type==='subjects') field='bookPdfUrl'; return ` <div class="flex justify-between items-center p-3 hover:bg-gray-100 rounded-lg"> <div> <p class="font-medium text-gray-800">${name}</p> <p class="text-sm text-gray-500"> ${type==='subjects'?`Grade: ${item.grade}`:''} ${type==='exams'?`Year: ${item.year}`:''} ${type==='generalBooks'?`Author: ${item.author||'N/A'}`:''} </p> </div> <button class="action-btn bg-indigo-600 text-white hover:bg-indigo-700" onclick="window.app.assignPdfToContent('${type}', '${item.id}', '${field}')"><i data-lucide="link" class="w-4 h-4 mr-1"></i>Assign</button> </div>`}).join(''); lucide.createIcons(); };
    const assignPdfToContent = async (type, id, field) => { /* ... unchanged ... */ if (!currentPdfToAssign.path) return; try { const url = await getDownloadURL(ref(storage, currentPdfToAssign.path)); const dRef = doc(db, type, id); let updateData={}; updateData[field]=url; await updateDoc(dRef, updateData); showToast(`File assigned to ${type.slice(0,-1)}!`); closeAssignPdfToContentModal(); } catch (e) { console.error("Assign file error:", e); showToast("Error assigning file.", "error"); } };

    // --- QUIZ MANAGER ---
    const startQuizManager = () => { /* ... Full function definition unchanged ... */ return { stop: () => { /* remove listeners */ } }; };

    // --- USER MANAGER ---
    const startUserManager = () => { /* ... Full function definition unchanged ... */ return { stop: () => { /* remove listeners */ } }; };

    // --- BLOG MANAGER ---
    // ... (All blog functions: listeners, init libs, rendering, actions, event setup - unchanged) ...
    function initPostsListener() { /* ... unchanged ... */ };
    function initCommentsListener() { /* ... unchanged ... */ };
    function initCategoriesListener(callback) { /* ... unchanged ... */ };
    async function fetchAllDataForAnalytics() { /* ... unchanged ... */ };
    function initBlogLibs() { /* ... unchanged ... */ };
    function renderPostsTable() { /* HTML unchanged */ /* ... function logic unchanged ... */ };
    function renderCommentsList() { /* HTML unchanged */ /* ... function logic unchanged ... */ };
    function renderCategoriesList() { /* HTML unchanged */ /* ... function logic unchanged ... */ };
    function updateBlogCategoryDropdowns() { /* ... function logic unchanged ... */ };
    function renderAnalytics() { /* ... function logic unchanged ... */ };
    async function showPostForm(postId = null) { /* ... function logic unchanged ... */ };
    async function handleBlogPostFormSubmit(e) { /* ... function logic unchanged ... */ };
    async function handleImageUpload(file) { /* ... function logic unchanged ... */ };
    function addAttachmentToList(fileName, fileUrl) { /* HTML unchanged */ /* ... function logic unchanged ... */ };
    async function handleAttachmentUpload(files) { /* ... function logic unchanged ... */ };
    function showDeleteModal(postId) { /* ... function logic unchanged ... */ };
    async function confirmDelete() { /* ... function logic unchanged ... */ };
    async function updateCommentStatus(commentId, newStatus) { /* ... function logic unchanged ... */ };
    async function deleteComment(commentId) { /* ... function logic unchanged ... */ };
    function showReplyModal(commentId) { /* ... function logic unchanged ... */ };
    async function handleReplySubmit(e) { /* ... function logic unchanged ... */ };
    function showShareModal(postId, postTitle) { /* ... function logic unchanged ... */ };
    function setupBlogEventListeners() { /* ... unchanged ... */ }; // Includes console logs

    // --- Global App Object ---
    window.app = { // Ensure this is accessible for inline onclicks
        editItem: (type, id) => {
            let item = null; let manager = managers[type];
            if (manager?.localItems) item = manager.localItems.find(i => i.id === id);
            else if (type === 'blogCategories') item = availableBlogCategories.find(i => i.id === id);
            // Blog posts edit is handled by showPostForm, not generic CRUD
            if (item && manager?.handleEdit) manager.handleEdit(item);
            else if (type !== 'blogPosts') { console.error(`Cannot edit item ${id} of type ${type}`); showToast("Could not find item data.", "error"); }
        },
        deleteItem: (type, id) => { if (managers[type]?.handleDelete) managers[type].handleDelete(id); else console.error(`No delete handler for ${type}`); },
        copyToClipboard: async (path) => { try { const url = await getDownloadURL(ref(storage, path)); navigator.clipboard.writeText(url); showToast("URL copied!"); } catch (e) { console.error("Copy URL error:", e); showToast("Could not copy URL.", "error"); } },
        deletePdf: async (path) => { if (confirm(`Delete this file?\n${path}\nCannot be undone.`)) { try { await deleteObject(ref(storage, path)); showToast("File deleted!"); allPdfFiles = allPdfFiles.filter(p => p.fullPath !== path); if(typeof renderPdfList === 'function') renderPdfList(); else console.warn("renderPdfList not available"); } catch (e) { console.error("Delete file error:", e); showToast("Error deleting file.", "error"); } } }, // Added renderPdfList call
        openAssignModal: (type, id, field, name) => { openAssignModal(type, id, field, name); },
        assignPdf: (path) => { assignPdf(path); },
        openAssignPdfToContentModal: (path, name) => { openAssignPdfToContentModal(path, name); },
        assignPdfToContent: (type, id, field) => { assignPdfToContent(type, id, field); }
    };

    // --- Initial DOM Ready ---
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM Loaded.");
         lucide.createIcons();
         // Authentication state change triggers app initialization.
     });

</script>
</body>
</html>
