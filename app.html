<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdayCaawiye - Complete CMS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        /* Sidebar, Modals, Utils - Keep all previous styles */
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #374151; color: white; }
        .sidebar-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .sidebar-link .icon { width: 1.125rem; height: 1.125rem; margin-right: 0.75rem; flex-shrink: 0; }
        .dropdown-menu { display: none; padding-left: 1.5rem; }
        .sidebar-link.has-dropdown.open + .dropdown-menu { display: block; }
        .sidebar-link.has-dropdown.open .dropdown-icon { transform: rotate(180deg); }
        .dropdown-menu .sidebar-link { padding-top: 0.5rem; padding-bottom: 0.5rem; font-size: 0.875rem; }
        .dropdown-menu .sidebar-link:hover { background-color: #374151; }
        .dropdown-menu .sidebar-link.active { color: #a5b4fc; background-color: transparent; font-weight: 500; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .quiz-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 2rem 1rem; }
        .quiz-modal-container { background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 56rem; margin: auto; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        #quiz-form { overflow-y: auto; }
        .quiz-form-input, .quiz-form-select { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.65rem 1rem; font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .quiz-form-input:focus, .quiz-form-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .quiz-btn { padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
        .quiz-btn-primary { background-color: #4f46e5; color: white; } .quiz-btn-primary:hover { background-color: #4338ca; }
        .quiz-btn-secondary { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; } .quiz-btn-secondary:hover { background-color: #e5e7eb; }
        .quiz-btn-danger { background-color: #dc2626; color: white; } .quiz-btn-danger:hover { background-color: #b91c1c; }
        .quiz-fab { position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem; border-radius: 9999px; z-index: 40; } .quiz-fab .fa-solid { font-size: 1.5rem; }
        .user-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 60; display: none; }
        .app-view { display: none; } .app-view.active { display: block; }
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; padding: 1rem; display: none; }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        #quill-editor { height: 400px; }
        .tagify { --tags-border-color: #d1d5db; border-radius: 0.5rem; } .tagify:hover { --tags-border-color: #4f46e5; } .tagify.tagify--focus { --tags-border-color: #4f46e5; }
        .user-filter-btn.active, .user-sort-btn.active { background-color: #e0e7ff; color: #4338ca; font-weight: 600; }
        .content-list { list-style: none; padding: 0; margin: 0; }
        .content-list li { background-color: #f9fafb; padding: 0.75rem 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .content-actions button { margin-left: 0.5rem; }
        /* Toast Styles */
        #toast { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    </style>
</head>
<body class="flex h-screen overflow-hidden" style="font-family: 'Inter', sans-serif;">

    <div id="main-app" class="flex w-full h-full">

        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col fixed h-full z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-5 text-2xl font-bold border-b border-gray-700 flex items-center">
                <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.appspot.com/o/logo.png?alt=media&token=5b34de54-86a0-47e1-8848-033190897645" alt="Logo" class="h-8 mr-2">
                <span>ArdayCaawiye</span>
            </div>
            <nav class="flex-1 p-3 space-y-1.5 overflow-y-auto">
                <a href="#" class="sidebar-link active" data-tab="dashboard"><i data-lucide="home" class="icon"></i> Dashboard</a>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="folder-kanban" class="icon"></i><span class="flex-1 text-left">Manage Content</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="subjects"><i data-lucide="book-copy" class="icon"></i> Subjects</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="exams"><i data-lucide="file-check-2" class="icon"></i> Exams</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="quizzes"><i data-lucide="puzzle" class="icon"></i> Quizzes</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="generalBooks"><i data-lucide="book-open" class="icon"></i> General Books</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="pdf-library"><i data-lucide="library" class="icon"></i> PDF Library</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="newspaper" class="icon"></i><span class="flex-1 text-left">Blog Management</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="list-posts"><i data-lucide="layout-list" class="icon"></i> All Posts</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="post-form-view"><i data-lucide="plus-square" class="icon"></i> Add New Post</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="categories"><i data-lucide="tag" class="icon"></i> Categories</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="comments"><i data-lucide="messages-square" class="icon"></i> Comments</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="analytics"><i data-lucide="bar-chart-3" class="icon"></i> Analytics</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="users" class="icon"></i><span class="flex-1 text-left">User Management</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="users-students"><i data-lucide="user" class="icon"></i> Students / Members</a></li>
                        <li><a href="#" class="sidebar-link" data-tab="users-roles"><i data-lucide="shield-check" class="icon"></i> Roles & Permissions</a></li>
                    </ul>
                </div>
                <div class="pt-2">
                    <button class="sidebar-link has-dropdown w-full"><i data-lucide="bar-chart-3" class="icon"></i><span class="flex-1 text-left">Reports & Analytics</span><i data-lucide="chevron-down" class="icon dropdown-icon w-4 h-4 ml-auto transition-transform"></i></button>
                    <ul class="dropdown-menu space-y-1 pt-1">
                        <li><a href="#" class="sidebar-link" data-tab="main-report"><i data-lucide="activity" class="icon"></i> Main Report</a></li>
                    </ul>
                </div>
                <a href="#" class="sidebar-link" data-tab="settings"><i data-lucide="settings" class="icon"></i> Settings</a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div id="auth-status" class="text-xs text-gray-400 truncate mb-2">Admin Access</div>
                <button id="logout-btn" class="w-full flex items-center justify-center p-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium text-sm"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout</button>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>

        <div class="md:hidden flex justify-between items-center bg-white p-4 border-b fixed top-0 left-0 right-0 z-10">
            <span class="text-xl font-bold text-gray-800">ArdayCaawiye CMS</span>
            <button id="mobile-menu-btn" class="text-gray-800"><i data-lucide="menu" class="w-6 h-6"></i></button>
        </div>

        <main class="flex-1 ml-0 md:ml-64 pt-20 md:pt-4 p-4 md:p-8 overflow-y-auto bg-gray-50">

            <div id="dashboard" class="tab-content fade-in">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h1>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-indigo-100 p-4 rounded-full mr-4"><i data-lucide="book-copy" class="w-8 h-8 text-indigo-600"></i></div><div><p class="text-gray-500">Total Subjects</p><p id="total-subjects" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-green-100 p-4 rounded-full mr-4"><i data-lucide="file-check-2" class="w-8 h-8 text-green-600"></i></div><div><p class="text-gray-500">Total Exams</p><p id="total-exams" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-amber-100 p-4 rounded-full mr-4"><i data-lucide="book-open" class="w-8 h-8 text-amber-600"></i></div><div><p class="text-gray-500">Total Books</p><p id="total-books" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-sky-100 p-4 rounded-full mr-4"><i data-lucide="puzzle" class="w-8 h-8 text-sky-600"></i></div><div><p class="text-gray-500">Total Quizzes</p><p id="total-quizzes" class="text-3xl font-bold">0</p></div></div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-blue-100 p-4 rounded-full mr-4"><i data-lucide="users" class="w-8 h-8 text-blue-600"></i></div><div><p class="text-gray-500">Total Users</p><p id="dash-total-users" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-emerald-100 p-4 rounded-full mr-4"><i data-lucide="user-check" class="w-8 h-8 text-emerald-600"></i></div><div><p class="text-gray-500">Paid Users</p><p id="dash-paid-users" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-rose-100 p-4 rounded-full mr-4"><i data-lucide="user-x" class="w-8 h-8 text-rose-600"></i></div><div><p class="text-gray-500">Banned Users</p><p id="dash-banned-users" class="text-3xl font-bold">0</p></div></div>
                     <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-purple-100 p-4 rounded-full mr-4"><i data-lucide="wallet" class="w-8 h-8 text-purple-600"></i></div><div><p class="text-gray-500">Total Revenue</p><p id="dash-total-revenue" class="text-3xl font-bold">$0</p></div></div>
                 </div>
            </div>

            <div id="subjects" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Subjects</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700 add-content-btn" data-type="subject">Add Subject</button>
                    <ul id="subjects-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>

            <div id="exams" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Exams</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                     <button class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700 add-content-btn" data-type="exam">Add Exam</button>
                     <ul id="exams-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>

            <div id="quizzes" class="tab-content fade-in hidden">
                <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <div><h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Quiz Manager ðŸ’¡</h1><p class="text-gray-500 mt-1">Create, edit, and organize quizzes.</p></div>
                    <button id="add-quiz-fab-header" class="quiz-btn quiz-btn-primary shadow-lg"><i class="fa-solid fa-plus mr-2"></i> Add New Quiz</button>
                </header>
                <div class="bg-white rounded-xl shadow-md p-4 mb-8 border"><label for="quiz-subject-filter" class="block text-sm font-semibold mb-2">Filter by Subject</label><select id="quiz-subject-filter" class="quiz-form-select text-gray-700"><option value="all">All Subjects</option></select></div>
                <div id="quiz-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="bg-white p-4 rounded-xl shadow border animate-pulse"><div class="h-16 bg-gray-200 rounded mb-3"></div><div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div><div class="h-8 bg-blue-100 rounded w-1/3 ml-auto"></div></div> </div>
                <div id="quiz-pagination-container" class="mt-10 flex justify-center items-center gap-2"></div>
            </div>

            <div id="generalBooks" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage General Books</h1>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 hover:bg-indigo-700 add-content-btn" data-type="book">Add Book</button>
                    <ul id="books-list" class="content-list"><li>Loading...</li></ul>
                </div>
            </div>

            <div id="pdf-library" class="tab-content fade-in hidden">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">PDF Library</h1>
                 <div class="bg-white rounded-xl shadow-md p-6">
                     <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-xl font-semibold">All Uploaded Files</h2><div><input type="file" id="pdf-upload-input" multiple accept=".pdf,.zip,.png,.jpg,.jpeg,.docx,.pptx" class="hidden"><button id="upload-pdf-btn" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium hover:bg-indigo-700 flex items-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i>Upload</button></div></div>
                     <div id="upload-progress-container" class="hidden my-4"><div class="text-sm mb-1">Uploading...</div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div></div>
                     <div class="mb-4 flex flex-col md:flex-row justify-between items-center gap-4"><input type="text" id="pdf-search" placeholder="Search files..." class="w-full md:w-1/2 p-2 border rounded"><button id="delete-selected-pdfs-btn" class="bg-red-600 text-white px-4 py-2 rounded font-medium hover:bg-red-700 flex items-center hidden"><i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected</button></div>
                     <div class="overflow-x-auto"><table class="w-full text-left"> <thead class="bg-gray-50"><tr><th class="p-3 w-8"><input type="checkbox" id="select-all-pdfs"></th><th class="p-3 font-semibold text-sm">File Name</th><th class="p-3 font-semibold text-sm">Size</th><th class="p-3 font-semibold text-sm">Upload Date</th><th class="p-3 font-semibold text-sm">Actions</th></tr></thead><tbody id="pdf-list-table"><tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr></tbody></table></div>
                 </div>
            </div>

            <div id="list-posts" class="tab-content fade-in hidden">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">All Posts</h1><button id="add-new-post-btn-main" class="bg-indigo-600 text-white px-4 py-2 rounded font-semibold flex items-center hover:bg-indigo-700"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Post</button></div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6"><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><input type="text" id="search-posts" placeholder="Search posts..." class="md:col-span-2 w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><select id="filter-category" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="">All Categories</option></select><select id="filter-status" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="">All Statuses</option><option value="Published">Published</option><option value="Draft">Draft</option><option value="Scheduled">Scheduled</option></select></div></div>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50 border-b"><tr><th class="p-4 w-12 text-left"><input type="checkbox" id="select-all-posts"></th><th class="p-4 text-left text-sm font-semibold uppercase">Title</th><th class="p-4 text-left text-sm font-semibold uppercase">Author</th><th class="p-4 text-left text-sm font-semibold uppercase">Category</th><th class="p-4 text-left text-sm font-semibold uppercase">Status</th><th class="p-4 text-left text-sm font-semibold uppercase">Published</th><th class="p-4 text-left text-sm font-semibold uppercase">Actions</th></tr></thead><tbody id="posts-table-body" class="divide-y"><tr><td colspan="7" class="p-8 text-center text-gray-500">Loading posts...</td></tr></tbody></table></div></div>
            </div>
            <div id="post-form-view" class="tab-content fade-in hidden">
                <h1 id="form-title" class="text-3xl font-bold text-gray-800 mb-6">Add New Post</h1>
                <form id="blog-post-form"><input type="hidden" id="post-id"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div class="bg-white p-6 rounded-lg shadow-sm"><label for="post-title" class="block text-lg font-semibold mb-2">Title</label><input type="text" id="post-title" placeholder="Post Title" class="w-full text-2xl font-bold p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div><div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="p-6 border-b"><label class="block text-lg font-semibold">Content</label></div><div id="quill-editor"></div></div><div class="bg-white p-6 rounded-lg shadow-sm"><label class="block text-lg font-semibold mb-2">Attachments</label><div id="attachment-dropzone" class="border-2 border-dashed rounded p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50"><i data-lucide="paperclip" class="w-10 h-10 mx-auto text-gray-400"></i><p class="mt-2 text-gray-500">Drop files or click</p><input type="file" class="hidden" id="post-attachments" multiple></div><div id="attachment-list" class="mt-4 space-y-2"></div></div><details class="bg-white rounded-lg shadow-sm"><summary class="p-6 cursor-pointer text-lg font-semibold flex justify-between items-center">SEO (Optional)<i data-lucide="chevron-down" class="w-5 h-5"></i></summary><div class="p-6 border-t space-y-4"><div><label for="seo-title" class="block text-sm font-medium">Meta Title</label><input type="text" id="seo-title" class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div><label for="seo-description" class="block text-sm font-medium">Meta Description</label><textarea id="seo-description" rows="3" class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea></div><div><label for="seo-keywords" class="block text-sm font-medium">Keywords</label><input type="text" id="seo-keywords" class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"></div></div></details></div><div class="lg:col-span-1 space-y-6"><div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-lg font-semibold mb-4 border-b pb-3">Publish</h2><div class="space-y-4"><div><label for="post-status" class="block text-sm font-medium">Status</label><select id="post-status" class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="Draft">Draft</option><option value="Published">Published</option><option value="Scheduled">Scheduled</option></select></div><div id="schedule-date-wrapper" class="hidden"><label for="post-schedule-date" class="block text-sm font-medium">Date</label><input type="text" id="post-schedule-date" placeholder="Select date" class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"></div></div><div class="flex justify-between items-center mt-6 pt-4 border-t"><button type="button" id="save-draft-btn" class="text-gray-600 font-medium hover:text-indigo-600">Save Draft</button><button type="submit" id="publish-btn" class="bg-indigo-600 text-white px-5 py-2 rounded font-semibold hover:bg-indigo-700">Publish</button></div></div><div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-lg font-semibold mb-4">Category</h2><select id="post-category" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="Uncategorized">Uncategorized</option></select></div><div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-lg font-semibold mb-4">Tags</h2><input id="post-tags" placeholder="Add tags..."></div><div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-lg font-semibold mb-4">Feature Image</h2><div id="image-dropzone" class="border-2 border-dashed rounded p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50"><i data-lucide="image" class="w-10 h-10 mx-auto text-gray-400"></i><p class="mt-2 text-gray-500">Drop image or click</p><input type="file" class="hidden" id="post-image" accept="image/*"></div><div id="image-preview-wrapper" class="mt-4 hidden"><img id="image-preview" src="#" alt="Preview" class="w-full h-auto rounded"><button type="button" id="remove-image-btn" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove</button></div></div></div></div></form>
            </div>
            <div id="categories" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Categories</h1><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><form id="add-category-form" class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-lg font-semibold mb-4">Add New</h2><div><label for="new-category-name" class="block text-sm font-medium">Name</label><input type="text" id="new-category-name" class="mt-1 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div><button type="submit" id="add-category-btn" class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded font-semibold hover:bg-indigo-700">Add</button></form></div><div class="md:col-span-2"><div class="bg-white rounded-lg shadow-sm"><h2 class="text-lg font-semibold p-6 border-b">Existing</h2><ul id="categories-list" class="divide-y"><li class="p-6 text-center text-gray-500">Loading...</li></ul></div></div></div>
            </div>
            <div id="comments" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Comments</h1><div class="bg-white p-4 rounded-lg shadow-sm mb-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="text" id="search-comments" placeholder="Search..." class="md:col-span-2 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><select id="filter-comment-status" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="">All Statuses</option><option value="Pending">Pending</option><option value="Approved">Approved</option><option value="Spam">Spam</option></select></div></div><div id="comments-list" class="space-y-6"><div class="bg-white p-6 rounded shadow text-center text-gray-500">Loading...</div></div>
            </div>
            <div id="analytics" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Blog Analytics</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded shadow"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Posts</p><i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i></div><p id="stats-total-posts" class="text-3xl font-bold mt-2">0</p></div><div class="bg-white p-6 rounded shadow"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Views</p><i data-lucide="eye" class="w-5 h-5 text-green-500"></i></div><p id="stats-total-views" class="text-3xl font-bold mt-2">0</p></div><div class="bg-white p-6 rounded shadow"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Pending Comments</p><i data-lucide="messages-square" class="w-5 h-5 text-yellow-500"></i></div><p id="stats-total-comments" class="text-3xl font-bold mt-2">0</p></div><div class="bg-white p-6 rounded shadow"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Published / Drafts</p><i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i></div><p id="stats-published-drafts" class="text-3xl font-bold mt-2">0 / 0</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded shadow"><h2 class="text-xl font-semibold mb-4">Popular Posts</h2><ul id="popular-posts-list" class="divide-y"><li class="py-2 text-center text-gray-500">Loading...</li></ul></div><div class="bg-white p-6 rounded shadow"><h2 class="text-xl font-semibold mb-4">Views Over Time</h2><div class="h-64 bg-gray-50 rounded flex items-center justify-center"><p class="text-gray-400">Chart Placeholder</p></div></div></div>
            </div>

            <div id="users-students" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">User Management</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded shadow flex items-center justify-between"><div><p class="text-sm text-gray-500">Total Users</p><p id="total-users" class="text-2xl font-bold">0</p></div><div class="bg-blue-100 text-blue-500 p-3 rounded-full"><i class="fas fa-users"></i></div></div><div class="bg-white p-6 rounded shadow flex items-center justify-between"><div><p class="text-sm text-gray-500">Paid Users</p><p id="paid-users" class="text-2xl font-bold">0</p></div><div class="bg-green-100 text-green-500 p-3 rounded-full"><i class="fas fa-dollar-sign"></i></div></div><div class="bg-white p-6 rounded shadow flex items-center justify-between"><div><p class="text-sm text-gray-500">Not Paid Users</p><p id="not-paid-users" class="text-2xl font-bold">0</p></div><div class="bg-red-100 text-red-500 p-3 rounded-full"><i class="fas fa-exclamation-triangle"></i></div></div><div class="bg-white p-6 rounded shadow flex items-center justify-between"><div><p class="text-sm text-gray-500">Total Revenue</p><p id="total-revenue" class="text-2xl font-bold">$0</p></div><div class="bg-purple-100 text-purple-500 p-3 rounded-full"><i class="fas fa-wallet"></i></div></div></div><div class="bg-white p-4 rounded shadow mb-6 flex flex-wrap gap-3 items-center"><span class="text-sm font-medium mr-2">Filter:</span><button class="user-filter-btn px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200 active" data-filter="all">All</button><button class="user-filter-btn px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200" data-filter="paid">Paid</button><button class="user-filter-btn px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200" data-filter="not_paid">Not Paid</button><span class="text-sm font-medium ml-auto mr-2">Sort:</span><button class="user-sort-btn px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200 active" data-sort="recent">Recent</button><button class="user-sort-btn px-3 py-1 text-sm rounded-full bg-gray-100 hover:bg-gray-200" data-sort="asc">A-Z</button></div><div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><div class="relative w-full md:w-1/3"><input type="text" id="search-input" placeholder="Search..." class="w-full pl-10 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div><button id="add-user-btn" class="w-full md:w-auto bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Add User</button></div><div class="bg-white rounded shadow overflow-x-auto"><table class="w-full"> <thead class="bg-gray-50 border-b"><tr><th class="p-4 text-left text-sm font-semibold">User</th><th class="p-4 text-left text-sm font-semibold">Phone</th><th class="p-4 text-left text-sm font-semibold">Role</th><th class="p-4 text-left text-sm font-semibold">Payment</th><th class="p-4 text-left text-sm font-semibold">Actions</th></tr></thead><tbody id="user-table-body"><tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr></tbody></table></div>
            </div>
            <div id="users-roles" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Roles & Permissions</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-8 rounded shadow"><h2 class="text-xl font-bold mb-4">Manage Roles</h2><p class="text-gray-500 mb-4">Define roles and permissions.</p><div class="space-y-2"><div class="flex justify-between items-center p-3 bg-gray-50 rounded border"><span class="font-medium">Editor</span><button class="text-sm text-indigo-600 hover:text-indigo-800">Edit</button></div><div class="flex justify-between items-center p-3 bg-gray-50 rounded border"><span class="font-medium">Moderator</span><button class="text-sm text-indigo-600 hover:text-indigo-800">Edit</button></div></div></div><div class="bg-white p-8 rounded shadow"><h2 class="text-xl font-bold mb-4">Admin Accounts</h2><p class="text-gray-500 mb-4">Users with 'Admin' role.</p><div class="space-y-3" id="admin-user-list"><p class="text-center text-gray-500">Loading...</p></div></div></div>
            </div>
            <div id="main-report" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Main Report</h1><div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8"><div class="bg-white p-5 rounded shadow"><p class="text-sm text-gray-500">Paid Users</p><p id="report-paid-users" class="text-3xl font-bold mt-1">0</p></div><div class="bg-white p-5 rounded shadow"><p class="text-sm text-gray-500">PDF Views</p><p id="report-pdf-views" class="text-3xl font-bold mt-1">0</p></div><div class="bg-white p-5 rounded shadow col-span-1 md:col-span-2 lg:col-span-2"><p class="text-sm text-gray-500">Top PDF</p><p id="report-top-pdf" class="text-2xl font-bold text-indigo-600 mt-1 truncate">N/A</p></div><div class="bg-white p-5 rounded shadow"><p class="text-sm text-gray-500">Blog Views</p><p id="report-blog-views" class="text-3xl font-bold mt-1">0</p></div><div class="bg-white p-5 rounded shadow"><p class="text-sm text-gray-500">Active Today</p><p id="report-active-users" class="text-3xl font-bold mt-1">0</p></div></div><div class="bg-white p-4 rounded shadow mb-8 flex flex-col md:flex-row gap-4"><div class="flex-1"><label for="report-date-range" class="block text-sm font-medium">Date Range</label><input type="text" id="report-date-range" class="mt-1 w-full p-2 border rounded" placeholder="Select range..."></div><div class="flex-1"><label for="report-content-type" class="block text-sm font-medium">Content</label><select id="report-content-type" class="mt-1 w-full p-2 border rounded"><option value="all">All</option><option value="pdf">PDFs</option><option value="blog">Blog</option></select></div><div class="flex-1"><label for="report-subject-filter" class="block text-sm font-medium">Subject/Year (PDF)</label><select id="report-subject-filter" class="mt-1 w-full p-2 border rounded"><option value="all">All</option></select></div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8"><div class="lg:col-span-3 bg-white p-6 rounded shadow"><h2 class="text-xl font-semibold mb-4">Traffic</h2><div class="h-80 bg-gray-50 rounded flex items-center justify-center"><p class="text-gray-400">Line Chart</p></div></div><div class="lg:col-span-2 bg-white p-6 rounded shadow"><h2 class="text-xl font-semibold mb-4">PDF Views</h2><div class="h-80 bg-gray-50 rounded flex items-center justify-center"><p class="text-gray-400">Pie Chart</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded shadow"><h2 class="text-xl font-semibold mb-4">Top PDFs</h2><div class="h-64 bg-gray-50 rounded flex items-center justify-center"><p class="text-gray-400">Bar Chart</p></div></div><div class="bg-white p-6 rounded shadow"><h2 class="text-xl font-semibold mb-4">Top Blog Posts</h2><div class="overflow-y-auto h-64"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2 text-sm font-semibold">Post</th><th class="p-2 text-sm font-semibold">Views</th><th class="p-2 text-sm font-semibold">Comments</th></tr></thead><tbody id="report-blog-table"><tr><td colspan="3" class="p-4 text-center text-gray-500">Loading...</td></tr></tbody></table></div></div></div>
            </div>
            <div id="settings" class="tab-content fade-in hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1><div class="bg-white p-8 rounded shadow"><p class="text-gray-500">App settings...</p></div>
            </div>

        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto py-10"><div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 m-4"></div></div>
    <div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"><div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 h-[80vh] flex flex-col"><h2 class="text-2xl font-bold mb-4">Assign PDF to <span id="assign-item-type" class="capitalize">Item</span></h2><p class="mb-4">Select PDF for <strong id="assign-item-name"></strong>.</p><input type="text" id="assign-pdf-search" placeholder="Search PDFs..." class="w-full p-2 border rounded mb-4"><div id="assign-pdf-list-container" class="flex-1 overflow-y-auto border p-4 rounded bg-gray-50"><p class="text-center text-gray-500">Loading...</p></div><div class="mt-6 flex justify-end"><button id="assign-modal-cancel" class="bg-gray-200 px-4 py-2 rounded font-medium hover:bg-gray-300">Cancel</button></div></div></div>
    <div id="assign-pdf-to-content-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"><div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-8 m-4 h-[80vh] flex flex-col"><h2 class="text-2xl font-bold mb-4">Assign File</h2><p class="mb-4 truncate">Assigning: <strong id="assign-pdf-name-display" class="text-indigo-600"></strong></p><div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4"><button class="assign-pdf-select-type-btn flex-1 bg-gray-100 p-2 rounded font-medium hover:bg-indigo-100" data-type="subjects"><i data-lucide="book-copy" class="w-4 h-4 inline mr-1"></i>Subject</button><button class="assign-pdf-select-type-btn flex-1 bg-gray-100 p-2 rounded font-medium hover:bg-indigo-100" data-type="exams"><i data-lucide="file-check-2" class="w-4 h-4 inline mr-1"></i>Exam</button><button class="assign-pdf-select-type-btn flex-1 bg-gray-100 p-2 rounded font-medium hover:bg-indigo-100" data-type="generalBooks"><i data-lucide="book-open" class="w-4 h-4 inline mr-1"></i>Book</button></div><input type="text" id="assign-content-search" placeholder="Search content..." class="w-full p-2 border rounded mb-4 hidden"><div id="assign-content-list-container" class="flex-1 overflow-y-auto border p-4 rounded bg-gray-50"><p class="text-center text-gray-500">Select content type.</p></div><div class="mt-6 flex justify-end"><button id="assign-pdf-to-content-modal-cancel" class="bg-gray-200 px-4 py-2 rounded font-medium hover:bg-gray-300">Cancel</button></div></div></div>
    <div id="quiz-modal" class="quiz-modal-overlay"><div class="quiz-modal-container"><form id="quiz-form" class="p-6 sm:p-8"><div class="flex justify-between items-center pb-4 border-b mb-6"><h2 id="quiz-modal-title" class="text-3xl font-extrabold">Add Quiz</h2><div class="flex gap-3 items-center"><button id="import-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Import"><i class="fa-solid fa-file-import mr-1"></i> Import</button><input type="file" id="json-file-input" accept=".json" class="hidden"><button id="export-json-btn" type="button" class="quiz-btn quiz-btn-secondary text-sm" title="Export"><i class="fa-solid fa-file-export mr-1"></i> Export</button><button id="close-modal-btn" type="button" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark text-3xl"></i></button></div></div><input type="hidden" id="quiz-id-input"><div class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="quiz-title" class="block text-sm font-semibold mb-1">Title*</label><input type="text" id="quiz-title" class="quiz-form-input" required></div><div><label for="quiz-subject-select" class="block text-sm font-semibold mb-1">Subject*</label><select id="quiz-subject-select" class="quiz-form-select" required><option value="">-- Select --</option></select></div></div><div class="p-4 rounded bg-blue-50 border"><label for="cover-image-input" class="block text-sm font-semibold text-blue-700 mb-2 flex items-center"><i class="fa-solid fa-image mr-2"></i> Cover (Optional)</label><input type="file" id="cover-image-input" class="quiz-form-input p-2 bg-white" accept="image/*"><p id="cover-image-filename" class="text-xs text-blue-500 mt-1 italic"></p><input type="hidden" id="cover-image-url-input"><div id="cover-image-preview" class="mt-4 border-2 border-dashed p-2 bg-white rounded flex justify-center items-center h-40 overflow-hidden"><span class="text-blue-400 text-sm">Preview</span></div></div><hr/><h3 class="text-2xl font-bold flex items-center"><i class="fa-solid fa-clipboard-question mr-2 text-gray-400"></i> Questions</h3><div id="questions-container" class="space-y-5 max-h-[50vh] overflow-y-auto pr-3"><p class="text-gray-500 text-center py-4 text-sm" id="question-placeholder">Add questions below.</p></div><button type="button" id="add-question-btn" class="quiz-btn quiz-btn-secondary w-full text-blue-600 border-blue-300 bg-blue-100 hover:bg-blue-200"><i class="fa-solid fa-plus mr-2"></i> Add Question</button></div><div class="mt-8 flex flex-col sm:flex-row gap-4"><button type="submit" id="save-quiz-btn" class="quiz-btn quiz-btn-primary flex-grow text-lg py-3"><i class="fa-solid fa-floppy-disk mr-2"></i> Save</button><button id="delete-quiz-btn" type="button" class="quiz-btn quiz-btn-danger flex-grow hidden"><i class="fa-solid fa-trash-alt mr-2"></i> Delete</button></div></form></div></div>
    <div id="user-modal" class="user-modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4"><div class="p-6 border-b flex justify-between items-center"><h2 id="user-modal-title" class="text-2xl font-bold">Add User</h2><button id="user-modal-close" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div><div class="p-6"><form id="user-form"><input type="hidden" id="user-id"><div class="mb-4"><label for="name" class="block text-sm font-medium">Name</label><input type="text" id="name" required class="mt-1 block w-full p-2 border rounded shadow-sm focus:outline-none focus:ring-blue-500"></div><div class="mb-4"><label for="user-email" class="block text-sm font-medium">Email</label><input type="email" id="user-email" required class="mt-1 block w-full p-2 border rounded shadow-sm focus:outline-none focus:ring-blue-500"></div><div class="mb-4"><label for="phone" class="block text-sm font-medium">Phone</label><div class="flex"><span class="inline-flex items-center px-3 text-sm bg-gray-200 border border-r-0 rounded-l">252</span><input type="tel" id="phone" pattern="\d{9,}" title="Min 9 digits" required class="rounded-none rounded-r bg-gray-50 border focus:ring-blue-500 block flex-1 w-full text-sm p-2.5"></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save</button></div></form></div></div></div>
    <div id="confirm-modal" class="user-modal-backdrop"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4"><div class="p-6 text-center"><i id="confirm-icon" class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><h3 id="confirm-title" class="text-xl font-bold mb-2">Are you sure?</h3><p id="confirm-message" class="text-gray-600 mb-6">Cannot undo.</p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button><button id="confirm-action-btn" class="px-6 py-2 bg-red-500 text-white rounded">Yes</button></div></div></div></div>
    <div id="delete-modal" class="modal"><div class="modal-content bg-white p-8 rounded shadow-2xl w-full max-w-md m-4"><div class="text-center"><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="trash-2" class="w-8 h-8 text-red-600"></i></div><h2 class="text-2xl font-bold mb-2">Delete Post</h2><p class="text-gray-600 mb-6">Delete post & comments?</p><div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 rounded font-medium hover:bg-gray-300">Cancel</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded font-medium hover:bg-red-700">Delete</button></div></div></div></div>
    <div id="reply-modal" class="modal"><div class="modal-content bg-white p-8 rounded shadow-2xl w-full max-w-lg m-4"><h2 class="text-2xl font-bold mb-4">Reply</h2><div class="mb-4 bg-gray-50 p-4 rounded border"><p class="text-sm font-medium" id="reply-author"></p><p class="text-sm text-gray-600 mt-1" id="reply-original-text"></p></div><form id="reply-form"><input type="hidden" id="reply-comment-id"><textarea id="reply-text" rows="4" placeholder="Reply..." class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea><div class="flex justify-end gap-4 mt-6"><button id="cancel-reply-btn" type="button" class="px-6 py-2 bg-gray-200 rounded font-medium hover:bg-gray-300">Cancel</button><button id="submit-reply-btn" type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded font-medium hover:bg-indigo-700">Submit</button></div></form></div></div>
    <div id="share-modal" class="modal"><div class="modal-content bg-white p-8 rounded shadow-2xl w-full max-w-lg m-4"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Share Post</h2><button id="cancel-share-btn" class="p-1 text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button></div><p class="text-gray-600 mb-2">Share:</p><p class="text-lg font-semibold mb-4" id="share-post-title"></p><div class="flex items-center space-x-2"><input type="text" id="share-post-url" readonly class="w-full p-2 border rounded bg-gray-50 focus:outline-none"><button id="copy-url-btn" class="px-4 py-2 bg-indigo-600 text-white rounded font-medium hover:bg-indigo-700 flex items-center"><i data-lucide="copy" class="w-4 h-4 mr-2"></i> Copy</button></div><div class="flex justify-center space-x-4 mt-6"><a id="share-twitter" href="#" target="_blank" class="p-3 bg-blue-400 text-white rounded-full hover:bg-blue-500"><i data-lucide="twitter" class="w-5 h-5"></i></a><a id="share-facebook" href="#" target="_blank" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700"><i data-lucide="facebook" class="w-5 h-5"></i></a><a id="share-linkedin" href="#" target="_blank" class="p-3 bg-blue-700 text-white rounded-full hover:bg-blue-800"><i data-lucide="linkedin" class="w-5 h-5"></i></a></div></div></div>

    <div id="toast" class="hidden fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform translate-x-full opacity-0"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore, collection, getDocs, getDoc, addDoc, doc, updateDoc, deleteDoc,
            onSnapshot, serverTimestamp, query, where, orderBy, writeBatch, Timestamp,
            getCountFromServer // Use getCountFromServer for dashboard stats
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject, listAll, getMetadata // Added listAll, getMetadata
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // !!! IMPORTANT: Replace with your actual Firebase API key !!!
            authDomain: "ardaycaawiye-18b89.firebaseapp.com", projectId: "ardaycaawiye-18b89", storageBucket: "ardaycaawiye-18b89.firebasestorage.app", messagingSenderId: "590874185284", appId: "1:590874185284:web:6ee7df602c45068e38b611", measurementId: "G-SBGSTJWDMR"
        };

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Collections & Storage Refs ---
        const postsCollection = collection(db, "blogPosts");
        const commentsCollection = collection(db, "blogComments");
        const categoriesCollection = collection(db, "blogCategories");
        const usersCollection = collection(db, "users");
        const subjectsCollection = collection(db, "subjects");
        const examsCollection = collection(db, "exams");
        const quizzesCollection = collection(db, "quizzes");
        const booksCollection = collection(db, "generalBooks");
        const pdfsStorageRef = ref(storage, '/'); // List root folder in storage, adjust if needed (e.g., ref(storage, 'pdfs/'))

        // --- Global State ---
        let currentUser = null; // Stays null as no login page
        let currentActiveTab = 'dashboard';
        let allPosts = [], allComments = [], allCategories = [], allUsers = [];
        let allSubjects = [], allExams = [], allQuizzes = [], allBooks = [], allPdfs = [];
        let unsubscribePosts = () => {}, unsubscribeComments = () => {}, unsubscribeCategories = () => {}, unsubscribeUsers = () => {};
        let unsubscribeSubjects = () => {}, unsubscribeExams = () => {}, unsubscribeQuizzes = () => {}, unsubscribeBooks = () => {};
        let editingPostId = null, postToDeleteId = null, commentToReplyId = null;
        let editingContent = { id: null, type: null }; // For generic content editing

        // --- Lib Instances ---
        let quill, tagify, schedulePicker, reportDatePicker;

        // --- DOM Elements ---
        const mainApp = document.getElementById('main-app');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatus = document.getElementById('auth-status');
        const allTabs = document.querySelectorAll('.tab-content');
        const allSidebarLinks = document.querySelectorAll('#sidebar .sidebar-link');
        const dropdownToggles = document.querySelectorAll('#sidebar .has-dropdown');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mainSidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const toast = document.getElementById('toast');
        // Blog
        const postsTableBody = document.getElementById('posts-table-body'); const blogPostForm = document.getElementById('blog-post-form'); const postFormTitle = document.getElementById('form-title'); const postIdInput = document.getElementById('post-id'); const postTitleInput = document.getElementById('post-title'); const postStatusSelect = document.getElementById('post-status'); const scheduleDateWrapper = document.getElementById('schedule-date-wrapper'); const postCategorySelect = document.getElementById('post-category'); const filterCategorySelect = document.getElementById('filter-category'); const imageDropzone = document.getElementById('image-dropzone'); const imageInput = document.getElementById('post-image'); const imagePreviewWrapper = document.getElementById('image-preview-wrapper'); const imagePreview = document.getElementById('image-preview'); const removeImageBtn = document.getElementById('remove-image-btn'); const attachmentDropzone = document.getElementById('attachment-dropzone'); const attachmentInput = document.getElementById('post-attachments'); const attachmentList = document.getElementById('attachment-list'); const commentsListView = document.getElementById('comments-list'); const deleteModal = document.getElementById('delete-modal'); const confirmDeleteBtn = document.getElementById('confirm-delete-btn'); const cancelDeleteBtn = document.getElementById('cancel-delete-btn'); const replyModal = document.getElementById('reply-modal'); const replyForm = document.getElementById('reply-form'); const cancelReplyBtn = document.getElementById('cancel-reply-btn'); const shareModal = document.getElementById('share-modal'); const cancelShareBtn = document.getElementById('cancel-share-btn'); const copyUrlBtn = document.getElementById('copy-url-btn'); const selectAllCheckbox = document.getElementById('select-all-posts'); const categoriesList = document.getElementById('categories-list'); const addCategoryForm = document.getElementById('add-category-form');
        // Users
        const userTableBody = document.getElementById('user-table-body'); const addUserBtn = document.getElementById('add-user-btn'); const userModal = document.getElementById('user-modal'); const userModalCloseBtn = document.getElementById('user-modal-close'); const userForm = document.getElementById('user-form'); const userModalTitle = document.getElementById('user-modal-title'); const userIdInput = document.getElementById('user-id'); const userNameInput = document.getElementById('name'); const userEmailInput = document.getElementById('user-email'); const userPhoneInput = document.getElementById('phone'); const userCancelBtn = document.getElementById('cancel-btn'); const confirmActionModal = document.getElementById('confirm-modal'); const confirmActionBtn = document.getElementById('confirm-action-btn'); const confirmCancelBtn = document.getElementById('confirm-cancel-btn'); const confirmTitle = document.getElementById('confirm-title'); const confirmMessage = document.getElementById('confirm-message'); const confirmIcon = document.getElementById('confirm-icon'); const searchUserInput = document.getElementById('search-input'); const userFilterBtns = document.querySelectorAll('.user-filter-btn'); const userSortBtns = document.querySelectorAll('.user-sort-btn'); const adminUserListContainer = document.getElementById('admin-user-list');
        // Dashboard
        const dashTotalSubjects = document.getElementById('total-subjects'); const dashTotalExams = document.getElementById('total-exams'); const dashTotalBooks = document.getElementById('total-books'); const dashTotalQuizzes = document.getElementById('total-quizzes'); const dashTotalUsers = document.getElementById('dash-total-users'); const dashPaidUsers = document.getElementById('dash-paid-users'); const dashBannedUsers = document.getElementById('dash-banned-users'); const dashTotalRevenue = document.getElementById('dash-total-revenue');
        // User Stats
        const usersTotal = document.getElementById('total-users'); const usersPaid = document.getElementById('paid-users'); const usersNotPaid = document.getElementById('not-paid-users'); const usersRevenue = document.getElementById('total-revenue');
        // Report
        const reportPaidUsersEl = document.getElementById('report-paid-users'); const reportPdfViewsEl = document.getElementById('report-pdf-views'); const reportTopPdfEl = document.getElementById('report-top-pdf'); const reportBlogViewsEl = document.getElementById('report-blog-views'); const reportActiveUsersEl = document.getElementById('report-active-users');
        // Content Lists
        const subjectsListEl = document.getElementById('subjects-list'); const examsListEl = document.getElementById('exams-list'); const quizzesListContainer = document.getElementById('quiz-list-container'); const booksListEl = document.getElementById('books-list'); const pdfListTableBody = document.getElementById('pdf-list-table');
        // PDF Library Elements
        const pdfUploadBtn = document.getElementById('upload-pdf-btn'); const pdfUploadInput = document.getElementById('pdf-upload-input'); const uploadProgressContainer = document.getElementById('upload-progress-container'); const uploadProgressBar = document.getElementById('upload-progress-bar'); const pdfSearchInput = document.getElementById('pdf-search'); const deleteSelectedPdfsBtn = document.getElementById('delete-selected-pdfs-btn'); const selectAllPdfsCheckbox = document.getElementById('select-all-pdfs');
        // Quiz Elements
        const addQuizBtnHeader = document.getElementById('add-quiz-fab-header'); const quizModal = document.getElementById('quiz-modal'); const quizForm = document.getElementById('quiz-form'); const closeQuizModalBtn = document.getElementById('close-modal-btn'); const quizSubjectFilter = document.getElementById('quiz-subject-filter'); /* Add other quiz form inputs */

        // =============================================
        // Initialization
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initBlogLibs(); // Init libs early
            initOtherLibs(); // Init other libs like flatpickr
            setupMainEventListeners(); // Setup general listeners
            setupBlogEventListeners(); // Setup blog specific listeners
            setupContentEventListeners(); // Setup content specific listeners

            // Assume logged in
            authStatus.textContent = 'Admin Access';
            mainApp.classList.remove('hidden');
            showTab(currentActiveTab || 'dashboard'); // Show initial tab
        });

        function initOtherLibs() {
            try { reportDatePicker = flatpickr("#report-date-range", { mode: "range", dateFormat: "Y-m-d" }); }
            catch(e) { console.warn("Flatpickr init error (maybe not on this tab):", e); }
            // Add other lib initializations here
        }

        // =============================================
        // Toast Notification
        // =============================================
        function showToast(message, isError = false) {
             toast.textContent = message; toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform ${isError ? 'bg-red-600' : 'bg-green-600'}`; toast.style.transform = 'translateX(100%)'; toast.style.opacity = '0'; toast.classList.remove('hidden'); void toast.offsetWidth; toast.style.transition = 'all 0.3s ease-out'; toast.style.transform = 'translateX(0)'; toast.style.opacity = '1'; setTimeout(() => { toast.style.transform = 'translateX(100%)'; toast.style.opacity = '0'; setTimeout(() => toast.classList.add('hidden'), 300); }, 3000);
         }

        // =============================================
        // Navigation & Listener Management
        // =============================================
        function stopAllListeners() {
            // console.log("Stopping listeners...");
            unsubscribePosts(); unsubscribeComments(); unsubscribeCategories(); unsubscribeUsers();
            unsubscribeSubjects(); unsubscribeExams(); unsubscribeQuizzes(); unsubscribeBooks();
            unsubscribePosts=()=>{}; unsubscribeComments=()=>{}; unsubscribeCategories=()=>{}; unsubscribeUsers=()=>{};
            unsubscribeSubjects=()=>{}; unsubscribeExams=()=>{}; unsubscribeQuizzes=()=>{}; unsubscribeBooks=()=>{};
        }

        function showTab(tabId) {
            console.log(`Switching to tab: ${tabId}`);
            stopAllListeners();
            currentActiveTab = tabId;
            allTabs.forEach(tab => tab.classList.add('hidden'));
            const newTab = document.getElementById(tabId);
            if (newTab) { newTab.classList.remove('hidden'); }
            else { document.getElementById('dashboard').classList.remove('hidden'); currentActiveTab = 'dashboard'; }

            allSidebarLinks.forEach(link => link.classList.remove('active'));
            dropdownToggles.forEach(btn => btn.classList.remove('open'));
            const activeLink = document.querySelector(`#sidebar .sidebar-link[data-tab="${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                const parentDropdownMenu = activeLink.closest('.dropdown-menu');
                if (parentDropdownMenu) {
                    const parentButton = parentDropdownMenu.previousElementSibling;
                    if (parentButton?.classList.contains('has-dropdown')) { parentButton.classList.add('open'); }
                }
            }

            // Init logic for the new tab
            switch (tabId) {
                case 'dashboard': loadDashboardStats(); break;
                case 'users-students': initUsersListener(renderUserTable); break;
                case 'users-roles': initUsersListener(renderAdminList); break;
                case 'main-report': console.log("Init Main Report..."); break;
                case 'list-posts': initPostsListener(); initCategoriesListener(); break;
                case 'post-form-view': initCategoriesListener(); if (!editingPostId) showPostForm(); break;
                case 'categories': initCategoriesListener(renderCategoriesList); break;
                case 'comments': initPostsListener(); initCommentsListener(); break;
                case 'analytics': fetchAllDataForAnalytics(); break;
                case 'subjects': initSubjectsListener(); break;
                case 'exams': initExamsListener(); break;
                case 'quizzes': initQuizzesListener(); initSubjectsListener(populateQuizSubjectFilter); break; // Fetch subjects too
                case 'generalBooks': initBooksListener(); break;
                case 'pdf-library': loadPdfList(); break;
                case 'settings': console.log("Settings Tab - Placeholder"); break;
            }
            lucide.createIcons();
        }

        // =============================================
        // Main Event Listeners Setup
        // =============================================
        function setupMainEventListeners() {
            // Logout
            if(logoutBtn) logoutBtn.addEventListener('click', () => { showToast("Logout action."); /* Add real logout */ });
            // Sidebar Navigation
            allSidebarLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); if (link.classList.contains('has-dropdown')) { link.classList.toggle('open'); } else if (link.dataset.tab) { editingPostId = null; editingContent = { id: null, type: null }; showTab(link.dataset.tab); if (!mainSidebar.classList.contains('-translate-x-full')) { mainSidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); } } }); });
            // Mobile Sidebar
            if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => { mainSidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); });
            if(sidebarOverlay) sidebarOverlay.addEventListener('click', () => { mainSidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); });
            // User Management
            if(addUserBtn) addUserBtn.addEventListener('click', () => showUserModal());
            if(userModalCloseBtn) userModalCloseBtn.addEventListener('click', () => hideUserModal());
            if(userCancelBtn) userCancelBtn.addEventListener('click', () => hideUserModal());
            if(userForm) userForm.addEventListener('submit', handleUserFormSubmit);
            if(searchUserInput) searchUserInput.addEventListener('input', () => renderUserTable());
            userFilterBtns.forEach(btn => btn.addEventListener('click', handleUserFilterClick));
            userSortBtns.forEach(btn => btn.addEventListener('click', handleUserSortClick));
            if(confirmCancelBtn) confirmCancelBtn.addEventListener('click', () => hideConfirmModal());
            if(userTableBody) userTableBody.addEventListener('click', (e) => { const editBtn=e.target.closest('.edit-user-btn'),delBtn=e.target.closest('.delete-user-btn'); if(editBtn)showUserModal(editBtn.dataset.id); if(delBtn)showConfirmModal('Delete User','Are you sure?',()=>deleteUser(delBtn.dataset.id),!0); });
        }

        // =============================================
        // Dashboard Logic
        // =============================================
        async function loadDashboardStats() {
             console.log("Loading dashboard stats...");
             try {
                // Define queries
                const usersQuery = query(usersCollection, where("role", "!=", "admin"));
                const paidUsersQuery = query(usersCollection, where("paymentStatus", "==", "paid"), where("role", "!=", "admin"));
                const subjectsQuery = query(subjectsCollection);
                const examsQuery = query(examsCollection);
                const booksQuery = query(booksCollection);
                const quizzesQuery = query(quizzesCollection); // Assuming quizzes collection exists

                // Fetch counts in parallel
                const counts = await Promise.all([
                    getCountFromServer(usersQuery),
                    getCountFromServer(paidUsersQuery),
                    getCountFromServer(subjectsQuery),
                    getCountFromServer(examsQuery),
                    getCountFromServer(booksQuery),
                    getCountFromServer(quizzesQuery) // Fetch quiz count
                ]);

                // Update DOM elements safely
                if(dashTotalUsers) dashTotalUsers.textContent = counts[0].data().count;
                if(dashPaidUsers) dashPaidUsers.textContent = counts[1].data().count;
                if(dashTotalSubjects) dashTotalSubjects.textContent = counts[2].data().count;
                if(dashTotalExams) dashTotalExams.textContent = counts[3].data().count;
                if(dashTotalBooks) dashTotalBooks.textContent = counts[4].data().count;
                if(dashTotalQuizzes) dashTotalQuizzes.textContent = counts[5].data().count; // Update quiz count

                // Example Revenue Calculation
                const revenue = counts[1].data().count * 5; // Assuming $5 per paid user
                if(dashTotalRevenue) dashTotalRevenue.textContent = `$${revenue}`;
                if(dashBannedUsers) dashBannedUsers.textContent = '0'; // Placeholder

             } catch (error) {
                 console.error("Error loading dashboard stats:", error);
                 showToast("Failed to load dashboard statistics.", true);
                 // Optionally reset stats on error
                 if(dashTotalUsers) dashTotalUsers.textContent = 'Err';
                 // ... reset others ...
             }
         }

        // =============================================
        // User Management Logic (Keep robust version)
        // =============================================
         let currentUsersFilter = 'all'; let currentUsersSort = 'recent';
         function handleUserFilterClick(e) { userFilterBtns.forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentUsersFilter=e.target.dataset.filter; renderUserTable(); }
         function handleUserSortClick(e) { userSortBtns.forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentUsersSort=e.target.dataset.sort; renderUserTable(); }
         function initUsersListener(renderCallback) { unsubscribeUsers = onSnapshot(usersCollection,snap=>{allUsers=snap.docs.map(d=>({id:d.id,...d.data()}));if(renderCallback)renderCallback();updateUserStats();},e=>{console.error(e);showToast("Err users.",!0);/* UI Error */}); }
         function renderUserTable() { if(!userTableBody) return; userTableBody.innerHTML = ''; const searchTerm = searchUserInput.value.toLowerCase(); let filteredUsers = allUsers.filter(user => user.role !== 'admin'); if (currentUsersFilter === 'paid') filteredUsers = filteredUsers.filter(u => u.paymentStatus === 'paid'); else if (currentUsersFilter === 'not_paid') filteredUsers = filteredUsers.filter(u => u.paymentStatus !== 'paid'); if (searchTerm) filteredUsers = filteredUsers.filter(u => (u.name?.toLowerCase().includes(searchTerm)) || (u.email?.toLowerCase().includes(searchTerm)) || (u.phone?.includes(searchTerm))); filteredUsers.sort((a, b) => { if (currentUsersSort === 'asc') return (a.name || '').localeCompare(b.name || ''); else { const timeA = a.createdAt?.toMillis() || 0; const timeB = b.createdAt?.toMillis() || 0; return timeB - timeA; } }); if (filteredUsers.length === 0) { userTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No users found.</td></tr>`; return; } filteredUsers.forEach(user => { const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50"; const pStatus = user.paymentStatus === 'paid'; tr.innerHTML = `<td class="p-4"><div class="font-medium">${user.name||'N/A'}</div><div class="text-sm text-gray-500">${user.email||'N/A'}</div></td><td class="p-4 text-sm">${user.phone?`252${user.phone}`:'N/A'}</td><td class="p-4 text-sm capitalize">${user.role||'student'}</td><td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded ${pStatus?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${pStatus?'Paid':'Not Paid'}</span></td><td class="p-4"><div class="flex space-x-1"><button class="edit-user-btn p-1 text-indigo-600 hover:text-indigo-800" data-id="${user.id}" title="Edit"><i data-lucide="edit-2" class="w-4 h-4 p-e-none"></i></button><button class="delete-user-btn p-1 text-red-600 hover:text-red-800" data-id="${user.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button></div></td>`; userTableBody.appendChild(tr); }); lucide.createIcons(); }
         function renderAdminList() { if(!adminUserListContainer) return; adminUserListContainer.innerHTML='';const admins=allUsers.filter(u=>u.role==='admin');if(admins.length===0){adminUserListContainer.innerHTML=`<p class="text-center text-gray-500">No admins.</p>`;return;}admins.forEach(a=>{const d=document.createElement('div');d.className="flex items-center justify-between p-3 bg-blue-50 border rounded";d.innerHTML=`<div><p class="font-semibold text-blue-800">${a.name||'Admin'}</p><p class="text-sm text-blue-600">${a.email}</p></div><span class="text-sm font-medium text-blue-700 capitalize">${a.role}</span>`;adminUserListContainer.appendChild(d);}); }
         function updateUserStats() { if(!usersTotal) return; const nonAdmin=allUsers.filter(u=>u.role!=='admin'),paid=nonAdmin.filter(u=>u.paymentStatus==='paid').length,rev=paid*5;usersTotal.textContent=nonAdmin.length;usersPaid.textContent=paid;usersNotPaid.textContent=nonAdmin.length-paid;usersRevenue.textContent=`$${rev}`; }
         async function showUserModal(userId=null) { if(!userModal) return; userForm.reset();userIdInput.value='';if(userId){userModalTitle.textContent='Edit';try{const snap=await getDoc(doc(db,"users",userId));if(snap.exists()){const d=snap.data();userIdInput.value=userId;userNameInput.value=d.name||'';userEmailInput.value=d.email||'';userPhoneInput.value=d.phone||'';}else{showToast('User not found.',!0);return;}}catch(e){console.error(e);showToast('Load failed.',!0);return;}}else{userModalTitle.textContent='Add New';}userModal.style.display='flex'; }
         function hideUserModal() { if(userModal) userModal.style.display='none'; }
         async function handleUserFormSubmit(e) { e.preventDefault();const id=userIdInput.value,name=userNameInput.value.trim(),email=userEmailInput.value.trim(),phone=userPhoneInput.value.trim();if(!name||!email){showToast('Name/Email required.',!0);return;}if(phone&&!/^\d+$/.test(phone)){showToast('Phone digits only.',!0);return;}const data={name,email,phone,role:'student',paymentStatus:'not_paid'};const btn=userForm.querySelector('button[type="submit"]');btn.disabled=!0;btn.textContent='Saving...';try{if(id){await updateDoc(doc(db,"users",id),data);showToast('User updated!');}else{data.createdAt=serverTimestamp();await addDoc(usersCollection,data);showToast('User added!');}hideUserModal();}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);}finally{btn.disabled=!1;btn.textContent='Save';} }
         async function deleteUser(userId) { try{await deleteDoc(doc(db,"users",userId));showToast('User deleted!');}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);} }
         let confirmActionCallback=null; function showConfirmModal(title,msg,onConfirm,isDanger=!1) { if(!confirmActionModal) return; confirmTitle.textContent=title;confirmMessage.textContent=msg;confirmActionCallback=onConfirm;confirmActionBtn.className=`px-6 py-2 text-white rounded font-medium ${isDanger?'bg-red-600 hover:bg-red-700':'bg-indigo-600 hover:bg-indigo-700'}`;confirmIcon.className=`text-4xl mb-4 ${isDanger?'fas fa-exclamation-triangle text-red-500':'fas fa-question-circle text-indigo-500'}`;confirmActionBtn.textContent=isDanger?'Yes, delete!':'Yes';confirmActionBtn.replaceWith(confirmActionBtn.cloneNode(!0));document.getElementById('confirm-action-btn').addEventListener('click',()=>{if(confirmActionCallback)confirmActionCallback();hideConfirmModal();});confirmActionModal.style.display='flex'; }
         function hideConfirmModal() { if(confirmActionModal) confirmActionModal.style.display='none';confirmActionCallback=null; }

        // =============================================
        // === CONTENT MANAGEMENT LOGIC (NEW/Updated) ===
        // =============================================

        // --- Listeners ---
        function initSubjectsListener() { unsubscribeSubjects = onSnapshot(query(subjectsCollection, orderBy("name")), s => { allSubjects = s.docs.map(d=>({id:d.id,...d.data()})); renderContentList(subjectsListEl, allSubjects, 'subject'); }, e => { console.error("Err subjects:", e); if(subjectsListEl) subjectsListEl.innerHTML = `<li class="text-red-500">Error loading.</li>`; }); }
        function initExamsListener() { unsubscribeExams = onSnapshot(query(examsCollection, orderBy("title")), s => { allExams = s.docs.map(d=>({id:d.id,...d.data()})); renderContentList(examsListEl, allExams, 'exam'); }, e => { console.error("Err exams:", e); if(examsListEl) examsListEl.innerHTML = `<li class="text-red-500">Error loading.</li>`; }); }
        function initQuizzesListener() { unsubscribeQuizzes = onSnapshot(query(quizzesCollection, orderBy("title")), s => { allQuizzes = s.docs.map(d=>({id:d.id,...d.data()})); renderQuizList(); }, e => { console.error("Err quizzes:", e); if(quizzesListContainer) quizzesListContainer.innerHTML = `<p class="text-red-500 text-center">Error loading quizzes.</p>`; }); }
        function initBooksListener() { unsubscribeBooks = onSnapshot(query(booksCollection, orderBy("title")), s => { allBooks = s.docs.map(d=>({id:d.id,...d.data()})); renderContentList(booksListEl, allBooks, 'book'); }, e => { console.error("Err books:", e); if(booksListEl) booksListEl.innerHTML = `<li class="text-red-500">Error loading.</li>`; }); }

        // --- Renderers ---
        function renderContentList(listElement, items, itemType) {
            if (!listElement) return; // Element might not exist if tab isn't visible
            listElement.innerHTML = '';
            if (!items || items.length === 0) { listElement.innerHTML = `<li class="text-gray-500 italic">No ${itemType.toLowerCase()}s found.</li>`; return; }
            items.forEach(item => {
                const li = document.createElement('li');
                // Use 'name' for subjects, 'title' for others, provide fallback
                const displayName = item.name || item.title || `Unnamed ${itemType}`;
                li.innerHTML = `
                    <span class="font-medium">${displayName}</span>
                    <div class="content-actions">
                        <button class="edit-content-btn p-1 text-indigo-600 hover:text-indigo-800" data-id="${item.id}" data-type="${itemType.toLowerCase()}" title="Edit ${itemType}">
                            <i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                        <button class="delete-content-btn p-1 text-red-600 hover:text-red-800" data-id="${item.id}" data-type="${itemType.toLowerCase()}" title="Delete ${itemType}">
                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                    </div>`;
                listElement.appendChild(li);
            });
            lucide.createIcons();
        }

        function renderQuizList() {
            if (!quizzesListContainer) return;
            quizzesListContainer.innerHTML = ''; // Clear loading/previous
            const subjectFilterValue = quizSubjectFilter ? quizSubjectFilter.value : 'all';

            const filteredQuizzes = allQuizzes.filter(quiz =>
                subjectFilterValue === 'all' || quiz.subjectId === subjectFilterValue // Assuming quizzes have a subjectId field
            );

            if (filteredQuizzes.length === 0) {
                 quizzesListContainer.innerHTML = `<p class="text-gray-500 text-center col-span-full">No quizzes found${subjectFilterValue !== 'all' ? ' for this subject' : ''}.</p>`;
                 return;
            }

            filteredQuizzes.forEach(quiz => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl shadow border border-gray-100 flex flex-col";
                // Find subject name (assuming allSubjects is populated)
                const subject = allSubjects.find(s => s.id === quiz.subjectId);
                div.innerHTML = `
                    ${quiz.coverImageUrl ? `<img src="${quiz.coverImageUrl}" alt="${quiz.title}" class="h-32 w-full object-cover rounded-lg mb-3">` : '<div class="h-32 bg-gray-200 rounded-lg mb-3 flex items-center justify-center text-gray-400">No Image</div>'}
                    <h3 class="font-semibold text-lg mb-1 truncate">${quiz.title}</h3>
                    <p class="text-sm text-gray-500 mb-3">${subject ? subject.name : 'Unknown Subject'}</p>
                    <div class="mt-auto flex justify-end space-x-2">
                         <button class="edit-content-btn quiz-btn quiz-btn-secondary text-xs" data-id="${quiz.id}" data-type="quiz">Edit</button>
                         <button class="delete-content-btn quiz-btn quiz-btn-danger text-xs" data-id="${quiz.id}" data-type="quiz">Delete</button>
                    </div>
                `;
                quizzesListContainer.appendChild(div);
            });
        }

        function populateQuizSubjectFilter() {
             if (!quizSubjectFilter) return;
             // Clear existing options except 'All Subjects'
             while (quizSubjectFilter.options.length > 1) { quizSubjectFilter.remove(1); }
             allSubjects.forEach(subject => {
                 const option = document.createElement('option');
                 option.value = subject.id; // Use subject ID for filtering
                 option.textContent = subject.name;
                 quizSubjectFilter.appendChild(option);
             });
        }

        // --- PDF Library (Keep implementation) ---
        async function loadPdfList() { /* ... keep implementation ... */ if(!pdfListTableBody)return;pdfListTableBody.innerHTML='<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading...</td></tr>';try{const listRef=ref(storage,'/');const res=await listAll(listRef);allPdfs=await Promise.all(res.items.map(async i=>{const m=await getMetadata(i);return{name:i.name,fullPath:i.fullPath,size:m.size,timeCreated:m.timeCreated};}));renderPdfTable();}catch(e){console.error("Err list PDFs:",e);pdfListTableBody.innerHTML='<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading files.</td></tr>';showToast("Err loading PDFs.",!0);} }
        function renderPdfTable() { /* ... keep implementation ... */ if(!pdfListTableBody)return;pdfListTableBody.innerHTML='';const s=pdfSearchInput.value.toLowerCase();const f=allPdfs.filter(p=>p.name.toLowerCase().includes(s));f.sort((a,b)=>b.size-a.size);if(f.length===0){pdfListTableBody.innerHTML='<tr><td colspan="5" class="p-4 text-center text-gray-500">No files.</td></tr>';return;}f.forEach(p=>{const tr=document.createElement('tr');tr.className="border-b hover:bg-gray-50";tr.innerHTML=`<td class="p-3"><input type="checkbox" class="pdf-checkbox" data-path="${p.fullPath}"></td><td class="p-3 font-medium">${p.name}</td><td class="p-3 text-sm">${formatBytes(p.size)}</td><td class="p-3 text-sm">${new Date(p.timeCreated).toLocaleDateString()}</td><td class="p-3"><div class="flex space-x-1"><button class="view-pdf-btn p-1 text-blue-600" data-path="${p.fullPath}" title="View"><i data-lucide="external-link" class="w-4 h-4 p-e-none"></i></button><button class="delete-pdf-btn p-1 text-red-600" data-path="${p.fullPath}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button></div></td>`;pdfListTableBody.appendChild(tr);});lucide.createIcons();updateDeleteSelectedButtonState();selectAllPdfsCheckbox.checked=!1; }
        function formatBytes(b,d=2) { /* ... keep implementation ... */ if(b===0)return'0 Bytes';const k=1024,dm=d<0?0:d,s=['Bytes','KB','MB','GB','TB'],i=Math.floor(Math.log(b)/Math.log(k));return parseFloat((b/Math.pow(k,i)).toFixed(dm))+' '+s[i];}
        async function handlePdfUpload(files) { /* ... keep implementation ... */ if(!files||files.length===0)return;uploadProgressContainer.classList.remove('hidden');uploadProgressBar.style.width='0%';let completed=0;for(const f of files){const fileRef=ref(storage,f.name);const uTask=uploadBytesResumable(fileRef,f);uTask.on('state_changed',s=>{const p=(s.bytesTransferred/s.totalBytes)*100;uploadProgressBar.style.width=p+'%';},e=>{console.error(e);showToast(`Err upload ${f.name}`,!0);completed++;if(completed===files.length)uploadProgressContainer.classList.add('hidden');},async()=>{try{await getDownloadURL(uTask.snapshot.ref);showToast(`${f.name} uploaded!`);}catch(e){showToast(`Error getting URL for ${f.name}`, true);}finally{completed++;if(completed===files.length){loadPdfList();uploadProgressContainer.classList.add('hidden');}}});}}
        async function deletePdfFile(path) { /* ... keep implementation ... */ const ref=ref(storage,path);try{await deleteObject(ref);showToast('File deleted.');loadPdfList();}catch(e){console.error(e);showToast(`Err delete file: ${e.message}`,!0);} }
        function updateDeleteSelectedButtonState() { /* ... keep implementation ... */ if(!pdfListTableBody)return;const s=pdfListTableBody.querySelectorAll('.pdf-checkbox:checked');deleteSelectedPdfsBtn.classList.toggle('hidden',s.length===0); }
        async function deleteSelectedPdfs() { /* ... keep implementation ... */ const sel=pdfListTableBody.querySelectorAll('.pdf-checkbox:checked');if(sel.length===0)return;showConfirmModal(`Delete ${sel.length} Files`,'Sure?',async()=>{deleteSelectedPdfsBtn.disabled=!0;deleteSelectedPdfsBtn.innerHTML='<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Deleting...';lucide.createIcons();let succ=0;for(const cb of sel){try{await deleteObject(ref(storage,cb.dataset.path));succ++;}catch(e){console.error(`Failed delete ${cb.dataset.path}:`,e);showToast(`Err delete ${cb.dataset.path.split('/').pop()}`,!0);}}showToast(`${succ}/${sel.length} deleted.`);loadPdfList();deleteSelectedPdfsBtn.disabled=!1;deleteSelectedPdfsBtn.innerHTML='<i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Selected';lucide.createIcons();},!0); }

        // --- Content CRUD Actions (Generic Examples) ---
        async function addContentItem(type, data) {
            let collectionRef;
            switch(type) {
                case 'subject': collectionRef = subjectsCollection; break;
                case 'exam': collectionRef = examsCollection; break;
                case 'book': collectionRef = booksCollection; break;
                // Add quiz case if needed, though quiz adding is more complex
                default: showToast(`Invalid content type: ${type}`, true); return;
            }
            try {
                const docData = { ...data, createdAt: serverTimestamp() }; // Add timestamp
                await addDoc(collectionRef, docData);
                showToast(`${capitalize(type)} added successfully!`);
                // Close any 'add' modal if open
            } catch (error) {
                console.error(`Error adding ${type}:`, error);
                showToast(`Error adding ${type}.`, true);
            }
        }

        async function updateContentItem(type, id, data) {
            let docRef;
             switch(type) {
                case 'subject': docRef = doc(db, "subjects", id); break;
                case 'exam': docRef = doc(db, "exams", id); break;
                case 'book': docRef = doc(db, "generalBooks", id); break;
                // Add quiz case if needed
                default: showToast(`Invalid content type: ${type}`, true); return;
            }
             try {
                await updateDoc(docRef, { ...data, updatedAt: serverTimestamp() }); // Add timestamp
                showToast(`${capitalize(type)} updated successfully!`);
                // Close any 'edit' modal if open
             } catch (error) {
                console.error(`Error updating ${type}:`, error);
                showToast(`Error updating ${type}.`, true);
             }
        }

        async function deleteContentItem(type, id) {
            let docRef;
             switch(type) {
                case 'subject': docRef = doc(db, "subjects", id); break;
                case 'exam': docRef = doc(db, "exams", id); break;
                case 'book': docRef = doc(db, "generalBooks", id); break;
                 case 'quiz': docRef = doc(db, "quizzes", id); break; // Add quiz case
                default: showToast(`Invalid content type: ${type}`, true); return;
            }
             try {
                await deleteDoc(docRef);
                showToast(`${capitalize(type)} deleted successfully!`);
                // Add cascading delete logic if needed (e.g., delete quizzes related to a subject)
             } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                showToast(`Error deleting ${type}.`, true);
             }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // --- Setup Content Event Listeners ---
        function setupContentEventListeners() {
            // PDF Library (Keep implementation)
            if(pdfUploadBtn) pdfUploadBtn.addEventListener('click', () => pdfUploadInput.click());
            if(pdfUploadInput) pdfUploadInput.addEventListener('change', (e) => handlePdfUpload(e.target.files));
            if(pdfSearchInput) pdfSearchInput.addEventListener('input', renderPdfTable);
            if(selectAllPdfsCheckbox) selectAllPdfsCheckbox.addEventListener('change', (e) => { pdfListTableBody.querySelectorAll('.pdf-checkbox').forEach(cb => cb.checked = e.target.checked); updateDeleteSelectedButtonState(); });
            if(pdfListTableBody) pdfListTableBody.addEventListener('change', (e) => { if (e.target.classList.contains('pdf-checkbox')) updateDeleteSelectedButtonState(); });
            if(deleteSelectedPdfsBtn) deleteSelectedPdfsBtn.addEventListener('click', deleteSelectedPdfs);
            if(pdfListTableBody) pdfListTableBody.addEventListener('click', async (e) => { const delBtn=e.target.closest('.delete-pdf-btn'),viewBtn=e.target.closest('.view-pdf-btn'); if(delBtn)showConfirmModal('Delete File',`Delete ${delBtn.dataset.path.split('/').pop()}?`,()=>deletePdfFile(delBtn.dataset.path),!0); if(viewBtn) try{const url=await getDownloadURL(ref(storage,viewBtn.dataset.path));window.open(url,'_blank');}catch(err){console.error(err);showToast("Could not get URL.",!0);} });

            // Quizzes (Add/Edit/Delete Logic Needed)
            if(addQuizBtnHeader) addQuizBtnHeader.addEventListener('click', () => { console.log("Show Quiz Modal..."); /* showQuizModal(); */ if(quizModal) quizModal.style.display = 'flex'; }); // Show modal
            if(closeQuizModalBtn) closeQuizModalBtn.addEventListener('click', () => { if(quizModal) quizModal.style.display = 'none'; }); // Hide modal
            if(quizSubjectFilter) quizSubjectFilter.addEventListener('change', renderQuizList); // Re-render list on filter change
            // Add listener for quizForm submit
            // Add listeners for quiz add question, etc.

            // Generic Content Add/Edit/Delete Delegation
            document.body.addEventListener('click', (e) => {
                const addBtn = e.target.closest('.add-content-btn');
                const editBtn = e.target.closest('.edit-content-btn');
                const deleteBtn = e.target.closest('.delete-content-btn');

                if (addBtn) {
                    const type = addBtn.dataset.type;
                    console.log(`Add ${type} button clicked`);
                    // Open a generic modal or specific modal to add content
                    // Example: addContentItem(type, { name: prompt(`Enter ${type} name:`) }); // Basic prompt example
                }
                if (editBtn) {
                    const type = editBtn.dataset.type;
                    const id = editBtn.dataset.id;
                    editingContent = { id, type }; // Store what's being edited
                     if(type === 'quiz') {
                         console.log("Show Quiz Modal for Edit:", id); // Specific quiz logic
                         // showQuizModal(id);
                          if(quizModal) quizModal.style.display = 'flex';
                     } else {
                         console.log(`Edit ${type}:`, id);
                         // Open a generic modal or specific modal to edit content, prefill with data
                         // Example: updateContentItem(type, id, { name: prompt(`Enter new name for ${id}:`) }); // Basic prompt example
                     }
                }
                if (deleteBtn) {
                    const type = deleteBtn.dataset.type;
                    const id = deleteBtn.dataset.id;
                    showConfirmModal(
                        `Delete ${capitalize(type)}`,
                        `Are you sure you want to delete this ${type}?`,
                        () => deleteContentItem(type, id),
                        true
                    );
                }
            });
        }


        // =============================================
        // BLOG LOGIC (Keep all functions as is)
        // =============================================
        function initBlogLibs() { try{quill=new Quill('#quill-editor',{theme:'snow',modules:{toolbar:[[{'header':[1,2,3,!1]}],['bold','italic','underline','strike'],[{'list':'ordered'},{'list':'bullet'}],['link','image','video','code-block'],['clean']]}});const t=document.getElementById('post-tags');if(t)tagify=new Tagify(t);schedulePicker=flatpickr("#post-schedule-date",{enableTime:!0,dateFormat:"Y-m-d H:i"});}catch(e){console.warn("Blog Lib Init Err:",e)} }
        async function mockUploadFile(file){showToast(`Sim Upload: ${file.name}`);await new Promise(r=>setTimeout(r,500));const u=`https://placehold.co/600x400?text=${encodeURIComponent(file.name)}`;console.log(`Mock: ${file.name}->${u}`);return {name:file.name,url:u};}
        function initPostsListener(){unsubscribePosts=onSnapshot(query(postsCollection,orderBy("createdAt","desc")),s=>{allPosts=s.docs.map(d=>({id:d.id,...d.data()}));if(currentActiveTab==='list-posts')renderPostsTable();},e=>{console.error(e);showToast("Err posts.",!0);if(postsTableBody)postsTableBody.innerHTML=`<tr><td colspan="7" class="p-4 text-center text-red-500">Error loading.</td></tr>`;});}
        function initCommentsListener(){unsubscribeComments=onSnapshot(query(commentsCollection,orderBy("date","desc")),s=>{allComments=s.docs.map(d=>({id:d.id,...d.data()}));if(currentActiveTab==='comments')renderCommentsList();},e=>{console.error(e);showToast("Err comments.",!0);if(commentsListView)commentsListView.innerHTML=`<div class="p-4 text-center text-red-500">Error loading.</div>`;});}
        function initCategoriesListener(cb=null){unsubscribeCategories=onSnapshot(query(categoriesCollection,orderBy("name")),s=>{allCategories=s.docs.map(d=>({id:d.id,...d.data()}));updateCategoryDropdowns();if(cb)cb();},e=>{console.error(e);showToast("Err cats.",!0);if(cb&&categoriesList)categoriesList.innerHTML=`<li class="p-4 text-center text-red-500">Error loading.</li>`;});}
        async function fetchAllDataForAnalytics(){try{const[pS,cS,catS]=await Promise.all([getDocs(postsCollection),getDocs(commentsCollection),getDocs(categoriesCollection)]);allPosts=pS.docs.map(d=>({id:d.id,...d.data()}));allComments=cS.docs.map(d=>({id:d.id,...d.data()}));allCategories=catS.docs.map(d=>({id:d.id,...d.data()}));renderAnalytics();}catch(e){console.error(e);showToast("Err analytics.",!0);}}
        function renderPostsTable(){if(!postsTableBody)return;postsTableBody.innerHTML='';const s=document.getElementById('search-posts').value.toLowerCase(),c=filterCategorySelect.value,st=document.getElementById('filter-status').value;let f=allPosts.filter(p=>(p.title.toLowerCase().includes(s)||(p.author||'').toLowerCase().includes(s))&&(c===''||p.category===c)&&(st===''||p.status===st));if(f.length===0){postsTableBody.innerHTML=`<tr><td colspan="7" class="p-4 text-center text-gray-500">No posts.</td></tr>`;return;}f.forEach(p=>{const sc={Published:"bg-green-100 text-green-800",Draft:"bg-yellow-100 text-yellow-800",Scheduled:"bg-blue-100 text-blue-800"};const tr=document.createElement('tr');tr.className="hover:bg-gray-50 border-b";tr.innerHTML=`<td class="p-4"><input type="checkbox" class="post-checkbox" data-id="${p.id}"></td><td class="p-4"><div class="font-medium">${p.title}</div><div class="text-sm text-gray-500">${(p.tags||[]).join(', ')}</div></td><td class="p-4 text-sm">${p.author||'N/A'}</td><td class="p-4 text-sm">${p.category||'Uncat'}</td><td class="p-4"><span class="px-2 py-1 text-xs rounded ${sc[p.status]||'bg-gray-100'}">${p.status}</span></td><td class="p-4 text-sm">${p.publishDate?new Date(p.publishDate.toDate()).toLocaleDateString():'â€”'}</td><td class="p-4"><div class="flex space-x-1"><button class="view-btn p-1 text-blue-600" data-id="${p.id}" title="View"><i data-lucide="eye" class="w-4 h-4 p-e-none"></i></button><button class="edit-btn p-1 text-indigo-600" data-id="${p.id}" title="Edit"><i data-lucide="edit-2" class="w-4 h-4 p-e-none"></i></button><button class="share-btn p-1 text-green-600" data-id="${p.id}" data-title="${p.title}" title="Share"><i data-lucide="share-2" class="w-4 h-4 p-e-none"></i></button><button class="delete-btn p-1 text-red-600" data-id="${p.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button></div></td>`;postsTableBody.appendChild(tr);});lucide.createIcons();if(selectAllCheckbox)selectAllCheckbox.checked=!1;}
        function renderCommentsList(){if(!commentsListView)return;commentsListView.innerHTML='';const s=document.getElementById('search-comments').value.toLowerCase(),st=document.getElementById('filter-comment-status').value;let f=allComments.filter(c=>(c.author.toLowerCase().includes(s)||c.text.toLowerCase().includes(s))&&(st===''||c.status===st));if(f.length===0){commentsListView.innerHTML=`<div class="p-4 text-center text-gray-500">No comments.</div>`;return;}f.forEach(c=>{const p=allPosts.find(p=>p.id===c.postId),sc={Approved:"border-green-500",Pending:"border-yellow-500",Spam:"border-red-500"};const d=document.createElement('div');d.className=`bg-white rounded shadow-sm border-l-4 ${sc[c.status]||'border-gray-300'} mb-4`;d.innerHTML=`<div class="p-4"><div class="flex justify-between items-start"><div class="font-semibold">${c.author}<span class="text-sm font-normal text-gray-500">(${c.email})</span><div class="text-xs text-gray-500">${c.date?new Date(c.date.toDate()).toLocaleString():''}</div></div><div class="text-xs text-right text-gray-500">On:<span class="text-indigo-600">${p?p.title:'Deleted'}</span></div></div><p class="text-gray-700 my-3">${c.text}</p>${c.reply?`<div class="bg-gray-50 p-2 rounded border ml-6 text-sm"><p class="font-semibold">Reply:</p><p>${c.reply}</p></div>`:''}</div><div class="bg-gray-50 px-4 py-2 rounded-b flex flex-wrap gap-2 text-xs">${c.status!=='Approved'?`<button class="approve-comment-btn font-medium text-green-600" data-id="${c.id}"><i data-lucide="check" class="w-3 h-3 inline mr-1 p-e-none"></i>Approve</button>`:''}${c.status==='Approved'&&!c.reply?`<button class="reply-comment-btn font-medium text-blue-600" data-id="${c.id}"><i data-lucide="corner-up-left" class="w-3 h-3 inline mr-1 p-e-none"></i>Reply</button>`:''}${c.status!=='Spam'?`<button class="spam-comment-btn font-medium text-yellow-600" data-id="${c.id}"><i data-lucide="shield-alert" class="w-3 h-3 inline mr-1 p-e-none"></i>Spam</button>`:''}<button class="delete-comment-btn font-medium text-red-600 ml-auto" data-id="${c.id}"><i data-lucide="trash-2" class="w-3 h-3 inline mr-1 p-e-none"></i>Delete</button></div>`;commentsListView.appendChild(d);});lucide.createIcons();}
        function renderCategoriesList(){if(!categoriesList)return;categoriesList.innerHTML='';if(allCategories.length===0){categoriesList.innerHTML=`<li class="p-4 text-center text-gray-500">No cats.</li>`;return;}allCategories.forEach(c=>{const li=document.createElement('li');li.className="flex items-center justify-between p-3 border-b";li.innerHTML=`<span class="font-medium">${c.name}</span><button class="delete-category-btn text-red-600" data-id="${c.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 p-e-none"></i></button>`;categoriesList.appendChild(li);});lucide.createIcons();}
        function updateCategoryDropdowns(){const s=[filterCategorySelect,postCategorySelect];s.forEach(sel=>{if(!sel)return;const v=sel.value;while(sel.options.length>1)sel.remove(1);allCategories.forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=c.name;sel.appendChild(o);});if(Array.from(sel.options).some(o=>o.value===v))sel.value=v;});}
        function renderAnalytics(){const stp=document.getElementById('stats-total-posts'),stv=document.getElementById('stats-total-views'),stc=document.getElementById('stats-total-comments'),spd=document.getElementById('stats-published-drafts'),ppl=document.getElementById('popular-posts-list');if(!stp)return;const tp=allPosts.length,tv=allPosts.reduce((a,p)=>a+(p.views||0),0),pc=allComments.filter(c=>c.status==='Pending').length,pub=allPosts.filter(p=>p.status==='Published').length,dr=allPosts.filter(p=>p.status==='Draft').length;stp.textContent=tp;stv.textContent=tv.toLocaleString();stc.textContent=pc;spd.textContent=`${pub}/${dr}`;ppl.innerHTML='';const pop=[...allPosts].sort((a,b)=>(b.views||0)-(a.views||0)).slice(0,5);if(pop.length===0){ppl.innerHTML=`<li class="py-2 text-center text-gray-500">No data</li>`;return;}pop.forEach(p=>{const li=document.createElement('li');li.className="py-2 flex justify-between items-center border-b";li.innerHTML=`<span class="font-medium text-sm">${p.title}</span><span class="text-xs text-gray-500">${(p.views||0).toLocaleString()} views</span>`;ppl.appendChild(li);});}
        async function showPostForm(postId=null){if(!blogPostForm)return;blogPostForm.reset();quill.setContents([]);if(tagify)tagify.removeAllTags();imagePreview.src="#";imagePreviewWrapper.classList.add('hidden');attachmentList.innerHTML='';postIdInput.value='';if(postId){editingPostId=postId;postFormTitle.textContent="Edit";try{const snap=await getDoc(doc(db,"blogPosts",postId));if(snap.exists()){const p=snap.data();postIdInput.value=snap.id;postTitleInput.value=p.title;try{if(p.content&&typeof p.content==='string')quill.setContents(JSON.parse(p.content));else if(p.content&&typeof p.content==='object')quill.setContents(p.content);else quill.setText('');}catch(e){console.error(e);quill.setText('Err');}postStatusSelect.value=p.status;postCategorySelect.value=p.category||'Uncat';if(tagify&&p.tags)tagify.loadOriginalValues(p.tags);if(p.publishDate&&p.status==='Scheduled'){schedulePicker.setDate(p.publishDate.toDate(),!0);scheduleDateWrapper.classList.remove('hidden');}else{scheduleDateWrapper.classList.add('hidden');schedulePicker.clear();}if(p.featureImage){imagePreview.src=p.featureImage;imagePreviewWrapper.classList.remove('hidden');}else imagePreviewWrapper.classList.add('hidden');(p.attachments||[]).forEach(f=>addAttachmentToList(f.name,f.url));document.getElementById('seo-title').value=p.seoTitle||'';document.getElementById('seo-description').value=p.seoDescription||'';document.getElementById('seo-keywords').value=p.seoKeywords||'';if(currentActiveTab!=='post-form-view')showTab('post-form-view');}else{showToast("Post not found.",!0);editingPostId=null;showTab('list-posts');return;}}catch(e){console.error(e);showToast("Err loading post.",!0);editingPostId=null;showTab('list-posts');}}else{editingPostId=null;postFormTitle.textContent="Add New";scheduleDateWrapper.classList.add('hidden');schedulePicker.clear();imagePreviewWrapper.classList.add('hidden');if(currentActiveTab!=='post-form-view')showTab('post-form-view');}}
        async function handleBlogPostFormSubmit(e){e.preventDefault();const btn=document.getElementById('publish-btn');btn.disabled=!0;btn.textContent="Saving...";const title=postTitleInput.value.trim(),status=postStatusSelect.value;if(!title){showToast("Title required.",!0);btn.disabled=!1;btn.textContent="Publish";return;}const content=JSON.stringify(quill.getContents());let pubDate=null;if(status==='Scheduled'){if(schedulePicker.selectedDates[0])pubDate=Timestamp.fromDate(schedulePicker.selectedDates[0]);else{showToast("Date required.",!0);btn.disabled=!1;btn.textContent="Schedule";return;}}else if(status==='Published'){const op=editingPostId?allPosts.find(p=>p.id===editingPostId):null;if(!editingPostId||(op&&!op.publishDate))pubDate=serverTimestamp();else if(op&&op.publishDate)pubDate=op.publishDate;}const data={title,content,status,category:postCategorySelect.value,tags:tagify?tagify.value.map(t=>t.value):[],publishDate:pubDate,featureImage:imagePreview.src.startsWith('http')?imagePreview.src:null,attachments:Array.from(attachmentList.children).map(i=>({name:i.dataset.name,url:i.dataset.url})),seoTitle:document.getElementById('seo-title').value,seoDescription:document.getElementById('seo-description').value,seoKeywords:document.getElementById('seo-keywords').value,modifiedAt:serverTimestamp()};try{if(editingPostId){await updateDoc(doc(db,"blogPosts",editingPostId),data);showToast("Post updated!");}else{data.createdAt=serverTimestamp();data.author=currentUser?.email||"Admin";data.views=0;data.commentsCount=0;await addDoc(postsCollection,data);showToast("Post created!");}editingPostId=null;showTab('list-posts');}catch(e){console.error(e);showToast(`Error: ${e.message}`,!0);}finally{btn.disabled=!1;btn.textContent=postStatusSelect.value==='Scheduled'?'Schedule':'Publish';}}
        async function handleImageUpload(file){if(file)try{const{url}=await mockUploadFile(file);imagePreview.src=url;imagePreviewWrapper.classList.remove('hidden');}catch(e){console.error(e);showToast("Img upload failed.",!0);}}
        function addAttachmentToList(name, url){const d=document.createElement('div');d.className="flex items-center justify-between bg-gray-100 p-2 rounded";d.dataset.name=name;d.dataset.url=url;d.innerHTML=`<div class="flex items-center overflow-hidden mr-2"><i data-lucide="file-text" class="w-4 h-4 text-gray-500 mr-2 shrink-0"></i><span class="text-sm truncate">${name}</span></div><button type="button" class="remove-attachment-btn text-sm text-red-600 shrink-0">&times;Remove</button>`;attachmentList.appendChild(d);lucide.createIcons();d.querySelector('.remove-attachment-btn').addEventListener('click',()=>{d.remove();});}
        async function handleAttachmentUpload(files){for(const f of files)try{const{name,url}=await mockUploadFile(f);addAttachmentToList(name,url);}catch(e){console.error(e);showToast(`Attach failed:${f.name}`,!0);}}
        function showDeleteModal(postId){postToDeleteId=postId;if(deleteModal)deleteModal.style.display='flex';}
        async function confirmDelete(){if(postToDeleteId){confirmDeleteBtn.disabled=!0;confirmDeleteBtn.textContent="Deleting...";try{const batch=writeBatch(db);batch.delete(doc(db,"blogPosts",postToDeleteId));const q=query(commentsCollection,where("postId","==",postToDeleteId));const snap=await getDocs(q);snap.forEach(d=>batch.delete(d.ref));await batch.commit();showToast("Post deleted!");}catch(e){console.error(e);showToast(`Err delete: ${e.message}`,!0);}finally{postToDeleteId=null;if(deleteModal)deleteModal.style.display='none';confirmDeleteBtn.disabled=!1;confirmDeleteBtn.textContent="Delete";}}}
        async function updateCommentStatus(id, status){try{await updateDoc(doc(db,"blogComments",id),{status});showToast(`Comment: ${status}.`);}catch(e){console.error(e);showToast("Err update comment.",!0);}}
        async function deleteComment(id){if(confirm("Delete comment?")){try{await deleteDoc(doc(db,"blogComments",id));showToast("Comment deleted.");}catch(e){console.error(e);showToast("Err deleting.",!0);}}}
        function showReplyModal(id){const c=allComments.find(c=>c.id===id);if(c){commentToReplyId=id;document.getElementById('reply-author').textContent=`Reply to:${c.author}`;document.getElementById('reply-original-text').textContent=`"${c.text}"`;replyForm.reset();if(replyModal)replyModal.style.display='flex';}}
        async function handleReplySubmit(e){e.preventDefault();const btn=document.getElementById('submit-reply-btn');btn.disabled=!0;btn.textContent="Submitting...";const txt=document.getElementById('reply-text').value;if(commentToReplyId&&txt){try{await updateDoc(doc(db,"blogComments",commentToReplyId),{reply:txt});showToast("Reply sent!");if(replyModal)replyModal.style.display='none';}catch(e){console.error(e);showToast("Error replying.",!0);}finally{commentToReplyId=null;btn.disabled=!1;btn.textContent="Submit";}}else{btn.disabled=!1;btn.textContent="Submit";}}
        function showShareModal(id, title){const url=`${location.origin}/blog/post/${id}`;document.getElementById('share-post-title').textContent=title;document.getElementById('share-post-url').value=url;document.getElementById('share-twitter').href=`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;document.getElementById('share-facebook').href=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;document.getElementById('share-linkedin').href=`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;if(shareModal)shareModal.style.display='flex';lucide.createIcons();}
        function setupBlogEventListeners(){const abm=document.getElementById('add-new-post-btn-main');if(abm)abm.addEventListener('click',()=>{editingPostId=null;showPostForm();});const spi=document.getElementById('search-posts');if(spi)spi.addEventListener('input',renderPostsTable);if(filterCategorySelect)filterCategorySelect.addEventListener('change',renderPostsTable);const fss=document.getElementById('filter-status');if(fss)fss.addEventListener('change',renderPostsTable);if(selectAllCheckbox)selectAllCheckbox.addEventListener('change',e=>{if(postsTableBody)postsTableBody.querySelectorAll('.post-checkbox').forEach(c=>c.checked=e.target.checked);});if(postsTableBody)postsTableBody.addEventListener('click',e=>{const vb=e.target.closest('.view-btn'),eb=e.target.closest('.edit-btn'),sb=e.target.closest('.share-btn'),db=e.target.closest('.delete-btn');if(vb)window.open(`/blog/post/${vb.dataset.id}`,'_blank');if(eb)showPostForm(eb.dataset.id);if(sb)showShareModal(sb.dataset.id,sb.dataset.title);if(db)showDeleteModal(db.dataset.id);});if(confirmDeleteBtn)confirmDeleteBtn.addEventListener('click',confirmDelete);if(cancelDeleteBtn)cancelDeleteBtn.addEventListener('click',()=>deleteModal.style.display='none');if(cancelShareBtn)cancelShareBtn.addEventListener('click',()=>shareModal.style.display='none');if(copyUrlBtn)copyUrlBtn.addEventListener('click',()=>{const ui=document.getElementById('share-post-url');ui.select();ui.setSelectionRange(0,99999);try{document.execCommand('copy');showToast("URL copied!");}catch(e){console.error(e);showToast("Copy failed.",!0);}});if(blogPostForm)blogPostForm.addEventListener('submit',handleBlogPostFormSubmit);const sdb=document.getElementById('save-draft-btn');if(sdb)sdb.addEventListener('click',()=>{postStatusSelect.value="Draft";handleBlogPostFormSubmit(new Event('submit',{bubbles:!0,cancelable:!0}));});if(postStatusSelect)postStatusSelect.addEventListener('change',e=>{scheduleDateWrapper.classList.toggle('hidden',e.target.value!=='Scheduled');document.getElementById('publish-btn').textContent=e.target.value==='Scheduled'?'Schedule':'Publish';});if(imageDropzone)imageDropzone.addEventListener('click',()=>imageInput.click());if(imageInput)imageInput.addEventListener('change',e=>handleImageUpload(e.target.files[0]));if(removeImageBtn)removeImageBtn.addEventListener('click',()=>{imageInput.value='';imagePreview.src='#';imagePreviewWrapper.classList.add('hidden');});if(attachmentDropzone)attachmentDropzone.addEventListener('click',()=>attachmentInput.click());if(attachmentInput)attachmentInput.addEventListener('change',e=>handleAttachmentUpload(e.target.files));const sci=document.getElementById('search-comments');if(sci)sci.addEventListener('input',renderCommentsList);const fcsc=document.getElementById('filter-comment-status');if(fcsc)fcsc.addEventListener('change',renderCommentsList);if(commentsListView)commentsListView.addEventListener('click',e=>{const t=e.target.closest('button');if(!t)return;const id=t.dataset.id;if(t.classList.contains('approve-comment-btn'))updateCommentStatus(id,'Approved');if(t.classList.contains('spam-comment-btn'))updateCommentStatus(id,'Spam');if(t.classList.contains('delete-comment-btn'))deleteComment(id);if(t.classList.contains('reply-comment-btn'))showReplyModal(id);});if(replyForm)replyForm.addEventListener('submit',handleReplySubmit);if(cancelReplyBtn)cancelReplyBtn.addEventListener('click',()=>replyModal.style.display='none');if(addCategoryForm)addCategoryForm.addEventListener('submit',async e=>{e.preventDefault();const ni=document.getElementById('new-category-name'),cn=ni.value.trim(),btn=document.getElementById('add-category-btn');if(cn){btn.disabled=!0;btn.textContent="Adding...";if(allCategories.find(c=>c.name.toLowerCase()===cn.toLowerCase())){showToast("Cat exists.",!0);btn.disabled=!1;btn.textContent="Add";return;}try{await addDoc(categoriesCollection,{name:cn});showToast("Cat added!");ni.value='';}catch(e){console.error(e);showToast("Error add cat.",!0);}finally{btn.disabled=!1;btn.textContent="Add";}}});if(categoriesList)categoriesList.addEventListener('click',async e=>{const dcb=e.target.closest('.delete-category-btn');if(dcb){const id=dcb.dataset.id;if(confirm("Delete category?")){try{await deleteDoc(doc(db,"blogCategories",id));showToast("Cat deleted.");}catch(e){console.error(e);showToast("Err delete cat.",!0);}}}});}

    </script>

</body>
</html>
